#textdomain wesnoth-loti
#define INSERT_INTO_ITEMS SORT ITEM_NUMBER
    [loti_item_storage_add]
        number = {ITEM_NUMBER}
        sort = {SORT}
    [/loti_item_storage_add]
#enddef
#define GEM_CASE NUMBER VARIABLE_NAME
    [case]
        value={NUMBER}
        [if]
            [variable]
                name={VARIABLE_NAME}
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP {VARIABLE_NAME} add 1}
            [/then]
            [else]
                {VARIABLE {VARIABLE_NAME} 1}
            [/else]
        [/if]
    [/case]
#enddef
#define CANNOT_TAKE_OPTIONS
    [option]
        label=_"Store it."
        [show_if]
            [not]
                [variable]
                    name=no_inventory
                    equals=yes
                [/variable]
            [/not]
        [/show_if]
        [command]
            {INSERT_INTO_ITEMS $item_list.object[$item_number].sort| $item_list.object[$item_number].number|}
            [remove_item]
                x,y=$x1,$y1
                image=$item_list.object[$item_number].image
            [/remove_item]
            {CLEAR_VARIABLE items[$k]}
            {VARIABLE_OP l add -1}
            {VARIABLE picked 1}
        [/command]
    [/option]
    [option]
        label=_"Leave it on the ground."
        [command]
        [/command]
    [/option]
#enddef

#define GENERATE_ITEM_LIST
    [set_variables]
        name=item_list
        mode=replace
        [literal]
            {ITEM_LIST}
        [/literal]
    [/set_variables]
    {FOREACH item_list.object item_number}
        [describe_object]
            number=$item_list.object[$item_number].number
            sort=$item_list.object[$item_number].sort
            output=item_list.object[$item_number].description
        [/describe_object]
    {NEXT item_number}
    [clear_item_list_cache]
    [/clear_item_list_cache]
    [set_variables]		#Item types are used in the code, and translating them will cause errors. This should make the usage of language names easy
        name=item_type_translations
        [value]
            [armour]
                translation= _ "armour"
            [/armour]
            [helm]
                translation= _ "helm"
            [/helm]
            [gauntlets]
                translation= _ "gauntlets"
            [/gauntlets]
            [boots]
                translation= _ "boots"
            [/boots]
            [sword]
                translation= _ "sword"
            [/sword]
            [axe]
                translation= _ "axe"
            [/axe]
            [staff]
                translation= _ "staff"
            [/staff]
            [bow]
                translation= _ "bow"
            [/bow]
            [dagger]
                translation= _ "dagger"
            [/dagger]
            [xbow]
                translation= _ "crossbow"
            [/xbow]
            [knife]
                translation= _ "knife"
            [/knife]
            [mace]
                translation= _ "mace"
            [/mace]
            [spear]
                translation= _ "spear"
            [/spear]
            [polearm]
                translation= _ "polearm"
            [/polearm]
            [sling]
                translation= _ "sling"
            [/sling]
            [thunderstick]
                translation= _ "thunderstick"
            [/thunderstick]
            [claws]
                translation= _ "metal claws"
            [/claws]
            [essence]
                translation= _ "otherworldly essence"
            [/essence]
            [amulet]
                translation= _ "amulet"
            [/amulet]
            [ring]
                translation= _ "ring"
            [/ring]
            [cloak]
                translation= _ "cloak"
            [/cloak]
            [limited]
                translation= _ "limited"
            [/limited]
            [potion]
                translation= _ "potion"
            [/potion]
        [/value]
    [/set_variables]
#enddef

#define REMOVE_OBJECT SORT
    [store_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        variable=gifted
        kill=no
    [/store_unit]
    {VARIABLE i 0}
    [while]
        [variable]
            name=i
            less_than=$gifted.modifications.object.length
        [/variable]
        [do]
            [if]
                [variable]
                    name=gifted.modifications.object[$i].sort
                    equals={SORT}
                [/variable]
                [then]
                    [item]
                        x,y=$x1,$y1
                        image=$gifted.modifications.object[$i].image
                        halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                    [/item]
                    {VARIABLE_OP items_dropped add 1}
                    [set_variables]
                        name=items_to_add
                        mode=append
                        [value]
                            x=$x1
                            y=$y1
                            type=$gifted.modifications.object[$i].number
                            sort={SORT}
                        [/value]
                    [/set_variables]
                    {PLACE_ITEM_EVENT $x1 $y1}
                    {CLEAR_VARIABLE gifted.modifications.object[$i]}
                [/then]
                [else]
                    [set_variable]
                        name=i
                        add=1
                    [/set_variable]
                [/else]
            [/if]
        [/do]
    [/while]
    {CLEAR_VARIABLE i}
    [unstore_unit]
        variable=gifted
        find_vacant=no
    [/unstore_unit]
    {CLEAR_VARIABLE gifted}
#enddef

#define ITEM_PICK
    [event]
        name=item_pick
        first_time_only=no
        {VARIABLE picked 0}
        {FOREACH items k}
            [if]
                [variable]
                    name=x1
                    equals=$items[$k].x
                [/variable]
                [and]
                    [variable]
                        name=y1
                        equals=$items[$k].y
                    [/variable]
                [/and]
                [then]
                    [set_variable]
                        name=l
                        value=$k
                    [/set_variable]
                    [while]
                        [variable]
                            name=o
                            less_than=$item_list.object.length
                        [/variable]
                        [do]
                            [if]
                                [variable]
                                    name=item_list.object[$o].number
                                    equals=$items[$l].type
                                [/variable]
                                [then]
                                    {VARIABLE item_number $o}
                                [/then]
                            [/if]
                            [set_variable]
                                name=o
                                add=1
                            [/set_variable]
                        [/do]
                    [/while]
                    {CLEAR_VARIABLE o}
                    [if]
                        [variable]
                            name=item_list.object[$item_number].number
                            greater_than=530
                        [/variable]
                        [and]
                            [variable]
                                name=item_list.object[$item_number].number
                                less_than_equal_to=600
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE item_list.object[$item_number].sort $items[$l].sort}
                        [/then]
                    [/if]

                    # Determine if this item can be equipped.
                    [can_equip_item]
                        find_in=unit
                        item_number=$item_number
                        to_variable=can_take
                    [/can_equip_item]

                    [switch]
                        variable=item_list.object[$item_number].sort
                        [case]
                            value=limited
                            {VARIABLE can_take_this_weapon 1}
                            {FOREACH unit.object thing_number}
                                [if]
                                    [variable]
                                        name=unit.modifications.object[$thing_number].number
                                        equals=$item_list.object[$item_number].number
                                    [/variable]
                                    [then]
                                        {VARIABLE can_take_this_weapon 0}
                                    [/then]
                                [/if]
                            {NEXT thing_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit already has this item."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=gem
                            [remove_item]
                                x,y=$x1,$y1
                                image=$item_list.object[$item_number].image
                            [/remove_item]
                            [insert_tag]
                                name=object
                                variable=item_list.object[$item_number]
                            [/insert_tag]
                            {VARIABLE been_a_gem 1}
                            [switch]
                                variable=item_list.object[$item_number].number
                                {GEM_CASE 521 obsidians}
                                {GEM_CASE 522 topazes}
                                {GEM_CASE 523 opals}
                                {GEM_CASE 524 pearls}
                                {GEM_CASE 525 diamonds}
                                {GEM_CASE 526 rubies}
                                {GEM_CASE 527 emeralds}
                                {GEM_CASE 528 amethysts}
                                {GEM_CASE 529 sapphires}
                                {GEM_CASE 530 black_pearls}
                            [/switch]
                            {CLEAR_VARIABLE items[$l]}
                            {VARIABLE_OP l add -1}
                            {VARIABLE picked 1}
                        [/case]
                        [case]
                            value=gold
                            [remove_item]
                                x,y=$x1,$y1
                                image=$item_list.object[$item_number].image
                            [/remove_item]
                            {VARIABLE been_a_gem 1}
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=24
                                [/variable]
                                [then]
                                    [gold]
                                        side=$side_number
                                        amount=200
                                    [/gold]
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=37
                                [/variable]
                                [then]
                                    [gold]
                                        side=$side_number
                                        amount=100
                                    [/gold]
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=44
                                [/variable]
                                [then]
                                    [gold]
                                        side=$side_number
                                        amount=50
                                    [/gold]
                                [/then]
                            [/if]
                            {CLEAR_VARIABLE items[$l]}
                            {VARIABLE_OP l add -1}
                            {VARIABLE picked 1}
                        [/case]
                        [case]
                            value=potion
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=106
                                [/variable]
                                [then]
                                    [if]
                                        [variable]
                                            name=unit.variables.healed_this_turn
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE can_take _"This unit had already a healing potion in this turn."}
                                        [/then]
                                        [else]
                                            {VARIABLE fully_healed 1}
                                        [/else]
                                    [/if]
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=43
                                [/variable]
                                [or]
                                    [variable]
                                        name=item_list.object[$item_number].number
                                        equals=205
                                    [/variable]
                                [/or]
                                [then]
                                    [if]
                                        [variable]
                                            name=unit.variables.healed_this_turn
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE can_take _"This unit had already a healing potion in this turn."}
                                        [/then]
                                        [else]
                                            {VARIABLE healed 1}
                                        [/else]
                                    [/if]
                                [/then]
                            [/if]
                        [/case]
                    [/switch]
                    [if]
                        [variable]
                            name=been_a_gem
                            not_equals=1
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].sort
                                    contains="potion"
                                [/variable]
                                [or]
                                    [variable]
                                        name=item_list.object[$item_number].sort
                                        equals="limited"
                                    [/variable]
                                [/or]
                                [then]
                                    {VARIABLE name_unequipped _"irrelevant"}
                                [/then]
                                [else]
                                    {VARIABLE name_unequipped _"none"}
                                    {FOREACH unit.modifications.object ot}
                                        [if]
                                            [variable]
                                                name=unit.modifications.object[$ot].sort
                                                equals=$item_list.object[$item_number].sort
                                            [/variable]
                                            [then]
                                                {VARIABLE name_unequipped $unit.modifications.object[$ot].name}
                                            [/then]
                                        [/if]
                                    {NEXT ot}
                                [/else]
                            [/if]
                            {VARIABLE in_foreach "item_storage.$item_list.object[$item_number].sort"}
                            [set_variable]
                                name=in_foreach_length
                                to_variable=$in_foreach|.length
                            [/set_variable]
                            {VARIABLE identical_count 0}
                            {VARIABLE ot 0}
                            [while]
                                [variable]
                                    name=ot
                                    less_than=$in_foreach_length
                                [/variable]
                                [do]
                                    [if]
                                        [variable]
                                            name=$in_foreach|[$ot].type
                                            equals=$item_list.object[$item_number].number
                                        [/variable]
                                        [then]
                                            {VARIABLE_OP identical_count add 1}
                                        [/then]
                                    [/if]
                                    [set_variable]
                                        name=ot
                                        add=1
                                    [/set_variable]
                                [/do]
                            [/while]
                            {CLEAR_VARIABLE in_foreach,in_foreach_length,ot}
                            [if]
                                [variable]
                                    name=can_take
                                    equals=1
                                [/variable]
                                [then]
                                    [message]
                                        speaker=narrator
                                        caption=$item_list.object[$item_number].name
                                        message= _"$item_list.object[$item_number].description

Item of the same type that will be unequipped: $name_unequipped
Take this item?"
                                        image=$item_list.object[$item_number].image
                                        side_for=$side_number
                                        [option]
                                            label=_"Take it."
                                            [command]
                                                {VARIABLE shall_take 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Store it. Currently having $identical_count such items stored."
                                            [show_if]
                                                [not]
                                                    [variable]
                                                        name=no_inventory
                                                        equals=yes
                                                    [/variable]
                                                [/not]
                                            [/show_if]
                                            [command]
                                                {VARIABLE shall_take 0}
                                                {INSERT_INTO_ITEMS $item_list.object[$item_number].sort| $item_list.object[$item_number].number}
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {CLEAR_VARIABLE items[$k]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Smash it to get random gem."
                                            [show_if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    not_equals="limited"
                                                [/variable]
                                                [and]
                                                    [not]
                                                        [variable]
                                                            name=item_list.object[$item_number].sort
                                                            contains="potion"
                                                        [/variable]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {VARIABLE_OP item_type rand (521,521,521,521,521,521,521,521,521,521,522,522,522,522,522,522,523,523,523,523,523,524,524,524,524,524,524)}
                                                [if]
                                                    [variable]
                                                        name=item_type
                                                        equals=524
                                                    [/variable]
                                                    [then]
#ifdef LOTI_LOW_DROPS
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,526,526,527,527)}
#else
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,525,525,526,526,526,526,527,527,527,527,527,527)}
#endif
                                                        [if]
                                                            [variable]
                                                                name=item_type
                                                                equals=527
                                                            [/variable]
                                                            [then]
                                                                {VARIABLE_OP item_type rand (530,530,529,529,529,528,528,528,528,528,527,527,527,527,527,527,527,527)}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                [/if]
                                                {FOREACH item_list.object cv}
                                                    [if]
                                                        [variable]
                                                            name=item_list.object[$cv].number
                                                            equals=$item_type
                                                        [/variable]
                                                        [then]
                                                            {VARIABLE gem_number $cv}
                                                        [/then]
                                                    [/if]
                                                {NEXT cv}
                                                [insert_tag]
                                                    name=object
                                                    variable=item_list.object[$gem_number]
                                                [/insert_tag]
                                                {VARIABLE been_a_gem 1}
                                                [switch]
                                                    variable=item_list.object[$gem_number].number
                                                    {GEM_CASE 521 obsidians}
                                                    {GEM_CASE 522 topazes}
                                                    {GEM_CASE 523 opals}
                                                    {GEM_CASE 524 pearls}
                                                    {GEM_CASE 525 diamonds}
                                                    {GEM_CASE 526 rubies}
                                                    {GEM_CASE 527 emeralds}
                                                    {GEM_CASE 528 amethysts}
                                                    {GEM_CASE 529 sapphires}
                                                    {GEM_CASE 530 black_pearls}
                                                [/switch]
                                                {CLEAR_VARIABLE item_type,gem_number}
                                                {CLEAR_VARIABLE items[$l]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Leave it on the ground."
                                            [command]
                                                {VARIABLE shall_take 0}
                                            [/command]
                                        [/option]
                                    [/message]
                                [/then]
                                [else]
                                    {VARIABLE shall_take 0}
                                    [message]
                                        speaker=narrator
                                        caption=$item_list.object[$item_number].name
                                        message="$item_list.object[$item_number].description
<span color='red'>$can_take </span>"
                                        image=$item_list.object[$item_number].image
                                        side_for=$side_number
                                        [option]
                                            label=_"Store it. Currently having $identical_count such items stored."
                                            [show_if]
                                                [not]
                                                    [variable]
                                                        name=no_inventory
                                                        equals=yes
                                                    [/variable]
                                                [/not]
                                            [/show_if]
                                            [command]
                                                {INSERT_INTO_ITEMS $item_list.object[$item_number].sort| $item_list.object[$item_number].number}
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {CLEAR_VARIABLE items[$k]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Smash it to get random gem."
                                            [command]
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {VARIABLE_OP item_type rand (521,521,521,521,521,521,521,521,521,521,522,522,522,522,522,522,523,523,523,523,523,524,524,524,524,524,524)}
                                                [if]
                                                    [variable]
                                                        name=item_type
                                                        equals=524
                                                    [/variable]
                                                    [then]
#ifdef LOTI_LOW_DROPS
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,526,526,527,527)}
#else
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,525,525,526,526,526,526,527,527,527,527,527,527)}
#endif
                                                        [if]
                                                            [variable]
                                                                name=item_type
                                                                equals=527
                                                            [/variable]
                                                            [then]
                                                                {VARIABLE_OP item_type rand (530,530,529,529,529,528,528,528,528,528,527,527,527,527,527,527,527,527)}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                [/if]
                                                {FOREACH item_list.object cv}
                                                    [if]
                                                        [variable]
                                                            name=item_list.object[$cv].number
                                                            equals=$item_type
                                                        [/variable]
                                                        [then]
                                                            {VARIABLE gem_number $cv}
                                                        [/then]
                                                    [/if]
                                                {NEXT cv}
                                                [insert_tag]
                                                    name=object
                                                    variable=item_list.object[$gem_number]
                                                [/insert_tag]
                                                {VARIABLE been_a_gem 1}
                                                [switch]
                                                    variable=item_list.object[$gem_number].number
                                                    {GEM_CASE 521 obsidians}
                                                    {GEM_CASE 522 topazes}
                                                    {GEM_CASE 523 opals}
                                                    {GEM_CASE 524 pearls}
                                                    {GEM_CASE 525 diamonds}
                                                    {GEM_CASE 526 rubies}
                                                    {GEM_CASE 527 emeralds}
                                                    {GEM_CASE 528 amethysts}
                                                    {GEM_CASE 529 sapphires}
                                                    {GEM_CASE 530 black_pearls}
                                                [/switch]
                                                {CLEAR_VARIABLE item_type,gem_number}
                                                {CLEAR_VARIABLE items[$l]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            label=_"Leave it on the ground."
                                            [command]
                                            [/command]
                                        [/option]
                                    [/message]
                                [/else]
                            [/if]
                            {CLEAR_VARIABLE identical_count}
                            [if]
                                [variable]
                                    name=shall_take
                                    equals=1
                                [/variable]
                                [then]
                                    [remove_item]
                                        x,y=$x1,$y1
                                        image=$item_list.object[$item_number].image
                                    [/remove_item]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].sort
                                            contains=potion
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=item_list.object[$item_number].sort
                                                equals=limited
                                            [/variable]
                                        [/or]
                                        [else]
                                            {REMOVE_OBJECT $item_list.object[$item_number].sort}
                                        [/else]
                                    [/if]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            greater_than=530
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=item_list.object[$item_number].number
                                                less_than_equal_to=600
                                            [/variable]
                                        [/and]
                                        [then]
                                            [if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    equals=helm
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=boots
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=gauntlets
                                                    [/variable]
                                                [/or]
                                                [and]
                                                    [variable]
                                                        name=item_list.object[$item_number].defence
                                                        greater_than_equal_to=1
                                                    [/variable]
                                                [/and]
                                                [then]
                                                    {VARIABLE former_defence $item_list.object[$item_number].defence}
                                                    {VARIABLE_OP item_list.object[$item_number].defence divide 3}
                                                [/then]
                                            [/if]
                                        [/then]
                                    [/if]
                                    [set_variables]
                                        name=added_object
                                        to_variable=item_list.object[$item_number]
                                    [/set_variables]
                                    [insert_tag]
                                        name=object
                                        variable=added_object
                                    [/insert_tag]
                                    {CLEAR_VARIABLE added_object}
                                    [if]	#A few hacks to check some items that need some special code when picked up
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            equals=16
                                        [/variable]
                                        [then]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=advanced
                                            [/store_unit]
                                            {CLEAR_VARIABLE advanced.variables.starving}
                                            [unstore_unit]
                                                variable=advanced
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE advanced}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            equals=89
                                        [/variable]
                                        [then]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=advanced
                                            [/store_unit]
                                            [set_variables]
                                                name=advanced.modifications.trait[$advanced.modifications.trait.length]
                                                mode=replace
                                                [value]
                                                    id=fearless
                                                    male_name= _ "fearless"
                                                    female_name= _ "female^fearless"
                                                    description= _ "Fights normally during unfavourable times of day/night"
                                                    [effect]
                                                        apply_to="fearless"
                                                    [/effect]
                                                [/value]
                                            [/set_variables]
                                            [unstore_unit]
                                                variable=advanced
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE advanced}
                                        [/then]
                                    [/if]
                                    {CLEAR_VARIABLE items[$k]}
                                    {VARIABLE_OP l add -1}
                                    {VARIABLE picked 1}
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            greater_than=530
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=item_list.object[$item_number].number
                                                less_than_equal_to=600
                                            [/variable]
                                        [/and]
                                        [then]
                                            [if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    equals=helm
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=boots
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=gauntlets
                                                    [/variable]
                                                [/or]
                                                [and]
                                                    [variable]
                                                        name=item_list.object[$item_number].defence
                                                        greater_than_equal_to=1
                                                    [/variable]
                                                [/and]
                                                [then]
                                                    {VARIABLE item_list.object[$item_number].defence $former_defence}
                                                    {CLEAR_VARIABLE former_defence}
                                                [/then]
                                            [/if]
                                        [/then]
                                    [/if]
                                    {UPDATE_STATS}
                                [/then]
                            [/if]
                            {CLEAR_VARIABLE shall_take}
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    greater_than=530
                                [/variable]
                                [and]
                                    [variable]
                                        name=item_list.object[$item_number].number
                                        less_than_equal_to=560
                                    [/variable]
                                [/and]
                                [then]
                                    {VARIABLE item_list.object[$item_number].sort armourword}
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    greater_than=560
                                [/variable]
                                [and]
                                    [variable]
                                        name=item_list.object[$item_number].number
                                        less_than_equal_to=600
                                    [/variable]
                                [/and]
                                [then]
                                    {VARIABLE item_list.object[$item_number].sort weaponword}
                                [/then]
                            [/if]
                        [/then]
                    [/if]
                    [set_variable]
                        name=k
                        value=$l
                    [/set_variable]
                [/then]
            [/if]
        {NEXT k}
        {CLEAR_VARIABLE been_a_gem}
        {FOREACH items_to_add i}
            [if]
                [variable]
                    name=$items_to_add[$i].sort
                    contains=potion
                [/variable]
                [or]
                    [variable]
                        name=$items_to_add[$i].sort
                        equals=limited
                    [/variable]
                [/or]
                [else]
                    [set_variables]
                        name=items
                        mode=append
                        [value]
                            x=$x1
                            y=$y1
                            type=$items_to_add[$i].type
                            sort=$items_to_add[$i].sort
                        [/value]
                    [/set_variables]
                [/else]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=picked
                equals=0
            [/variable]
            [or]
                [variable]
                    name=been_a_gem
                    equals=1
                [/variable]
            [/or]
            [then]
                [if]
                    [variable]
                        name=been_a_gem
                        equals=1
                    [/variable]
                    [then]
                        [fire_event]
                            name=item_pick
                            [primary_unit]
                                id=$unit.id
                            [/primary_unit]
                        [/fire_event]
                    [/then]
                    [else]
                        [allow_undo]
                        [/allow_undo]
                    [/else]
                [/if]
            [/then]
            [else]
                [fire_event]	#Just for the case if collecting items was meant to be used for something
                    name=item picked
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/else]
        [/if]
        {CLEAR_VARIABLE items_to_add}
        {CLEAR_VARIABLE picked}
        {CLEAR_VARIABLE l}
        {CLEAR_VARIABLE item_number,name_unequipped}
        {CLEAR_VARIABLE can_take,can_take_this_weapon}
    [/event]
#enddef
