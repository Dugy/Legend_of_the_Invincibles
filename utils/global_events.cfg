#textdomain wesnoth-loti

#define DEFAULT_DROP_ITEM X Y WEAPONS
    [random_item]
        x={X}
        y={Y}
#ifdef LOTI_LOW_DROPS
        group=drop
#else
        group=expanded_drop
#endif
        [types]
            armour=armour,armour,armour,helm,boots,gauntlets
            weapon={WEAPONS}
            other=amulet,amulet,ring,ring,cloak,cloak,limited,potion,potion,potion,potion,potion,gold,gold,gold,gold
        [/types]
    [/random_item]
#enddef

#define DROP_GEM X Y
    [random_item]
        x={X}
        y={Y}
#ifdef LOTI_LOW_DROPS
        group=gem
#else
        group=gem_expanded
#endif
    [/random_item]
#enddef

#define DROPS CHANCE CHANCE_GEM WEAPONS BOSSES ENEMIES
    #ifndef MULTIPLAYER
        {DROPS_EXT {CHANCE} {CHANCE_GEM} {WEAPONS} {BOSSES} {ENEMIES} "1"}
    #else
        {DROPS_EXT {CHANCE} {CHANCE_GEM} {WEAPONS} {BOSSES} {ENEMIES} "1,2,3,4,5"}
    #endif
#enddef

#define DROPS_EXT CHANCE CHANCE_GEM WEAPONS BOSSES ENEMIES ALLIES
    #Adjust this macro to control drops better
    [event]
        name=die
        first_time_only=no
        [filter]
            side={ENEMIES}
        [/filter]
        {VARIABLE_OP did_drop rand (1..100)}
        [if]
            [variable]
                name=did_drop
                less_than_equal_to={CHANCE}
            [/variable]
            [then]
                {DEFAULT_DROP_ITEM $x1 $y1 {WEAPONS}}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.canrecruit
                equals=yes
            [/variable]
            [and]
                [variable]
                    name=unit.canrecruit
                    equals={BOSSES}
                [/variable]
            [/and]
            [then]
                {DEFAULT_DROP_ITEM $x1 $y1 {WEAPONS}}
            [/then]
        [/if]
        {CLEAR_VARIABLE did_drop}
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter]
            side={ENEMIES}
        [/filter]
        {VARIABLE_OP did_drop rand (1..100)}
        [if]
            [variable]
                name=did_drop
                less_than_equal_to={CHANCE_GEM}
            [/variable]
            [or]
                [variable]
                    name=unit.variables.bonus_boss
                    equals=yes
                [/variable]
            [/or]
            [then]
                [if]
                    [variable]
                        name=unit.variables.bonus_boss
                        equals=yes
                    [/variable]
                    [then]
                        [random_item]
                            x=$x1
                            y=$y1
                            group=high_gem
                        [/random_item]
                    [/then]
                    [else]
                        {DROP_GEM $x1 $y1}
                    [/else]
                [/if]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_drop,item_type}
    [/event]
    [event]
        name=unit placed
        first_time_only=no
        [filter]
            [not]
                side={ALLIES}
            [/not]
        [/filter]
        [check_unit_title]
            find_in=unit
        [/check_unit_title]
    [/event]
    [event]
        name=prestart
        {VARIABLE enemy_sides ({ENEMIES})}
        {VARIABLE allied_sides ({ALLIES})}
    [/event]
#enddef

#define PLACE_ITEM_EVENT X Y
    [set_variables]
        name=item_event
        mode=replace
        [literal]
            name=moveto
            first_time_only=no	#This would cause a neglectful delay and break the 'press t to keep moving' thing when stepping on places where items dropped, but the delay
            [filter]		#is really neglectful and the player is not very likely to discover some units when walking where items already dropped. It might be more
                x,y={X},{Y}	#significant in HotOW, but it would just fool the player to assure that he won't notice enemy spawns due to the delays when they are created.
                side=$allied_sides
                [not]
                    [filter_wml]
                        [variables]
                            cant_pick=yes
                        [/variables]
                    [/filter_wml]
                [/not]
            [/filter]
            [fire_event]
                name=item_pick
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
        [/literal]
    [/set_variables]
    {VARIABLE item_event.id "ie{X}|{Y}"}
    {VARIABLE item_event.filter.x {X}}
    {VARIABLE item_event.filter.y {Y}}
    [insert_tag]
        name=event
        variable=item_event
    [/insert_tag]
    {CLEAR_VARIABLE item_event}
#enddef

#define NARRATOR_MESSAGE TEXT
    [message]
        speaker=narrator
        image="wesnoth-icon.png"
        message={TEXT}
    [/message]
#enddef

#define DRAW_ITEM
    [loti_item_type]
        number=$item_type
        to_variable=item_info
    [/loti_item_type]
    [item]
        halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
        x,y=$item_unknown_x,$item_unknown_y
        image=$item_info.image
    [/item]
    {CLEAR_VARIABLE item_type}
    {CLEAR_VARIABLE item_unknown_x}
    {CLEAR_VARIABLE item_unknown_y}
    {CLEAR_VARIABLE item_info}
#enddef

#define RARE_ITEM X Y
    [random_item]
        x={X}
        y={Y}
        group=rare_drop
    [/random_item]
#enddef

#define GLADIATORS_ITEM X Y
    [random_item]
        x={X}
        y={Y}
        group=gladiators_drop
    [/random_item]
#enddef

#define PLACE_ITEM NUMBER X Y
    [set_variable]
        name=item_unknown_x
        value={X}
    [/set_variable]
    [set_variable]
        name=item_unknown_y
        value={Y}
    [/set_variable]
    [set_variable]
        name=item_type
        value={NUMBER}
    [/set_variable]
    [set_variables]
        name=items
        mode=append
        [value]
            x={X}
            y={Y}
            type={NUMBER}
        [/value]
    [/set_variables]
    {PLACE_ITEM_EVENT {X} {Y}}
    {DRAW_ITEM}
#enddef

#define PRELOAD_WEAPON_BINDINGS
    [event]
        name=preload
        first_time_only=no
        {DEFAULT_WEAPON_BINDINGS}
    [/event]
#enddef

#define LOTI_AMLA_STUFF
#ifndef DISABLE_AMLA_WORKAROUND
    [event]
        name=pre advance
        first_time_only=no
        [set_variable]
            name="pre_advance_store"
            to_variable="unit"
        [/set_variable]
        [pre_advance_stuff]
            id=$unit.id
        [/pre_advance_stuff]
    [/event]

    [event]
        name=advance
        first_time_only=no
        [advance_stuff]
            id=$unit.id
        [/advance_stuff]
    [/event]
    [event]
        name=post advance
        first_time_only=no
        [modify_unit]
            [filter]
                find_in="unit"
            [/filter]
            moves="$pre_advance_store.moves"
            attacks_left="$pre_advance_store.attacks_left"
        [/modify_unit]
        {UPDATE_STATS}
        {CLEAR_VARIABLE pre_advance_store}
    [/event]
#endif
#enddef

#define GLOBAL_EVENTS
{LOTI_AMLA_STUFF}
    [event]
        name=prestart
        [unit]
            type=Event Loader
            side=1
            x,y=1,1
        [/unit]
        [kill]
            type=Event Loader
            animate=no
        [/kill]
        {VARIABLE_OP base_seed rand "0..10000"}
    [/event]
    {PRELOAD_WEAPON_BINDINGS}
#enddef

#define GLOBAL_EVENTS_LIST
    {ABILITIES_EVENTS}
    {SOUL_EATER}
    {REDEEMING}
    {LOTI_COLLECT_WHEN_VICTORY}
    [event]
        name=victory
        id=kill_walking_corpses
        [kill]
            type=Walking Corpse
            side=1
            [not]
                [filter_wml]
                    [variables]
                        geared=yes
                    [/variables]
                [/filter_wml]
            [/not]
            fire_event=no
            animate=no
        [/kill]
    [/event]
    {ITEM_PICK}
    [event]
        name=update_stats
        first_time_only=no
        [update_stats]
            x,y=$x1,$y1
        [/update_stats]
    [/event]
#ifdef DISABLE_AMLA_WORKAROUND
    [event] # Clean version that unfortunately can't be used.
        name=post advance
        first_time_only=no
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=advanced2
            kill=yes
        [/store_unit]
        {CLEAR_VARIABLE advanced2.status.incinerated}
        [if]
            [variable]
                name=advanced2.type
                equals=Elvish Assassin
            [/variable]
            [then]
                [set_variables]
                    mode=replace
                    name=advanced2.modifications.advancement[1]
                    [value]
                        max_times=1
                        always_display=yes
                        id=execution
                        image=attacks/bow-elven-magic.png
                        strict_amla=yes
                        require_amla=""
                        [effect]
                            apply_to=remove_attack
                            name=execution
                        [/effect]
                        [effect]
                            apply_to=bonus_attack
                            name=execution
                            description= _ "execution"
                            icon=attacks/bow-elven-magic.png
                            range=ranged
                            defense_weight=0
                            damage=-40
                            merge=yes
                            force_original_attack=longbow
                        [/effect]
                    [/value]
                [/set_variables]
            [/then]
        [/if]
        {FOREACH advanced2.modifications.object i}
            [if]
                [variable]
                    name=advanced2.modifications.object[$i].sort
                    contains=potion
                [/variable]
                [then]
                    {CLEAR_VARIABLE advanced2.modifications.object[$i]}
                    {VARIABLE_OP i sub 1}
                [/then]
            [/if]
        {NEXT i}
        [unstore_unit]
            variable=advanced2
            find_vacant=no
        [/unstore_unit]
        {UPDATE_STATS}
    [/event]
#else

#endif
    {LOTI_UPDATES}
    
    {LOTI_ESSENTIALS}

    {HELP_EVENTS}
    
    {LOTI_RECRUIT_MODS}

    {LOTI_DEMON_HACK}

    {LOTI_FORCE_RESPEC}

    {LOTI_MAKE_BLACK_SOUL}

    {LOTI_MAKE_DOPPELGANGER}

    {LOTI_DELAYED_EXP}

    {LOTI_CLEAR_HEALED_STATUS}

#ifndef NO_LOTI
    {LOTI_BEELZEBUB_PROGRESS}
#endif

#ifdef ACCELERATE_AI
    [event]
        name=start
        [if]
            [variable]
                name=no_fast_ai
                equals=yes
            [/variable]
            [else]
                [store_side]
                    [filter]
                    [/filter]
                    variable=ai_sides
                [/store_side]
                [foreach]
                    array=ai_sides
                    [do]
                        [micro_ai]
                            side=$this_item.side
                            ai_type=fast_ai
                            action=add
                        [/micro_ai]
                    [/do]
                [/foreach]
                {CLEAR_VARIABLE ai_sides}
            [/else]
        [/if]
    [/event]
#endif

    {LOTI_EXTRA_ADVANCEMENT_PATHS}

#enddef

#define LOTI_UPDATES
    [event]
        name=prestart
        # Remove recently picked gems on units on the recall list
        [store_unit]
            [filter]
                side=$allied_sides
            [/filter]
            variable=starters
            kill=yes
        [/store_unit]
        {FOREACH starters i}
            {FOREACH starters[$i].modifications.object j}
                [if]
                    [variable]
                        name=starters[$i].modifications.object[$j].number
                        greater_than_equal_to=521
                    [/variable]
                    [and]
                        [variable]
                            name=starters[$i].modifications.object[$j].number
                            less_than_equal_to=530
                        [/variable]
                    [/and]
                    [then]
                        {CLEAR_VARIABLE starters[$i].modifications.object[$j]}
                        {VARIABLE_OP j sub 1}
                    [/then]
                [/if]
            {NEXT j}
            [unstore_unit]
                variable=starters[$i]
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE starters}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        #Workaround to make units newly created with plague behave properly.
        [update_stats]
            [not]
                [filter_wml]
                    [variables]
                        updated=yes
                    [/variables]
                [/filter_wml]
            [/not]
            side=$allied_sides
        [/update_stats]
        [fire_event]
            name=unit placed activate
        [/fire_event]
    [/event]
    [event]
        name=unit placed activate
        [event]
            name=unit placed
            first_time_only=no
            [filter]
                side=$allied_sides
                [not]
                    [filter_wml]
                        [variables]
                            update_started=yes
                        [/variables]
                    [/filter_wml]
                [/not]
                [not]
                    [filter_wml]
                        [variables]
                            updated=yes
                        [/variables]
                    [/filter_wml]
                [/not]
            [/filter]
            {UPDATE_STATS}
            [deny_undo]
            [/deny_undo]
        [/event]
     [/event]
     
    [event]
        name=recall
        first_time_only=no
        [filter]
            side=1
            [and]
                [not]
                    [filter_wml]
                        [variables]
                            updated=yes
                        [/variables]
                    [/filter_wml]
                [/not]
                [or]
                    [filter_wml]
                        [variables]
                            glob_on_starving=*
                        [/variables]
                    [/filter_wml]
                [/or]
            [/and]
        [/filter]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=advanced
            kill=no
        [/store_unit]
        [if]
            [variable]
                name=advanced.variables.updated
                equals=yes
            [/variable]
            [else]
                {UPDATE_STATS}
            [/else]
        [/if]
        {CLEAR_VARIABLE advanced.variables.starving}
        [unstore_unit]
            variable=advanced
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE advanced}
    [/event]
#enddef

#define LOTI_COLLECT_WHEN_VICTORY
    [event]
        name=victory
        [foreach]
            array=items
            [do]
                [remove_item]
                    x,y=$this_item.x,$this_item.y
                [/remove_item]
                [if]
                    [variable]
                        name=this_item.turn
                        equals=$turn_number
                    [/variable]
                    [or]
                        [have_location]
                            x,y=$this_item.x,$this_item.y
                            terrain=X*^*,*^X*
                        [/have_location]
                    [/or]
                    [then]
                        [loti_item_type]
                            number=$this_item.type
                            to_variable=item_info
                        [/loti_item_type]
                        {INSERT_INTO_ITEMS $item_info.sort $item_info.number}
                        [message]
                            speaker=narrator
                            message=_"Automatically picked $item_info.name you could not pick before the end of the scenario."
                            image="wesnoth-icon.png"
                        [/message]
                    [/then]
                [/if]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE item_x,item_y,items,item_info}
    [/event]
#enddef

#define LOTI_ESSENTIALS
    [event]
        name=start
        {VARIABLE bosses "Umbra4,Akula,Achilles,Baal,Shadowlord,Lethalia_evil,Niflheim,Uria,Lilith,Abaddon,Romero,Beelzebub,Delly"} #Some abilities have no effect on bosses, the game needs to know who the bosses are
        {GENERATE_ITEM_LIST}

        [set_menu_item]
            id=3dropping
            description=_"Items"
            use_hotkey=yes
            [default_hotkey]
                key=i
                shift=yes
            [/default_hotkey]
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=$side_number
                    [not]
                        [filter_wml]
                            [variables]
                                cant_pick=yes
                            [/variables]
                        [/filter_wml]
                    [/not]
                [/have_unit]
            [/show_if]
            [command]
                [show_inventory]
                    x,y=$x1,$y1
                [/show_inventory]
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=8respec
            description=_"Alter advancement"
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=$side_number
                    [filter_wml]
                        [variables]
                            achieved_amla=yes
                        [/variables]
                    [/filter_wml]
                    [not]
                        [filter_wml]
                            [variables]
                                cant_pick=yes
                            [/variables]
                        [/filter_wml]
                    [/not]
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=worked_on
                    kill=no
                [/store_unit]
                [store_unit_type]
                    type=Advancing$worked_on.type
                    variable=unit_style
                [/store_unit_type]
                {VARIABLE last_advancement_index unused}
                {VARIABLE advancement_number $worked_on.modifications.advancement.length}
                {VARIABLE_OP advancement_number sub 1}

                [while]
                    [variable]
                        name=advancement_number
                        greater_than_equal_to=0
                    [/variable]
                    [and]
                        [variable]
                            name=last_advancement_index
                            equals=unused
                        [/variable]
                    [/and]
                    [do]
                        {FOREACH unit_style.advancement i}
                            [if]
                                [variable]
                                    name=unit_style.advancement[$i].id
                                    equals=$worked_on.modifications.advancement[$advancement_number].id
                                [/variable]
                                [then]
                                    {VARIABLE last_advancement_index $advancement_number}
                                [/then]
                            [/if]
                        {NEXT i}
                        {VARIABLE_OP advancement_number sub 1}
                    [/do]
                [/while]
                {CLEAR_VARIABLE advancement_number,unit_style}
                [if]
                    [variable]
                        name=last_advancement_index
                        equals=unused
                    [/variable]
                    [then]
                        {NARRATOR_MESSAGE _"Last advancement not found."}
                    [/then]
                    [else]
                        [message]
                            speaker=narrator
                            message= _ "The last advancement this unit has taken is described as:
<b>$worked_on.modifications.advancement[$last_advancement_index].description </b>
Do you want to change it for something else?"
                            side_for=$side_number
                            image=$worked_on.modifications.advancement[$last_advancement_index].image
                            [option]
                                label=_"Yes"
                                [command]
                                    {CLEAR_VARIABLE worked_on.modifications.advancement[$last_advancement_index]}
                                    {CLEAR_VARIABLE worked_on.variables.achieved_amla}
                                    {VARIABLE experience_to_give $worked_on.experience}
                                    {VARIABLE_OP experience_to_give add $worked_on.max_experience}
                                    [unit]
                                        side=$worked_on.side
                                        x=$worked_on.x
                                        y=$worked_on.y
                                        experience=$experience_to_give
                                        max_experience=$worked_on.max_experience
                                        canrecruit=$worked_on.canrecruit
                                        variation=$worked_on.variation
                                        type=Advancing$worked_on.type
                                        id=$worked_on.id
                                        hitpoints=$worked_on.hitpoints
                                        gender=$worked_on.gender
                                        name=$worked_on.name
                                        facing=$worked_on.facing
                                        extra_recruit=$worked_on.extra_recruit
                                        underlying_id=$worked_on.underlying_id
                                        unrenamable=$worked_on.unrenamable
                                        animate=no
                                        [insert_tag]
                                            name=status
                                            variable=worked_on.status
                                        [/insert_tag]
                                        [insert_tag]
                                            name=modifications
                                            variable=worked_on.modifications
                                        [/insert_tag]
                                        [insert_tag]
                                            name=variables
                                            variable=worked_on.variables
                                        [/insert_tag]
                                        to_variable=advancing_store
                                    [/unit]
                                    [unstore_unit]
                                        variable=advancing_store
                                        find_vacant=no
                                    [/unstore_unit]
                                    [store_unit]
                                        [filter]
                                            x,y=$x1,$y1
                                        [/filter]
                                        variable=advanced2
                                        kill=yes
                                    [/store_unit]
                                    [unit]
                                        side=$worked_on.side
                                        x=$worked_on.x
                                        y=$worked_on.y
                                        experience=$advanced2.experience
                                        canrecruit=$worked_on.canrecruit
                                        variation=$worked_on.variation
                                        type=$worked_on.type
                                        id=$worked_on.id
                                        moves=$worked_on.moves
                                        hitpoints=$worked_on.hitpoints
                                        gender=$worked_on.gender
                                        name=$worked_on.name
                                        facing=$worked_on.facing
                                        extra_recruit=$worked_on.extra_recruit
                                        underlying_id=$worked_on.underlying_id
                                        unrenamable=$worked_on.unrenamable
                                        animate=no
                                        attacks_left=$worked_on.attacks_left
                                        [insert_tag]
                                            name=status
                                            variable=worked_on.status
                                        [/insert_tag]
                                        [insert_tag]
                                            name=modifications
                                            variable=advanced2.modifications
                                        [/insert_tag]
                                        [insert_tag]
                                            name=variables
                                            variable=worked_on.variables
                                        [/insert_tag]
                                    [/unit]
                                    [update_stats]
                                        id=$worked_on.id
                                    [/update_stats]
                                    {CLEAR_VARIABLE experience_to_give}
                                [/command]
                            [/option]
                            [option]
                                label=_"No"
                                [command]
                                [/command]
                            [/option]
                        [/message]
                    [/else]
                [/if]
                {CLEAR_VARIABLE worked_on,last_advancement_index}
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=9help
            description=_"Campaign help"
            [command]
                [message]
                    speaker=narrator
                    message=_"What do you need help with?"
                    side_for=$side_number
                    image="wesnoth-icon.png"
                    [option]
                        label=_"Interface"
                        [command]
                            [fire_event]
                                name=help_interface
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        label=_"Walkthroughs"
                        [command]
                            [fire_event]
                                name=help_walkthroughs_check
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        label=_"Frequently Asked Questions"
                        [command]
                            [fire_event]
                                name=help_faq
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        label=_"Exit"
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/command]
        [/set_menu_item]
        [set_menu_item]
            use_hotkey=only
            id=xx_unit_info
            description=_"Unit information"
            [default_hotkey]
                key=c
                shift=yes
            [/default_hotkey]
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=$side_number
                    [not]
                        [filter_wml]
                            [variables]
                                cant_pick=yes
                            [/variables]
                        [/filter_wml]
                    [/not]
                [/have_unit]
            [/show_if]
            [command]
                [fire_event]
                    name=unit information
                    [primary_unit]
                        find_in=unit
                    [/primary_unit]
                [/fire_event]
            [/command]
        [/set_menu_item]
        {VARIABLE items_dropped 0}
    [/event]

    [event]
        name=crafting_menu
        first_time_only=no
        [lua]
            code=<< loti.gem.show_crafting_window( wml.variables["x1"], wml.variables["y1"]) >>
        [/lua]
    [/event]

    [event]
        name=unit information
        first_time_only=no
        # This is the rewrite from fdsfsfdsjkljkl, nicely improving the old code.

        [unit_information_parts_1_to_5]
        [/unit_information_parts_1_to_5]

        # Generate the list of books read and limited use items used.
        # Simple enough -- no Lua needed.
        [foreach]
            array = unit.modifications.object
            [do]
                [if]
                    [variable]
                        name=unit.modifications.object[$i].sort
                        equals="limited"
                    [/variable]
                    [then]
                        {VARIABLE limited_items[$limited_items.length].name $unit.modifications.object[$i].name}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=unit.modifications.object[$i].sort
                        equals="potion"
                    [/variable]
                    [then]
                        {VARIABLE potions[$potions.length].name $unit.modifications.object[$i].name}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [set_variable]
            name=limited_items_list
            [join]
                variable=limited_items
                key=name
                separator=", "
                remove_empty=yes
            [/join]
        [/set_variable]
        [if]
            [variable]
                name=limited_items_list
                equals=""
            [/variable]
            [then]
                {VARIABLE limited_items_list _"none"}
            [/then]
        [/if]

        [set_variable]
            name=potions_list
            [join]
                variable=potions
                key=name
                separator=", "
                remove_empty=yes
            [/join]
        [/set_variable]
        [if]
            [variable]
                name=potions_list
                equals=""
            [/variable]
            [then]
                {VARIABLE potions_list _"none"}
            [/then]
        [/if]
        {CLEAR_VARIABLE potions,limited_items}

        # Create a list of advancements with a count of how many times each was taken
        [unit_information_part_6]
        [/unit_information_part_6]

        [message]
            speaker=narrator
            image=$unit.profile
            caption=$unit.name
            message= _ "
<span size='xx-large' weight='bold' underline='single'>$unit.name</span><span color='#88FCA0' size='x-large'> ($unit.language_name)</span>
$desc_prefix
<span size='large' weight='bold'>Attacks:</span>
$attacks_list

<span size='large' weight='bold'>Abilities:</span>
$abilities_list

<span size='large' weight='bold'>Resistances and Penetrations:</span>
$resistances_list

<span size='large' weight='bold'>Terrain defences and Movement costs:</span>
$defences_list

<span size='large' weight='bold'>Potions in effect:</span>
$potions_list

<span size='large' weight='bold'>Books Read and Non-Removable Items:</span>
$limited_items_list

<span size='large' weight='bold'>Advancements taken:</span>
$advancements_taken
$soul_eating"
        [/message]

        {CLEAR_VARIABLE desc_prefix,attacks_list,abilities_list,resistances_list,defences_list,limited_items_list,advancements_taken,soul_eating,potions_list}
    [/event]
#enddef

#define LOTI_RECRUIT_MODS
    [event]
        name=recruit
        first_time_only=no
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=advanced
            kill=no
        [/store_unit]
#ifndef MULTIPLAYER
        [if]
            [variable]
                name=side_number
                equals=1
            [/variable]
            [then]
                {VARIABLE_OP loyality rand (1..50)}
                [if]
                    [variable]
                        name=loyality
                        equals=1
                    [/variable]
                    [have_unit]
                        id=$unit.id
                        [not]
                            upkeep=loyal
                        [/not]
                    [/have_unit]
                    [then]
                        #textdomain wesnoth-help
                        [set_variables]
                            name=advanced.modifications.trait[$advanced.modifications.trait.length]
                            [value]
                                id=loyal
                                male_name=_"loyal"
                                female_name=_"female^loyal"
                                [effect]
                                    apply_to=loyal
                                    description=_"Zero upkeep"
                                [/effect]
                            [/value]
                            mode=replace
                        [/set_variables]
                        {VARIABLE advanced.upkeep loyal}
                        #textdomain wesnoth-loti
                    [/then]
                [/if]
                {VARIABLE_OP highlander rand (1..100)}
                [if]
                    [variable]
                        name=highlander
                        equals=1
                    [/variable]
                    [then]
                        [set_variables]
                            name=advanced.modifications.trait[$advanced.modifications.trait.length]
                            [value]
                                id=healthy
                                male_name= _"highlander"
                                female_name= _"female^highlander"
                                generate_description=false
                                description= _"Born better than others, 5 more hitpoints + 3 more per level, 1 more damage per level, heals 2 HP every turn"
                                [effect]
                                    apply_to=hitpoints
                                    increase_total=5
                                [/effect]
                                [effect]
                                    apply_to=hitpoints
                                    times=per level
                                    increase_total=3
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    times=per level
                                    increase_damage=1
                                [/effect]
                            [/value]
                            mode=replace
                        [/set_variables]
                        {VARIABLE advanced.hitpoints "$($advanced.max_hitpoints+5+3*$advanced.level)"}
                    [/then]
                [/if]
                [unstore_unit]
                    variable=advanced
                    find_vacant=no
                [/unstore_unit]
                [if]
                    [variable]
                        name=highlander
                        equals=1
                    [/variable]
                    [or]
                        [variable]
                            name=loyality
                            equals=1
                        [/variable]
                    [/or]
                    [then]
                        [store_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            variable=advanced2
                            kill=yes
                        [/store_unit]
                        [unit]	#Doesn't flash white like the previous way to do it
                            side=$advanced2.side
                            x=$advanced2.x
                            y=$advanced2.y
                            experience=$advanced2.experience
                            canrecruit=$advanced2.canrecruit
                            variation=$advanced2.variation
                            type=$advanced2.type
                            id=$advanced2.id
                            moves=$advanced2.moves
                            hitpoints=$advanced2.hitpoints
                            gender=$advanced2.gender
                            name=$advanced2.name
                            facing=$advanced2.facing
                            extra_recruit=$advanced2.extra_recruit
                            attacks_left=0
                            moves=0
                            underlying_id=$advanced2.underlying_id
                            unrenamable=$advanced2.unrenamable
                            animate=no
                            [insert_tag]
                                name=status
                                variable=advanced2.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=advanced2.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=advanced2.variables
                            [/insert_tag]
                        [/unit]
                        {UPDATE_ATTACKS $advanced2.x $advanced2.y}
                    [/then]
                    [else]
                        {UPDATE_ATTACKS $x1 $y1}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=loyality
                        equals=1
                    [/variable]
                    [have_unit]
                        id=$unit.id
                        [not]
                            upkeep=loyal
                        [/not]
                    [/have_unit]
                    [then]
                        [unit_overlay]
                            id=$advanced.id
                            image=misc/loyal-icon.png
                        [/unit_overlay]
                    [/then]
                [/if]
            [/then]
        [/if]
#endif
        {CLEAR_VARIABLE highlander}
        {CLEAR_VARIABLE advanced,advanced2}
        {CLEAR_VARIABLE loyality}
    [/event]
#ifndef EASY
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=$enemy_sides
        [/filter]
#ifdef NORMAL
        {VARIABLE_OP bonus rand (1..20)}
#endif
#ifdef HARD
        {VARIABLE_OP bonus rand (1..10)}
#endif
#ifdef MULTIPLAYER
        {VARIABLE_OP bonus rand (1..10)}
#endif
        [if]
            [variable]
                name=bonus
                equals=1
            [/variable]
            [then]
                {VARIABLE_OP type rand (1..10)}
                [switch]
                    variable=type
                    [case]
                        value=1
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=attack
                                increase_damage=80%
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(30,0,0)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=2
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=attack
                                increase_attacks=80%
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,0,30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=3
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=attack
                                set_type=arcane
                                [set_specials]
                                    mode=append
                                    {WEAPON_SPECIAL_DRAIN}
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(-30,-30,-30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=4
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=resistance
                                replace=false
                                [resistance]
                                    blade=-40
                                    impact=-40
                                    pierce=-40
                                [/resistance]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="O(50%)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=5
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=movement
                                increase=5
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,30,30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=6
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_REGENERATES_OTHER 32}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(30,30,30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=7
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_SKIRMISHER}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=movement
                                increase=2
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,20,40)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=8
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_REFLECT}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(40,20,0)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=9
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_TEMPTATION}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(50,20,10)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=10
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=resistance
                                replace=false
                                [resistance]
                                    fire=-40
                                    cold=-40
                                    arcane=-40
                                [/resistance]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="O(50%)"
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,20,40)"
                            [/effect]
                        [/object]
                    [/case]
                [/switch]
            [/then]
        [/if]
        {CLEAR_VARIABLE bonus,type}
    [/event]
#endif
#enddef

#define LOTI_DEMON_HACK
    [event]
        name=start
        [store_unit]
            [filter]
                race=demon-loti
                canrecruit=yes
                [or]
                    race=demon lord-loti
                    canrecruit=yes
                [/or]
                [or]
                    race=imp-loti
                    canrecruit=yes
                [/or]
            [/filter]
            variable=leader
            kill=yes
        [/store_unit]
        {FOREACH leader i}
            [unit]
                x=$leader[$i].x
                y=$leader[$i].y
                id=$leader[$i].id
                side=$leader[$i].side
                canrecruit=no
                type=$leader[$i].type
                random_traits=yes
                name=$leader[$i].name
                gender=$leader[$i].gender
                to_variable=leader_store
                [insert_tag]
                    name=modifications
                    variable=leader[$i].modifications
                [/insert_tag]
                [insert_tag]
                    name=variables
                    variable=leader[$i].variables
                [/insert_tag]
                [insert_tag]
                    name=status
                    variable=leader[$i].status
                [/insert_tag]
            [/unit]
            {VARIABLE leader_store.canrecruit yes}
            [unstore_unit]
                variable=leader_store
            [/unstore_unit]
            {CLEAR_VARIABLE leader_store}
        {NEXT i}
        {CLEAR_VARIABLE leader}
    [/event]
#enddef

#define LOTI_FORCE_RESPEC
    [event]
        name=turn refresh
        first_time_only=no
        [if]
            [variable]
                name=allied_sides
                contains=$side_number
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        side=$side_number
                        [filter_wml]
                            [variables]
                                may_need_respec=yes
                            [/variables]
                        [/filter_wml]
                    [/filter]
                    variable=improperly_advanced
                    kill=no
                [/store_unit]
                {FOREACH improperly_advanced ak}
                    [fire_event]
                        name=force respec
                        [primary_unit]
                            id=$improperly_advanced[$ak].id
                        [/primary_unit]
                    [/fire_event]
                {NEXT ak}
                {CLEAR_VARIABLE improperly_advanced}
            [/then]
        [/if]
    [/event]
    [event]
        name=force respec
        first_time_only=no
        {CLEAR_VARIABLE unit.variables.may_need_respec}
        {VARIABLE times_advanced 0}
        {FOREACH unit.modifications.advancement i}
            [if]
                [variable]
                    name=unit.modifications.advancement[$i].id
                    equals=backup_amla
                [/variable]
                [then]
                    {VARIABLE_OP times_advanced add 1}
                    {CLEAR_VARIABLE unit.modifications.advancement[$i]}
                    {VARIABLE_OP i sub 1}
                [/then]
            [/if]
        {NEXT i}
        [if]	#For the case if something went wrong
            [variable]
                name=times_advanced
                equals=0
            [/variable]
            [else]
                [while]
                    [variable]
                        name=times_advanced
                        greater_than=0
                    [/variable]
                    [do]
                        {VARIABLE experience_to_give $unit.experience}
                        {VARIABLE_OP experience_to_give add $unit.max_experience}
                        {CLEAR_VARIABLE unit.variables.may_need_respec}
                        [unit]
                            side=$unit.side
                            x=$unit.x
                            y=$unit.y
                            experience=$experience_to_give
                            max_experience=$unit.max_experience
                            canrecruit=$unit.canrecruit
                            variation=$unit.variation
                            type=Advancing$unit.type
                            id=$unit.id
                            hitpoints=$unit.hitpoints
                            gender=$unit.gender
                            name=$unit.name
                            facing=$unit.facing
                            extra_recruit=$unit.extra_recruit
                            underlying_id=$unit.underlying_id
                            unrenamable=$unit.unrenamable
                            animate=no
                            [insert_tag]
                                name=status
                                variable=unit.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=unit.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=unit.variables
                            [/insert_tag]
                            to_variable=advancing_store
                        [/unit]
                        [unstore_unit]
                            variable=advancing_store
                            find_vacant=no
                        [/unstore_unit]
                        [store_unit]
                            [filter]
                                id=$advancing_store.id
                            [/filter]
                            variable=advanced
                            kill=yes
                        [/store_unit]
                        [unit]
                            side=$unit.side
                            x=$unit.x
                            y=$unit.y
                            experience=$advanced.experience
                            canrecruit=$unit.canrecruit
                            variation=$unit.variation
                            type=$unit.type
                            id=$unit.id
                            moves=$unit.moves
                            hitpoints=$unit.hitpoints
                            gender=$unit.gender
                            name=$unit.name
                            facing=$unit.facing
                            extra_recruit=$unit.extra_recruit
                            underlying_id=$unit.underlying_id
                            unrenamable=$unit.unrenamable
                            animate=no
                            attacks_left=$unit.attacks_left
                            [insert_tag]
                                name=status
                                variable=unit.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=advanced.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=unit.variables
                            [/insert_tag]
                            to_variable=advanced2
                        [/unit]
                        {VARIABLE_OP times_advanced sub 1}
                    [/do]
                [/while]
                [unstore_unit]
                    variable=advanced2
                    find_vacant=no
                [/unstore_unit]
                [update_stats]
                    id=$advanced2.id
                [/update_stats]
            [/else]
        [/if]
        {CLEAR_VARIABLE experience_to_give,times_advanced,advancing_store}
    [/event]
#enddef

#define LOTI_BEELZEBUB_PROGRESS
    [event]
        name=victory
        [store_turns]
            variable=turns
        [/store_turns]
        [if]
            [variable]
                name=turns
                not_equals=-1
            [/variable]
            [then]
                [if]
                    # Initialise variable if necessary
                    [variable]
                        name=saved_turns
                        greater_than=0
                    [/variable]
                    [else]
                        {VARIABLE saved_turns 0}
                    [/else]
                [/if]
                {VARIABLE turns_multiplied "$($turns-$turn_number)"}
                {VARIABLE_OP turns_multiplied multiply 100}
                {VARIABLE_OP turns_multiplied divide $turns}
                {VARIABLE old_saved_turns $saved_turns}
                {VARIABLE_OP saved_turns add $turns_multiplied}
                [if]
                    [variable]
                        name=saved_turns
                        greater_than_equal_to=500
                    [/variable]
                    [and]
                        [variable]
                            name=old_saved_turns
                            less_than=500
                        [/variable]
                    [/and]
                    [then]
                        [message]
                            speaker=narrator
                            message=_"Your rapid progress has caused your enemies to panic. Horribly desperate to stop your progress, they looked into ancient archives of forbidden lore and found a solution. They cast a spell that exploited a small weakness in the barrier separating Inferno, reached in and summoned one of its most horrid entities, Beelzebub. They made a pact so that the hellspawn would chase you. Fortunately, Beelzebub is not very good at pursuing."
                            side_for=$side_number
                            image="wesnoth-icon.png"
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        {CLEAR_VARIABLE turns_multiplied,turns,old_saved_turns}
    [/event]
#enddef

#define LOTI_MAKE_BLACK_SOUL
    [event]
        name=make black soul
        first_time_only=no
        [set_variable]
            name=blackening_store.level
            multiply=3
        [/set_variable]
        [set_variable]
            name=blackening_store.variables.black_soul
            set=yes
        [/set_variable]
        [set_variable]
            name=blackening_store.level
            add=2
        [/set_variable]
        [set_variable]
            name=blackening_store.race
            value="black soul-loti"
        [/set_variable]
        [set_variable]
            name=blackening_store.alignment
            value=chaotic
        [/set_variable]
        [set_variable]
            name=blackening_store.status.unplagueable
            value=yes
        [/set_variable]
        [unstore_unit]
            variable=blackening_store
            find_vacant=yes
        [/unstore_unit]
        [object]
            [filter]
                id=$blackening_store.id
            [/filter]
            silent=yes
            duration=forever
            [effect]
                apply_to=image_mod
                replace="CS(-255,-255,-255)"
            [/effect]
            [effect]
                apply_to=max_experience
                increase=150%
            [/effect]
            [effect]
                apply_to=attack
                increase_damage=110%
                {QUANTITY increase_damage 40% 75% 110%}
                increase_attacks=50%
                [set_specials]
                    mode=append
                    {WEAPON_SPECIAL_LETHARGY}
                [/set_specials]
            [/effect]
            [effect]
                apply_to=hitpoints
                increase=100%
                increase_total=100%
            [/effect]
            [effect]
                apply_to=resistance
                replace=false
                [resistance]
                    fire=-30
                    cold=-30
                    arcane=50
                    blade=-30
                    pierce=-30
                    impact=-30
                [/resistance]
            [/effect]
        [/object]
    [/event]
#enddef

#define LOTI_MAKE_DOPPELGANGER
    [event]
        name=make doppelganger
        first_time_only=no
        [set_variables]
            name=doppel_stats
            [value]
                [effect]
                    apply_to=hitpoints
                    increase_total="$(0.5*$unit.max_hitpoints)"
                [/effect]
                [effect]
                    apply_to=new_ability
                    [insert_tag]
                        name=abilities
                        variable=unit.abilities
                    [/insert_tag]
                [/effect]
            [/value]
        [/set_variables]
        {FOREACH doppel_stats.effect[1].abilities.dummy i}
            [if]
                [variable]
                    name=doppel_stats.effect[1].abilities.dummy[$i].id
                    equals=soul eater
                [/variable]
                [then]
                    {CLEAR_VARIABLE doppel_stats.effect[1].abilities.dummy[$i]}
                [/then]
            [/if]
        {NEXT i}
        {FOREACH unit.attack i}
            [set_variables]
                name=doppel_stats.effect[$doppel_stats.effect.length]
                to_variable=unit.attack[$i]
                mode=replace
            [/set_variables]
            {VARIABLE "doppel_stats.effect[$($doppel_stats.effect.length-1)].apply_to" new_attack}
            {VARIABLE_OP "doppel_stats.effect[$($doppel_stats.effect.length-1)].damage" divide 2}
        {NEXT i}
        [if]
            [variable]
                name=unit.type
                contains=Lethalia
            [/variable]
            [then]
                {GENERIC_UNIT $unit.side Lethalia_doppelganger $unit.x $unit.y}
                [+unit]
                    [modifications]
                        [insert_tag]
                            name=advancement
                            variable=doppel_stats
                        [/insert_tag]
                    [/modifications]
                [/unit]
            [/then]
            [else]
                {GENERIC_UNIT $unit.side Efraim_doppelganger $unit.x $unit.y}
                [+unit]
                    [modifications]
                        [insert_tag]
                            name=advancement
                            variable=doppel_stats
                        [/insert_tag]
                    [/modifications]
                [/unit]
            [/else]
        [/if]
        {CLEAR_VARIABLE doppel_stats}
    [/event]
#enddef

#define LOTI_CLEAR_HEALED_STATUS
    [event]
        name=new turn,victory
        first_time_only=no
        [store_unit]
            [filter]
                [filter_wml]
                    [variables]
                        healed_this_turn=yes
                    [/variables]
                [/filter_wml]
            [/filter]
            variable=no_longer
        [/store_unit]
        {FOREACH no_longer i}
            {CLEAR_VARIABLE no_longer[$i].variables.healed_this_turn}
            [unstore_unit]
                variable=no_longer[$i]
                find_vacant=no
                advance=no
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE no_longer}
    [/event]
#enddef

#define LOTI_DELAYED_EXP
    [event]
        name=attack_end
        first_time_only=no
        [if]
            [variable]
                name=unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP unit.experience add $unit.variables.lua_delayed_exp}
                {CLEAR_VARIABLE unit.variables.lua_delayed_exp}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                    advance=no
                [/unstore_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=second_unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP second_unit.experience add $second_unit.variables.lua_delayed_exp}
                {CLEAR_VARIABLE second_unit.variables.lua_delayed_exp}
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                    advance=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]
#enddef

#define LOTI_EXTRA_ADVANCEMENT_PATHS
    [event]
        name=post stats update
        first_time_only=no
#ifdef MULTIPLAYER
        [if]
            [variable]
                name=updated.type
                equals="Necromancer"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "09 Ancient Lich,Arch Necromancer,Demilich"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Lich"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "09 Ancient Lich,Lich King,Demilich"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Master Bowman"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Champion Bowman"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Draug"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Deathlord"}
                {VARIABLE updated.max_experience 150}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Death Knight"
            [/variable]
            [or]
                [variable]
                    name=updated.type
                    equals="Death Knight LotI"
                [/variable]
            [/or]
            [then]
                {VARIABLE updated.advances_to "Deathlord,Lich King,Infernal Knight"}
                {VARIABLE updated.max_experience 150}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Iron Mauler"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Destroyer,Blackguard"}
                {VARIABLE updated.max_experience 192}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Royal Guard"
            [/variable]
            [or]
                [variable]
                    name=updated.type
                    equals="Royal Guard LotI"
                [/variable]
            [/or]
            [then]
                {VARIABLE updated.advances_to "Swordmaster"}
                {VARIABLE updated.max_experience 192}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Cavalier"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Chaos Rider"}
                {VARIABLE updated.max_experience 192}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Grand Marshal"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Dragon Rider,Duke"}
                {VARIABLE updated.max_experience 300}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Great Mage"
            [/variable]
            [or]
                [variable]
                    name=updated.type
                    equals="08 Great Mage"
                [/variable]
            [/or]
            [then]
                {VARIABLE updated.advances_to "Elder Mage LotI"}
                {VARIABLE updated.max_experience 300}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Ranger"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Forester"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Huntsman"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Predator"}
                {VARIABLE updated.max_experience 190}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Grand Knight"
            [/variable]
            [or]
                [variable]
                    name=updated.type
                    equals="Grand Knight LotI"
                [/variable]
            [/or]
            [then]
                {VARIABLE updated.advances_to "Dragon Rider"}
                {VARIABLE updated.max_experience 480}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Chocobone LotI"
            [/variable]
            [or]
                [variable]
                    name=updated.type
                    equals="Chocobone"
                [/variable]
            [/or]
            [then]
                {VARIABLE updated.advances_to "Grim Knight,Zombie Rider"}
                {VARIABLE updated.max_experience 140}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Orcish Slayer"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Orcish Nightblade loti"}
                {VARIABLE updated.max_experience 160}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Goblin Pillager"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Goblin Ravager"}
                {VARIABLE updated.max_experience 140}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Goblin Rouser"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Goblin Warbanner"}
                {VARIABLE updated.max_experience 58}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Goblin Impaler"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Sky Goblin"}
                {VARIABLE updated.max_experience 66}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Javelineer"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Pilum Master"}
                {VARIABLE updated.max_experience 140}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Deathblade"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Grim Knight,Phantom"}
                {VARIABLE updated.max_experience 72}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Lancer"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Lunatic Knight"}
                {VARIABLE updated.max_experience 130}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Silver Mage"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Duelist Wizard"}
                {VARIABLE updated.max_experience 150}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Highwayman"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Blackguard,Shadow Prince"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Paladin"
            [/variable]
            [or]
                [variable]
                    name=updated.type
                    equals="Paladin LotI"
                [/variable]
            [/or]
            [or]
                [variable]
                    name=updated.type
                    equals="Mage of Light"
                [/variable]
            [/or]
            [then]
                {VARIABLE updated.advances_to "Prophet,Celestial Messenger"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Troll Warrior"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Siege Troll"}
                {VARIABLE updated.max_experience 150}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Troll Rocklobber"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Troll Boulderlobber"}
                {VARIABLE updated.max_experience 120}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Orcish Warlord"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Orcish Warmonger"}
                {VARIABLE updated.max_experience 190}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Orcish Slurbow"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Orcish Strafer"}
                {VARIABLE updated.max_experience 170}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Direwolf Rider"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Werewolf Rider"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Nightgaunt"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Dark Shade"}
                {VARIABLE updated.max_experience 150}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Spectre"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Reaper"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Fugitive"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Shadow Prince"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Halberdier"
            [/variable]
            [or]
                [variable]
                    name=updated.type
                    equals="Halberdier LotI"
                [/variable]
            [/or]
            [then]
                {VARIABLE updated.advances_to "Scythemaster"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish Sylph"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Elvish Seer"}
                {VARIABLE updated.max_experience 300}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish Shyde"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Faerie Incarnation"}
                {VARIABLE updated.max_experience 150}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Master at Arms"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Shadowalker, Champion"}
                {VARIABLE updated.max_experience 190}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Assassin"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Exterminator"}
                {VARIABLE updated.max_experience 180}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Banebow"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Soul Shooter"}
                {VARIABLE updated.max_experience 168}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Skeleton"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Revenant,Chocobone,Deathblade"}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Revenant"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Death Knight,Draug,Zombie Rider"}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish Sharpshooter"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Elvish Gryphon Rider,Elvish Assassin"}
                {VARIABLE updated.max_experience 170}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish Outrider"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Elvish Gryphon Rider"}
                {VARIABLE updated.max_experience 170}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish Avenger"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Elvish Nightprowler"}
                {VARIABLE updated.max_experience 132}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish Champion"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Elvish Juggernaut"}
                {VARIABLE updated.max_experience 132}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish Marshal"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Elvish Warlord"}
                {VARIABLE updated.max_experience 132}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Elvish High Lord"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Elvish Overlord"}
                {VARIABLE updated.max_experience 132}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Dwarvish Berserker"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Dwarvish Battlerager"}
                {VARIABLE updated.max_experience 90}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Dwarvish Lord"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Dwarvish Hero"}
                {VARIABLE updated.max_experience 170}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Dwarvish Dragonguard"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Dwarvish Technocrat"}
                {VARIABLE updated.max_experience 170}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Dwarvish Sentinel"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Dwarvish Protector"}
                {VARIABLE updated.max_experience 140}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Mage"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Red Mage,White Mage,Sword Mage"}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Fencer"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Duelist,Sword Mage"}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Ghast"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Abomination"}
            [/then]
        [/if]
        [if]
            [variable]
                name=updated.type
                equals="Soulless"
            [/variable]
            [then]
                {VARIABLE updated.advances_to "Revenant,Bone Shooter,Monstrosity,Necrophage"}
            [/then]
        [/if]
#endif
    [/event]

#enddef
