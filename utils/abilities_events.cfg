#textdomain wesnoth-loti

#define ABSORB_EVENT VALUE
    [event]
        name=attacker hits
        first_time_only=no

        [filter_second]
            ability=absorb {VALUE}
        [/filter_second]
        [if]
            [variable]
                name=second_unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                [heal_unit]
                    animate=no
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    amount={VALUE}
                    restore_statuses=no
                [/heal_unit]
            [/then]
        [/if]
    [/event]
    [event]
        name=defender hits
        first_time_only=no

        [filter]
            ability=absorb {VALUE}
        [/filter]
        [if]
            [variable]
                name=unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                [heal_unit]
                    animate=no
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount={VALUE}
                    restore_statuses=no
                [/heal_unit]
            [/then]
        [/if]
    [/event]
#enddef

#define INCORPORATE_EFFECTS
    {VARIABLE damage $damage_inflicted}
    {VARIABLE_OP damage multiply 100}
    [get_unit_resistance]
        find_in=second_unit
        damage_type=$weapon.type
        to_variable=resistance
    [/get_unit_resistance]
    [if]
        [variable]
            name=resistance
            greater_than=0
        [/variable]
        [else]
            {VARIABLE resistance 100}
        [/else]
    [/if]
    {VARIABLE_OP damage divide $resistance}
    {CLEAR_VARIABLE resistance}
#enddef
#define INCORPORATE_EFFECTS_RETALIATION
    {VARIABLE damage $damage_inflicted}
    {VARIABLE_OP damage multiply 100}
    [get_unit_resistance]
        find_in=unit
        damage_type=$weapon.type
        to_variable=resistance
    [/get_unit_resistance]
    [if]
        [variable]
            name=resistance
            greater_than=0
        [/variable]
        [else]
            {VARIABLE resistance 100}
        [/else]
    [/if]
    {VARIABLE_OP damage divide $resistance}
    {CLEAR_VARIABLE resistance}
#enddef

#define ABILITIES_EVENTS
    [event]
        name=last breath
        [filter]
            ability=necromancy
            [not]
                race=undead
            [/not]
            [not]
                race=black soul-loti
            [/not]
        [/filter]
        [message]
            speaker=unit
            message= _ "Tharrr marr grath'elekort-esto!"
        [/message]
        {VARIABLE unit.hitpoints 40}
#ifver WESNOTH_VERSION >= 1.13.2
        {FOREACH unit.modifications.advancement i}
#else
        {FOREACH unit.modifications.advance i}
#endif
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=unit.modifications.advancement[$i].id
#else
                    name=unit.modifications.advance[$i].id
#endif
                    contains=legacy
                [/variable]
                [else]
#ifver WESNOTH_VERSION >= 1.13.2
                    {CLEAR_VARIABLE unit.modifications.advancement[$i]}
#else
                    {CLEAR_VARIABLE unit.modifications.advance[$i]}
#endif
                    {VARIABLE_OP i sub 1}
                [/else]
            [/if]
        {NEXT i}
        {FOREACH unit.modifications.object i}
            [if]
                [variable]
                    name=unit.modifications.object[$i].sort
                    equals=limited
                [/variable]
                [then]
                    {CLEAR_VARIABLE unit.modifications.object[$i]}
                    {VARIABLE_OP i sub 1}
                [/then]
            [/if]
        {NEXT i}
        {CLEAR_VARIABLE unit.variables.may_need_respec,unit.variables.achieved_mala}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        {ADVANCE_UNIT x,y=$x1,$y1 "Lich"}
        {UPDATE_STATS}
    [/event]

    [event]
        name=attacker misses
        first_time_only=no

        [filter_second]
            ability=mockery
        [/filter_second]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x2,$y2
            [/filter]
            amount=2
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=defender misses
        first_time_only=no

        [filter]
            ability=mockery
        [/filter]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=2
            restore_statuses=no
        [/heal_unit]
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                side=$side_number
                [filter_adjacent]
                    ability=freezing
                    is_enemy=yes
                [/filter_adjacent]
            [/filter]
            amount=2
            damage_type=cold
            slowed=yes
            fire_event=yes
            experience=no
            kill=no
            animate=no
        [/harm_unit]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                gender=male
                [filter_adjacent]
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                    ability=temptation
                    is_enemy=yes
                    gender=female
                [/filter_adjacent]
                [or]
                    gender=female
                    [filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                        ability=temptation
                        is_enemy=yes
                        gender=male
                    [/filter_adjacent]
                [/or]
                [not]
                    race=undead
                [/not]
                side=$side_number
            [/filter]
            kill=no
            variable=tempting_store_youll_want_to_be_there
        [/store_unit]
        {FOREACH tempting_store_youll_want_to_be_there i}
            {VARIABLE tempting_store_youll_want_to_be_there[$i].attacks_left 0}
            [unstore_unit]
                variable=tempting_store_youll_want_to_be_there[$i]
                find_vacant=no
#ifver WESNOTH_VERSION >= 1.13.2
                male_text=_"Infatuated"
                female_text=_"female^Infatuated"

#else
                text=_"Infatuated"
#endif
                {COLOR_HARM}
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE tempting_store_youll_want_to_be_there}
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                ability=cancer
                side=$side_number
            [/filter]
            variable=carcinogenous
        [/store_unit]
        {FOREACH carcinogenous i}
            [if]
                [variable]
                    name=carcinogenous[$i].status.not_living
                    equals=yes
                [/variable]
                [or]
                    [variable]
                        name=carcinogenous[$i].status.unpoisonable
                        equals=yes
                    [/variable]
                [/or]
                [else]
                    {VARIABLE carcinogenous[$i].status.poisoned yes}
                    [unstore_unit]
                        variable=carcinogenous[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/else]
            [/if]
        {NEXT i}
        {CLEAR_VARIABLE carcinogenous}
    [/event]
    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                side=$side_number
                ability=frostbite
            [/filter]
            amount=24
            damage_type=cold
            fire_event=no
            experience=no
            kill=no
            animate=yes
        [/harm_unit]
    [/event]
    [event]
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                ability=leech
                side=$side_number
            [/filter]
            variable=leechers
            kill=no
        [/store_unit]
        {FOREACH leechers i}
            [store_unit]
                [filter]
                    [filter_adjacent]
                        id=$leechers[$i].id
                    [/filter_adjacent]
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                [/filter]
                variable=leeched
                kill=no
            [/store_unit]
            {VARIABLE amount 0}
            {FOREACH leeched j}
                [harm_unit]
                    [filter]
                        id=$leeched[$j].id
                    [/filter]
                    amount=2
                    fire_event=yes
                    experience=no
                    kill=no
                    animate=no
                [/harm_unit]
                {VARIABLE_OP amount add 2}
            {NEXT j}
            {CLEAR_VARIABLE leeched}
            [heal_unit]
                [filter]
                    id=$leechers[$i].id
                [/filter]
                amount=$amount
                animate=yes
                restore_statuses=no
            [/heal_unit]
            {CLEAR_VARIABLE amount}
        {NEXT i}
        {CLEAR_VARIABLE leechers}
    [/event]
    [event]
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                ability=parasite
                side=$side_number
            [/filter]
            variable=leechers
            kill=no
        [/store_unit]
        {FOREACH leechers i}
            [store_unit]
                [filter]
                    [filter_adjacent]
                        id=$leechers[$i].id
                    [/filter_adjacent]
                    [filter_side]
                        [allied_with]
                            side=$side_number
                        [/allied_with]
                    [/filter_side]
                [/filter]
                variable=leeched
                kill=no
            [/store_unit]
            {VARIABLE amount 0}
            {FOREACH leeched j}
                [harm_unit]
                    [filter]
                        id=$leeched[$j].id
                    [/filter]
                    amount=4
                    fire_event=yes
                    experience=no
                    kill=no
                    animate=no
                [/harm_unit]
                {VARIABLE_OP amount add 4}
            {NEXT j}
            {CLEAR_VARIABLE leeched}
            [heal_unit]
                [filter]
                    id=$leechers[$i].id
                [/filter]
                amount=$amount
                animate=yes
                restore_statuses=no
            [/heal_unit]
            {CLEAR_VARIABLE amount}
        {NEXT i}
        {CLEAR_VARIABLE leechers}
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                [filter_adjacent]
                    ability=dark aura
                    side=$side_number
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
            [/filter]
            amount=2
            damage_type=arcane
            poisoned=yes
            fire_event=yes
            experience=no
            kill=no
            animate=no
        [/harm_unit]
    [/event]

    [event]			#For the Foul Potion
        name=die
        first_time_only=no

        [filter]
            [not]
                [filter_wml]
                    [status]
                        not_living="yes"
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]

        [filter_second]
            ability=unholy hunger
        [/filter_second]
        {CLEAR_VARIABLE second_unit.variables.starving}
        [unstore_unit]
            variable=second_unit
            {COLOR_HEAL}
            text= _ "+3 max HP"
            find_vacant=no
        [/unstore_unit]

        [object]
            silent=yes
            duration=forever
            sort=potion_like
            [filter]
                x,y=$x2,$y2
            [/filter]

            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=10
            [/effect]
        [/object]
    [/event]
    [event]		#For the Foul Potion
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                ability=unholy hunger
                [not]
                    [filter_adjacent]
                        ability=healing
                    [/filter_adjacent]
                [/not]
                [not]
                    [filter_location]
                        terrain=*^V*
                    [/filter_location]
                [/not]
		x=1-999
		y=1-999
            [/filter]
            variable=starving
            kill=no
        [/store_unit]
        {FOREACH starving i}
            [if]
                [variable]
                    name=starving[$i].variables.starving
                    greater_than_equal_to=1
                [/variable]
                [then]
                    {VARIABLE_OP starving[$i].variables.starving add 1}
                    [unstore_unit]
                        variable=starving[$i]
                        {COLOR_HARM}
                        text= _ "-$starving[$i].variables.starving max HP"
                        find_vacant=no
                    [/unstore_unit]
                    [object]
                        silent=yes
                        duration=forever
                        sort=potion_like
                        [filter]
                            x,y=$starving[$i].x,$starving[$i].y
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase_total=-$starving[$i].variables.starving
                            increase=-$starving[$i].variables.starving
                        [/effect]
                    [/object]
                [/then]
                [else]
                    {VARIABLE starving[$i].variables.starving 1}
                    [unstore_unit]
                        variable=starving[$i]
                        find_vacant=no
                    [/unstore_unit]
                [/else]
            [/if]
        {NEXT i}
    [/event]

    [event]
        name=attack end
        first_time_only=no

        [filter_attack]
            special=knockback
        [/filter_attack]
        [if]
            [variable]
                name=second_unit.hitpoints
                less_than_equal_to=1
            [/variable]
            [else]
                [store_unit]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    variable=knockbacked
                    kill=yes
                [/store_unit]
                {VARIABLE knock_x $x2}
                {VARIABLE knock_y $y2}
                {VARIABLE_OP knock_x sub $x1}
                {VARIABLE_OP knock_y sub $y1}
                {VARIABLE_OP knockbacked.x add $knock_x}
                {VARIABLE_OP knockbacked.y add $knock_y}
                [unstore_unit]
                    variable=knockbacked
                    find_vacant=yes
                    check_passability=yes
                [/unstore_unit]
                [if]
                    [have_unit]
                        id=$knockbacked.id
                    [/have_unit]
                    [else]
                        [unstore_unit]
                            variable=knockbacked
                            find_vacant=yes
                            x,y=$x2,$y2
                            advance=no
                        [/unstore_unit]
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=knockbacked.hitpoints
                        less_than_equal_to=1
                    [/variable]
                    [then]
                        [kill]
                            id=$knockbacked.id
                            animate=no
                            experience=yes
                            fire_event=yes
                            [filter_second]
                                x,y=$x1,$y1
                            [/filter_second]
                        [/kill]
                        [fire_event]
                            name=force respec
                            [primary_unit]
                                id=$unit.id
                            [/primary_unit]
                        [/fire_event]
                    [/then]
                [/if]
                {CLEAR_VARIABLE knock_x,knock_y,knockbacked}
            [/else]
        [/if]
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=storm
        [/filter_attack]
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {INCORPORATE_EFFECTS}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                # We do not hurt our own units.
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
                # The defender was already damaged.
                [not]
                    x,y=$x2,$y2
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/1.5)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
        [/harm_unit_loti]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                # We do not hurt our own units.
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
                # The defender was already damaged.
                [not]
                    x,y=$x2,$y2
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=8
            damage_type=impact
            fire_event=yes
        [/harm_unit_loti]
        # Harm units two hexes away from the attacker (half damage).
        [harm_unit_loti]
            [filter]
                [filter_location]
                    # Exclude the units that just received full damage.
                    [not]
                        x,y=$x1,$y1
                        radius=1
                    [/not]
                    # Include the remaining units within two hexes.
                    [and]
                        x,y=$x1,$y1
                        radius=2
                    [/and]
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                [/filter_location]
                # We do not hurt our own units.
                [not]
                    side=$unit.side
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=4
            damage_type=impact
            fire_event=yes
        [/harm_unit_loti]
        [harm_unit_loti]
            [filter]
                [filter_location]
                    # Exclude the units that just received full damage.
                    [not]
                        x,y=$x1,$y1
                        radius=1
                    [/not]
                    # Include the remaining units within two hexes.
                    [and]
                        x,y=$x1,$y1
                        radius=2
                    [/and]
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                [/filter_location]
                # We do not hurt our own units.
                [not]
                    side=$unit.side
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
        [/harm_unit_loti]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=soul thrash
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
                [if]
                    [variable]
                        name=unit.variables.wrath
                        equals=yes
                    [/variable]
                    [then]
                        {VARIABLE_OP unit.variables.wrath_intensity add $second_unit.level}
                    [/then]
                    [else]
                        {VARIABLE unit.variables.wrath yes}
                        {VARIABLE unit.variables.wrath_intensity $second_unit.level}
                    [/else]
                [/if]
                {FOREACH unit.attack i}
                    {FOREACH unit.attack[$i].specials.damage j}
                        [if]
                            [variable]
                                name=unit.attack[$i].specials.damage[$j].id
                                equals=latent_wrath
                            [/variable]
                            [then]
                                {VARIABLE unit.attack[$i].specials.damage[$j].add $unit.variables.wrath_intensity}
                            [/then]
                        [/if]
                    {NEXT j}
                {NEXT i}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [fire_event]
                    name=force respec
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=soul extraction
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
                [unit]
                    type=Ghost
                    name=$second_unit.name
                    side=$unit.side
                    x,y=$second_unit.x,$second_unit.y
                [/unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=soul extraction
        [/filter_second_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                [/harm_unit_loti]
                [unit]
                    type=Ghost
                    name=$unit.name
                    side=$second_unit.side
                    x,y=$unit.x,$unit.y
                [/unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=raijers saloon
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        {VARIABLE_OP did_kill add $second_unit.level}
        [if]
            [variable]
                name=did_kill
                less_than=5
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [and]
                [variable]
                    name=second_unit.hitpoints
                    greater_than=1
                [/variable]
            [/and]
            [then]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [allied_with]
                                side=$side_number
                            [/allied_with]
                        [/filter_side]
                        [or]
                            x,y=$x1,$y1
                        [/or]
                    [/filter]
                    variable=nearby
                    kill=no
                [/store_unit]
                {VARIABLE amount $second_unit.hitpoints}
                {VARIABLE_OP amount divide $nearby.length}
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
                {FOREACH nearby i}
                    [heal_unit]
                        [filter]
                            id=$nearby[$i].id
                        [/filter]
                        amount=$amount
                        animate=yes
                        restore_statuses=yes
                    [/heal_unit]
                {NEXT i}
                [fire_event]
                    name=force respec
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,amount,nearby}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=nosferatu gorge
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        {VARIABLE_OP did_kill add $second_unit.level}
        [if]
            [variable]
                name=did_kill
                less_than=5
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [and]
                [variable]
                    name=second_unit.hitpoints
                    greater_than=1
                [/variable]
            [/and]
            [then]
                {VARIABLE amount $second_unit.hitpoints}
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
                [heal_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=$amount
                    animate=yes
                    restore_statuses=yes
                [/heal_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,amount}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=soul annihilation
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x2,$y2
                        [/filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=nearby
                    kill=no
                [/store_unit]
                {VARIABLE damage_to_deal "$($second_unit.hitpoints/$nearby.length)"}
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
                [harm_unit_loti]
                    [filter]
                        [filter_adjacent]
                            x,y=$x2,$y2
                        [/filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$damage_to_deal
                    damage_type=arcane
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,damage_to_deal,nearby}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=soul annihilation
        [/filter_second_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$unit.id
                [/variable]
            [/not]
            [then]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [allied_with]
                                side=$side_number
                            [/allied_with]
                        [/filter_side]
                    [/filter]
                    variable=nearby
                    kill=no
                [/store_unit]
                {VARIABLE damage_to_deal "$($unit.hitpoints/$nearby.length)"}
                [harm_unit_loti]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
                [harm_unit_loti]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [allied_with]
                                side=$side_number
                            [/allied_with]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=$damage_to_deal
                    damage_type=arcane
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,damage_to_deal,nearby}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=disintegrate
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=disintegrate
        [/filter_second_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=devastating_blow
        [/filter_attack]
        {FOREACH weapon.specials.dummy i}
            [if]
                [variable]
                    name=weapon.specials.dummy[$i].id
                    equals=devastating_blow
                [/variable]
                [then]
                    {VARIABLE_OP random rand (1..100)}
                    [if]
                        [variable]
                            name=random
                            less_than=$weapon.specials.dummy[$i].devastating_blow
                        [/variable]
                        [then]
                            {VARIABLE_OP second_unit.hitpoints divide 1.2}
                            [unstore_unit]
                                variable=second_unit
                                find_vacant=no
                            [/unstore_unit]
                        [/then]
                    [/if]
                [/then]
            [/if]
        {NEXT i}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=shockwave
        [/filter_attack]

        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=harmer
            kill=no
        [/store_unit]
        [store_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            variable=primary_target
            kill=no
        [/store_unit]		#Stores the information about units to know their positions. Other targets are stored a bit lower, we need to damage them first.
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
                [not]
                    x,y=$x1,$y1
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=8
            damage_type=impact
            fire_event=yes
            animate=no
        [/harm_unit_loti]
        [store_unit]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
                [not]
                    x,y=$x2,$y2
                [/not]
            [/filter]
            variable=other_targets
            kill=yes		#We don't want to duplicate them.
        [/store_unit]
        {FOREACH other_targets i}
            {VARIABLE move_x $other_targets[$i].x}
            {VARIABLE move_y $other_targets[$i].y}
            {VARIABLE_OP move_x sub $primary_target.x}
            {VARIABLE_OP move_y sub $primary_target.y}
            {VARIABLE_OP other_targets[$i].x add $move_x}
            {VARIABLE_OP other_targets[$i].y add $move_y}		#Get the directions from the primary targets to others, and move them into them.
            [unstore_unit]
                variable=other_targets[$i]
                find_vacant=yes
                check_passability=yes			#We don't want them to be knocked into walls, do we?
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE harmer}
        {CLEAR_VARIABLE primary_target}
        {CLEAR_VARIABLE other_targets}
        {CLEAR_VARIABLE move_x}
        {CLEAR_VARIABLE move_y}
    [/event]

    [event]			#Thieves can steal.
        name=attacker hits
        first_time_only=no
        [filter]
            type=Thief
            [or]
                type=Rogue
            [/or]
            [or]
                type=Assassin
            [/or]
            [or]
                type=Exterminator
            [/or]
            [or]
                ability=steals
            [/or]
        [/filter]
        [filter_attack]
            range=melee
        [/filter_attack]
        {VARIABLE_OP gold_stolen rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3)}
        [gold]
            side=$unit.side
            amount=$gold_stolen
        [/gold]
        {CLEAR_VARIABLE gold_stolen}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            type=Thief
            [or]
                type=Rogue
            [/or]
            [or]
                type=Assassin
            [/or]
            [or]
                type=Shadowalker
            [/or]
            [or]
                ability=steals
            [/or]
        [/filter_second]
        [filter_second_attack]
            range=melee
        [/filter_second_attack]
        {VARIABLE_OP gold_stolen rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3)}
        [gold]
            side=$second_unit.side
            amount=$gold_stolen
        [/gold]
        {CLEAR_VARIABLE gold_stolen}
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            ability=tax collector
        [/filter_second]
        {VARIABLE_OP gold_taken rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-2,-2,-3)}
        [gold]
            side=$second_unit.side
            amount=$gold_taken
        [/gold]
        {CLEAR_VARIABLE gold_taken}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            ability=tax collector
        [/filter]
        {VARIABLE_OP gold_taken rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-2,-2,-3)}
        [gold]
            side=$unit.side
            amount=$gold_taken
        [/gold]
        {CLEAR_VARIABLE gold_taken}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
	[store_unit]
	        [filter]
	            ability=producer
	        [/filter]
		variable=earners
	[/store_unit]
	{VARIABLE gold_got 0}
	{FOREACH earners i}
	        {VARIABLE_OP gold_gained rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3)}
		{VARIABLE_OP gold_got add $gold_gained}
	{NEXT i}
        [gold]
            side=$second_unit.side
            amount=$gold_got
        [/gold]
        {CLEAR_VARIABLE gold_gained,gold_got,earners}
    [/event]

    [event]
        name=defender misses
        first_time_only=no
        [filter_attack]
            special=parry
        [/filter_attack]
        {VARIABLE has_leech 0}
        {VARIABLE has_drain 0}
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        {FOREACH weapon.specials.damage i}
            [if]
                [variable]
                    name=weapon.specials.damage[$i].id
                    equals=leeches
                [/variable]
                [then]
                    {VARIABLE has_leech 1}
                [/then]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.drain.id
                equals=drain
            [/variable]
            [then]
                {VARIABLE has_drain yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [animate_unit]
            flag=attack
            [filter]
                id=$unit.id
            [/filter]
            [filter_second]
                id=$second_unit.id
            [/filter_second]
            [primary_attack]
                range=melee
            [/primary_attack]
            hits=yes
        [/animate_unit]
        [set_variable]
            name=resistance
            to_variable="second_unit.resistance.$weapon.type"
        [/set_variable]
        {VARIABLE damage_to_deal $weapon.damage}
        [if]
            [variable]
                name=unit.status.slowed
                equals=yes
            [/variable]
            [then]
                {VARIABLE_OP damage_to_deal divide 2}
            [/then]
        [/if]
        {VARIABLE damage_dealt "$($($damage_to_deal*$resistance)/100)"}
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$damage_to_deal
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow,has_poison,damage_to_deal}

        {VARIABLE_OP damage_dealt divide 100}
        {VARIABLE healed 0}
        [if]
            [variable]
                name=has_drain
                equals=1
            [/variable]
            [not]
                [variable]
                    name=second_unit.status.non_living
                    equals=yes
                [/variable]
            [/not]
            [then]
                {VARIABLE_OP healed add "$($damage_dealt/2)"}
            [/then]
        [/if]
        [if]
            [variable]
                name=has_leech
                equals=1
            [/variable]
            [then]
                {VARIABLE_OP healed add "$($damage_dealt/10)"}
            [/then]
        [/if]
        {FOREACH weapon.specials.dummy i}
            [if]
                [variable]
                    name=weapon.specials.dummy[$i].id
                    equals=suck
                [/variable]
                [then]
                    [if]
                        [variable]
                            name=weapon.specials.dummy[$i].suck
                            less_than=$weapon.damage
                        [/variable]
                        [then]
                            {VARIABLE_OP healed add $weapon.specials.dummy[$i].suck}
                        [/then]
                        [else]
                            {VARIABLE_OP healed add $damage_dealt}
                        [/else]
                    [/if]
                [/then]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=healed
                greater_than=0
            [/variable]
            [then]
                [heal_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=$healed
                    animate=yes
                    restore_statuses=no
                [/heal_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE has_leech,has_drain,healed,damage_dealt}
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                [filter_location]
                    [filter]
                        ability=northfrost aura
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2
                [/filter_location]
                side=$side_number
            [/filter]
            amount=4
            damage_type=cold
            slowed=yes
            fire_event=yes
            experience=no
            kill=no
            animate=no
        [/harm_unit]
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                [filter_adjacent]
                    ability=flaming radiance
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                [/filter_adjacent]
                side=$side_number
            [/filter]
            variable=on_fire
            kill=no
        [/store_unit]
        {FOREACH on_fire i}
            [if]
                [variable]
                    name=on_fire[$i].variables.flaming_irradiated
                    equals=yes
                [/variable]
                [then]
                    {VARIABLE_OP on_fire[$i].variables.flaming_irradiation add 8}
                [/then]
                [else]
                    {VARIABLE on_fire[$i].variables.flaming_irradiation 8}
                    {VARIABLE on_fire[$i].variables.flaming_irradiated yes}
                [/else]
            [/if]
            [unstore_unit]
                variable=on_fire[$i]
                find_vacant=no
            [/unstore_unit]
            [harm_unit]
                [filter]
                    id=$on_fire[$i].id
                [/filter]
                amount=$on_fire[$i].variables.flaming_irradiation
                damage_type=fire
                fire_event=yes
                experience=no
                kill=no
                animate=yes
            [/harm_unit]
        {NEXT i}
        {CLEAR_VARIABLE on_fire}
        [store_unit]
            [filter]
                [not]
                    [filter_adjacent]
                        ability=flaming radiance
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter_adjacent]
                [/not]
                [filter_wml]
                    [variables]
                        flaming_irradiated=yes
                    [/variables]
                [/filter_wml]
                side=$side_number
            [/filter]
            variable=not_on_fire
            kill=no
        [/store_unit]
        {FOREACH not_on_fire i}
            {CLEAR_VARIABLE not_on_fire[$i].variables.flaming_irradiated}
            {CLEAR_VARIABLE not_on_fire[$i].variables.flaming_irradiation}
            [unstore_unit]
                variable=not_on_fire[$i]
                find_vacant=no
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE not_on_fire}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            ability=autocast
        [/filter]
        [filter_attack]
            range=melee
            #		[or]
            #			type=pierce
            #		[/or]
            #		[or]
            #			type=blade
            #		[/or]
            #		[or]
            #			type=impact
            #		[/or]
            #		[not]
            #			name=thorns
            #		[/not]
            #		[not]
            #			name=vine whip
            #		[/not]
            #		[not]
            #			name=vine
            #		[/not]
            #		[not]
            #			name=ensnare
            #		[/not]
            #		[not]
            #			name=entangle
            #		[/not]
            #		[not]
            #			name=gossamer
            #		[/not]
        [/filter_attack]
        {FOREACH unit.abilities.dummy i}
            [if]
                [variable]
                    name=unit.abilities.dummy[$i].id
                    equals=autocast
                [/variable]
                [then]
                    {VARIABLE list $unit.abilities.dummy[$i].cast}
                [/then]
            [/if]
        {NEXT i}
        {FOREACH unit.attack i}
            [if]
                [variable]
                    name=list
                    contains=$unit.attack[$i].name
                [/variable]
                [then]
                    [set_variables]
                        name="fitting_spells"
                        to_variable=unit.attack[$i]
                        mode=append
                    [/set_variables]
                [/then]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=fitting_spells.length
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP picked rand "1..$fitting_spells.length"}
                {VARIABLE_OP picked sub 1}
                [animate_unit]
                    flag=attack
                    [filter]
                        find_in=unit
                    [/filter]
                    [filter_second]
                        find_in=second_unit
                    [/filter_second]
                    [primary_attack]
                        name=$fitting_spells[$picked].name
                    [/primary_attack]
                    hits=yes
                [/animate_unit]
                [harm_unit_loti]
                    [filter]
                        find_in=second_unit
                    [/filter]
                    [filter_second]
                        find_in=unit
                    [/filter_second]
                    amount=$fitting_spells[$picked].damage
                    damage_type=$fitting_spells[$picked].type
                    fire_event=yes
                [/harm_unit_loti]
                [fire_event]
                    name=attacker hits
                    [filter]
                        find_in=unit
                    [/filter]
                    [filter_second]
                        find_in=second_unit
                    [/filter_second]
                    [insert_tag]
                        name=filter_attack
                        variable=$fitting_spells[$picked]
                    [/insert_tag]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE list,fitting_spells,picked}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=from the ashes
            [not]
                [filter_wml]
                    [variables]
                        from_the_ashes_used=yes
                    [/variables]
                [/filter_wml]
            [/not]
        [/filter_second]
        [fire_event]
            name=from the ashes
            [primary_unit]
                id=$second_unit.id
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=from the ashes
            [not]
                [filter_wml]
                    [variables]
                        from_the_ashes_used=yes
                    [/variables]
                [/filter_wml]
            [/not]
        [/filter]
        [fire_event]
            name=from the ashes
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=from the ashes
        first_time_only=no
        [if]
            [variable]
                name=unit.hitpoints
                less_than=20
            [/variable]
            [then]
                {VARIABLE unit.variables.from_the_ashes_used yes}
                {VARIABLE unit.variables.from_the_ashes_cooldown 10}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [heal_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    amount=40
                    animate=yes
                    restore_statuses=yes
                [/heal_unit]
                [harm_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=40
                    damage_type=fire
                    fire_event=yes
                    experience=no
                    kill=no
                [/harm_unit]
            [/then]
        [/if]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                ability=from the ashes
                [filter_wml]
                    [variables]
                        from_the_ashes_used=yes
                    [/variables]
                [/filter_wml]
            [/filter]
            variable=ash_cooldown
        [/store_unit]
        {FOREACH ash_cooldown h}
            [if]
                [variable]
                    name=ash_cooldown[$h].variables.from_the_ashes_cooldown
                    greater_than=1
                [/variable]
                [then]
                    {VARIABLE_OP ash_cooldown[$h].variables.from_the_ashes_cooldown sub 1}
                [/then]
                [else]
                    {CLEAR_VARIABLE ash_cooldown[$h].variables.from_the_ashes_cooldown}
                    {CLEAR_VARIABLE ash_cooldown[$h].variables.from_the_ashes_used}
                [/else]
            [/if]
            [unstore_unit]
                variable=ash_cooldown[$h]
                find_vacant=no
            [/unstore_unit]
        {NEXT h}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=cleave
            [not]
                special=whirlwind
            [/not]
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {VARIABLE has_lethargy no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        {FOREACH weapon.specials.dummy i}
            [if]
                [variable]
                    name=weapon.specials.dummy[$i].id
                    equals=lethargy
                [/variable]
                [then]
                    {VARIABLE has_lethargy yes}
                [/then]
            [/if]
        {NEXT i}
        [harm_unit_loti]
            [filter]
                [filter_location]
                    x,y=$x2,$y2
                    radius=1
                [/filter_location]
                [and]
                    [filter_adjacent]
                        x,y=$x1,$y1
                    [/filter_adjacent]
                [/and]
                [not]
                    x,y=$x2,$y2
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
        {CLEAR_VARIABLE damage}

        [if]
            [variable]
                name=has_lethargy
                equals=yes
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        [filter_location]
                            x,y=$x2,$y2
                            radius=1
                        [/filter_location]
                        [and]
                            [filter_adjacent]
                                x,y=$x1,$y1
                            [/filter_adjacent]
                        [/and]
                        [not]
                            x,y=$x2,$y2
                        [/not]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=targets
                    kill=no
                [/store_unit]
                {FOREACH targets i}
                    [fire_event]
                        name=lethargy
                        [primary_unit]
                            find_in=targets[$i]
                        [/primary_unit]
                    [/fire_event]
                {NEXT i}
                {CLEAR_VARIABLE targets}
            [/then]
        [/if]
        {CLEAR_VARIABLE has_lethargy}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=spell_suck
            [or]
                type=pierce
                [or]
                    type=impact
                [/or]
                [or]
                    type=blade
                [/or]
                [and]
                    special=suck
                [/and]
            [/or]
        [/filter_attack]
        {FOREACH weapon.specials.dummy i}
            [if]
                [variable]
                    name=weapon.specials.dummy[$i].id
                    equals=suck
                [/variable]
                [or]
                    [variable]
                        name=weapon.specials.dummy[$i].id
                        equals=spell_suck
                    [/variable]
                [/or]
                [then]
                    [if]
                        [variable]
                            name=weapon.specials.dummy[$i].suck
                            less_than=$damage_inflicted
                        [/variable]
                        [then]
                            [heal_unit]
                                [filter]
                                    x,y=$x1,$y1
                                [/filter]
                                amount=$weapon.specials.dummy[$i].suck
                                animate=yes
                                restore_statuses=no
                            [/heal_unit]
                        [/then]
                        [else]
                            [heal_unit]
                                [filter]
                                    x,y=$x1,$y1
                                [/filter]
                                amount=$damage_inflicted
                                animate=yes
                                restore_statuses=no
                            [/heal_unit]
                        [/else]
                    [/if]
                [/then]
            [/if]
        {NEXT i}
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special=spell_suck
            [or]
                type=pierce
                [or]
                    type=impact
                [/or]
                [or]
                    type=blade
                [/or]
                [and]
                    special=suck
                [/and]
            [/or]
        [/filter_second_attack]
        {FOREACH second_weapon.specials.dummy i}
            [if]
                [variable]
                    name=second_weapon.specials.dummy[$i].id
                    equals=suck
                [/variable]
                [or]
                    [variable]
                        name=second_weapon.specials.dummy[$i].id
                        equals=spell_suck
                    [/variable]
                [/or]
                [then]
                    [if]
                        [variable]
                            name=second_weapon.specials.dummy[$i].suck
                            less_than=$damage_inflicted
                        [/variable]
                        [then]
                            [heal_unit]
                                [filter]
                                    x,y=$x2,$y2
                                [/filter]
                                amount=$second_weapon.specials.dummy[$i].suck
                                animate=yes
                                restore_statuses=no
                            [/heal_unit]
                        [/then]
                        [else]
                            [heal_unit]
                                [filter]
                                    x,y=$x2,$y2
                                [/filter]
                                amount=$damage_inflicted
                                animate=yes
                                restore_statuses=no
                            [/heal_unit]
                        [/else]
                    [/if]
                [/then]
            [/if]
        {NEXT i}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special=pierce
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]

        [store_locations]
            [filter_adjacent_location]
                x,y=$x2,$y2
                adjacent=-$unit.facing
            [/filter_adjacent_location]

            variable=pierce_target_hex
        [/store_locations]
        [harm_unit_loti]
            [filter]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount="$($damage/2)"
            damage_type=pierce
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
        [/harm_unit_loti]

        {CLEAR_VARIABLE pierce_target_hex,has_slow,has_poison,damage}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special=cone
        [/filter_attack]
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {INCORPORATE_EFFECTS}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]

        [store_locations]
            [filter_adjacent_location]
                x,y=$x2,$y2
                adjacent=-$unit.facing
            [/filter_adjacent_location]

            variable=pierce_target_hex
        [/store_locations]

        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_location]
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                        radius=1
                    [/filter_location]
                [/and]
                [not]
                    x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/4)
            damage_type=$weapon.type
            fire_event=yes
            poisoned=$has_poison
            animate=no
        [/harm_unit_loti]

        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_adjacent]
                        x,y=$x1,$y1
                    [/filter_adjacent]
                [/and]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            poisoned=$has_poison
            fire_event=yes
        [/harm_unit_loti]

        [harm_unit_loti]
            [filter]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
        [/harm_unit_loti]

        {CLEAR_VARIABLE pierce_direction,pierce_target_hex,has_poison,damage}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special=hose
        [/filter_attack]
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {INCORPORATE_EFFECTS}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]

        #hit cleave targets
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_adjacent]
                        x,y=$x1,$y1
                    [/filter_adjacent]
                [/and]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage*0.75)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
        [/harm_unit_loti]

        [store_locations]
            [filter_adjacent_location]
                x,y=$x2,$y2
                adjacent=-$unit.facing
            [/filter_adjacent_location]
            variable=pierce_target_hex
        [/store_locations]

        #hit pierce target
        [harm_unit_loti]
            [filter]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage*0.75)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
        [/harm_unit_loti]

        #hit 2 nearby locations next to pierce target
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_location]
                        radius=1
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                    [/filter_location]
                [/and]
                [not]
                    x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
        [/harm_unit_loti]
        [store_locations]
            [filter_adjacent_location]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                adjacent=-$unit.facing
            [/filter_adjacent_location]
            variable=second_pierce_target_hex
        [/store_locations]

        #hit second pierce target
        [harm_unit_loti]
            [filter]
                x,y=$second_pierce_target_hex.x,$second_pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
        [/harm_unit_loti]

        #hit 2 locations touching pierce target and second pierce target
        [harm_unit_loti]
            [filter]
                [filter_location]
                    radius=1
                    x,y=$second_pierce_target_hex.x,$second_pierce_target_hex.y
                [/filter_location]
                [and]
                    [filter_location]
                        radius=1
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                    [/filter_location]
                [/and]
                [not]
                    x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [/not]
                [not]
                    x,y=$second_pierce_target_hex.x,$second_pierce_target_hex.y
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
                [filter_second]
                    find_in=unit
                [/filter_second]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/3)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
        [/harm_unit_loti]

        {CLEAR_VARIABLE pierce_direction,pierce_target_hex,has_slow,has_poison,damage,second_pierce_target_hex}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=infect
        [/filter_attack]
        [filter_second]
            [not]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/not]
            [not]
                [filter_location]
                    terrain=*^V*
                [/filter_location]
            [/not]
        [/filter_second]
        [modify_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$unit.side
                infected_type=Walking Corpse
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special=infect
        [/filter_second_attack]
        [filter]
            [not]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/not]
            [not]
                [filter_location]
                    terrain=*^V*
                [/filter_location]
            [/not]
        [/filter]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$second_unit.side
                infected_type=Walking Corpse
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=greater infect
        [/filter_attack]
        [filter_second]
            [not]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter_second]
        [modify_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$unit.side
                infected_type=Soulless
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special=greater infect
        [/filter_second_attack]
        [filter]
            [not]
                [filter_wml]
                    [status]
                        not_living=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$second_unit.side
                infected_type=Soulless
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        infected=yes
                    [/status]
                [/filter_wml]
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_wml]
                        hitpoints=1
                    [/filter_wml]
                [/and]
            [/filter]
            variable=zombie_store
            kill=yes
        [/store_unit]
        {FOREACH zombie_store i}
            [unit]
                side=$zombie_store[$i].variables.infected_by_side
                x=$zombie_store[$i].x
                y=$zombie_store[$i].y
                variation=$zombie_store[$i].undead_variation
                type=$zombie_store[$i].variables.infected_type
                moves=0
                facing=$zombie_store[$i].facing
                attacks_left=0
                animate=no
            [/unit]
            [fire_event]
                name=last_breath
                [primary_unit]
                    x,y=$zombie_store[$i].x,$zombie_store[$i].y
                [/primary_unit]
            [/fire_event]
            [fire_event]
                name=die
                [primary_unit]
                    x,y=$zombie_store[$i].x,$zombie_store[$i].y
                [/primary_unit]
            [/fire_event]
        {NEXT i}
        {CLEAR_VARIABLE zombie_store}

        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        infected=yes
                    [/status]
                [/filter_wml]
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_adjacent]
                        ability=healing
                    [/filter_adjacent]
                [/and]
                [or]
                    [filter_wml]
                        [status]
                            infected=yes
                        [/status]
                    [/filter_wml]
                    [and]
                        [filter_side]
                            side=$side_number
                        [/filter_side]
                    [/and]
                    [and]
                        [filter_location]
                            terrain=*^V*
                        [/filter_location]
                    [/and]
                [/or]
            [/filter]
            variable=unzombie_store
            kill=yes
        [/store_unit]
        {FOREACH unzombie_store i}
            {CLEAR_VARIABLE unzombie_store[$i].status.infected}
            {CLEAR_VARIABLE unzombie_store[$i].variables.infected_by_side}
            {CLEAR_VARIABLE unzombie_store[$i].variables.infected_type}
            [unstore_unit]
                variable=unzombie_store[$i]
                find_vacant=no
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE unzombie_store}
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter]
            [filter_wml]
                [status]
                    infected=yes
                [/status]
            [/filter_wml]
        [/filter]
	[fire_event]
		name=last breath
		[filter]
			find_in=unit
		[/filter]
	[/fire_event]
	[fire_event]
		name=die
		[filter]
			find_in=unit
		[/filter]
	[/fire_event]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=zombie_store
            kill=yes
        [/store_unit]
        [unit]
            side=$zombie_store.variables.infected_by_side
            x=$zombie_store.x
            y=$zombie_store.y
            variation=$zombie_store.undead_variation
            type=$zombie_store.variables.infected_type
            moves=0
            facing=$zombie_store.facing
            attacks_left=0
            animate=no
        [/unit]
        {CLEAR_VARIABLE zombie_store}
    [/event]
    [event]
        name=victory
        first_time_only=no
        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        infected=yes
                    [/status]
                [/filter_wml]
            [/filter]
            variable=unzombie_store
            kill=yes
        [/store_unit]
        {FOREACH unzombie_store i}
            {CLEAR_VARIABLE unzombie_store[$i].status.infected}
            {CLEAR_VARIABLE unzombie_store[$i].variables.infected_by_side}
            {CLEAR_VARIABLE unzombie_store[$i].variables.infected_type}
            [unstore_unit]
                variable=unzombie_store[$i]
                find_vacant=no
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE unzombie_store}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=incinerate
        [/filter_attack]
        {VARIABLE second_unit.status.incinerated yes}
        {VARIABLE second_unit.variables.incinerator $unit.id}
        [unstore_unit]
            variable=second_unit
            find_vacant=no
        [/unstore_unit]
        [object]
            silent=yes
            sort=potion-like
            [filter]
                find_in=second_unit
            [/filter]
            [effect]
                apply_to=image_mod
                replace="CS(100,50,0)"
            [/effect]
        [/object]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special=incinerate
        [/filter_second_attack]
        {VARIABLE unit.status.incinerated yes}
        {VARIABLE unit.variables.incinerator $second_unit.id}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]

        [object]
            silent=yes
            sort=potion-like
            [filter]
                find_in=unit
            [/filter]
            [effect]
                apply_to=image_mod
                replace="CS(100,50,0)"
            [/effect]
        [/object]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no

        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        incinerated=yes
                    [/status]
                [/filter_wml]
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_adjacent]
                        ability=healing
                    [/filter_adjacent]
                [/and]
                [or]
                    [filter_wml]
                        [status]
                            incinerated=yes
                        [/status]
                    [/filter_wml]
                    [and]
                        [filter_side]
                            side=$side_number
                        [/filter_side]
                    [/and]
                    [and]
                        [filter_location]
                            terrain=*^V*
                        [/filter_location]
                    [/and]
                [/or]
            [/filter]
            variable=unburn_store
            kill=yes
        [/store_unit]
        {FOREACH unburn_store i}
            {CLEAR_VARIABLE unburn_store[$i].status.incinerated}
            {CLEAR_VARIABLE unburn_store[$i].variables.incinerator}
            [unstore_unit]
                variable=unburn_store[$i]
                find_vacant=no
            [/unstore_unit]
            [object]
                silent=yes
                sort=potion-like
                [filter]
                    find_in=unburn_store[$i]
                [/filter]
                [effect]
                    apply_to=image_mod
                    replace="CS(0,0,0)"
                [/effect]
            [/object]
        {NEXT i}
        {CLEAR_VARIABLE unburn_store}

        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        incinerated=yes
                    [/status]
                [/filter_wml]
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
            [/filter]
            variable=burn_store
            kill=no
        [/store_unit]
        {FOREACH burn_store i}
            [harm_unit]
                [filter]
                    id=$burn_store[$i].id
                [/filter]
                amount=16
                damage_type=fire
                fire_event=yes
                kill=no
                animate=no
            [/harm_unit]
        {NEXT i}
        {CLEAR_VARIABLE burn_store}
        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        incinerated=yes
                    [/status]
                [/filter_wml]
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_wml]
                        hitpoints=1
                    [/filter_wml]
                [/and]
            [/filter]
            variable=burn_store
            kill=no
        [/store_unit]
        {FOREACH burn_store ti}
            [kill]
                id=$burn_store[$ti].id
                animate=yes
                fire_event=yes
                experience=yes
                [filter_second]
                    id=$burn_store[$ti].variables.incinerator
                [/filter_second]
            [/kill]
            [fire_event]
                name=force respec
                [primary_unit]
                    id=$burn_store[$ti].variables.incinerator
                [/primary_unit]
            [/fire_event]
        {NEXT ti}
        {CLEAR_VARIABLE burn_store}
    [/event]
    [event]
        name=victory
        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        incinerated=yes
                    [/status]
                [/filter_wml]
            [/filter]
            variable=unburn_store
            kill=yes
        [/store_unit]
        {FOREACH unburn_store i}
            {CLEAR_VARIABLE unburn_store[$i].status.incinerated}
            {CLEAR_VARIABLE unburn_store[$i].variables.incinerator}
            [unstore_unit]
                variable=unburn_store[$i]
                find_vacant=no
            [/unstore_unit]
            [object]
                silent=yes
                sort=potion-like
                [filter]
                    find_in=unburn_store[$i]
                [/filter]
                [effect]
                    apply_to=image_mod
                    replace="CS(0,0,0)"
                [/effect]
            [/object]
        {NEXT i}
        {CLEAR_VARIABLE unburn_store}
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            [not]
                [filter_wml]
                    [status]
                        not_living="yes"
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]

        [filter_second]
            ability=feeding_easy
        [/filter_second]

        [unstore_unit]
            variable=second_unit
            {COLOR_HEAL}
            text= _ "+1 max HP"
            find_vacant=no
        [/unstore_unit]

        [object]
            silent=yes
            duration=forever

            [filter]
                x,y=$x2,$y2
            [/filter]

            [effect]
                apply_to=hitpoints
                increase_total=1
                increase=1
            [/effect]
        [/object]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=extra damage 5 impact
        [/filter_attack]
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=5
            damage_type=impact
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=extra damage 5 impact
        [/filter_second_attack]
        [harm_unit_loti]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=5
            damage_type=impact
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=mayhem
        [/filter_attack]
        [object]
            silent=yes
            duration=forever
            sort=potion_like
            [filter]
                x,y=$x2,$y2
            [/filter]
            [effect]
                apply_to=attack
                increase_damage=-1
            [/effect]
        [/object]
        [floating_text]
            x,y=$x2,$y2
            text="<span color='red'>" + _ "-1 damage" + "</span>"
        [/floating_text]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=trickery
        [/filter_attack]
        [object]
            silent=yes
            duration=forever
            sort=potion_like
            [filter]
                x,y=$x2,$y2
            [/filter]
            [effect]
                apply_to=defense
                replace=false
                [defense]
                    frozen=5
                    castle=5
                    sand=5
                    village=5
                    flat=5
                    hills=5
                    mountains=5
                    swamp_water=5
                    cave=5
                    shallow_water=5
                    reef=5
                    forest=5
                    fungus=5
                    unwalkable=5
                [/defense]
            [/effect]
        [/object]
        [floating_text]
            x,y=$x2,$y2
            text="<span color='red'>" + _ "-5% defence" + "</span>"
        [/floating_text]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=doom
        [/filter_attack]
        [object]
            silent=yes
            duration=forever
            sort=potion_like
            [filter]
                x,y=$x2,$y2
            [/filter]
            [effect]
                apply_to=resistance
                replace=false
                [resistance]
                    fire=5
                    cold=5
                    arcane=5
                    impact=5
                    blade=5
                    pierce=5
                [/resistance]
            [/effect]
        [/object]
        [floating_text]
            x,y=$x2,$y2
            text="<span color='red'>" + _ "-5% all resistances" + "</span>"
        [/floating_text]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=whirlwind
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE has_leech 0}
        {VARIABLE has_drain 0}
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        {FOREACH weapon.specials.damage i}
            [if]
                [variable]
                    name=weapon.specials.damage[$i].id
                    equals=leeches
                [/variable]
                [then]
                    {VARIABLE has_leech yes}
                [/then]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=weapon.specials.drains.id
                equals=drains
            [/variable]
            [then]
                {VARIABLE has_drain yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        #{DEBUG "Whirlwind Hit: dmg $damage  leech $has_leech  poison $has_poison  drain $has_drain  slow $has_slow"}
        [if]
            [variable]
                name=has_leech
                not_equals=0
            [/variable]
            [or]
                [variable]
                    name=has_drain
                    not_equals=0
                [/variable]
            [/or]
            [then]
                [store_unit]    # We need to know how many units were hit, and what were their resistances
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [not]
                            x,y=$x2,$y2
                        [/not]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=units
                [/store_unit]
                {VARIABLE damage_to_leech 0}
                {VARIABLE damage_to_drain 0}
                {FOREACH units i}
                    [get_unit_resistance]
                        find_in=units[$i]
                        damage_type=$weapon.type
                        to_variable=secondary_resistance
                    [/get_unit_resistance]
                    [if]
                        [variable]
                            name=secondary_resistance
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE secondary_resistance 100}
                        [/then]
                    [/if]
                    {VARIABLE secondary_damage $damage}
                    {VARIABLE_OP secondary_damage multiply $secondary_resistance}
                    [if]
                        [variable]
                            name=secondary_damage
                            greater_than=$($units[$i].hitpoints*100)
                        [/variable]
                        [then]
                            {VARIABLE true_damage $units[$i].hitpoints}
                            {VARIABLE_OP true_damage multiply 100}
                        [/then]
                        [else]
                            {VARIABLE true_damage $secondary_damage}
                        [/else]
                    [/if]
                    # Note: Damage that is too small to leech can be combined from multiple targets into a real hitpoint.
                    # Example: 4 damage to 3 targets. Each hit alone produces 0 leech gain, but all 3 together get 1 hitpoint.
                    [if]
                        [variable]
                            name=has_leech
                            not_equals=0
                        [/variable]
                        [then]
                            {VARIABLE_OP damage_to_leech add $true_damage}
                        [/then]
                    [/if]
                    # Drain
                    [if]
                        [variable]
                            name=units[$i].status.not_living
                            not_equals=yes
                        [/variable]
                        [and]
                            [variable]
                                name=has_drain
                                not_equals=0
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE_OP damage_to_drain add $true_damage}
                        [/then]
                    [/if]
                    #{DEBUG "Whirl loop unit at $units[$i].x,$units[$i].y  Resist $secondary_resistance  secD $secondary_damage  trueD $true_damage  damage_to_leech $damage_to_leech  damage_to_drain $damage_to_drain"}
                    {CLEAR_VARIABLE secondary_resistance,secondary_damage,true_damage}
                {NEXT i}
                [if]
                    [variable]
                        name=has_leech
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_leech}
                        # Divide by 100 to rescale, then 10% leech factor
                        {VARIABLE_OP healed_amount divide 1000}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "LeechAddition $damage_to_leech  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=has_drain
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_drain}
                        # Divide by 100 to rescale, then 50% drain factor
                        {VARIABLE_OP healed_amount divide 200}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "DrainAddition $damage_to_drain  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                {CLEAR_VARIABLE units}
                {CLEAR_VARIABLE damage_to_leech,damage_to_drain,healed_amount}
            [/then]
        [/if]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$damage
            damage_type=$weapon.type
            fire_event=yes
            poisoned=$has_poison
            slowed=$has_slow
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
        {CLEAR_VARIABLE has_leech}
        {CLEAR_VARIABLE has_drain,damage}
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=chaos
        [/filter_second_attack]
        {INCORPORATE_EFFECTS_RETALIATION}
        {VARIABLE has_leech 0}
        {VARIABLE has_drain 0}
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        {FOREACH second_weapon.specials.damage i}
            [if]
                [variable]
                    name=second_weapon.specials.damage[$i].id
                    equals=leeches
                [/variable]
                [then]
                    {VARIABLE has_leech yes}
                [/then]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=second_weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=second_weapon.specials.drains.id
                equals=drains
            [/variable]
            [then]
                {VARIABLE has_drain yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=second_weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        #{DEBUG "Chaos Hit: dmg $damage  leech $has_leech  poison $has_poison  drain $has_drain  slow $has_slow"}
        [if]
            [variable]
                name=has_leech
                not_equals=0
            [/variable]
            [or]
                [variable]
                    name=has_drain
                    not_equals=0
                [/variable]
            [/or]
            [then]
                [store_unit]        # We need to know how many units were leeched, and what were their resistances
                    [filter]
                        [filter_adjacent]
                            x,y=$x2,$y2
                        [/filter_adjacent]
                        [not]
                            x,y=$x1,$y1
                        [/not]
                        [filter_side]
                            [enemy_of]
                                side=$second_unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=units
                [/store_unit]
                {VARIABLE damage_to_leech 0}
                {VARIABLE damage_to_drain 0}
                {FOREACH units i}
                    [get_unit_resistance]
                        find_in=units[$i]
                        damage_type=$weapon.type
                        to_variable=secondary_resistance
                    [/get_unit_resistance]
                    [if]
                        [variable]
                            name=secondary_resistance
                            less_than=0
                        [/variable]
                        [then]
                            {VARIABLE secondary_resistance 100}
                        [/then]
                    [/if]
                    {VARIABLE secondary_damage $damage}
                    {VARIABLE_OP secondary_damage multiply $secondary_resistance}
                    [if]
                        [variable]
                            name=secondary_damage
                            greater_than=$($units[$i].hitpoints*100)
                        [/variable]
                        [then]
                            {VARIABLE true_damage $units[$i].hitpoints}
                            {VARIABLE_OP true_damage multiply 100}
                        [/then]
                        [else]
                            {VARIABLE true_damage $secondary_damage}
                        [/else]
                    [/if]
                    # Note: Damage that is too small to leech can be combined from multiple targets into a real hitpoint.
                    # Example: 4 damage to 3 targets. Each hit alone produces 0 leech gain, but all 3 together get 1 hitpoint.
                    [if]
                        [variable]
                            name=has_leech
                            not_equals=0
                        [/variable]
                        [then]
                            {VARIABLE_OP damage_to_leech add $true_damage}
                        [/then]
                    [/if]
                    # Drain
                    [if]
                        [variable]
                            name=units[$i].status.not_living
                            not_equals=yes
                        [/variable]
                        [and]
                            [variable]
                                name=has_drain
                                not_equals=0
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE_OP damage_to_drain add $true_damage}
                        [/then]
                    [/if]
                    #{DEBUG "Chaos loop unit at $units[$i].x,$units[$i].y  Resist $secondary_resistance  secD $secondary_damage  trueD $true_damage  damage_to_leech $damage_to_leech  damage_to_drain $damage_to_drain"}
                    {CLEAR_VARIABLE secondary_resistance,secondary_damage,true_damage}
                {NEXT i}
                [if]
                    [variable]
                        name=has_leech
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_leech}
                        # Divide by 100 to rescale, then 10% leech factor
                        {VARIABLE_OP healed_amount divide 1000}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "Chaos LeechAddition $damage_to_leech  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x2,$y2
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=has_drain
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_drain}
                        # Divide by 100 to rescale, then 50% drain factor
                        {VARIABLE_OP healed_amount divide 200}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "Chaos DrainAddition $damage_to_drain  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x2,$y2
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                {CLEAR_VARIABLE units}
                {CLEAR_VARIABLE damage_to_leech,damage_to_drain,healed_amount}
            [/then]
        [/if]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    x,y=$x1,$y1
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$second_unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=$($damage/2)
            damage_type=$second_weapon.type
            fire_event=yes
            poisoned=$has_poison
            slowed=$has_slow
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
        {CLEAR_VARIABLE has_leech}
        {CLEAR_VARIABLE has_drain,damage}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=kamikaze sprint
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE opponent_damage $second_weapon.damage}
        {VARIABLE_OP opponent_damage multiply $second_weapon.number}
        [if]
            [variable]
                name=unit.hitpoints
                greater_than=$opponent_damage
            [/variable]
            [then]
                [if]
                    [variable]
                        name=opponent_damage
                        greater_than_equal_to=1
                    [/variable]
                    [then]
                        [harm_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=$opponent_damage
                            damage_type=$second_weapon.type
                            fire_event=no
			    kill=yes
                        [/harm_unit]
                    [/then]
                [/if]
                [store_unit]
                    [filter]
                        find_in=unit
                    [/filter]
                    variable=attacker
                    kill=no
                [/store_unit]
                [store_locations]
                    [filter_adjacent_location]
                        x,y=$second_unit.x,$second_unit.y
                        adjacent=-$attacker.facing
                    [/filter_adjacent_location]

                    variable=pierce_target_hex
                [/store_locations]
                [while]
                    [have_unit]
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                    [/have_unit]
                    [do]
                        {VARIABLE_OP damage divide 2}
                        [harm_unit_loti]
                            [filter]
                                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                                [filter_side]
                                    [enemy_of]
                                        side=$unit.side
                                    [/enemy_of]
                                [/filter_side]
                            [/filter]
                            [filter_second]
                                find_in=unit
                            [/filter_second]
                            amount=$damage
                            damage_type=$weapon.type
                            fire_event=yes
                            kill=yes
                        [/harm_unit_loti]
                        [store_locations]
                            [filter_adjacent_location]
                                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                                adjacent=-$attacker.facing
                            [/filter_adjacent_location]

                            variable=pierce_target_hex
                        [/store_locations]
                    [/do]
                [/while]
                [store_unit]
                    [filter]
                        find_in=unit
                    [/filter]
                    variable=attacker
                    kill=yes
                [/store_unit]
                {VARIABLE attacker.x $pierce_target_hex.x}
                {VARIABLE attacker.y $pierce_target_hex.y}
                [unstore_unit]
                    variable=attacker
                    find_vacant=yes
                    check_passability=yes
                [/unstore_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=second_unit.hitpoints
                less_than=1
            [/variable]
            [then]
		[kill]
			find_in=second_unit
			[filter_second]
				find_in=unit
			[/filter_second]
			animate=yes
			fire_event=yes
		[/kill]
	    [/then]
	[/if]
        {CLEAR_VARIABLE damage,attacker}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=explosive leech
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        [store_unit]		#We need to know how many units are leeched, and what are their resistances
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
            [/filter]
            variable=units
        [/store_unit]
        {VARIABLE healed_amount 0}
        {FOREACH units i}
            [switch]
                variable=weapon.type
                [case]
                    value=arcane
                    {VARIABLE_OP healed_amount add "$($units[$i].resistance.arcane*$damage)"}
                [/case]
                [case]
                    value=fire
                    {VARIABLE_OP healed_amount add "$($units[$i].resistance.fire*$damage)"}
                [/case]
                [case]
                    value=cold
                    {VARIABLE_OP healed_amount add "$($units[$i].resistance.cold*$damage)"}
                [/case]
                [case]
                    value=blade
                    {VARIABLE_OP healed_amount add "$($units[$i].resistance.blade*$damage)"}
                [/case]
                [case]
                    value=pierce
                    {VARIABLE_OP healed_amount add "$($units[$i].resistance.pierce*$damage)"}
                [/case]
                [case]
                    value=impact
                    {VARIABLE_OP healed_amount add "$($units[$i].resistance.impact*$damage)"}
                [/case]
            [/switch]
        {NEXT i}
        [floating_text]
            x,y=$x1,$y1
            text="<span color='#00FF00'>$($healed_amount/400)</span>"
        [/floating_text]
        [heal_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=$($healed_amount/400)
            animate=no
            restore_statuses=no
        [/heal_unit]
        {CLEAR_VARIABLE units}
        {CLEAR_VARIABLE healed_amount}
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/4)
            damage_type=$weapon.type
            fire_event=yes
        [/harm_unit_loti]
        {CLEAR_VARIABLE damage}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=explosive
        [/filter_attack]
        {VARIABLE has_poison no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        {INCORPORATE_EFFECTS}
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($($damage*3)/4-4)
            damage_type=$weapon.type
            fire_event=yes
            poisoned=$has_poison
        [/harm_unit_loti]
        [if]
            [variable]
                name=damage
                greater_than=24	# If the damage is high enough, the range is increased.
            [/variable]
            [then]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=1
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=2
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]

                    amount=$($($damage*3)/4-18)
                    damage_type=$weapon.type
                    fire_event=yes
                    animate=no
                    poisoned=$has_poison
                [/harm_unit_loti]
            [/then]
        [/if]
        [if]
            [variable]
                name=damage
                greater_than=48		# If the damage is extremely high, the range is increased even more.
            [/variable]
            [then]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=2
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=3
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$($($damage)/2-24)
                    damage_type=$weapon.type
                    fire_event=yes
                    animate=no
                    poisoned=$has_poison
                [/harm_unit_loti]
            [/then]
        [/if]
        [if]
            [variable]
                name=damage
                greater_than=108		# If the damage is higher than most common attacks can get, the range is increased even even more.
            [/variable]
            [then]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=3
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=4
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$($($damage)/3-36)
                    damage_type=$weapon.type
                    fire_event=yes
                    animate=no
                    poisoned=$has_poison
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE damage,has_poison}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=explosive unprotected
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2
                [/not]
                [not]
                    x,y=$x1,$y1
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($($damage*3)/4-4)
            damage_type=$weapon.type
            fire_event=yes
        [/harm_unit_loti]
        {CLEAR_VARIABLE damage}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=mind raid
        [/filter_attack]
        [if]
            [variable]
                name=second_unit.experience
                greater_than_equal_to=1
            [/variable]
            [then]
                {VARIABLE_OP second_unit.experience sub 1}
                {VARIABLE_OP unit.experience add 1}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [if]
                    [variable]
                        name=unit.experience
                        greater_than=$unit.max_experience
                    [/variable]
                    [then]
                        [fire_event]
                            name=force respec
                            [primary_unit]
                                id=$unit.id
                            [/primary_unit]
                        [/fire_event]
                    [/then]
                [/if]
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no

        [filter_attack]
            special=mind raid
        [/filter_attack]
        [if]
            [variable]
                name=unit.experience
                greater_than_equal_to=1
            [/variable]
            [then]
                {VARIABLE_OP unit.experience sub 1}
                {VARIABLE_OP second_unit.experience add 1}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special=leeches
        [/filter_attack]
        [set_variable]
            name=damage_dealt
            value=$damage_inflicted
        [/set_variable]
        [set_variable]
            name=damage_dealt
            divide=10
            round=ceil
        [/set_variable]
        {VARIABLE_OP unit.hitpoints add $damage_dealt}
        [if]
            [variable]
                name=unit.hitpoints
                greater_than=$unit.max_hitpoints
            [/variable]
            [then]
                {VARIABLE unit.hitpoints $unit.max_hitpoints}
            [/then]
        [/if]
        [unstore_unit]
            variable=unit
            find_vacant=no
            {COLOR_HEAL}
            text= _ "$damage_dealt"
        [/unstore_unit]
        {CLEAR_VARIABLE damage_dealt}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=leeches
        [/filter_second_attack]
        [set_variable]
            name=damage_dealt
            value=$damage_inflicted
        [/set_variable]
        [set_variable]
            name=damage_dealt
            divide=10
            round=ceil
        [/set_variable]
        {VARIABLE_OP second_unit.hitpoints add $damage_dealt}
        [if]
            [variable]
                name=second_unit.hitpoints
                greater_than=$second_unit.max_hitpoints
            [/variable]
            [then]
                {VARIABLE second_unit.hitpoints $second_unit.max_hitpoints}
            [/then]
        [/if]
        [unstore_unit]
            variable=second_unit
            find_vacant=no
            {COLOR_HEAL}
            text= _ "$damage_dealt"
        [/unstore_unit]
        {CLEAR_VARIABLE damage_dealt}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=explosive slow
        [/filter_attack]

        [harm_unit]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    side=$side_number
                [/not]
                [not]
                    x,y=$x2,$y2
                [/not]
                side=$enemy_sides
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=2
            slowed=yes
            damage_type=$weapon.type
            fire_event=yes
            kill=no
            experience=no
        [/harm_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=murderlust
        [/filter_second]
        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=8
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=killhunger
        [/filter_second]
        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=4
            animate=yes
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=lesser evisceration
        [/filter_second]
        [heal_unit]
            [filter]
                [filter_adjacent]
                    id=$second_unit.id
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            amount=4
            animate=yes
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=evisceration
        [/filter_second]
        [heal_unit]
            [filter]
                [filter_adjacent]
                    id=$second_unit.id
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            amount=10
            animate=yes
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=greater evisceration
        [/filter_second]
        [heal_unit]
            [filter]
                [filter_adjacent]
                    id=$second_unit.id
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            amount=16
            animate=yes
        [/heal_unit]
    [/event]
    [event]
        name=last breath
        first_time_only=no
        [filter]
            race=undead
        [/filter]
        [filter_second_attack]
            special=purify
        [/filter_second_attack]
        {VARIABLE transform_type null}
        [if]
            [variable]
                name=unit.type
                contains=Skeleton
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Deathblade
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Revenant
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Revenant LotI
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Walking Corpse
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Soulless
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Death Knight LotI
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Draug
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Grim Knight
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Death Knight
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Deathlord
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Lich King
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Phantom
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Ghoul
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Ghast
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Necrophage
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Abomination
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Monstrosity
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Spearman,Heavy Infantryman,Elvish Fighter,Fencer,Thug,Footpad)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Chocobone
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Grim Knight
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Chocobone LotI
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Cavalryman,Horseman,Elvish Scout)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Bone Shooter
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Skeleton Archer
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Soul Shooter
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Soul Shooter LotI
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Banebow
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Bowman,Elvish Archer,Poacher)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Lich
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Ancient Lich
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Ancient Lich LotI
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Mage,Elvish Shaman)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Ghost
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Wraith
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Spectre
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Shadow
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Nightgaunt
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Reaper
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Dark Shade
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Spearman,Heavy Infantryman,Elvish Fighter,Fencer,Thug,Footpad,Cavalryman,Horseman,Elvish Scout,Bowman,Elvish Archer,Poacher,Mage,Elvish Shaman)}
            [/then]
        [/if]
        [if]
            [variable]
                name=transform_type
                not_equals=null
            [/variable]
            [then]
                [fire_event]
                    name=die
                    [primary_unit]
                        find_in=unit
                    [/primary_unit]
                    [secondary_unit]
                        find_in=second_unit
                    [/secondary_unit]
                [/fire_event]
                {CLEAR_VARIABLE unit.modifications.trait}
                {CLEAR_VARIABLE unit.modifications.object}
#ifver WESNOTH_VERSION >= 1.13.2
                {CLEAR_VARIABLE unit.modifications.advancement}
#else
                {CLEAR_VARIABLE unit.modifications.advance}
#endif
                {VARIABLE unit.hitpoints $unit.max_hitpoints}
                {VARIABLE unit.type $transform_type}
                {VARIABLE unit.side $second_unit.side}
                [if]
                    [variable]
                        variable=transform_type
                        equals=Elvish Shaman
                    [/variable]
                    [then]
                        {VARIABLE unit.gender female}
                    [/then]
                [/if]
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                {UPDATE_STATS}
                [delay]
                    time=800
                [/delay]
                [floating_text]
                    text=_"What happened to me...?"
                    x,y=$x1,$y1
                [/floating_text]
                [delay]
                    time=500
                [/delay]
                [floating_text]
                    text=_"I have put an end to your unlife."
                    x,y=$x2,$y2
                [/floating_text]
                [delay]
                    time=500
                [/delay]
                [floating_text]
                    text=_"Thank you."
                    x,y=$x1,$y1
                [/floating_text]
            [/then]
        [/if]
        {CLEAR_VARIABLE transform_type}
    [/event]
    [event]
        name=attack end
        first_time_only=no

        [filter]
            [filter_adjacent]
                ability=push
                is_enemy=no
            [/filter_adjacent]
        [/filter]
        {VARIABLE_OP unit.moves add 1}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                ability=wardrums
                side=$side_number
            [/filter]
            variable=drummed
            kill=no
        [/store_unit]
        {FOREACH drummed i}
            {VARIABLE_OP drummed[$i].moves add 2}
            [unstore_unit]
                variable=drummed[$i]
                find_vacant=no
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE drummed}
    [/event]
    [event]
        name=attack end
        first_time_only=no

        [filter]
            ability=penetrate
        [/filter]
        {VARIABLE_OP unit.moves add 1}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]
    [event]
        name=attack end
        first_time_only=no

        [filter_attack]
            special=hit and run
        [/filter_attack]
        {VARIABLE_OP unit.moves add "$($unit.max_moves/2)"}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]
    {ABSORB_EVENT 1}
    {ABSORB_EVENT 2}
    {ABSORB_EVENT 3}
    {ABSORB_EVENT 4}
    [event]		#For the Cloak of Burning Retribution
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=retribution
        [/filter_second]
        [harm_unit_loti]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=$($damage_inflicted/4)
            damage_type=fire
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            [filter_adjacent]
                ability=spell eater
                is_enemy=no
            [/filter_adjacent]
        [/filter_second]
        [filter_attack]
                type=arcane
                [or]
                    type=fire
                [/or]
                [or]
                    type=cold
                [/or]
        [/filter_attack]
	[store_unit]
		[filter]
			ability=spell eater
			[filter_adjacent]
				find_in=second_unit
			[/filter_adjacent]
		[/filter]
		variable=eaters
	[/store_unit]
	{FOREACH eaters i}
		[object]
		    silent=yes
		    duration=forever
		    sort=potion_like
		    [filter]
		        find_in=eaters[$i]
		    [/filter]
		    [effect]
		        apply_to=resistance
		        replace=false
		        [resistance]
		            fire=-2
		            cold=-2
		            arcane=-2
		            impact=-2
		            blade=-2
		            pierce=-2
		        [/resistance]
		    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase_total=4
                        increase=8
                    [/effect]
                    [effect]
                        apply_to=attack
                        increase_damage=1
                    [/effect]
		[/object]
	{NEXT i}
	{CLEAR_VARIABLE eaters}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            [filter_adjacent]
                ability=blood drinking
            [/filter_adjacent]
        [/filter_second]
        {VARIABLE drunk "$(0.05*$damage_inflicted)"}
        [fire_event]
            name=blood drinking
            [primary_unit]
                find_in=second unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            [filter_adjacent]
                ability=blood drinking
            [/filter_adjacent]
        [/filter]
        {VARIABLE drunk "$(0.05*$damage_inflicted)"}
        [fire_event]
            name=blood drinking
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=blood drinking
        first_time_only=no
        [filter_second]
            ability=blood drinking
        [/filter_second]
        [if]
            [variable]
                name=drunk
                greater_than=1
            [/variable]
            [else]
                {VARIABLE drunk 1}
            [/else]
        [/if]
        [heal_unit]
            [filter]
                ability=blood drinking
                [filter_adjacent]
                    find_in=unit
                [/filter_adjacent]
            [/filter]
            amount=$drunk
            animate=yes
            restore_statuses=no
        [/heal_unit]
        {CLEAR_VARIABLE drunk}
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=whirlwind
            [or]
                special=explosive
            [/or]
        [/filter_attack]
        [fire_event]
            name=dooming lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=cleave
        [/filter_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=hose
            [or]
                special=storm
            [/or]
        [/filter_attack]
        [fire_event]
            name=devastating lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=cone
            [or]
                special=explosive leech
            [/or]
        [/filter_attack]
        [fire_event]
            name=crippling lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=explosive unprotected
        [/filter_attack]
        [fire_event]
            name=wrecking lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_second_attack]
            special=chaos
        [/filter_second_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            ability=wrath
            [or]
                [filter_adjacent]
                    ability=hate speech
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter]
        [if]
            [variable]
                name=unit.variables.wrath
                equals=yes
            [/variable]
            [then]
                {VARIABLE_OP unit.variables.wrath_intensity add 1}
            [/then]
            [else]
                {VARIABLE unit.variables.wrath yes}
                {VARIABLE unit.variables.wrath_intensity 1}
            [/else]
        [/if]
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        [fire_event]
            name=set wrath intensity
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=innocence
        [/filter_second]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=innocence
        [/filter]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=lesser lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 1}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=lethargy
        [/filter_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=lethargy
        [/filter_second_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special=lesser lethargy
        [/filter_attack]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=lesser lethargy
        [/filter_second_attack]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 2}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=debilitating lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 4}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=crippling lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 6}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=wrecking lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 8}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=dooming lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 10}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=devastating lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 12}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=lethargy x
        first_time_only=no
        [if]
            [variable]
                name=unit.variables.wrath
                equals=yes
            [/variable]
            [then]
                {VARIABLE_OP unit.variables.wrath_intensity sub $lethargy_amount}
            [/then]
            [else]
                {VARIABLE unit.variables.wrath yes}
                {VARIABLE unit.variables.wrath_intensity "$(-1*$lethargy_amount)"}
            [/else]
        [/if]
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
        [fire_event]
            name=set wrath intensity
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=martyrdom
        [/filter_second]
        [fire_event]
            name=martyrdom
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=martyrdom
        [/filter]
        [fire_event]
            name=martyrdom
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=martyrdom
        first_time_only=no
        [store_unit]
            [filter]
                [filter_adjacent]
                    find_in=unit
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            variable=infuriated
        [/store_unit]
        {FOREACH infuriated i}
            [if]
                [variable]
                    name=unit.variables.wrath_intensity
                    greater_than_equal_to=1
                [/variable]
                [then]
                    {VARIABLE_OP infuriated[$i].variables.wrath_intensity add 1}
                [/then]
                [else]
                    {VARIABLE infuriated[$i].variables.wrath yes}
                    {VARIABLE infuriated[$i].variables.wrath_intensity 1}
                [/else]
            [/if]
            [unstore_unit]
                variable=infuriated[$i]
                find_vacant=no
            [/unstore_unit]
            [fire_event]
                name=set wrath intensity
                [primary_unit]
                    find_in=infuriated[$i]
                [/primary_unit]
            [/fire_event]
        {NEXT i}
        {CLEAR_VARIABLE infuriated}
    [/event]

    [event]
        name=set wrath intensity
        first_time_only=no

        {FOREACH unit.attack swi}
            {FOREACH unit.attack[$swi].specials.damage swj}
                [if]
                    [variable]
                        name=unit.attack[$swi].specials.damage[$swj].id
                        equals=latent_wrath
                    [/variable]
                    [then]
                        {VARIABLE unit.attack[$swi].specials.damage[$swj].add $unit.variables.wrath_intensity}
                    [/then]
                [/if]
            {NEXT swj}
        {NEXT swi}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                [filter_wml]
                    [variables]
                        wrath=yes
                    [/variables]
                [/filter_wml]
            [/filter]
            variable=wrathful
        [/store_unit]
        {FOREACH wrathful h}
            [if]
                [variable]
                    name=wrathful[$h].variables.wrath_intensity
                    greater_than=1
                [/variable]
                [or]
                    [variable]
                        name=wrathful[$h].variables.wrath_intensity
                        less_than=-1
                    [/variable]
                [/or]
                [then]
                    [if]
                        [variable]
                            name=wrathful[$h].variables.wrath_intensity
                            greater_than=0
                        [/variable]
                        [then]
                            [set_variable]
                                name=wrathful[$h].variables.wrath_intensity
                                divide=2
                                round=floor
                            [/set_variable]
                        [/then]
                        [else]
                            [set_variable]
                                name=wrathful[$h].variables.wrath_intensity
                                divide=2
                                round=ceil
                            [/set_variable]
                        [/else]
                    [/if]
                [/then]
                [else]
                    {CLEAR_VARIABLE wrathful[$h].variables.wrath,wrathful[$h].variables.wrath_intensity}
                [/else]
            [/if]
            {FOREACH wrathful[$h].attack i}
                {FOREACH wrathful[$h].attack[$i].specials.damage j}
                    [if]
                        [variable]
                            name=wrathful[$h].attack[$i].specials.damage[$j].id
                            equals=latent_wrath
                        [/variable]
                        [then]
                            {VARIABLE wrathful[$h].attack[$i].specials.damage[$j].add $wrathful[$h].variables.wrath_intensity}
                        [/then]
                    [/if]
                {NEXT j}
            {NEXT i}
            [unstore_unit]
                variable=wrathful[$h]
                find_vacant=no
                advance=no
            [/unstore_unit]
        {NEXT h}
        {CLEAR_VARIABLE wrathful}
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=retribution
        [/filter]
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage_inflicted/4)
            damage_type=fire
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=weak reflect
        [/filter_second]
        [harm_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=$($damage_inflicted/4)
            damage_type=$weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=weak reflect
        [/filter]
        [harm_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            amount=$($damage_inflicted/4)
            damage_type=$second_weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=reflect
        [/filter_second]
        [harm_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=$($damage_inflicted/2)
            damage_type=$weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=reflect
        [/filter]
        [harm_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            amount=$($damage_inflicted/2)
            damage_type=$second_weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter]
            ability=lesser redeem
        [/filter]
        [set_variables]
            name=random_code
            [value]
                rand=0..$second_unit.level
                name=did_succeed
            [/value]
            mode=replace
        [/set_variables]
        [insert_tag]
            name=set_variable
            variable=random_code
        [/insert_tag]
        {CLEAR_VARIABLE random_code}
        [if]
            [variable]
                name=did_succeed
                greater_than=0
            [/variable]
            [else]
                [animate_unit]
                    flag=redeem_anim
                    [filter]
                        id=$unit.id
                    [/filter]
                    [facing]
                        x,y=$second_unit.x,$second_unit.y
                    [/facing]
                    hits=yes
                [/animate_unit]
                [kill]
                    id=$second_unit.id
                    animate=no
                    fire_event=yes
                [/kill]
                [if]
                    [variable]
                        name=unit.variables.lesser_redeem_count
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE_OP unit.variables.lesser_redeem_count add 1}
                    [/then]
                    [else]
                        {VARIABLE unit.variables.lesser_redeem_count 1}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=unit.variables.lesser_redeem_level
                        greater_than=0
                    [/variable]
                    [else]
                        {VARIABLE unit.variables.lesser_redeem_level 1}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=unit.variables.max_lesser_redeem_count
                        greater_than=0
                    [/variable]
                    [else]
                        {VARIABLE unit.variables.max_lesser_redeem_count 5}
                        {VARIABLE count $unit.variables.lesser_redeem_level}
                        [while]
                            [variable]
                                name=count
                                greater_than=1
                            [/variable]
                            [do]
                                {VARIABLE_OP unit.variables.max_lesser_redeem_count multiply 3}
                                {VARIABLE_OP unit.variables.max_lesser_redeem_count divide 2}
                                {VARIABLE_OP count sub 1}
                            [/do]
                        [/while]
                        {CLEAR_VARIABLE count}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=unit.variables.lesser_redeem_count
                        greater_than_equal_to=$unit.variables.max_lesser_redeem_count
                    [/variable]
                    [then]
                        {VARIABLE_OP unit.variables.lesser_redeem_level add 1}
                        {VARIABLE unit.variables.lesser_redeem_count 0}
                        {VARIABLE upgrade yes}
                        {VARIABLE unit.variables.max_lesser_redeem_count 0}
                    [/then]
                [/if]
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                    {COLOR_HEAL}
                    text="$unit.variables.lesser_redeem_count|/$unit.variables.max_lesser_redeem_count"
                    advance=no
                [/unstore_unit]
                [if]
                    [variable]
                        name=upgrade
                        equals=yes
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=2
                            [/variable]
                            [then]
                                [object]
                                    silent=yes
                                    [filter]
                                        id=$unit.id
                                    [/filter]
                                    [effect]
                                        apply_to=hitpoints
                                        increase_total=5
                                        increase=5
                                    [/effect]
                                    [effect]
                                        apply_to=attack
                                        increase_damage=1
                                    [/effect]
                                [/object]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=3
                            [/variable]
                            [then]
                                [object]
                                    silent=yes
                                    [filter]
                                        id=$unit.id
                                    [/filter]
                                    [effect]
                                        apply_to=hitpoints
                                        increase_total=3
                                        increase=3
                                    [/effect]
                                    [effect]
                                        apply_to=resistance
                                        replace=false
                                        [resistance]
                                            blade=-3
                                            pierce=-3
                                            impact=-3
                                            arcane=-3
                                            fire=-3
                                            cold=-3
                                        [/resistance]
                                    [/effect]
                                [/object]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=4
                            [/variable]
                            [then]
                                [object]
                                    silent=yes
                                    [filter]
                                        id=$unit.id
                                    [/filter]
                                    [effect]
                                        apply_to=hitpoints
                                        increase_total=2
                                        increase=2
                                    [/effect]
                                    [effect]
                                        apply_to=resistance
                                        replace=false
                                        [resistance]
                                            blade=-2
                                            pierce=-2
                                            impact=-2
                                            arcane=-2
                                            fire=-2
                                            cold=-2
                                        [/resistance]
                                    [/effect]
                                    [effect]
                                        apply_to=movement
                                        increase=1
                                    [/effect]
                                [/object]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=5
                            [/variable]
                            [then]
                                [object]
                                    silent=yes
                                    [filter]
                                        id=$unit.id
                                    [/filter]
                                    [effect]
                                        apply_to=attack
                                        increase_damage=1
                                    [/effect]
                                    [effect]
                                        apply_to=resistance
                                        replace=false
                                        [resistance]
                                            blade=-2
                                            pierce=-2
                                            impact=-2
                                            arcane=-2
                                            fire=-2
                                            cold=-2
                                        [/resistance]
                                    [/effect]
                                    blade_penetrate=5
                                    arcane_penetrate=5
                                    pierce_penetrate=5
                                [/object]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=6
                            [/variable]
                            [then]
                                [object]
                                    silent=yes
                                    [filter]
                                        id=$unit.id
                                    [/filter]
                                    [effect]
                                        apply_to=hitpoints
                                        increase_total=3
                                        increase=3
                                    [/effect]
                                    fire_penetrate=5
                                    impact_penetrate=5
                                    cold_penetrate=5
                                [/object]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                greater_than=6
                            [/variable]
                            [then]
                                [object]
                                    silent=yes
                                    [filter]
                                        id=$unit.id
                                    [/filter]
                                    [effect]
                                        apply_to=hitpoints
                                        increase_total=1
                                        increase=1
                                    [/effect]
                                    [effect]
                                        apply_to=resistance
                                        replace=false
                                        [resistance]
                                            blade=-1
                                            pierce=-1
                                            impact=-1
                                            arcane=-1
                                            fire=-1
                                            cold=-1
                                        [/resistance]
                                    [/effect]
                                    fire_penetrate=2
                                    impact_penetrate=2
                                    cold_penetrate=2
                                    fire_penetrate=2
                                    impact_penetrate=2
                                    cold_penetrate=2
                                [/object]
                            [/then]
                        [/if]
                    [/then]
                [/if]
                {CLEAR_VARIABLE upgrade}
            [/else]
        [/if]
    [/event]

    [event]	#For the poison immunity
        name=attack
        first_time_only=no
        [filter_attack]
            special=poison
        [/filter_attack]
        [filter_second]
            ability=immune to poison
        [/filter_second]
        [modify_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [status]
                not_living=yes
            [/status]
        [/modify_unit]
    [/event]

    [event]
        name=attack_end
        first_time_only=no
        [filter_attack]
            special=poison
        [/filter_attack]
        [filter_second]
            ability=immune to poison
        [/filter_second]
        [if]
            [variable]
                name=second_unit.race
                not_equals=undead
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=immunised
                [/store_unit]
                {CLEAR_VARIABLE immunised.status.not_living}
                [unstore_unit]
                    variable=immunised
                    find_vacant=no
                    advance=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter_attack]
            special=drains
        [/filter_attack]
        [filter_second]
            ability=immune to drain
        [/filter_second]
        [store_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            variable=immunised
        [/store_unit]
        {VARIABLE immunised.status.not_living yes}
        [unstore_unit]
            variable=immunised
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]

    [event]
        name=attack_end
        first_time_only=no
        [filter_attack]
            special=drains
        [/filter_attack]
        [filter_second]
            ability=immune to drain
        [/filter_second]
        [if]
            [variable]
                name=second_unit.race
                not_equals=undead
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=immunised
                [/store_unit]
                {CLEAR_VARIABLE immunised.status.not_living}
                [unstore_unit]
                    variable=immunised
                    find_vacant=no
                    advance=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter]
            ability=immune to drain
        [/filter]
        [filter_second_attack]
            special=drains
        [/filter_second_attack]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=immunised
        [/store_unit]
        {VARIABLE immunised.status.not_living yes}
        [unstore_unit]
            variable=immunised
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]

    [event]
        name=attack_end
        first_time_only=no
        [filter]
            ability=immune to drain
        [/filter]
        [filter_second_attack]
            special=drains
        [/filter_second_attack]
        [if]
            [variable]
                name=unit.race
                not_equals=undead
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=immunised
                [/store_unit]
                {CLEAR_VARIABLE immunised.status.not_living}
                [unstore_unit]
                    variable=immunised
                    find_vacant=no
                    advance=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter_second]
            ability=regrowing
        [/filter_second]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x2,$y2
            [/filter]
            amount="$(2*$second_unit.level)"
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=attack
        first_time_only=no
        [filter]
            ability=regrowing
        [/filter]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount="$(2*$unit.level)"
            restore_statuses=no
        [/heal_unit]
    [/event]

    [event]	#For the slow immunity
        name=attack end
        first_time_only=no
        [filter_attack]
            special=slow
        [/filter_attack]
        [filter_second]
            ability=resistant to slow
        [/filter_second]
        {CLEAR_VARIABLE second_unit.status.slowed}
        [unstore_unit]
            variable=second_unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_second_attack]
            special=slow
        [/filter_second_attack]
        [filter]
            ability=resistant to slow
        [/filter]
        {CLEAR_VARIABLE unit.status.slowed}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter_second_attack]
            special=poison
        [/filter_second_attack]
        [filter]
            ability=immune to poison
        [/filter]
        [modify_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [status]
                not_living=yes
            [/status]
        [/modify_unit]
    [/event]

    [event]
        name=attack_end
        first_time_only=no
        [filter_second_attack]
            special=poison
        [/filter_second_attack]
        [filter]
            ability=immune to poison
        [/filter]
        [if]
            [variable]
                name=unit.race
                not_equals=undead
            [/variable]
            [then]
                [modify_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [status]
                        not_living=no
                    [/status]
                [/modify_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter_second]
            ability=immune to poison
        [/filter_second]
        [filter_attack]
            special=poison
        [/filter_attack]
        [modify_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [status]
                not_living=yes
            [/status]
        [/modify_unit]
    [/event]

    [event]
        name=attack_end
        first_time_only=no
        [filter_second]
            ability=immune to poison
        [/filter_second]
        [filter_attack]
            special=poison
        [/filter_attack]
        [if]
            [variable]
                name=unit.race
                not_equals=undead
            [/variable]
            [then]
                [modify_unit]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [status]
                        not_living=no
                    [/status]
                [/modify_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            range=melee
        [/filter_attack]
        [filter_second]
            ability=thorns
        [/filter_second]
        [harm_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=2
            damage_type=pierce
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            range=melee
        [/filter_second_attack]
        [filter]
            ability=thorns
        [/filter]
        [harm_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            amount=2
            damage_type=pierce
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]

    [event]	#This was taken from wesnoth forums, author was dixie, slightly modified by Dugi to fit the interface
        name=attacker hits
        first_time_only=no
        [filter_second]
            [not]
                [filter_wml]
                    [status]
                        dazzled=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter_second]
        [filter_attack]
            special=dazzle
        [/filter_attack]
        [set_variable]
            name=second_unit.variables.turn_dazzled
            value=$turn_number
        [/set_variable]
        [set_variable]
            name=second_unit.variables.side_turn_dazzled
            value=$side_number
        [/set_variable]
        [unstore_unit]
            variable=second_unit
            {COLOR_HARM}
            text= _ "dazzled"
        [/unstore_unit]

        [object]
            silent=yes
            sort=potion_like
            [filter]
                find_in=second_unit
            [/filter]
            [effect]
                apply_to=status
                add=dazzled
            [/effect]
            [effect]
                apply_to=image_mod
                replace="CS(50,50,80)"
            [/effect]
            [effect]
                apply_to=attack
                remove_specials=dazzled
            [/effect]
            [effect]
                apply_to=attack
                [set_specials]
                    mode=append
                    [chance_to_hit]
                        id=dazzled
                        name= _ "dazzled"
                        description= _ "Still feeling dizzy from a blinding flash of light, this unit's chances to hit will be set to a maximum of 50% until a whole turn has passed. The effect will then vanish by itself afterwards."

                        value=50
                        [filter_base_value]
                            greater_than=50
                        [/filter_base_value]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
        [/object]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special=dazzle
        [/filter_second_attack]
        [filter]
            [not]
                [filter_wml]
                    [status]
                        dazzled=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        [filter_attack]
            special=dazzle
        [/filter_attack]
        [set_variable]
            name=unit.variables.turn_dazzled
            value=$turn_number
        [/set_variable]
        [set_variable]
            name=unit.variables.side_turn_dazzled
            value=$side_number
        [/set_variable]
        [unstore_unit]
            variable=unit
            {COLOR_HARM}
            text= _ "dazzled"
        [/unstore_unit]

        [object]
            silent=yes
            sort=potion_like
            [filter]
                find_in=unit
            [/filter]
            [effect]
                apply_to=status
                add=dazzled
            [/effect]
            [effect]
                apply_to=image_mod
                replace="CS(50,50,80)"
            [/effect]
            [effect]
                apply_to=attack
                remove_specials=dazzled
            [/effect]
            [effect]
                apply_to=attack
                [set_specials]
                    mode=append
                    [chance_to_hit]
                        id=dazzled
                        name= _ "dazzled"
                        description= _ "Still feeling dizzy from a blinding flash of light, this unit's chances to hit will be set to a maximum of 50% until a whole turn has passed. The effect will then vanish by itself afterwards."
                        value=50
                        [filter_base_value]
                            greater_than=50
                        [/filter_base_value]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
        [/object]
    [/event]
    [event]
        name=side turn
        first_time_only=no

        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        dazzled=yes
                    [/status]
                [/filter_wml]
            [/filter]
            variable=undazzle
        [/store_unit]

        {FOREACH undazzle i}
            [if]
                [variable]
                    name=undazzle[$i].variables.side_turn_dazzled
                    equals=$side_number
                [/variable]
                [and]
                    [variable]
                        name=undazzle[$i].variables.turn_dazzled
                        less_than=$turn_number
                    [/variable]
                [/and]

                [then]
                    [unstore_unit]
                        variable=undazzle[$i]
                    [/unstore_unit]

                    [object]
                        silent=yes
                        sort=potion_like
                        [filter]
                            find_in=undazzle[$i]
                        [/filter]
                        [effect]
                            apply_to=status
                            remove=dazzled
                        [/effect]
                        [effect]
                            apply_to=image_mod
                            replace="CS(0,0,0)"
                        [/effect]
                        [effect]
                            apply_to=attack
                            remove_specials=dazzled
                        [/effect]
                    [/object]

                    {CLEAR_VARIABLE undazzle[$i].variables.side_turn_dazzled}
                    {CLEAR_VARIABLE undazzle[$i].variables.turn_dazzled}
                [/then]
            [/if]
        {NEXT i}

        {CLEAR_VARIABLE undazzle}
    [/event]

#enddef
