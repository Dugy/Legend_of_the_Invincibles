#textdomain wesnoth-loti

#define INCORPORATE_EFFECTS
    {VARIABLE damage $damage_inflicted}
    {VARIABLE_OP damage multiply 100}
    [get_unit_resistance]
        find_in=second_unit
        damage_type=$weapon.type
        to_variable=resistance
    [/get_unit_resistance]
    [if]
        [variable]
            name=resistance
            greater_than=0
        [/variable]
        [else]
            {VARIABLE resistance 100}
        [/else]
    [/if]
    {VARIABLE_OP damage divide $resistance}
    {CLEAR_VARIABLE resistance}
#enddef
#define INCORPORATE_EFFECTS_RETALIATION
    {VARIABLE damage $damage_inflicted}
    {VARIABLE_OP damage multiply 100}
    [get_unit_resistance]
        find_in=unit
        damage_type=$weapon.type
        to_variable=resistance
    [/get_unit_resistance]
    [if]
        [variable]
            name=resistance
            greater_than=0
        [/variable]
        [else]
            {VARIABLE resistance 100}
        [/else]
    [/if]
    {VARIABLE_OP damage divide $resistance}
    {CLEAR_VARIABLE resistance}
#enddef
#define EXPLOSIVE_UNIT_DIES BOMBER WEAPON_TYPE
    # A unit hits with weapon special 'explosive detonation', or with trait 'unstable' and hit by impact weapon, explodes, killing self and damaging adjacent
    # add 1/4 damage at radius 1?
    # affected adjacent units with explosive detonation or unstable should probably light off as well- k>1 baby, chain reaction!
    # Get units to harm after explosion (which kills the cause of all the trouble)
    [store_unit]
        [filter]
            [filter_adjacent]
                x,y=${BOMBER}.x,${BOMBER}.y
            [/filter_adjacent]
        [/filter]
        variable=dont_stand_so_close_to_me
    [/store_unit]
    # Add animation to bomber and blow him up (assumes no death animation exists)
    [object]
        silent=yes
        [filter]
            id=${BOMBER}.id
        [/filter]
        [effect]
            apply_to=new_animation
            [death]
                missile_start_time=0
                [missile_frame]
                    halo="halo/lightning-explosion-[1~9].png:100"
                    sound=explosion.ogg
                    auto_vflip=no
                [/missile_frame]
            [/death]
        [/effect]
    [/object]
    [harm_unit]
        [filter]
            id=${BOMBER}.id
        [/filter]
        amount=$(${BOMBER}.hitpoints * 1000)  # sometimes you just have to be sure
        damage_type=${WEAPON_TYPE}
        fire_event=yes
        animate=yes
        kill=yes
    [/harm_unit]
    # Harm bomber's victims
    [foreach]
        array=dont_stand_so_close_to_me
        [do]
            [harm_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                amount=${BOMBER}.hitpoints
                damage_type=${WEAPON_TYPE}
                fire_event=yes
                animate=yes
                kill=yes
            [/harm_unit]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE dont_stand_so_close_to_me}
#enddef

#define ABILITIES_EVENTS
    [event]
        name=last breath
        first_time_only=no
        [filter]
            ability=necromancy
            [not]
                race=undead
            [/not]
            [not]
                race=black soul-loti
            [/not]
        [/filter]
        [message]
            speaker=unit
            message= _ "Tharrr marr grath'elekort-esto!"
        [/message]
        {VARIABLE unit.hitpoints 40}
        [for]
            array=unit.modifications.advancement
            [do]
                [if]
                    [variable]
                        name=unit.modifications.advancement[$i].id
                        contains=legacy
                    [/variable]
                    [else]
                        {CLEAR_VARIABLE unit.modifications.advancement[$i]}
                        {VARIABLE_OP i sub 1}
                    [/else]
                [/if]
            [/do]
        [/for]
        [for]
            array=unit.modifications.object
            [do]
                [if]
                    [variable]
                        name=unit.modifications.object[$i].sort
                        equals=limited
                    [/variable]
                    [then]
                        {CLEAR_VARIABLE unit.modifications.object[$i]}
                        {VARIABLE_OP i sub 1}
                    [/then]
                [/if]
            [/do]
        [/for]
        {CLEAR_VARIABLE unit.variables.may_need_respec,unit.variables.achieved_amla,unit.status}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        {ADVANCE_UNIT x,y=$x1,$y1 "Lich"}
        {UPDATE_STATS}
    [/event]

    [event]
        name=attacker misses
        first_time_only=no

        [filter_second]
            ability=mockery
        [/filter_second]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x2,$y2
            [/filter]
            amount=2
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=defender misses
        first_time_only=no

        [filter]
            ability=mockery
        [/filter]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=2
            restore_statuses=no
        [/heal_unit]
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                side=$side_number
                [filter_adjacent]
                    ability=freezing
                    is_enemy=yes
                [/filter_adjacent]
            [/filter]
            amount=2
            damage_type=cold
            slowed=yes
            fire_event=yes
            experience=no
            kill=no
            animate=no
        [/harm_unit]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                gender=male
                [filter_adjacent]
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                    ability=temptation
                    is_enemy=yes
                    gender=female
                [/filter_adjacent]
                [or]
                    gender=female
                    [filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                        ability=temptation
                        is_enemy=yes
                        gender=male
                    [/filter_adjacent]
                [/or]
                [not]
                    race=undead
                [/not]
                side=$side_number
            [/filter]
            kill=no
            variable=tempting_store_youll_want_to_be_there
        [/store_unit]
        [for]
            array=tempting_store_youll_want_to_be_there
            [do]
                {VARIABLE tempting_store_youll_want_to_be_there[$i].attacks_left 0}
                [unstore_unit]
                    variable=tempting_store_youll_want_to_be_there[$i]
                    find_vacant=no
                    male_text=_"Infatuated"
                    female_text=_"female^Infatuated"

                    {COLOR_HARM}
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE tempting_store_youll_want_to_be_there}
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                ability=cancer
                side=$side_number
            [/filter]
            variable=carcinogenous
        [/store_unit]
        [for]
            array=carcinogenous
            [do]
                [if]
                    [variable]
                        name=carcinogenous[$i].status.not_living
                        equals=yes
                    [/variable]
                    [or]
                        [variable]
                            name=carcinogenous[$i].status.unpoisonable
                            equals=yes
                        [/variable]
                    [/or]
                    [else]
                        {VARIABLE carcinogenous[$i].status.poisoned yes}
                        [unstore_unit]
                            variable=carcinogenous[$i]
                            find_vacant=no
                        [/unstore_unit]
                    [/else]
                [/if]
            [/do]
        [/for]
        {CLEAR_VARIABLE carcinogenous}
    [/event]
    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                side=$side_number
                ability=frostbite
            [/filter]
            amount=24
            damage_type=cold
            fire_event=no
            experience=no
            kill=no
            animate=yes
        [/harm_unit]
    [/event]
    [event]
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                ability=leech
                side=$side_number
            [/filter]
            variable=leechers
            kill=no
        [/store_unit]
        [for]
            array=leechers
            variable=i
            [do]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            id=$leechers[$i].id
                        [/filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=leeched
                    kill=no
                [/store_unit]
                {VARIABLE amount 0}
                [for]
                    array=leeched
                    variable=j
                    [do]
                        [harm_unit]
                            [filter]
                                id=$leeched[$j].id
                            [/filter]
                            amount=2
                            fire_event=yes
                            experience=no
                            kill=no
                            animate=no
                        [/harm_unit]
                        {VARIABLE_OP amount add 2}
                    [/do]
                [/for]
                {CLEAR_VARIABLE leeched}
                [heal_unit]
                    [filter]
                        id=$leechers[$i].id
                    [/filter]
                    amount=$amount
                    animate=yes
                    restore_statuses=no
                [/heal_unit]
                {CLEAR_VARIABLE amount}
            [/do]
        [/for]
        {CLEAR_VARIABLE leechers}
    [/event]
    [event]
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                ability=parasite
                side=$side_number
            [/filter]
            variable=leechers
            kill=no
        [/store_unit]
        [for]
            array=leechers
            variable=i
            [do]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            id=$leechers[$i].id
                        [/filter_adjacent]
                        [filter_side]
                            [allied_with]
                                side=$side_number
                            [/allied_with]
                        [/filter_side]
                    [/filter]
                    variable=leeched
                    kill=no
                [/store_unit]
                {VARIABLE amount 0}
                [for]
                    array=leeched
                    variable=j
                    [do]
                        [harm_unit]
                            [filter]
                                id=$leeched[$j].id
                            [/filter]
                            amount=4
                            fire_event=yes
                            experience=no
                            kill=no
                            animate=no
                        [/harm_unit]
                        {VARIABLE_OP amount add 4}
                    [/do]
                [/for]
                {CLEAR_VARIABLE leeched}
                [heal_unit]
                    [filter]
                        id=$leechers[$i].id
                    [/filter]
                    amount=$amount
                    animate=yes
                    restore_statuses=no
                [/heal_unit]
                {CLEAR_VARIABLE amount}
            [/do]
        [/for]
        {CLEAR_VARIABLE leechers}
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                [filter_adjacent]
                    ability=dark aura
                    side=$side_number
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$side_number
                    [/enemy_of]
                [/filter_side]
            [/filter]
            amount=2
            damage_type=arcane
            poisoned=yes
            fire_event=yes
            experience=no
            kill=no
            animate=no
        [/harm_unit]
    [/event]

    [event]			#For the Foul Potion
        name=die
        first_time_only=no

        [filter]
            [not]
                status=undrainable
            [/not]
        [/filter]

        [filter_second]
            ability=unholy hunger
        [/filter_second]
        {CLEAR_VARIABLE second_unit.variables.starving}
        [unstore_unit]
            variable=second_unit
            {COLOR_HEAL}
            text= _ "+3 max HP"
            find_vacant=no
        [/unstore_unit]

        [object]
            silent=yes
            duration=forever
            sort=potion_like
            [filter]
                x,y=$x2,$y2
            [/filter]

            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=10
            [/effect]
        [/object]
    [/event]
    [event]		#For the Foul Potion
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                ability=unholy hunger
                [not]
                    [filter_adjacent]
                        ability=healing
                    [/filter_adjacent]
                [/not]
                [not]
                    [filter_location]
                        terrain=*^V*
                    [/filter_location]
                [/not]
                x=1-999
                y=1-999
            [/filter]
            variable=starving
            kill=no
        [/store_unit]
        [for]
            array=starving
            [do]
                [if]
                    [variable]
                        name=starving[$i].variables.starving
                        greater_than_equal_to=1
                    [/variable]
                    [then]
                        {VARIABLE_OP starving[$i].variables.starving add 1}
                        [unstore_unit]
                            variable=starving[$i]
                            {COLOR_HARM}
                            text= _ "-$starving[$i].variables.starving max HP"
                            find_vacant=no
                        [/unstore_unit]
                        [object]
                            silent=yes
                            duration=forever
                            sort=potion_like
                            [filter]
                                x,y=$starving[$i].x,$starving[$i].y
                            [/filter]
                            [effect]
                                apply_to=hitpoints
                                increase_total=-$starving[$i].variables.starving
                                increase=-$starving[$i].variables.starving
                            [/effect]
                        [/object]
                    [/then]
                    [else]
                        {VARIABLE starving[$i].variables.starving 1}
                        [unstore_unit]
                            variable=starving[$i]
                            find_vacant=no
                        [/unstore_unit]
                    [/else]
                [/if]
            [/do]
        [/for]
    [/event]
    [event]
        name=attack
        id=furious_begin
        first_time_only=no
        [filter_attack]
            special_id=furious
        [/filter_attack]
        [unit_status_semaphore]
            id=$second_unit.id
            status=undrainable
            action=incr
        [/unit_status_semaphore]
    [/event]
    [event]
        name=attack end
        id=furious_end
        first_time_only=no
        [filter_attack]
            special_id=furious
        [/filter_attack]
        [unit_status_semaphore]
            id=$second_unit.id
            status=undrainable
            action=decr
        [/unit_status_semaphore]
    [/event]

    [event]
        name=attack end
        first_time_only=no

        [filter_attack]
            special_id=knockback
        [/filter_attack]
        [knockback]
            [filter]
                find_in=second_unit
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
        [/knockback]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special_id=supreme knockback
        [/filter_attack]
        [knockback]
            distance=5
            [filter]
                find_in=second_unit
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
        [/knockback]
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special_id=storm
        [/filter_attack]
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {INCORPORATE_EFFECTS}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                # We do not hurt our own units.
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
                # The defender was already damaged.
                [not]
                    x,y=$x2,$y2
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/1.5)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                # We do not hurt our own units.
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
                # The defender was already damaged.
                [not]
                    x,y=$x2,$y2
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=8
            damage_type=impact
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        # Harm units two hexes away from the attacker (half damage).
        [harm_unit_loti]
            [filter]
                [filter_location]
                    # Exclude the units that just received full damage.
                    [not]
                        x,y=$x1,$y1
                        radius=1
                    [/not]
                    # Include the remaining units within two hexes.
                    [and]
                        x,y=$x1,$y1
                        radius=2
                    [/and]
                [/filter_location]
                # We do not hurt our own units.
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=4
            damage_type=impact
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        [harm_unit_loti]
            [filter]
                [filter_location]
                    # Exclude the units that just received full damage.
                    [not]
                        x,y=$x1,$y1
                        radius=1
                    [/not]
                    # Include the remaining units within three hexes.
                    [and]
                        x,y=$x1,$y1
                        radius=2
                    [/and]
                [/filter_location]
                # We do not hurt our own units.
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
    [/event]
    [event] # Unit with active explosive detonation special hits
        name=attacker hits
        id=explosive detonation
        first_time_only=no
        [filter_attack]
            special_id_active=explosive detonation
        [/filter_attack]
        {EXPLOSIVE_UNIT_DIES unit weapon.type}
    [/event]
    [event]# Attacker hits an unstable unit with an impact weapon type
        name=attacker hits
        id=unstable
        first_time_only=no
        [filter_attack]
            type=impact
        [/filter_attack]
        [filter_second]
            [filter_wml]
                [modifications]
                    [trait]
                        id=unstable
                    [/trait]
                [/modifications]
            [/filter_wml]
        [/filter_second]
        {EXPLOSIVE_UNIT_DIES second_unit second_weapon.type}
    [/event]
    [event] # Defender hits an unstable unit with an impact weapon type, not their fault really, sucks to be them
        name=defender hits
        id=unstable
        first_time_only=no
        [filter]
            [filter_second_attack]
                type=impact
            [/filter_second_attack]
            [filter_wml]
                [modifications]
                    [trait]
                        id=unstable
                    [/trait]
                [/modifications]
            [/filter_wml]
        [/filter]
        {EXPLOSIVE_UNIT_DIES second_unit second_weapon.type}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=soul thrash
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
                [set_wrath_intensity]
                    id=$unit.id
                    add=$second_unit.level
                [/set_wrath_intensity]

                [fire_event]
                    name=force respec
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=soul extraction
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
                [unit]
                    type=Ghost
                    name=$second_unit.name
                    side=$unit.side
                    x,y=$second_unit.x,$second_unit.y
                [/unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=soul extraction
        [/filter_second_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    fire_defender_hits=true
                [/harm_unit_loti]
                [unit]
                    type=Ghost
                    name=$unit.name
                    side=$second_unit.side
                    x,y=$unit.x,$unit.y
                [/unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=raijers saloon
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        {VARIABLE_OP did_kill add $second_unit.level}
        [if]
            [variable]
                name=did_kill
                less_than=5
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [and]
                [variable]
                    name=second_unit.hitpoints
                    greater_than=1
                [/variable]
            [/and]
            [then]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [allied_with]
                                side=$unit.side
                            [/allied_with]
                        [/filter_side]
                        [or]
                            x,y=$x1,$y1
                        [/or]
                    [/filter]
                    variable=nearby
                    kill=no
                [/store_unit]
                {VARIABLE amount $second_unit.hitpoints}
                {VARIABLE_OP amount divide $nearby.length}
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
                [for]
                    array=nearby
                    [do]
                        [heal_unit]
                            [filter]
                                id=$nearby[$i].id
                            [/filter]
                            amount=$amount
                            animate=yes
                            restore_statuses=yes
                        [/heal_unit]
                    [/do]
                [/for]
                [fire_event]
                    name=force respec
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,amount,nearby}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=nosferatu gorge
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        {VARIABLE_OP did_kill add $second_unit.level}
        [if]
            [variable]
                name=did_kill
                less_than=5
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [and]
                [variable]
                    name=second_unit.hitpoints
                    greater_than=1
                [/variable]
            [/and]
            [then]
                {VARIABLE amount $second_unit.hitpoints}
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
                [heal_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=$amount
                    animate=yes
                    restore_statuses=yes
                [/heal_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,amount}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=soul annihilation
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..100)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x2,$y2
                        [/filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=nearby
                    kill=no
                [/store_unit]
                {VARIABLE damage_to_deal "$($second_unit.hitpoints/$nearby.length)"}
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
                [harm_unit_loti]
                    [filter]
                        [filter_adjacent]
                            x,y=$x2,$y2
                        [/filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$damage_to_deal
                    damage_type=arcane
                    fire_event=yes
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,damage_to_deal,nearby}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=soul annihilation
        [/filter_second_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$unit.id
                [/variable]
            [/not]
            [then]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [allied_with]
                                side=$unit.side
                            [/allied_with]
                        [/filter_side]
                    [/filter]
                    variable=nearby
                    kill=no
                [/store_unit]
                {VARIABLE damage_to_deal "$($unit.hitpoints/$nearby.length)"}
                [harm_unit_loti]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                    fire_defender_hits=true
                [/harm_unit_loti]
                [harm_unit_loti]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [allied_with]
                                side=$unit.side
                            [/allied_with]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=$damage_to_deal
                    damage_type=arcane
                    fire_event=yes
                    animate=no
                    fire_defender_hits=true
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill,damage_to_deal,nearby}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=disintegrate
        [/filter_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=disintegrate
        [/filter_second_attack]
        {VARIABLE_OP did_kill rand (1..50)}
        [if]
            [variable]
                name=did_kill
                equals=1
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$unit.id
                [/variable]
            [/not]
            [then]
                [harm_unit_loti]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=10000
                    fire_event=yes
                    fire_defender_hits=true
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE did_kill}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special_id=devastating_blow
        [/filter_attack]
        [foreach]
            array=weapon.specials.dummy
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=devastating_blow
                    [/variable]
                    [then]
                        {VARIABLE_OP random rand (1..100)}
                        [if]
                            [variable]
                                name=random
                                less_than=$this_item.devastating_blow
                            [/variable]
                            [variable]
                                name=second_unit.hitpoints
                                greater_than=1
                            [/variable]
                            [then]
                                [floating_text]
                                    x=$second_unit.x
                                    y=$second_unit.y
                                    color="255,0,0"
                                    text=_"-20% HP"
                                [/floating_text]
                                [delay]
                                    time=300
                                    accelerate=yes
                                [/delay]
                                [harm_unit]
                                    [filter]
                                        id=$second_unit.id
                                    [/filter]
                                    [filter_second]
                                        id=$unit.id
                                    [/filter_second]
                                    amount="$($second_unit.hitpoints - ($second_unit.hitpoints * 0.8))"
                                    kill=no
                                    fire_event=yes
                                    animate=no
                                    experience=no
                                [/harm_unit]
                            [/then]
                        [/if]
                    [/then]
                [/if]
            [/do]
        [/foreach]
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special_id=shockwave
        [/filter_attack]

        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=harmer
            kill=no
        [/store_unit]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$harmer.side
                    [/enemy_of]
                [/filter_side]
                [not]
                    x,y=$x1,$y1
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=8
            damage_type=impact
            fire_event=yes
            animate=no
            fire_attacker_hits=true
        [/harm_unit_loti]
        [knockback]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$harmer.side
                    [/enemy_of]
                [/filter_side]
                [not]
                    x,y=$x1,$y1
                [/not]
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
        [/knockback]
        {CLEAR_VARIABLE harmer}
    [/event]

    [event]			#Thieves can steal.
        name=attacker hits
        first_time_only=no
        [filter]
            type=Thief
            [or]
                type=Rogue
            [/or]
            [or]
                type=Assassin
            [/or]
            [or]
                type=Exterminator
            [/or]
            [or]
                ability=steals
            [/or]
        [/filter]
        [filter_attack]
            range=melee
        [/filter_attack]
        {VARIABLE_OP gold_stolen rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3)}
        [gold]
            side=$unit.side
            amount=$gold_stolen
        [/gold]
        {CLEAR_VARIABLE gold_stolen}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            type=Thief
            [or]
                type=Rogue
            [/or]
            [or]
                type=Assassin
            [/or]
            [or]
                type=Exterminator
            [/or]
            [or]
                ability=steals
            [/or]
        [/filter_second]
        [filter_second_attack]
            range=melee
        [/filter_second_attack]
        {VARIABLE_OP gold_stolen rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3)}
        [gold]
            side=$second_unit.side
            amount=$gold_stolen
        [/gold]
        {CLEAR_VARIABLE gold_stolen}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            ability=cowardice
            [not]
                [filter_adjacent]
                [/filter_adjacent]
            [/not]
        [/filter]
        [if]
            [variable]
                name=unit.moves
                equals=0
            [/variable]
            [and]
                [variable]
                    name=unit.attacks_left
                    greater_than=0
                [/variable]
            [/and]
            [then]
                {VARIABLE_OP unit.attacks_left sub 1}
                {VARIABLE unit.moves $unit.max_moves}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            ability=tax collector
        [/filter_second]
        {VARIABLE_OP gold_taken rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-2,-2,-3)}
        [gold]
            side=$second_unit.side
            amount=$gold_taken
        [/gold]
        {CLEAR_VARIABLE gold_taken}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            ability=tax collector
        [/filter]
        {VARIABLE_OP gold_taken rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-2,-2,-3)}
        [gold]
            side=$unit.side
            amount=$gold_taken
        [/gold]
        {CLEAR_VARIABLE gold_taken}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                ability=producer
            [/filter]
            variable=earners
        [/store_unit]
        {VARIABLE gold_got 0}
        [foreach]
            array=earners
            [do]
                {VARIABLE_OP gold_gained rand (0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3)}
                {VARIABLE_OP gold_got add $gold_gained}
            [/do]
        [/foreach]
        [gold]
            side=$side_number
            amount=$gold_got
        [/gold]
        {CLEAR_VARIABLE gold_gained,gold_got,earners}
    [/event]

    [event]
        name=defender misses
        first_time_only=no
        [filter_attack]
            special_id=parry
        [/filter_attack]
        {VARIABLE has_leech no}
        {VARIABLE has_drain no}
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        [foreach]
            array=weapon.specials.damage
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=leeches
                    [/variable]
                    [then]
                        {VARIABLE has_leech yes}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.drain.id
                equals=drain
            [/variable]
            [then]
                {VARIABLE has_drain yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [foreach]
            array=weapon.specials.damage
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=furious
                    [/variable]
                    [then]
                        {VARIABLE has_leech no}
                        {VARIABLE has_drains no}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [animate_unit]
            flag=attack
            [filter]
                id=$unit.id
            [/filter]
            [filter_second]
                id=$second_unit.id
            [/filter_second]
            [primary_attack]
                range=melee
            [/primary_attack]
            hits=yes
        [/animate_unit]
        [set_variable]
            name=resistance
            to_variable="second_unit.resistance.$weapon.type"
        [/set_variable]
        {VARIABLE damage_to_deal $weapon.damage}
        [if]
            [variable]
                name=unit.status.slowed
                equals=yes
            [/variable]
            [then]
                {VARIABLE_OP damage_to_deal divide 2}
            [/then]
        [/if]
        {VARIABLE damage_dealt "$($($damage_to_deal*$resistance)/100)"}
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$damage_to_deal
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow,has_poison,damage_to_deal}

        {VARIABLE_OP damage_dealt divide 100}
        {VARIABLE healed 0}
        [if]
            [variable]
                name=has_drain
                equals=yes
            [/variable]
            [not]
                [variable]
                    name=second_unit.status.non_living
                    equals=yes
                [/variable]
            [/not]
            [then]
                {VARIABLE_OP healed add "$($damage_dealt/2)"}
            [/then]
        [/if]
        [if]
            [variable]
                name=has_leech
                equals=yes
            [/variable]
            [then]
                {VARIABLE_OP healed add "$($damage_dealt/10)"}
            [/then]
        [/if]
        [foreach]
            array=weapon.specials.dummy
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=suck
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=this_item.suck
                                less_than=$weapon.damage
                            [/variable]
                            [then]
                                {VARIABLE_OP healed add $this_item.suck}
                            [/then]
                            [else]
                                {VARIABLE_OP healed add $damage_dealt}
                            [/else]
                        [/if]
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [if]
            [variable]
                name=healed
                greater_than=0
            [/variable]
            [then]
                [heal_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=$healed
                    animate=yes
                    restore_statuses=no
                [/heal_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE has_leech,has_drain,healed,damage_dealt}
    [/event]

    [event]
        name=defender misses
        first_time_only=no
        [filter_attack]
            special_id=reflects
        [/filter_attack]
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        [if]
            [variable]
                name=second_weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=second_weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [set_variable]
            name=resistance
            to_variable="unit.resistance.$weapon.type"
        [/set_variable]
        {VARIABLE damage_to_deal $second_weapon.damage}
        [if]
            [variable]
                name=unit.status.slowed
                equals=yes
            [/variable]
            [then]
                {VARIABLE_OP damage_to_deal divide 2}
            [/then]
        [/if]
        {VARIABLE damage_dealt "$($($damage_to_deal*$resistance)/100)"}
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$damage_to_deal
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        {CLEAR_VARIABLE resistance,has_slow,has_poison,damage_to_deal}
    [/event]

    [event]
        name=attacker misses
        first_time_only=no
        [filter_second_attack]
            special_id=reflects
        [/filter_second_attack]
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [set_variable]
            name=resistance
            to_variable="second_unit.resistance.$weapon.type"
        [/set_variable]
        {VARIABLE damage_to_deal $second_weapon.damage}
        [if]
            [variable]
                name=second_unit.status.slowed
                equals=yes
            [/variable]
            [then]
                {VARIABLE_OP damage_to_deal divide 2}
            [/then]
        [/if]
        {VARIABLE damage_dealt "$($($damage_to_deal*$resistance)/100)"}
        [harm_unit_loti]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=$damage_to_deal
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        {CLEAR_VARIABLE resistance,has_slow,has_poison,damage_to_deal}
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [harm_unit]
            [filter]
                [filter_location]
                    [filter]
                        ability=northfrost aura
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2
                [/filter_location]
                side=$side_number
            [/filter]
            amount=4
            damage_type=cold
            slowed=yes
            fire_event=yes
            experience=no
            kill=no
            animate=no
        [/harm_unit]
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                ability_type_active=periodic_damage_aura
            [/filter]
            variable=damagers
        [/store_unit]
        [foreach]
            array=damagers
            variable=damager
            [do]
                [foreach]
                    array=damager.abilities.periodic_damage_aura
                    variable=aura
                    [do]
                        [harm_unit_loti]
                            [filter]
                                [filter_location]
                                    [filter]
                                        find_in=damager
                                    [/filter]
                                    radius=$aura.radius
                                [/filter_location]
                                [filter_side]
                                    [enemy_of]
                                        side=$side_number
                                    [/enemy_of]
                                [/filter_side]
                            [/filter]
                            [filter_second]
                                find_in=damager
                            [/filter_second]
                            amount=$aura.damage
                            damage_type=$aura.damage_type
                            slowed=$aura.slow
                            poisoned=$aura.poison
                            fire_event=yes
                            kill=$aura.kill
                            animate=no
                            fire_attacker_hits=true
                        [/harm_unit_loti]
                    [/do]
                [/foreach]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE damagers}
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [store_unit]
            [filter]
                [filter_adjacent]
                    ability=flaming radiance
                    [filter_side]
                        [enemy_of]
                            side=$side_number
                        [/enemy_of]
                    [/filter_side]
                [/filter_adjacent]
                side=$side_number
            [/filter]
            variable=on_fire
            kill=no
        [/store_unit]
        [for]
            array=on_fire
            [do]
                [if]
                    [variable]
                        name=on_fire[$i].variables.flaming_irradiated
                        equals=yes
                    [/variable]
                    [then]
                        {VARIABLE_OP on_fire[$i].variables.flaming_irradiation add 8}
                    [/then]
                    [else]
                        {VARIABLE on_fire[$i].variables.flaming_irradiation 8}
                        {VARIABLE on_fire[$i].variables.flaming_irradiated yes}
                    [/else]
                [/if]
                [unstore_unit]
                    variable=on_fire[$i]
                    find_vacant=no
                [/unstore_unit]
                [harm_unit]
                    [filter]
                        id=$on_fire[$i].id
                    [/filter]
                    amount=$on_fire[$i].variables.flaming_irradiation
                    damage_type=fire
                    fire_event=yes
                    experience=no
                    kill=no
                    animate=yes
                [/harm_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE on_fire}
        [store_unit]
            [filter]
                [not]
                    [filter_adjacent]
                        ability=flaming radiance
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter_adjacent]
                [/not]
                [filter_wml]
                    [variables]
                        flaming_irradiated=yes
                    [/variables]
                [/filter_wml]
                side=$side_number
            [/filter]
            variable=not_on_fire
            kill=no
        [/store_unit]
        [for]
            array=not_on_fire
            [do]
                {CLEAR_VARIABLE not_on_fire[$i].variables.flaming_irradiated}
                {CLEAR_VARIABLE not_on_fire[$i].variables.flaming_irradiation}
                [unstore_unit]
                    variable=not_on_fire[$i]
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE not_on_fire}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            ability=autocast
        [/filter]
        [filter_attack]
            range=melee
            #		[or]
            #			type=pierce
            #		[/or]
            #		[or]
            #			type=blade
            #		[/or]
            #		[or]
            #			type=impact
            #		[/or]
            #		[not]
            #			name=thorns
            #		[/not]
            #		[not]
            #			name=vine whip
            #		[/not]
            #		[not]
            #			name=vine
            #		[/not]
            #		[not]
            #			name=ensnare
            #		[/not]
            #		[not]
            #			name=entangle
            #		[/not]
            #		[not]
            #			name=gossamer
            #		[/not]
        [/filter_attack]
        [foreach]
            array=unit.abilities.dummy
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=autocast
                    [/variable]
                    [then]
                        {VARIABLE list $this_item.cast}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [for]
            array=unit.attack
            [do]
                [if]
                    [variable]
                        name=list
                        contains=$unit.attack[$i].name
                    [/variable]
                    [then]
                        [set_variables]
                            name="fitting_spells"
                            to_variable=unit.attack[$i]
                            mode=append
                        [/set_variables]
                    [/then]
                [/if]
            [/do]
        [/for]
        [if]
            [variable]
                name=fitting_spells.length
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP picked rand "1..$fitting_spells.length"}
                {VARIABLE_OP picked sub 1}
                [animate_unit]
                    flag=attack
                    [filter]
                        find_in=unit
                    [/filter]
                    [filter_second]
                        find_in=second_unit
                    [/filter_second]
                    [primary_attack]
                        name=$fitting_spells[$picked].name
                    [/primary_attack]
                    hits=yes
                [/animate_unit]
                [harm_unit_loti]
                    [filter]
                        find_in=second_unit
                    [/filter]
                    [filter_second]
                        find_in=unit
                    [/filter_second]
                    amount=$fitting_spells[$picked].damage
                    damage_type=$fitting_spells[$picked].type
                    fire_event=yes
                    kill=yes
                    fire_attacker_hits=true
                [/harm_unit_loti]
                [fire_event]
                    name=attacker hits
                    [filter]
                        find_in=unit
                    [/filter]
                    [filter_second]
                        find_in=second_unit
                    [/filter_second]
                    [insert_tag]
                        name=filter_attack
                        variable=$fitting_spells[$picked]
                    [/insert_tag]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE list,fitting_spells,picked}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=from the ashes
            [not]
                [filter_wml]
                    [variables]
                        from_the_ashes_used=yes
                    [/variables]
                [/filter_wml]
            [/not]
        [/filter_second]
        [fire_event]
            name=from the ashes
            [primary_unit]
                id=$second_unit.id
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=from the ashes
            [not]
                [filter_wml]
                    [variables]
                        from_the_ashes_used=yes
                    [/variables]
                [/filter_wml]
            [/not]
        [/filter]
        [fire_event]
            name=from the ashes
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=from the ashes
        first_time_only=no
        [if]
            [variable]
                name=unit.hitpoints
                less_than=20
            [/variable]
            [then]
                {VARIABLE unit.variables.from_the_ashes_used yes}
                {VARIABLE unit.variables.from_the_ashes_cooldown 10}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [heal_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    amount=40
                    animate=yes
                    restore_statuses=yes
                [/heal_unit]
                [harm_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=40
                    damage_type=fire
                    fire_event=yes
                    experience=no
                    kill=no
                [/harm_unit]
            [/then]
        [/if]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                ability=from the ashes
                [filter_wml]
                    [variables]
                        from_the_ashes_used=yes
                    [/variables]
                [/filter_wml]
            [/filter]
            variable=ash_cooldown
        [/store_unit]
        [for]
            array=ash_cooldown
            variable=h
            [do]
                [if]
                    [variable]
                        name=ash_cooldown[$h].variables.from_the_ashes_cooldown
                        greater_than=1
                    [/variable]
                    [then]
                        {VARIABLE_OP ash_cooldown[$h].variables.from_the_ashes_cooldown sub 1}
                    [/then]
                    [else]
                        {CLEAR_VARIABLE ash_cooldown[$h].variables.from_the_ashes_cooldown}
                        {CLEAR_VARIABLE ash_cooldown[$h].variables.from_the_ashes_used}
                    [/else]
                [/if]
                [unstore_unit]
                    variable=ash_cooldown[$h]
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/for]
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special_id=cleave
            [not]
                special_id=whirlwind
            [/not]
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {VARIABLE has_lethargy no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [foreach]
            array=weapon.specials.dummy
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=lethargy
                    [/variable]
                    [then]
                        {VARIABLE has_lethargy yes}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [harm_unit_loti]
            [filter]
                [filter_location]
                    x,y=$x2,$y2
                    radius=1
                [/filter_location]
                [and]
                    [filter_adjacent]
                        x,y=$x1,$y1
                    [/filter_adjacent]
                [/and]
                [not]
                    x,y=$x2,$y2
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
                fire_attacker_hits=true
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
        {CLEAR_VARIABLE damage}

        [if]
            [variable]
                name=has_lethargy
                equals=yes
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        [filter_location]
                            x,y=$x2,$y2
                            radius=1
                        [/filter_location]
                        [and]
                            [filter_adjacent]
                                x,y=$x1,$y1
                            [/filter_adjacent]
                        [/and]
                        [not]
                            x,y=$x2,$y2
                        [/not]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=targets
                    kill=no
                [/store_unit]
                [for]
                    array=targets
                    [do]
                        [fire_event]
                            name=lethargy
                            [primary_unit]
                                find_in=targets[$i]
                            [/primary_unit]
                        [/fire_event]
                    [/do]
                [/for]
                {CLEAR_VARIABLE targets}
            [/then]
        [/if]
        {CLEAR_VARIABLE has_lethargy}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special_id=spell_suck
            [or]
                type=pierce
                [or]
                    type=impact
                [/or]
                [or]
                    type=blade
                [/or]
                [or]
                    type=arcane
                [/or]
                [and]
                    special_id=suck
                [/and]
            [/or]
            [not]
                special_id=furious
            [/not]
        [/filter_attack]
        [foreach]
            array=weapon.specials.dummy
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=suck
                    [/variable]
                    [or]
                        [variable]
                            name=this_item.id
                            equals=spell_suck
                        [/variable]
                    [/or]
                    [then]
                        [if]
                            [variable]
                                name=this_item.suck
                                less_than=$damage_inflicted
                            [/variable]
                            [then]
                                [heal_unit]
                                    [filter]
                                        x,y=$x1,$y1
                                    [/filter]
                                    amount=$this_item.suck
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                            [/then]
                            [else]
                                [heal_unit]
                                    [filter]
                                        x,y=$x1,$y1
                                    [/filter]
                                    amount=$damage_inflicted
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                            [/else]
                        [/if]
                    [/then]
                [/if]
            [/do]
        [/foreach]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special_id=spell_suck
            [or]
                type=pierce
                [or]
                    type=impact
                [/or]
                [or]
                    type=blade
                [/or]
                [or]
                    type=arcane
                [/or]
                [and]
                    special_id=suck
                [/and]
            [/or]
        [/filter_second_attack]
        [foreach]
            array=second_weapon.specials.dummy
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=suck
                    [/variable]
                    [or]
                        [variable]
                            name=this_item.id
                            equals=spell_suck
                        [/variable]
                    [/or]
                    [then]
                        [if]
                            [variable]
                                name=this_item.suck
                                less_than=$damage_inflicted
                            [/variable]
                            [then]
                                [heal_unit]
                                    [filter]
                                        x,y=$x2,$y2
                                    [/filter]
                                    amount=$this_item.suck
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                            [/then]
                            [else]
                                [heal_unit]
                                    [filter]
                                        x,y=$x2,$y2
                                    [/filter]
                                    amount=$damage_inflicted
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                            [/else]
                        [/if]
                    [/then]
                [/if]
            [/do]
        [/foreach]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special_id=pierce
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]

        [store_locations]
            [filter_adjacent_location]
                x,y=$x2,$y2
                adjacent=-$unit.facing
            [/filter_adjacent_location]

            variable=pierce_target_hex
        [/store_locations]
        [harm_unit_loti]
            [filter]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount="$($damage/2)"
            damage_type=pierce
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
            fire_attacker_hits=true
        [/harm_unit_loti]

        {CLEAR_VARIABLE pierce_target_hex,has_slow,has_poison,damage}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special_id=massive missile
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        {VARIABLE decay 0}
        [foreach]
            array=weapon.specials.dummy
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=massive missile
                    [/variable]
                    [then]
                        {VARIABLE decay $this_item.decay}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        {VARIABLE pos_x $x2}
        {VARIABLE pos_y $y2}
        [while]
            [variable]
                name=damage
                greater_than_equal_to=10
            [/variable]
            [do]
                [store_locations]
                    [filter_adjacent_location]
                        x,y=$pos_x,$pos_y
                        adjacent=-$unit.facing
                    [/filter_adjacent_location]

                    variable=pierce_target_hex
                [/store_locations]
                [harm_unit_loti]
                    [filter]
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        find_in=unit
                    [/filter_second]
                    amount="$damage"
                    damage_type=$weapon.type
                    fire_event=yes
                    animate=no
                    poisoned=$has_poison
                    slowed=$has_slow
                    fire_attacker_hits=true
                [/harm_unit_loti]
                {VARIABLE pos_x $pierce_target_hex.x}
                {VARIABLE pos_y $pierce_target_hex.y}
                {VARIABLE damage "$($damage*$decay/100)"}
            [/do]
        [/while]

        {CLEAR_VARIABLE pierce_target_hex,pos_x,pos_y,has_slow,has_poison,damage,decay}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special_id=cone
        [/filter_attack]
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {INCORPORATE_EFFECTS}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]

        [store_locations]
            [filter_adjacent_location]
                x,y=$x2,$y2
                adjacent=-$unit.facing
            [/filter_adjacent_location]

            variable=pierce_target_hex
        [/store_locations]

        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_location]
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                        radius=1
                    [/filter_location]
                [/and]
                [not]
                    x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/4)
            damage_type=$weapon.type
            fire_event=yes
            poisoned=$has_poison
            animate=no
            fire_attacker_hits=true
        [/harm_unit_loti]

        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_adjacent]
                        x,y=$x1,$y1
                    [/filter_adjacent]
                [/and]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            poisoned=$has_poison
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]

        [harm_unit_loti]
            [filter]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            fire_attacker_hits=true
        [/harm_unit_loti]

        {CLEAR_VARIABLE pierce_direction,pierce_target_hex,has_poison,damage}
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special_id=hose
        [/filter_attack]
        {VARIABLE has_poison no}
        {VARIABLE has_slow no}
        {INCORPORATE_EFFECTS}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]

        #hit cleave targets
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_adjacent]
                        x,y=$x1,$y1
                    [/filter_adjacent]
                [/and]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage*0.75)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]

        [store_locations]
            [filter_adjacent_location]
                x,y=$x2,$y2
                adjacent=-$unit.facing
            [/filter_adjacent_location]
            variable=pierce_target_hex
        [/store_locations]

        #hit pierce target
        [harm_unit_loti]
            [filter]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage*0.75)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
            fire_attacker_hits=true
        [/harm_unit_loti]

        #hit 2 nearby locations next to pierce target
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [and]
                    [filter_location]
                        radius=1
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                    [/filter_location]
                [/and]
                [not]
                    x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
            fire_attacker_hits=true
        [/harm_unit_loti]
        [store_locations]
            [filter_adjacent_location]
                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                adjacent=-$unit.facing
            [/filter_adjacent_location]
            variable=second_pierce_target_hex
        [/store_locations]

        #hit second pierce target
        [harm_unit_loti]
            [filter]
                x,y=$second_pierce_target_hex.x,$second_pierce_target_hex.y
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/2)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
            fire_attacker_hits=true
        [/harm_unit_loti]

        #hit 2 locations touching pierce target and second pierce target
        [harm_unit_loti]
            [filter]
                [filter_location]
                    radius=1
                    x,y=$second_pierce_target_hex.x,$second_pierce_target_hex.y
                [/filter_location]
                [and]
                    [filter_location]
                        radius=1
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                    [/filter_location]
                [/and]
                [not]
                    x,y=$pierce_target_hex.x,$pierce_target_hex.y
                [/not]
                [not]
                    x,y=$second_pierce_target_hex.x,$second_pierce_target_hex.y
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
                [filter_second]
                    find_in=unit
                [/filter_second]
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage/3)
            damage_type=$weapon.type
            fire_event=yes
            animate=no
            poisoned=$has_poison
            slowed=$has_slow
            fire_attacker_hits=true
        [/harm_unit_loti]

        {CLEAR_VARIABLE pierce_direction,pierce_target_hex,has_slow,has_poison,damage,second_pierce_target_hex}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special_id=infect
        [/filter_attack]
        [filter_second]
            [not]
                status=unplagueable
            [/not]
            [not]
                [filter_location]
                    terrain=*^V*
                [/filter_location]
            [/not]
        [/filter_second]
        [modify_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$unit.side
                infected_type=Walking Corpse
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special_id=infect
        [/filter_second_attack]
        [filter]
            [not]
                status=unplagueable
            [/not]
            [not]
                [filter_location]
                    terrain=*^V*
                [/filter_location]
            [/not]
        [/filter]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$second_unit.side
                infected_type=Walking Corpse
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special_id=greater infect
        [/filter_attack]
        [filter_second]
            [not]
                status=unplagueable
            [/not]
        [/filter_second]
        [modify_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$unit.side
                infected_type=Soulless
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special_id=greater infect
        [/filter_second_attack]
        [filter]
            [not]
                status=unplagueable
            [/not]
        [/filter]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            [status]
                infected=yes
            [/status]
            [variables]
                infected_by_side=$second_unit.side
                infected_type=Soulless
                canrecruit=no
            [/variables]
        [/modify_unit]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                status=infected
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_wml]
                        hitpoints=1
                    [/filter_wml]
                [/and]
                [not]
                    [filter_location]
                        terrain=*^V*
                    [/filter_location]
                [/not]
                [not]
                    ability=necromancy
                [/not]
            [/filter]
            variable=zombie_store
            kill=yes
        [/store_unit]
        [foreach]
            array=zombie_store # A Zombie store?  Can't I just order one on Amazon?
            [do]
                [unit]
                    side=$this_item.variables.infected_by_side
                    x=$this_item.x
                    y=$this_item.y
                    variation=$this_item.undead_variation
                    type=$this_item.variables.infected_type
                    moves=0
                    facing=$this_item.facing
                    attacks_left=0
                    animate=no
                [/unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE zombie_store}

        [store_unit]
            [filter]
                status=infected
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_adjacent]
                        ability=healing
                    [/filter_adjacent]
                [/and]
                [or]
                    status=infected
                    [and]
                        [filter_side]
                            side=$side_number
                        [/filter_side]
                    [/and]
                    [and]
                        [filter_location]
                            terrain=*^V*
                        [/filter_location]
                    [/and]
                [/or]
            [/filter]
            variable=unzombie_store
            kill=yes
        [/store_unit]
        [for]
            array=unzombie_store
            [do]
                {CLEAR_VARIABLE unzombie_store[$i].status.infected}
                {CLEAR_VARIABLE unzombie_store[$i].variables.infected_by_side}
                {CLEAR_VARIABLE unzombie_store[$i].variables.infected_type}
                [unstore_unit]
                    variable=unzombie_store[$i]
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE unzombie_store}
        # To cover the case where the infected unit is a necromancer
        [store_unit]
            [filter]
                status=infected
                ability=necromancy
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_wml]
                        hitpoints=1
                    [/filter_wml]
                [/and]
                [not]
                    [filter_location]
                        terrain=*^V*
                    [/filter_location]
                [/not]
            [/filter]
            variable=necromancy_store
        [/store_unit]
        [foreach]
            array=necromancy_store
            [do]
                [fire_event]
                    name=last_breath
                    [primary_unit]
                        id=$this_item.id
                    [/primary_unit]
                [/fire_event]
                [fire_event]
                    name=die
                    [primary_unit]
                        id=$this_item.id
                    [/primary_unit]
                [/fire_event]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE necromancy_store}
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter]
            status=infected
            [not]
                [filter_location]
                    terrain=*^V*
                [/filter_location]
            [/not]
        [/filter]
        [fire_event]
            name=last breath
            [filter]
                find_in=unit
            [/filter]
        [/fire_event]
        [fire_event]
            name=die
            [filter]
                find_in=unit
            [/filter]
        [/fire_event]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=zombie_store
            kill=yes
        [/store_unit]
        [unit]
            side=$zombie_store.variables.infected_by_side
            x=$zombie_store.x
            y=$zombie_store.y
            variation=$zombie_store.undead_variation
            type=$zombie_store.variables.infected_type
            moves=0
            facing=$zombie_store.facing
            attacks_left=0
            animate=no
        [/unit]
        {CLEAR_VARIABLE zombie_store}
    [/event]
    [event]
        name=victory
        first_time_only=no
        [store_unit]
            [filter]
                status=infected
            [/filter]
            variable=unzombie_store
            kill=yes
        [/store_unit]
        [for]
            array=unzombie_store
            [do]
                {CLEAR_VARIABLE unzombie_store[$i].status.infected}
                {CLEAR_VARIABLE unzombie_store[$i].variables.infected_by_side}
                {CLEAR_VARIABLE unzombie_store[$i].variables.infected_type}
                [unstore_unit]
                    variable=unzombie_store[$i]
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE unzombie_store}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special_id=incinerate
        [/filter_attack]
        {VARIABLE second_unit.status.incinerated yes}
        {VARIABLE second_unit.variables.incinerator $unit.id}
        [if]
            [have_unit]
                find_in=second_unit
            [/have_unit]
            [then]
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]

                {VARIABLE is_red no}
                [foreach]
                    array=second_unit.modifications.object
                    [do]
                        [if]
                            [variable]
                                name=this_item.incineration
                                equals=yes
                            [/variable]
                            [then]
                                {VARIABLE is_red yes}
                            [/then]
                        [/if]
                    [/do]
                [/foreach]
                [if]
                    [variable]
                        name=is_red
                        equals=no
                    [/variable]
                    [then]
                        [object]
                            silent=yes
                            sort=potion-like
                            remove_on_heal=yes
                            incineration=yes
                            [filter]
                                find_in=second_unit
                            [/filter]
                            [effect]
                                apply_to=image_mod
                                add="CS(100,50,0)"
                            [/effect]
                        [/object]
                    [/then]
                [/if]
                {CLEAR_VARIABLE is_red}
            [/then]
        [/if]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no
        [filter_second_attack]
            special_id=incinerate
        [/filter_second_attack]
        {VARIABLE unit.status.incinerated yes}
        {VARIABLE unit.variables.incinerator $second_unit.id}
        [if]
            [have_unit]
                find_in=unit
            [/have_unit]
            [then]
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]

                {VARIABLE is_red no}
                [foreach]
                    array=unit.modifications.object
                    [do]
                        [if]
                            [variable]
                                name=this_item.incineration
                                equals=yes
                            [/variable]
                            [then]
                                {VARIABLE is_red yes}
                            [/then]
                        [/if]
                    [/do]
                [/foreach]
                [if]
                    [variable]
                        name=is_red
                        equals=no
                    [/variable]
                    [then]
                        [object]
                            silent=yes
                            sort=potion-like
                            remove_on_heal=yes
                            incineration=yes
                            [filter]
                                find_in=unit
                            [/filter]
                            [effect]
                                apply_to=image_mod
                                add="CS(100,50,0)"
                            [/effect]
                        [/object]
                    [/then]
                [/if]
                {CLEAR_VARIABLE is_red}
            [/then]
        [/if]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                status=incinerated
                [filter_side]
                    side=$side_number
                [/filter_side]
                [and]
                    [filter_adjacent]   # Next to healer
                        ability=healing
                        is_enemy=no
                    [/filter_adjacent]
                    [or]
                        [filter_location]  # In a village
                            terrain=*^V*
                        [/filter_location]
                    [/or]
                    [or]
                        ability_type_active=regenerate
                    [/or]
                [/and]
            [/filter]
            variable=unburn_store
            kill=yes
        [/store_unit]
        [for]
            array=unburn_store
            [do]
                {REMOVE_INCINERATION unburn_store[$i]}
                [unstore_unit]
                    variable=unburn_store[$i]
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE unburn_store}
        [store_unit]
            [filter]
                status=incinerated
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
                [and]
                    [filter_wml]
                        hitpoints=1
                    [/filter_wml]
                [/and]
            [/filter]
            variable=burn_store
            kill=no
        [/store_unit]
        [for]
            array=burn_store
            variable=burnt  # Something in the kill messes with default variable i when it's Lilith that dies
            [do]
                [award_extra_experience] # Do this before kill, as these may be lost when unit killed (Lilith, at least)
                    id=$burn_store[$burnt].variables.incinerator
                    death_of_level=$burn_store[$burnt].level
                    defer=no
                [/award_extra_experience]
                [kill]
                    id=$burn_store[$burnt].id
                    [secondary_unit]
                        id=$burn_store[$burnt].variables.incinerator
                    [/secondary_unit]
                    animate=yes
                    fire_event=yes
                [/kill]
            [/do]
        [/for]
        {CLEAR_VARIABLE burn_store}
        [store_unit]
            [filter]
                status=incinerated
                [and]
                    [filter_side]
                        side=$side_number
                    [/filter_side]
                [/and]
            [/filter]
            variable=burn_store
            kill=no
        [/store_unit]
        [for]
            array=burn_store
            [do]
                {VARIABLE burn_store[$i].resting no}
                [unstore_unit]
                    variable=burn_store[$i]
                [/unstore_unit]
                [harm_unit]
                    [filter]
                        id=$burn_store[$i].id
                    [/filter]
                    amount=16
                    damage_type=fire
                    fire_event=yes
                    kill=no
                    animate=no
                [/harm_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE burn_store}
    [/event]
    [event]
        name=victory
        [store_unit]
            [filter]
                status=incinerated
            [/filter]
            variable=unburn_store
            kill=yes
        [/store_unit]
        [for]
            array=unburn_store
            [do]
                {REMOVE_INCINERATION unburn_store[$i]}
                [unstore_unit]
                    variable=unburn_store[$i]
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE unburn_store}
    [/event]
    [event]
        name=post_advance
        # Workaround for advancement clearing unit.status.incinerated but not modifications.object.incineration
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit_store
            kill=yes
        [/store_unit]
        {REMOVE_INCINERATION unit_store[0]}
        [unstore_unit]
            variable=unit_store[0]
            find_vacant=no
        [/unstore_unit]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            [not]
                status=undrainable
            [/not]
        [/filter]

        [filter_second]
            ability=feeding_easy
        [/filter_second]

        [unstore_unit]
            variable=second_unit
            {COLOR_HEAL}
            text= _ "+1 max HP"
            find_vacant=no
        [/unstore_unit]

        [object]
            silent=yes
            duration=forever

            [filter]
                x,y=$x2,$y2
            [/filter]

            [effect]
                apply_to=hitpoints
                increase_total=1
                increase=1
            [/effect]
        [/object]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=extra damage 5 impact
        [/filter_attack]
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=5
            damage_type=impact
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=extra damage 5 impact
        [/filter_second_attack]
        [harm_unit_loti]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=5
            damage_type=impact
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=mayhem
        [/filter_attack]
        [set_briskness_intensity]
            id=$second_unit.id
            sub=1
        [/set_briskness_intensity]
        [floating_text]
            x,y=$x2,$y2
            text=_"<span color='red'>" + _ "-1 attacks" + "</span>"
        [/floating_text]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=trickery
        [/filter_attack]
        [set_elusiveness_intensity]
            id=$second_unit.id
            sub=5
        [/set_elusiveness_intensity]
        [floating_text]
            x,y=$x2,$y2
            text="<span color='red'>" + _ "-5% defence" + "</span>"
        [/floating_text]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=doom
        [/filter_attack]
        [set_resolve_intensity]
            id=$second_unit.id
            sub=5
        [/set_resolve_intensity]
        [floating_text]
            x,y=$x2,$y2
            text="<span color='red'>" + _ "-5% all resistances" + "</span>"
        [/floating_text]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=whirlwind
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE has_leech 0}
        {VARIABLE has_drain 0}
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        [foreach]
            array=weapon.specials.damage
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=leeches
                    [/variable]
                    [then]
                        {VARIABLE has_leech yes}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [if]
            [variable]
                name=weapon.specials.drains.id
                equals=drains
            [/variable]
            [then]
                {VARIABLE has_drain yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        #{DEBUG "Whirlwind Hit: dmg $damage  leech $has_leech  poison $has_poison  drain $has_drain  slow $has_slow"}
        [if]
            [variable]
                name=has_leech
                not_equals=0
            [/variable]
            [or]
                [variable]
                    name=has_drain
                    not_equals=0
                [/variable]
            [/or]
            [then]
                [store_unit]    # We need to know how many units were hit, and what were their resistances
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [not]
                            x,y=$x2,$y2
                        [/not]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=units
                [/store_unit]
                {VARIABLE damage_to_leech 0}
                {VARIABLE damage_to_drain 0}
                [foreach]
                    array=units
                    [do]
                        [get_unit_resistance]
                            find_in=this_item
                            damage_type=$weapon.type
                            to_variable=secondary_resistance
                        [/get_unit_resistance]
                        [if]
                            [variable]
                                name=secondary_resistance
                                less_than=0
                            [/variable]
                            [then]
                                {VARIABLE secondary_resistance 100}
                            [/then]
                        [/if]
                        {VARIABLE secondary_damage $damage}
                        {VARIABLE_OP secondary_damage multiply $secondary_resistance}
                        [if]
                            [variable]
                                name=secondary_damage
                                greater_than=$($this_item.hitpoints*100)
                            [/variable]
                            [then]
                                {VARIABLE true_damage $this_item.hitpoints}
                                {VARIABLE_OP true_damage multiply 100}
                            [/then]
                            [else]
                                {VARIABLE true_damage $secondary_damage}
                            [/else]
                        [/if]
                        # Note: Damage that is too small to leech can be combined from multiple targets into a real hitpoint.
                        # Example: 4 damage to 3 targets. Each hit alone produces 0 leech gain, but all 3 together get 1 hitpoint.
                        [if]
                            [variable]
                                name=has_leech
                                not_equals=0
                            [/variable]
                            [then]
                                {VARIABLE_OP damage_to_leech add $true_damage}
                            [/then]
                        [/if]
                        # Drain
                        [if]
                            [variable]
                                name=this_item.status.undrainable
                                not_equals=yes
                            [/variable]
                            [and]
                                [variable]
                                    name=has_drain
                                    not_equals=0
                                [/variable]
                            [/and]
                            [then]
                                {VARIABLE_OP damage_to_drain add $true_damage}
                            [/then]
                        [/if]
                        #{DEBUG "Whirl loop unit at $units[$i].x,$units[$i].y  Resist $secondary_resistance  secD $secondary_damage  trueD $true_damage  damage_to_leech $damage_to_leech  damage_to_drain $damage_to_drain"}
                        {CLEAR_VARIABLE secondary_resistance,secondary_damage,true_damage}
                    [/do]
                [/foreach]
                [if]
                    [variable]
                        name=has_leech
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_leech}
                        # Divide by 100 to rescale, then 10% leech factor
                        {VARIABLE_OP healed_amount divide 1000}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "LeechAddition $damage_to_leech  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=has_drain
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_drain}
                        # Divide by 100 to rescale, then 50% drain factor
                        {VARIABLE_OP healed_amount divide 200}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "DrainAddition $damage_to_drain  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                {CLEAR_VARIABLE units}
                {CLEAR_VARIABLE damage_to_leech,damage_to_drain,healed_amount}
            [/then]
        [/if]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$damage
            damage_type=$weapon.type
            fire_event=yes
            poisoned=$has_poison
            slowed=$has_slow
            fire_attacker_hits=true
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
        {CLEAR_VARIABLE has_leech}
        {CLEAR_VARIABLE has_drain,damage}
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=chaos
        [/filter_second_attack]
        {INCORPORATE_EFFECTS_RETALIATION}
        {VARIABLE has_leech 0}
        {VARIABLE has_drain 0}
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        [foreach]
            array=second_weapon.specials.damage
            [do]
                [if]
                    [variable]
                        name=this_item.id
                        equals=leeches
                    [/variable]
                    [then]
                        {VARIABLE has_leech yes}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [if]
            [variable]
                name=second_weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=second_weapon.specials.drains.id
                equals=drains
            [/variable]
            [then]
                {VARIABLE has_drain yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=second_weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        #{DEBUG "Chaos Hit: dmg $damage  leech $has_leech  poison $has_poison  drain $has_drain  slow $has_slow"}
        [if]
            [variable]
                name=has_leech
                not_equals=0
            [/variable]
            [or]
                [variable]
                    name=has_drain
                    not_equals=0
                [/variable]
            [/or]
            [then]
                [store_unit]        # We need to know how many units were leeched, and what were their resistances
                    [filter]
                        [filter_adjacent]
                            x,y=$x2,$y2
                        [/filter_adjacent]
                        [not]
                            x,y=$x1,$y1
                        [/not]
                        [filter_side]
                            [enemy_of]
                                side=$second_unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=units
                [/store_unit]
                {VARIABLE damage_to_leech 0}
                {VARIABLE damage_to_drain 0}
                [foreach]
                    array=units
                    [do]
                        [get_unit_resistance]
                            find_in=this_item
                            damage_type=$weapon.type
                            to_variable=secondary_resistance
                        [/get_unit_resistance]
                        [if]
                            [variable]
                                name=secondary_resistance
                                less_than=0
                            [/variable]
                            [then]
                                {VARIABLE secondary_resistance 100}
                            [/then]
                        [/if]
                        {VARIABLE secondary_damage $damage}
                        {VARIABLE_OP secondary_damage multiply $secondary_resistance}
                        [if]
                            [variable]
                                name=secondary_damage
                                greater_than=$($this_item.hitpoints*100)
                            [/variable]
                            [then]
                                {VARIABLE true_damage $this_item.hitpoints}
                                {VARIABLE_OP true_damage multiply 100}
                            [/then]
                            [else]
                                {VARIABLE true_damage $secondary_damage}
                            [/else]
                        [/if]
                        # Note: Damage that is too small to leech can be combined from multiple targets into a real hitpoint.
                        # Example: 4 damage to 3 targets. Each hit alone produces 0 leech gain, but all 3 together get 1 hitpoint.
                        [if]
                            [variable]
                                name=has_leech
                                not_equals=0
                            [/variable]
                            [then]
                                {VARIABLE_OP damage_to_leech add $true_damage}
                            [/then]
                        [/if]
                        # Drain
                        [if]
                            [variable]
                                name=this_item.status.undrainable
                                not_equals=yes
                            [/variable]
                            [and]
                                [variable]
                                    name=has_drain
                                    not_equals=0
                                [/variable]
                            [/and]
                            [then]
                                {VARIABLE_OP damage_to_drain add $true_damage}
                            [/then]
                        [/if]
                        #{DEBUG "Chaos loop unit at $units[$i].x,$units[$i].y  Resist $secondary_resistance  secD $secondary_damage  trueD $true_damage  damage_to_leech $damage_to_leech  damage_to_drain $damage_to_drain"}
                        {CLEAR_VARIABLE secondary_resistance,secondary_damage,true_damage}
                    [/do]
                [/foreach]
                [if]
                    [variable]
                        name=has_leech
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_leech}
                        # Divide by 100 to rescale, then 10% leech factor
                        {VARIABLE_OP healed_amount divide 1000}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "Chaos LeechAddition $damage_to_leech  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x2,$y2
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=has_drain
                        not_equals=0
                    [/variable]
                    [then]
                        {VARIABLE healed_amount $damage_to_drain}
                        # Divide by 100 to rescale, then 50% drain factor
                        {VARIABLE_OP healed_amount divide 200}
                        {VARIABLE_OP healed_amount round 0}
                        #{DEBUG "Chaos DrainAddition $damage_to_drain  real heal $healed_amount"}
                        [heal_unit]
                            [filter]
                                x,y=$x2,$y2
                            [/filter]
                            amount=$healed_amount
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {CLEAR_VARIABLE healed_amount}
                    [/then]
                [/if]
                {CLEAR_VARIABLE units}
                {CLEAR_VARIABLE damage_to_leech,damage_to_drain,healed_amount}
            [/then]
        [/if]
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    x,y=$x1,$y1
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$second_unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=$($damage/2)
            damage_type=$second_weapon.type
            fire_event=yes
            poisoned=$has_poison
            slowed=$has_slow
            fire_defender_hits=true
        [/harm_unit_loti]
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
        {CLEAR_VARIABLE has_leech}
        {CLEAR_VARIABLE has_drain,damage}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special_id=kamikaze sprint
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        {VARIABLE opponent_damage $second_weapon.damage}
        {VARIABLE_OP opponent_damage multiply $second_weapon.number}
        [if]
            [variable]
                name=unit.hitpoints
                greater_than=$opponent_damage
            [/variable]
            [then]
                [if]
                    [variable]
                        name=opponent_damage
                        greater_than_equal_to=1
                    [/variable]
                    [then]
                        [harm_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=$opponent_damage
                            damage_type=$second_weapon.type
                            fire_event=no
                            kill=yes
                        [/harm_unit]
                    [/then]
                [/if]
                [store_unit]
                    [filter]
                        find_in=unit
                    [/filter]
                    variable=attacker
                    kill=no
                [/store_unit]
                [store_locations]
                    [filter_adjacent_location]
                        x,y=$second_unit.x,$second_unit.y
                        adjacent=-$attacker.facing
                    [/filter_adjacent_location]

                    variable=pierce_target_hex
                [/store_locations]
                [while]
                    [have_unit]
                        x,y=$pierce_target_hex.x,$pierce_target_hex.y
                    [/have_unit]
                    [do]
                        {VARIABLE_OP damage divide 2}
                        [harm_unit_loti]
                            [filter]
                                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                                [filter_side]
                                    [enemy_of]
                                        side=$unit.side
                                    [/enemy_of]
                                [/filter_side]
                            [/filter]
                            [filter_second]
                                find_in=unit
                            [/filter_second]
                            amount=$damage
                            damage_type=$weapon.type
                            fire_event=yes
                            kill=yes
                            fire_attacker_hits=true
                        [/harm_unit_loti]
                        [store_locations]
                            [filter_adjacent_location]
                                x,y=$pierce_target_hex.x,$pierce_target_hex.y
                                adjacent=-$attacker.facing
                            [/filter_adjacent_location]

                            variable=pierce_target_hex
                        [/store_locations]
                    [/do]
                [/while]
                [store_unit]
                    [filter]
                        find_in=unit
                    [/filter]
                    variable=attacker
                    kill=yes
                [/store_unit]
                {VARIABLE attacker.x $pierce_target_hex.x}
                {VARIABLE attacker.y $pierce_target_hex.y}
                [unstore_unit]
                    variable=attacker
                    find_vacant=yes
                    check_passability=yes
                [/unstore_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=second_unit.hitpoints
                less_than=1
            [/variable]
            [then]
                [kill]
                    find_in=second_unit
                    [secondary_unit]
                        find_in=unit
                    [/secondary_unit]
                    animate=yes
                    fire_event=yes
                [/kill]
            [/then]
        [/if]
        # Doesn't seem to fire by itself
        [fire_event]
            name=attack_end
            [primary_unit]
                id=$unit.id
            [/primary_unit]
            [secondary_unit]
                id=$second_unit.id
            [/secondary_unit]
        [/fire_event]
        {CLEAR_VARIABLE damage,attacker}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=explosive leech
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        [store_unit]		#We need to know how many units are leeched, and what are their resistances
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            variable=units
        [/store_unit]
        {VARIABLE healed_amount 0}
        [foreach]
            array=units
            [do]
                [switch]
                    variable=weapon.type
                    [case]
                        value=arcane
                        {VARIABLE_OP healed_amount add "$($this_item.resistance.arcane*$damage)"}
                    [/case]
                    [case]
                        value=fire
                        {VARIABLE_OP healed_amount add "$($this_item.resistance.fire*$damage)"}
                    [/case]
                    [case]
                        value=cold
                        {VARIABLE_OP healed_amount add "$($this_item.resistance.cold*$damage)"}
                    [/case]
                    [case]
                        value=blade
                        {VARIABLE_OP healed_amount add "$($this_item.resistance.blade*$damage)"}
                    [/case]
                    [case]
                        value=pierce
                        {VARIABLE_OP healed_amount add "$($this_item.resistance.pierce*$damage)"}
                    [/case]
                    [case]
                        value=impact
                        {VARIABLE_OP healed_amount add "$($this_item.resistance.impact*$damage)"}
                    [/case]
                [/switch]
            [/do]
        [/foreach]
        [floating_text]
            x,y=$x1,$y1
            text=_ "<span color='#00FF00'>$($healed_amount/400)</span>"
        [/floating_text]
        [heal_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount=$($healed_amount/400)
            animate=no
            restore_statuses=no
        [/heal_unit]
        {CLEAR_VARIABLE units}
        {CLEAR_VARIABLE healed_amount}
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage/4)
            damage_type=$weapon.type
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        {CLEAR_VARIABLE damage}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special_id=explosive
        [/filter_attack]
        {VARIABLE has_poison no}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        {INCORPORATE_EFFECTS}
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2
                [/not]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($($damage*3)/4-4)
            damage_type=$weapon.type
            fire_event=yes
            poisoned=$has_poison
            fire_attacker_hits=true
        [/harm_unit_loti]
        [if]
            [variable]
                name=damage
                greater_than=24	# If the damage is high enough, the range is increased.
            [/variable]
            [then]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=1
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=2
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]

                    amount=$($($damage*3)/4-18)
                    damage_type=$weapon.type
                    fire_event=yes
                    animate=no
                    poisoned=$has_poison
                    fire_attacker_hits=true
                [/harm_unit_loti]
            [/then]
        [/if]
        [if]
            [variable]
                name=damage
                greater_than=48		# If the damage is extremely high, the range is increased even more.
            [/variable]
            [then]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=2
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=3
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$($($damage)/2-24)
                    damage_type=$weapon.type
                    fire_event=yes
                    animate=no
                    poisoned=$has_poison
                    fire_attacker_hits=true
                [/harm_unit_loti]
            [/then]
        [/if]
        [if]
            [variable]
                name=damage
                greater_than=108		# If the damage is higher than most common attacks can get, the range is increased even even more.
            [/variable]
            [then]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=3
                            [/not]
                            # Include the remaining units within four hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=4
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$($($damage)/3-36)
                    damage_type=$weapon.type
                    fire_event=yes
                    animate=no
                    poisoned=$has_poison
                    fire_attacker_hits=true
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE damage,has_poison}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special_id=explosive unprotected
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        [harm_unit_loti]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2
                [/not]
                [not]
                    x,y=$x1,$y1
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($($damage*3)/4-4)
            damage_type=$weapon.type
            fire_event=yes
            fire_attacker_hits=true
        [/harm_unit_loti]
        {CLEAR_VARIABLE damage}
    [/event]
    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special_id=mind raid
        [/filter_attack]
        [if]
            [variable]
                name=second_unit.experience
                greater_than_equal_to=2
            [/variable]
            [then]
                {VARIABLE_OP second_unit.experience sub 2}
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]
                [award_extra_experience]
                    find_in=unit
                    experience=2
                    defer=yes
                [/award_extra_experience]
            [/then]
            [else]
                [award_extra_experience]
                    find_in=unit
                    experience=$second_unit.experience
                    defer=yes
                [/award_extra_experience]
                {VARIABLE second_unit.experience 0}
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                [/unstore_unit]
            [/else]
        [/if]
    [/event]
    [event]
        name=defender_hits
        first_time_only=no

        [filter_attack]
            special_id=mind raid
        [/filter_attack]
        [if]
            [variable]
                name=unit.experience
                greater_than_equal_to=2
            [/variable]
            [then]
                {VARIABLE_OP unit.experience sub 2}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [award_extra_experience]
                    find_in=second_unit
                    experience=2
                    defer=yes
                [/award_extra_experience]
            [/then]
            [else]
                [award_extra_experience]
                    find_in=second_unit
                    experience=$unit.experience
                    defer=yes
                [/award_extra_experience]
                {VARIABLE unit.experience 0}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
            [/else]
        [/if]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special_id=leeches
            [not]
                special_id=furious
            [/not]
        [/filter_attack]
        [set_variable]
            name=damage_dealt
            value=$damage_inflicted
        [/set_variable]
        [set_variable]
            name=damage_dealt
            divide=10
            round=ceil
        [/set_variable]
        [heal_unit]
            [filter]
                id=$unit.id
            [/filter]
            amount=$damage_dealt
            animate=yes
            restore_statuses=no
        [/heal_unit]
        {CLEAR_VARIABLE damage_dealt}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=leeches
            [not]
                special_id=furious
            [/not]
        [/filter_second_attack]
        [set_variable]
            name=damage_dealt
            value=$damage_inflicted
        [/set_variable]
        [set_variable]
            name=damage_dealt
            divide=10
            round=ceil
        [/set_variable]
        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=$damage_dealt
            animate=yes
            restore_statuses=no
        [/heal_unit]
        {CLEAR_VARIABLE damage_dealt}
    [/event]

    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special_id=explosive slow
        [/filter_attack]
        [harm_unit]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [filter_side]
                    [enemy_of]
                        side=$unit.side
                    [/enemy_of]
                [/filter_side]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=2
            slowed=yes
            damage_type=$weapon.type
            fire_event=yes
            kill=no
            experience=no
        [/harm_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=supreme murderlust
        [/filter_second]
        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=8
            animate=yes
            restore_statuses=yes
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=murderlust
            side=$side_number
        [/filter_second]
        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=8
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=killhunger
        [/filter_second]
        [heal_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            amount=4
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=lesser evisceration
        [/filter_second]
        [heal_unit]
            [filter]
                [filter_adjacent]
                    id=$second_unit.id
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            amount=4
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=evisceration
        [/filter_second]
        [heal_unit]
            [filter]
                [filter_adjacent]
                    id=$second_unit.id
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            amount=10
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=greater evisceration
        [/filter_second]
        [heal_unit]
            [filter]
                [filter_adjacent]
                    id=$second_unit.id
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            amount=16
            animate=yes
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter_second]
            ability=shade armour
        [/filter_second]
        [if]
            [variable]
                name=second_unit.variables.shade_armour_intensity
                greater_than_equal_to=0
            [/variable]
            [then]
                [if]
                    [variable]
                        name=second_unit.variables.shade_armour_intensity
                        less_than=2
                    [/variable]
                    [then]
                        {VARIABLE_OP second_unit.variables.shade_armour_intensity add 1}
                    [/then]
                [/if]
            [/then]
            [else]
                {VARIABLE second_unit.variables.shade_armour_intensity 1}
            [/else]
        [/if]
        [unstore_unit]
            variable=second_unit
            find_vacant=no
        [/unstore_unit]
    [/event]
    [event]
        name=last breath
        first_time_only=no
        [filter]
            race=undead
        [/filter]
        [filter_second_attack]
            special_id=purify
        [/filter_second_attack]
        {VARIABLE transform_type null}
        [if]
            [variable]
                name=unit.type
                contains=Skeleton
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Deathblade
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Revenant
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Revenant LotI
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Walking Corpse
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Soulless
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Death Knight LotI
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Draug
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Grim Knight
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Death Knight
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Deathlord
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Lich King
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Phantom
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Ghoul
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Ghast
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Necrophage
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Abomination
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Monstrosity
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Spearman,Heavy Infantryman,Elvish Fighter,Fencer,Thug,Footpad)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Chocobone
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Grim Knight
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Chocobone LotI
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Zombie Rider
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Cavalryman,Horseman,Elvish Scout)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Bone Shooter
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Skeleton Archer
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Soul Shooter
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Soul Shooter LotI
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Banebow
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Bowman,Elvish Archer,Poacher)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Lich
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Ancient Lich
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Ancient Lich LotI
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Mage,Elvish Shaman)}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.type
                contains=Ghost
            [/variable]
            [or]
                [variable]
                    name=unit.type
                    contains=Wraith
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Spectre
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Shadow
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Nightgaunt
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Reaper
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.type
                    contains=Dark Shade
                [/variable]
            [/or]
            [then]
                {VARIABLE_OP transform_type rand (Spearman,Heavy Infantryman,Elvish Fighter,Fencer,Thug,Footpad,Cavalryman,Horseman,Elvish Scout,Bowman,Elvish Archer,Poacher,Mage,Elvish Shaman)}
            [/then]
        [/if]
        [if]
            [variable]
                name=transform_type
                not_equals=null
            [/variable]
            [then]
                [fire_event]
                    name=die
                    [primary_unit]
                        find_in=unit
                    [/primary_unit]
                    [secondary_unit]
                        find_in=second_unit
                    [/secondary_unit]
                [/fire_event]
                {CLEAR_VARIABLE unit.modifications.trait}
                {CLEAR_VARIABLE unit.modifications.object}
                {CLEAR_VARIABLE unit.status}
                {CLEAR_VARIABLE unit.variables}
                {CLEAR_VARIABLE unit.modifications.advancement}
                {VARIABLE unit.hitpoints $unit.max_hitpoints}
                {VARIABLE unit.type $transform_type}
                {VARIABLE unit.side $second_unit.side}
                [if]
                    [variable]
                        name=transform_type
                        equals=Elvish Shaman
                    [/variable]
                    [then]
                        {VARIABLE unit.gender female}
                    [/then]
                [/if]
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                {UPDATE_STATS}
                [delay]
                    time=800
                [/delay]
                [floating_text]
                    text=_"What happened to me...?"
                    x,y=$x1,$y1
                [/floating_text]
                [delay]
                    time=500
                [/delay]
                [floating_text]
                    text=_"I have put an end to your unlife."
                    x,y=$x2,$y2
                [/floating_text]
                [delay]
                    time=500
                [/delay]
                [floating_text]
                    text=_"Thank you."
                    x,y=$x1,$y1
                [/floating_text]
            [/then]
        [/if]
        {CLEAR_VARIABLE transform_type}
    [/event]
    [event]
        name=attack end
        first_time_only=no

        [filter]
            [filter_adjacent]
                ability=push
                is_enemy=no
            [/filter_adjacent]
        [/filter]
        {VARIABLE_OP unit.moves add 1}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            variable=hiders
            [filter]
                side=$side_number
                ability=shade armour
                ability_type_active=hides
            [/filter]
        [/store_unit]
        [foreach]
            array=hiders
            [do]
                [if]
                    [variable]
                        name=this_item.variables.shade_armour_intensity
                        greater_than_equal_to=0
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=this_item.variables.shade_armour_intensity
                                less_than=5
                            [/variable]
                            [then]
                                {VARIABLE_OP this_item.variables.shade_armour_intensity add 1}
                            [/then]
                        [/if]
                    [/then]
                    [else]
                        {VARIABLE this_item.variables.shade_armour_intensity 1}
                    [/else]
                [/if]
                [unstore_unit]
                    variable=this_item
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE hiders}
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            variable=hiders
            [filter]
                side=$side_number
                ability=shade armour
                [not]
                    ability_type_active=hides
                [/not]
            [/filter]
        [/store_unit]
        [foreach]
            array=hiders
            [do]
                [if]
                    [variable]
                        name=this_item.variables.shade_armour_intensity
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE_OP this_item.variables.shade_armour_intensity sub 1}
                    [/then]
                [/if]
                [unstore_unit]
                    variable=this_item
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE hiders}
    [/event]
    [event]
        name=turn refresh
        id=propel
        first_time_only=no
        [store_unit]
            variable=runners
            [filter]
                side=$side_number
                [filter_adjacent]
                    ability=propel
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
        [/store_unit]
        [foreach]
            array=runners
            [do]
                {VARIABLE this_item.max_moves "$($this_item.max_moves + 2)"}
                [unstore_unit]
                    variable=this_item
                    x,y=$this_item.x,$this_item.y
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE runners}
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                [filter_adjacent]
                    ability=wardrums
                    side=$side_number
                [/filter_adjacent]
                side=$side_number
            [/filter]
            variable=drummed
            kill=no
        [/store_unit]
        [for]
            array=drummed
            [do]
                {VARIABLE_OP drummed[$i].moves add 2}
                [unstore_unit]
                    variable=drummed[$i]
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE drummed}
    [/event]
    [event]
        name=attack end
        first_time_only=no
        [filter]
            ability=penetrate
        [/filter]
        {VARIABLE_OP unit.moves add 1}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]
    [event]
        name=attack end
        first_time_only=no

        [filter_attack]
            special_id=hit and run
        [/filter_attack]
        {VARIABLE_OP unit.moves add "$($unit.max_moves/2)"}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=no
        [/unstore_unit]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no

        [filter_second]
            ability=absorb
        [/filter_second]
        {VARIABLE value 0}
        [for]
            array=second_unit.abilities.dummy
            [do]
                [if]
                    [variable]
                        name=second_unit.abilities.dummy[$i].id
                        equals=absorb
                    [/variable]
                    [then]
                        {VARIABLE value $second_unit.abilities.dummy[$i].value}
                    [/then]
                [/if]
            [/do]
        [/for]
        [if]
            [variable]
                name=second_unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                [heal_unit]
                    animate=no
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    amount=$value
                    restore_statuses=no
                [/heal_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE value}
    [/event]
    [event]
        name=defender hits
        first_time_only=no

        [filter]
            ability=absorb
        [/filter]
        [filter_attack]
            [not]
                special_id=furious
            [/not]
        [/filter_attack]
        {VARIABLE value 0}
        [for]
            array=unit.abilities.dummy
            [do]
                [if]
                    [variable]
                        name=unit.abilities.dummy[$i].id
                        equals=absorb
                    [/variable]
                    [then]
                        {VARIABLE value $unit.abilities.dummy[$i].value}
                    [/then]
                [/if]
            [/do]
        [/for]
        [if]
            [variable]
                name=unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                [heal_unit]
                    animate=no
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=$value
                    restore_statuses=no
                [/heal_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE value}
    [/event]
    [event]		#For the Cloak of Burning Retribution
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=retribution
        [/filter_second]
        [harm_unit_loti]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=$($damage_inflicted/4)
            damage_type=fire
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            [filter_adjacent]
                ability=spell eater
                is_enemy=no
            [/filter_adjacent]
        [/filter_second]
        [filter_attack]
            type=arcane
            [or]
                type=fire
            [/or]
            [or]
                type=cold
            [/or]
        [/filter_attack]
        [store_unit]
            [filter]
                ability=spell eater
                [filter_adjacent]
                    find_in=second_unit
                [/filter_adjacent]
            [/filter]
            variable=eaters
        [/store_unit]
        [foreach]
            array=eaters
            [do]
                [object]
                    silent=yes
                    duration=forever
                    sort=potion_like
                    remove_on_heal=yes
                    [filter]
                        find_in=this_item
                    [/filter]
                    [effect]
                        apply_to=resistance
                        replace=false
                        [resistance]
                            fire=-2
                            cold=-2
                            arcane=-2
                            impact=-2
                            blade=-2
                            pierce=-2
                        [/resistance]
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase_total=4
                        increase=8
                    [/effect]
                    [effect]
                        apply_to=attack
                        increase_damage=1
                    [/effect]
                [/object]
                [floating_text]
                    x,y=$this_item.x,$this_item.y
                    {COLOR_HEAL}
                    text=_"+2 resist / +8 HP / +4 MAX_HP / +1 damage"
                [/floating_text]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE eaters}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            [filter_adjacent]
                ability=blood drinking
            [/filter_adjacent]
        [/filter_second]
        {VARIABLE drunk "$(0.05*$damage_inflicted)"}
        [store_unit]
            [filter]
                ability=blood drinking
                [filter_adjacent]
                    find_in=second_unit
                [/filter_adjacent]
            [/filter]
            variable=drinkers
            kill=no
        [/store_unit]
        [foreach]
            array=drinkers
            [do]
                [fire_event]
                    name=blood drinking
                    [primary_unit]
                        find_in=this_item
                    [/primary_unit]
                [/fire_event]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE drinkers}
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            [filter_adjacent]
                ability=blood drinking
            [/filter_adjacent]
        [/filter]
        {VARIABLE drunk "$(0.05*$damage_inflicted)"}
        [store_unit]
            [filter]
                ability=blood drinking
                [filter_adjacent]
                    find_in=unit
                [/filter_adjacent]
            [/filter]
            variable=drinkers
            kill=no
        [/store_unit]
        [foreach]
            array=drinkers
            [do]
                [fire_event]
                    name=blood drinking
                    [primary_unit]
                        find_in=this_item
                    [/primary_unit]
                [/fire_event]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE drinkers}
    [/event]
    [event]
        name=blood drinking
        first_time_only=no
        [if]
            [variable]
                name=drunk
                greater_than=1
            [/variable]
            [else]
                {VARIABLE drunk 1}
            [/else]
        [/if]
        [heal_unit]
            [filter]
                find_in=unit
            [/filter]
            amount=$drunk
            animate=yes
            restore_statuses=no
        [/heal_unit]
        {CLEAR_VARIABLE drunk}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=sense of purpose
        [/filter_attack]
        [set_precision_intensity]
            id=$unit.id
            add=1
        [/set_precision_intensity]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=sense of purpose
        [/filter_second_attack]
        [set_precision_intensity]
            id=$second_unit.id
            add=1
        [/set_precision_intensity]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter_second_attack]
            special_id=killjoy
        [/filter_second_attack]
        [set_briskness_intensity]
            id=$second_unit.id
            add=1
        [/set_briskness_intensity]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special_id=whirlwind
            [or]
                special_id=explosive
            [/or]
        [/filter_attack]
        [fire_event]
            name=dooming lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special_id=cleave
        [/filter_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special_id=hose
            [or]
                special_id=storm
            [/or]
        [/filter_attack]
        [fire_event]
            name=devastating lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special_id=cone
            [or]
                special_id=explosive leech
            [/or]
        [/filter_attack]
        [fire_event]
            name=crippling lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special_id=explosive unprotected
        [/filter_attack]
        [fire_event]
            name=wrecking lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special_id=massive missile
        [/filter_attack]
        [set_wrath_intensity]
            id=$unit.id
            sub=6
        [/set_wrath_intensity]
    [/event]

    [event]
        name=attack end
        first_time_only=no
        [filter_second_attack]
            special_id=chaos
        [/filter_second_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            ability=wrath
            [or]
                [filter_adjacent]
                    ability=hate speech
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter]
        [set_wrath_intensity]
            id=$unit.id
            add=1
        [/set_wrath_intensity]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=raging resolve
        [/filter_attack]
        [set_resolve_intensity]
            id=$unit.id
            add=1
        [/set_resolve_intensity]
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=raging resolve
        [/filter_second_attack]
        [set_resolve_intensity]
            id=$second_unit.id
            add=1
        [/set_resolve_intensity]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=revulsion
        [/filter_second]
        [set_resolve_intensity]
            id=$unit.id
            sub=5
        [/set_resolve_intensity]
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=revulsion
        [/filter]
        [set_resolve_intensity]
            id=$second_unit.id
            sub=5
        [/set_resolve_intensity]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=innocence
        [/filter_second]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=innocence
        [/filter]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=triggerable
        [/filter_second]
        [set_wrath_intensity]
            id=$second_unit.id
            add=1
        [/set_wrath_intensity]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            [filter_adjacent]
                ability=vindictive
            [/filter_adjacent]
        [/filter_second]
        [store_unit]
            [filter]
                ability=vindictive
                [filter_adjacent]
                    find_in=second_unit
                [/filter_adjacent]
            [/filter]
            variable=vindictors
        [/store_unit]
        [for]
            array=vindictors
            [do]
                [set_wrath_intensity]
                    id=$vindictors[$i].id
                    add=1
                [/set_wrath_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE vindictors}
    [/event]

    [event]
        name=lesser lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 1}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=lethargy
        [/filter_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=lethargy
        [/filter_second_attack]
        [fire_event]
            name=lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=lesser lethargy
        [/filter_attack]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=lesser lethargy
        [/filter_second_attack]
        [fire_event]
            name=lesser lethargy
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 2}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=debilitating lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 4}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=crippling lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 6}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=wrecking lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 8}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=dooming lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 10}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=devastating lethargy
        first_time_only=no
        {VARIABLE lethargy_amount 12}
        [fire_event]
            name=lethargy x
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
        {CLEAR_VARIABLE lethargy_amount}
    [/event]

    [event]
        name=lethargy x
        first_time_only=no
        [set_wrath_intensity]
            id=$unit.id
            sub=$lethargy_amount
        [/set_wrath_intensity]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=martyrdom
        [/filter_second]
        [fire_event]
            name=martyrdom
            [primary_unit]
                find_in=second_unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=martyrdom
        [/filter]
        [fire_event]
            name=martyrdom
            [primary_unit]
                find_in=unit
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=martyrdom
        first_time_only=no
        [store_unit]
            [filter]
                [filter_adjacent]
                    find_in=unit
                    is_enemy=no
                [/filter_adjacent]
            [/filter]
            variable=infuriated
        [/store_unit]
        [foreach]
            array=infuriated
            variable=infuriated_unit
            [do]
                [set_wrath_intensity]
                    id=$infuriated_unit.id
                    add=1
                [/set_wrath_intensity]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE infuriated}
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        # Decay of stackable status-like abilities
        [store_unit]
            [filter]
                side=$side_number
                ability=latent_wrath
            [/filter]
            variable=wrathful
        [/store_unit]
        [for]
            array=wrathful
            variable=h
            [do]
                [set_wrath_intensity]
                    id=$wrathful[$h].id
                    div=2
                [/set_wrath_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE wrathful}

        [store_unit]
            [filter]
                side=$side_number
                ability=latent_resolve
            [/filter]
            variable=resolve
        [/store_unit]
        [for]
            array=resolve
            variable=h
            [do]
                [set_resolve_intensity]
                    id=$resolve[$h].id
                    div=2
                [/set_resolve_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE resolve}

        [store_unit]
            [filter]
                side=$side_number
                ability=latent_elusiveness
            [/filter]
            variable=elusive
        [/store_unit]
        [for]
            array=elusive
            variable=h
            [do]
                [set_elusiveness_intensity]
                    id=$elusive[$h].id
                    div=2
                [/set_elusiveness_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE elusive}

        [store_unit]
            [filter]
                side=$side_number
                ability=latent_precision
            [/filter]
            variable=precise
        [/store_unit]
        [for]
            array=precise
            variable=h
            [do]
                [set_precision_intensity]
                    id=$precise[$h].id
                    div=2
                [/set_precision_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE precise}

        [store_unit]
            [filter]
                side=$side_number
                ability=latent_briskness_nonzero
            [/filter]
            variable=brisk
        [/store_unit]
        [for]
            array=brisk
            variable=h
            [do]
                [set_briskness_intensity]
                    id=$brisk[$h].id
                    div=2
                [/set_briskness_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE brisk}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                [filter_adjacent]
                    ability=relentless tide
                    side=$side_number
                [/filter_adjacent]
                side=$side_number
            [/filter]
            variable=fortified
            kill=no
        [/store_unit]
        [for]
            array=fortified
            [do]
                [set_resolve_intensity]
                    id=$fortified[$i].id
                    add=10
                [/set_resolve_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE fortified}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                ability=fueled by death
                side=$side_number
                [not]
                    x,y=recall,recall
                [/not]
            [/filter]
            variable=fueled
            kill=no
        [/store_unit]
        [for]
            array=fueled
            variable=i
            [do]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            id=$fueled[$i].id
                        [/filter_adjacent]
                    [/filter]
                    variable=drained
                    kill=no
                [/store_unit]
                {VARIABLE amount 0}
                [for]
                    array=drained
                    variable=j
                    [do]
                        [if]
                            [variable]
                                name=drained[$j].status.undrainable
                                equals=yes
                            [/variable]
                            [else]
                                [harm_unit]
                                    [filter]
                                        id=$drained[$j].id
                                    [/filter]
                                    amount=4
                                    fire_event=yes
                                    experience=no
                                    kill=no
                                    animate=no
                                [/harm_unit]
                            [/else]
                        [/if]
                        {VARIABLE_OP amount add 2}
                    [/do]
                [/for]
                {CLEAR_VARIABLE drained}
                {VARIABLE_OP amount div 2}
                [set_wrath_intensity]
                    id=$fueled[$i].id
                    add=$amount
                [/set_wrath_intensity]
                {CLEAR_VARIABLE amount}
            [/do]
        [/for]
        {CLEAR_VARIABLE fueled}
    [/event]

    [event]
        name=start,victory
        first_time_only=no

        [store_unit]
            [filter]
                ability=latent_wrath
            [/filter]
            variable=wrathful
        [/store_unit]
        [for]
            variable=h
            array=wrathful
            [do]
                [set_wrath_intensity]
                    id=$wrathful[$h].id
                    set=0
                [/set_wrath_intensity]
            [/do]
        [/for]
        {CLEAR_VARIABLE wrathful}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=unforgiving
        [/filter_second]
        {VARIABLE has_it false}
        [for]
            array=second_unit.variables.unforgiven
            [do]
                [if]
                    [variable]
                        name=second_unit.variables.unforgiven[$i].type
                        equals=$unit.type
                    [/variable]
                    [then]
                        {VARIABLE second_unit.variables.unforgiven[$i].left 5}
                        {VARIABLE has_it true}
                    [/then]
                [/if]
            [/do]
        [/for]
        [if]
            [variable]
                name=has_it
                equals=no
            [/variable]
            [then]
                [set_variables]
                    mode=append
                    name=second_unit.variables.unforgiven
                    [value]
                        type=$unit.type
                        left=5
                    [/value]
                [/set_variables]
                {VARIABLE second_unit.variables.unforgiving true}
            [/then]
        [/if]
        [unstore_unit]
            variable=second_unit
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE has_it}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            ability=unforgiving
            [filter_wml]
                [variables]
                    unforgiving=true
                [/variables]
            [/filter_wml]
        [/filter]
        {VARIABLE has_it false}
        [foreach]
            array=unit.variables.unforgiven
            variable=unforgiven_entry
            [do]
                [if]
                    [variable]
                        name=unforgiven_entry.type
                        equals=$second_unit.type
                    [/variable]
                    [then]
                        {VARIABLE has_it true}
                    [/then]
                [/if]
            [/do]
        [/foreach]
        [if]
            [variable]
                name=has_it
                boolean_equals=true
            [/variable]
            [then]
                [harm_unit_loti]
                    [filter]
                        find_in=second_unit
                    [/filter]
                    [filter_second]
                        find_in=unit
                    [/filter_second]
                    amount="$($weapon.damage/2)"
                    damage_type=fire
                    fire_event=yes
                    animate=no
                [/harm_unit_loti]
            [/then]
        [/if]
        {CLEAR_VARIABLE has_it}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                [filter_wml]
                    [variables]
                        unforgiving=true
                    [/variables]
                [/filter_wml]
                side=$side_number
                ability=unforgiving
            [/filter]
            variable=unforgiving
        [/store_unit]
        [for]
            array=unforgiving
            variable=i
            [do]
                {VARIABLE has_something false}
                [for]
                    array=unforgiving[$i].variables.unforgiven
                    variable=j
                    [do]
                        [if]
                            [variable]
                                name=unforgiving[$i].variables.unforgiven[$j].left
                                greater_than=1
                            [/variable]
                            [then]
                                {VARIABLE_OP unforgiving[$i].variables.unforgiven[$j].left sub 1}
                                {VARIABLE has_something true}
                            [/then]
                            [else]
                                {CLEAR_VARIABLE unforgiving[$i].variables.unforgiven[$j]}
                            [/else]
                        [/if]
                    [/do]
                [/for]
                [if]
                    [variable]
                        name=has_something
                        equals=no
                    [/variable]
                    [then]
                        {CLEAR_VARIABLE unforgiving[$i].variables.unforgiving}
                    [/then]
                [/if]
                [unstore_unit]
                    variable=unforgiving[$i]
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/for]
        {CLEAR_VARIABLE unforgiving,has_something}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                ability=eats walking corpses
            [/filter]
            variable=eaters
        [/store_unit]
        [foreach]
            array=eaters
            variable=eater
            [do]
                [store_unit]
                    [filter]
                        side=$eater.side
                        type=Walking Corpse
                        [filter_adjacent]
                            find_in=eater
                        [/filter_adjacent]
                    [/filter]
                    variable=eaten
                [/store_unit]
                [if]
                    [variable]
                        name=eaten.length
                        greater_than_equal_to=1
                    [/variable]
                    [then]
                        [kill]
                            find_in=eaten[0]
                            animate=yes
                            fire_event=yes
                        [/kill]
                        {VARIABLE eater.status.was_fed yes}
                    [/then]
                    [else]
                        {CLEAR_VARIABLE eater.status.was_fed}
                    [/else]
                [/if]
                [unstore_unit]
                    variable=eater
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE eaters,eaten}
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=retribution
        [/filter]
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                find_in=unit
            [/filter_second]
            amount=$($damage_inflicted/4)
            damage_type=fire
            fire_event=yes
            animate=no
        [/harm_unit_loti]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=weak reflect
            [or]
                [filter_adjacent]
                    ability=weak reflect aura
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter_second]
        [harm_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=$($damage_inflicted/4)
            damage_type=$weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=weak reflect
            [or]
                [filter_adjacent]
                    ability=weak reflect aura
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter]
        [harm_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage_inflicted/4)
            damage_type=$second_weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=reflect
            [or]
                [filter_adjacent]
                    ability=reflect aura
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter_second]
        [harm_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=$($damage_inflicted/2)
            damage_type=$weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=reflect
            [or]
                [filter_adjacent]
                    ability=reflect aura
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter]
        [harm_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($damage_inflicted/2)
            damage_type=$second_weapon.type
            fire_event=yes
            experience=no
            animate=no
            kill=no
        [/harm_unit]
    [/event]
    [event]
        name=attacker hits
        id=electrical_discharge
        first_time_only=no
        [filter_second]
            ability=electrical_discharge
        [/filter_second]
        [if]
            [variable]
                name=weapon.range
                equals="melee"
            [/variable]
            [then]
                [harm_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [filter_second]
                        x,y=$x2,$y2
                    [/filter_second]
                    amount=$damage_inflicted
                    damage_type=lightning
                    fire_event=yes
                    experience=no
                    animate=no
                    kill=yes
                [/harm_unit]
            [/then]
        [/if]
    [/event]
    [event]
        name=defender hits
        id=electrical_discharge
        first_time_only=no
        [if]
            [variable]
                name=second_weapon.range
                equal=melee
            [/variable]
            [then]
                [harm_unit]
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=$damage_inflicted
                    damage_type=lightning
                    fire_event=yes
                    experience=no
                    animate=no
                    kill=yes
                [/harm_unit]
            [/then]
        [/if]
    [/event]
    [event]
        name=attack
        first_time_only=no
        [filter]
            ability=lesser redeem
        [/filter]
        [set_variables]
            name=random_code
            [value]
                rand=0..$second_unit.level
                name=did_succeed
            [/value]
            mode=replace
        [/set_variables]
        [insert_tag]
            name=set_variable
            variable=random_code
        [/insert_tag]
        {CLEAR_VARIABLE random_code}
        [if]
            [variable]
                name=did_succeed
                equals=0
            [/variable]
            [not]
                [variable]
                    name=bosses
                    contains=$second_unit.id
                [/variable]
            [/not]
            [then]
                [animate_unit]
                    flag=redeem_anim
                    [filter]
                        id=$unit.id
                    [/filter]
                    [facing]
                        x,y=$second_unit.x,$second_unit.y
                    [/facing]
                    hits=yes
                [/animate_unit]
                [kill]
                    id=$second_unit.id
                    [secondary_unit]
                        id=$unit.id
                    [/secondary_unit]
                    animate=no
                    fire_event=yes
                [/kill]
                [if]
                    [variable]
                        name=unit.variables.lesser_redeem_count
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE_OP unit.variables.lesser_redeem_count add 1}
                    [/then]
                    [else]
                        {VARIABLE unit.variables.lesser_redeem_count 1}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=unit.variables.lesser_redeem_level
                        greater_than=0
                    [/variable]
                    [else]
                        {VARIABLE unit.variables.lesser_redeem_level 1}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=unit.variables.max_lesser_redeem_count
                        greater_than=0
                    [/variable]
                    [else]
                        {VARIABLE unit.variables.max_lesser_redeem_count 5}
                        {VARIABLE count $unit.variables.lesser_redeem_level}
                        [while]
                            [variable]
                                name=count
                                greater_than=1
                            [/variable]
                            [do]
                                {VARIABLE_OP unit.variables.max_lesser_redeem_count multiply 3}
                                [set_variable]
                                    name=unit.variables.max_lesser_redeem_count
                                    divide=2
                                    round=floor
                                [/set_variable]
                                {VARIABLE_OP count sub 1}
                            [/do]
                        [/while]
                        {CLEAR_VARIABLE count}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=unit.variables.lesser_redeem_count
                        greater_than_equal_to=$unit.variables.max_lesser_redeem_count
                    [/variable]
                    [then]
                        {VARIABLE_OP unit.variables.lesser_redeem_level add 1}
                        {VARIABLE unit.variables.lesser_redeem_count 0}
                        {VARIABLE upgrade yes}
                        {VARIABLE unit.variables.max_lesser_redeem_count 0}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=upgrade
                        equals=yes
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=2
                            [/variable]
                            [then]
                                [set_variables]
                                    name=unit.modifications.advancement[$unit.modifications.advancement.length]
                                    [value]
                                        id=lesser_redeem1
                                        description= _ "LesserRedeem: 5 hps and +1 all damage"
                                        [effect]
                                            apply_to=hitpoints
                                            increase_total=5
                                            increase=5
                                        [/effect]
                                        [effect]
                                            apply_to=attack
                                            increase_damage=1
                                        [/effect]
                                    [/value]
                                    mode=replace
                                [/set_variables]
                                [floating_text]
                                    x,y=$x1,$y1
                                    text=_"LesserRedeem Level Up 1"
                                [/floating_text]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=3
                            [/variable]
                            [then]
                                [set_variables]
                                    name=unit.modifications.advancement[$unit.modifications.advancement.length]
                                    [value]
                                        id=lesser_redeem2
                                        description= _ "LesserRedeem: 3 hps and +3 resist all"
                                        [effect]
                                            apply_to=hitpoints
                                            increase_total=3
                                            increase=3
                                        [/effect]
                                        [effect]
                                            apply_to=resistance
                                            replace=false
                                            [resistance]
                                                blade=-3
                                                pierce=-3
                                                impact=-3
                                                arcane=-3
                                                fire=-3
                                                cold=-3
                                            [/resistance]
                                        [/effect]
                                    [/value]
                                    mode=replace
                                [/set_variables]
                                [floating_text]
                                    x,y=$x1,$y1
                                    text=_"LesserRedeem Level Up 2"
                                [/floating_text]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=4
                            [/variable]
                            [then]
                                [set_variables]
                                    name=unit.modifications.advancement[$unit.modifications.advancement.length]
                                    [value]
                                        id=lesser_redeem3
                                        description= _ "LesserRedeem: 2 hps, +2 resist all, +1 move"
                                        [effect]
                                            apply_to=hitpoints
                                            increase_total=2
                                            increase=2
                                        [/effect]
                                        [effect]
                                            apply_to=resistance
                                            replace=false
                                            [resistance]
                                                blade=-2
                                                pierce=-2
                                                impact=-2
                                                arcane=-2
                                                fire=-2
                                                cold=-2
                                            [/resistance]
                                        [/effect]
                                        [effect]
                                            apply_to=movement
                                            increase=1
                                        [/effect]
                                    [/value]
                                    mode=replace
                                [/set_variables]
                                [floating_text]
                                    x,y=$x1,$y1
                                    text=_"LesserRedeem Level Up 3"
                                [/floating_text]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=5
                            [/variable]
                            [then]
                                [set_variables]
                                    name=unit.modifications.advancement[$unit.modifications.advancement.length]
                                    [value]
                                        id=lesser_redeem4
                                        description= _ "LesserRedeem: +1 dmg, +2 resist all, penetrate blade, arcane and pierce"
                                        [effect]
                                            apply_to=attack
                                            increase_damage=1
                                        [/effect]
                                        [effect]
                                            apply_to=resistance
                                            replace=false
                                            [resistance]
                                                blade=-2
                                                pierce=-2
                                                impact=-2
                                                arcane=-2
                                                fire=-2
                                                cold=-2
                                            [/resistance]
                                        [/effect]
                                        blade_penetrate=5
                                        arcane_penetrate=5
                                        pierce_penetrate=5
                                    [/value]
                                    mode=replace
                                [/set_variables]
                                [floating_text]
                                    x,y=$x1,$y1
                                    text=_"LesserRedeem Level Up 4"
                                [/floating_text]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                equals=6
                            [/variable]
                            [then]
                                [set_variables]
                                    name=unit.modifications.advancement[$unit.modifications.advancement.length]
                                    [value]
                                        id=lesser_redeem5
                                        description= _ "LesserRedeem: 3 hps, penetrate fire, impact and cold"
                                        [effect]
                                            apply_to=hitpoints
                                            increase_total=3
                                            increase=3
                                        [/effect]
                                        fire_penetrate=5
                                        impact_penetrate=5
                                        cold_penetrate=5
                                    [/value]
                                    mode=replace
                                [/set_variables]
                                [floating_text]
                                    x,y=$x1,$y1
                                    text=_"LesserRedeem Level Up 5"
                                [/floating_text]
                            [/then]
                        [/if]
                        [if]
                            [variable]
                                name=unit.variables.lesser_redeem_level
                                greater_than=6
                            [/variable]
                            [then]
                                [set_variables]
                                    name=unit.modifications.advancement[$unit.modifications.advancement.length]
                                    [value]
                                        id=lesser_redeem6
                                        description= _ "LesserRedeem: 2 hps, +1 resist all, +2 penetrate all"
                                        [effect]
                                            apply_to=hitpoints
                                            increase_total=2
                                            increase=2
                                        [/effect]
                                        [effect]
                                            apply_to=resistance
                                            replace=false
                                            [resistance]
                                                blade=-1
                                                pierce=-1
                                                impact=-1
                                                arcane=-1
                                                fire=-1
                                                cold=-1
                                            [/resistance]
                                        [/effect]
                                        fire_penetrate=2
                                        impact_penetrate=2
                                        cold_penetrate=2
                                        blade_penetrate=2
                                        arcane_penetrate=2
                                        pierce_penetrate=2
                                    [/value]
                                    mode=replace
                                [/set_variables]
                                [floating_text]
                                    x,y=$x1,$y1
                                    text=_"LesserRedeem Level Up 6"
                                [/floating_text]
                            [/then]
                        [/if]
                    [/then]
                [/if]
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                    {COLOR_HEAL}
                    text="$unit.variables.lesser_redeem_count|/$unit.variables.max_lesser_redeem_count"
                    advance=no
                [/unstore_unit]
                {UPDATE_STATS}
                {CLEAR_VARIABLE upgrade,did_succeed}
            [/then]
        [/if]
    [/event]

    [event]
        name=attack
        first_time_only=no
        [filter_second]
            ability=regrowing
        [/filter_second]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x2,$y2
            [/filter]
            amount="$(2*$second_unit.level)"
            restore_statuses=no
        [/heal_unit]
    [/event]
    [event]
        name=attack
        first_time_only=no
        [filter]
            ability=regrowing
        [/filter]
        [heal_unit]
            animate=no
            [filter]
                x,y=$x1,$y1
            [/filter]
            amount="$(2*$unit.level)"
            restore_statuses=no
        [/heal_unit]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=thorns
            [or]
                [filter_adjacent]
                    ability=thorns aura
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter_second]
        [harm_unit_loti]
            [filter]
                x,y=$x1,$y1
            [/filter]
            [filter_second]
                x,y=$x2,$y2
            [/filter_second]
            amount=4
            damage_type=pierce
            fire_event=yes
            experience=yes
            animate=no
            kill=yes
        [/harm_unit_loti]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=thorns
            [or]
                [filter_adjacent]
                    ability=thorns aura
                    is_enemy=no
                [/filter_adjacent]
            [/or]
        [/filter]
        [harm_unit_loti]
            [filter]
                x,y=$x2,$y2
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=4
            damage_type=pierce
            fire_event=yes
            experience=yes
            animate=no
            kill=yes
        [/harm_unit_loti]
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability_type_active=aggressive_blood
        [/filter_second]
        [foreach]
            array=second_unit.abilities.aggressive_blood
            variable=aggressive_blood
            [do]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            [filter]
                                find_in=second_unit
                            [/filter]
                            radius=$aggressive_blood.radius
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$second_unit.side
                            [/enemy_of]
                        [/filter_side]
                        [not]
                            ability_type_active=aggressive_blood
                        [/not]
                    [/filter]
                    [filter_second]
                        find_in=second_unit
                    [/filter_second]
                    amount=$aggressive_blood.damage
                    damage_type=$aggressive_blood.damage_type
                    slowed=$aggressive_blood.slow
                    poisoned=$aggressive_blood.poison
                    fire_event=yes
                    kill=$aggressive_blood.kill
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
            [/do]
        [/foreach]
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability_type_active=aggressive_blood
        [/filter]
        [foreach]
            array=unit.abilities.aggressive_blood
            variable=aggressive_blood
            [do]
                [harm_unit_loti]
                    [filter]
                        [filter_location]
                            [filter]
                                find_in=unit
                            [/filter]
                            radius=$aggressive_blood.radius
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$unit.side
                            [/enemy_of]
                        [/filter_side]
                        [not]
                            ability_type_active=aggressive_blood
                        [/not]
                    [/filter]
                    [filter_second]
                        find_in=unit
                    [/filter_second]
                    amount=$aggressive_blood.damage
                    damage_type=$aggressive_blood.damage_type
                    slowed=$aggressive_blood.slow
                    poisoned=$aggressive_blood.poison
                    fire_event=yes
                    kill=$aggressive_blood.kill
                    animate=no
                    fire_attacker_hits=true
                [/harm_unit_loti]
            [/do]
        [/foreach]
    [/event]

    [event]	# Inspired by a similar special on the forums
        name=attacker hits
        first_time_only=no
        [filter_attack]
            special_id=dazzle
        [/filter_attack]
        [set_precision_intensity]
            id=$second_unit.id
            sub=3
        [/set_precision_intensity]
    [/event]
    [event]
        name=defender hits
        first_time_only=no
        [filter_second_attack]
            special_id=dazzle
        [/filter_second_attack]
        [set_precision_intensity]
            id=$unit.id
            sub=3
        [/set_precision_intensity]
    [/event]
#enddef
