#textdomain wesnoth-loti
#define WEAPON_SPECIAL_REDEEM_1
    [damage]
        id=redeem 1
        name= _ "redeem (1)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any level 0 or level 1 target, level 2 targets are absorbed with a 50% chance and level 3 targets are absorbed with a 25% chance. Experience is not gained. 6 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_2
    [damage]
        id=redeem 2
        name= _ "redeem (2)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 2 or lower, level 3 targets are absorbed with a 50% chance and level 4 targets are absorbed with a 25% chance. Experience is not gained. 8 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_3
    [damage]
        id=redeem 3
        name= _ "redeem (3)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 2 or lower, level 3 targets are absorbed with a 75% chance, level 4 targets are absorbed with a 50% chance, level 5 targets are absorbed with a 25% chance and the chance to absorb level 6 targets is only 10%. Experience is not gained. 10 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_4
    [damage]
        id=redeem 4
        name= _ "redeem (4)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 3 or lower, level 4 targets are absorbed with a 75% chance, level 5 targets are absorbed with a 50% chance, level 6 targets are absorbed with a 25% chance and the chance to absorb level 7 targets is only 10%. Experience is not gained. 13 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_5
    [damage]
        id=redeem 5
        name= _ "redeem (5)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 3 or lower, level 4 targets are absorbed with a 75% chance, level 5 targets are absorbed with a 50% chance, level 6 targets are absorbed with a 25% chance and the chance to absorb level 7 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 0 or less, 50% chance if their level is 1 and 25% chance if their level is 2. Experience is not gained. 17 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_6
    [damage]
        id=redeem 6
        name= _ "redeem (6)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 4 or lower, level 5 targets are absorbed with a 75% chance, level 6 targets are absorbed with a 50% chance, level 7 targets are absorbed with a 25% chance and the chance to absorb level 8 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 1 or less, 50% chance if their level is 2 and 25% chance if their level is 3. Experience is not gained. 22 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_7
    [damage]
        id=redeem 7
        name= _ "redeem (7)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 5 or lower, level 6 targets are absorbed with a 75% chance, level 7 targets are absorbed with a 50% chance, level 8 targets are absorbed with a 25% chance and the chance to absorb level 9 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 1 or less, 50% chance if their level is 2 and 25% chance if their level is 3. Experience is not gained. 29 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_8
    [damage]
        id=redeem 8
        name= _ "redeem (8)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 6 or lower, level 7 targets are absorbed with a 75% chance, level 8 targets are absorbed with a 50% chance, level 9 targets are absorbed with a 25% chance and the chance to absorb level 10 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 2 or less, 50% chance if their level is 3 and 25% chance if their level is 4. Experience is not gained. 38 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_9
    [damage]
        id=redeem 9
        name= _ "redeem (9)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 5 or lower, level 6 targets are absorbed with a 90% chance, level 7 targets are absorbed with a 60% chance, level 8 targets are absorbed with a 40% chance, level 9 targets are absorbed with a 30% chance, level 10 targets are absorbed with a 20% chance and the chance to absorb level 11 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 2 or less, 50% chance if their level is 3 and 25% chance if their level is 4. Experience is not gained. 50 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_10
    [damage]
        id=redeem 10
        name= _ "redeem (10)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 6 or lower, level 7 targets are absorbed with a 90% chance, level 8 targets are absorbed with a 60% chance, level 9 targets are absorbed with a 40% chance, level 10 targets are absorbed with a 30% chance, level 11 targets are absorbed with a 20% chance and the chance to absorb level 12 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 3 or less, 50% chance if their level is 4 and 25% chance if their level is 5. Experience is not gained. 66 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_11
    [damage]
        id=redeem 11
        name= _ "redeem (11)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 7 or lower, level 8 targets are absorbed with a 90% chance, level 9 targets are absorbed with a 60% chance, level 10 targets are absorbed with a 40% chance, level 11 targets are absorbed with a 30% chance, level 12 targets are absorbed with a 20% chance and the chance to absorb level 13 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 3 or less, 50% chance if their level is 4 and 25% chance if their level is 5. Experience is not gained. 88 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_12
    [damage]
        id=redeem 12
        name= _ "redeem (12)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 6 or lower, level 7 targets are absorbed with a 90% chance, level 8 targets are absorbed with an 80% chance, level 9 targets are absorbed with a 70% chance, level 10 targets are absorbed with a 60% chance, level 11 targets are absorbed with a 50%, level 12 targets are absorbed with a 40%, level 13 targets are absorbed with a 30% chance, level 14 targets are absorbed with a 20% and the chance to absorb level 15 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 4 or less, 50% chance if their level is 5 and 25% chance if their level is 6. Experience is not gained. 117 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_13
    [damage]
        id=redeem 13
        name= _ "redeem (13)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 7 or lower, level 8 targets are absorbed with a 90% chance, level 9 targets are absorbed with an 80% chance, level 10 targets are absorbed with a 70% chance, level 11 targets are absorbed with a 60% chance, level 12 targets are absorbed with a 50%, level 13 targets are absorbed with a 40%, level 14 targets are absorbed with a 30% chance, level 15 targets are absorbed with a 20% and the chance to absorb level 16 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 4 or less, 50% chance if their level is 5 and 25% chance if their level is 6. Experience is not gained. 156 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_14
    [damage]
        id=redeem 14
        name= _ "redeem (14)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 8 or lower, level 9 targets are absorbed with a 90% chance, level 10 targets are absorbed with an 80% chance, level 11 targets are absorbed with a 70% chance, level 12 targets are absorbed with a 60% chance, level 13 targets are absorbed with a 50%, level 14 targets are absorbed with a 40%, level 15 targets are absorbed with a 30% chance, level 16 targets are absorbed with a 20% and the chance to absorb level 17 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 5 or less, 50% chance if their level is 6 and 25% chance if their level is 7. Experience is not gained. 208 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_15
    [damage]
        id=redeem 15
        name= _ "redeem (15)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 9 or lower, level 10 targets are absorbed with a 90% chance, level 11 targets are absorbed with an 80% chance, level 12 targets are absorbed with a 70% chance, level 13 targets are absorbed with a 60% chance, level 14 targets are absorbed with a 50%, level 15 targets are absorbed with a 40%, level 16 targets are absorbed with a 30% chance, level 17 targets are absorbed with a 20% and the chance to absorb level 18 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 5 or less, 50% chance if their level is 7 and 25% chance if their level is 8. Experience is not gained. 277 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_16
    [damage]
        id=redeem 16
        name= _ "redeem (16)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 10 or lower, level 11 targets are absorbed with a 90% chance, level 12 targets are absorbed with an 80% chance, level 13 targets are absorbed with a 70% chance, level 14 targets are absorbed with a 60% chance, level 15 targets are absorbed with a 50%, level 16 targets are absorbed with a 40%, level 17 targets are absorbed with a 30% chance, level 18 targets are absorbed with a 20% and the chance to absorb level 19 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 6 or less, 50% chance if their level is 8 and 25% chance if their level is 9. Experience is not gained. 369 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_17
    [damage]
        id=redeem 17
        name= _ "redeem (17)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 11 or lower, level 12 targets are absorbed with a 90% chance, level 13 targets are absorbed with an 80% chance, level 14 targets are absorbed with a 70% chance, level 15 targets are absorbed with a 60% chance, level 16 targets are absorbed with a 50%, level 17 targets are absorbed with a 40%, level 18 targets are absorbed with a 30% chance, level 19 targets are absorbed with a 20% and the chance to absorb level 20 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 6 or less, 50% chance if their level is 9 and 25% chance if their level is 10. Experience is not gained. 492 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_18
    [damage]
        id=redeem 18
        name= _ "redeem (18)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 12 or lower, level 13 targets are absorbed with a 90% chance, level 14 targets are absorbed with an 80% chance, level 15 targets are absorbed with a 70% chance, level 16 targets are absorbed with a 60% chance, level 17 targets are absorbed with a 50%, level 18 targets are absorbed with a 40%, level 19 targets are absorbed with a 30% chance, level 20 targets are absorbed with a 20% and the chance to absorb level 21 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 7 or less, 50% chance if their level is 10 and 25% chance if their level is 11. Experience is not gained. 656 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_19
    [damage]
        id=redeem 19
        name= _ "redeem (19)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 13 or lower, level 14 targets are absorbed with a 90% chance, level 15 targets are absorbed with an 80% chance, level 16 targets are absorbed with a 70% chance, level 17 targets are absorbed with a 60% chance, level 18 targets are absorbed with a 50%, level 19 targets are absorbed with a 40%, level 20 targets are absorbed with a 30% chance, level 21 targets are absorbed with a 20% and the chance to absorb level 22 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 7 or less, 50% chance if their level is 11 and 25% chance if their level is 12. Experience is not gained. 874 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_20
    [damage]
        id=redeem 20
        name= _ "redeem (20)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 14 or lower, level 15 targets are absorbed with a 90% chance, level 16 targets are absorbed with an 80% chance, level 17 targets are absorbed with a 70% chance, level 18 targets are absorbed with a 60% chance, level 19 targets are absorbed with a 50%, level 20 targets are absorbed with a 40%, level 21 targets are absorbed with a 30% chance, level 22 targets are absorbed with a 20% and the chance to absorb level 23 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 8 or less, 50% chance if their level is 12 and 25% chance if their level is 14. Experience is not gained. 1165 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef

#define REDEEM_COOLDOWN
    [store_unit]
        [filter]
            id=$unit.id
        [/filter]
        variable=redeemer
        kill=no
    [/store_unit]
    {VARIABLE redeemer.variables.redeem_wait 2}
    {VARIABLE redeemer.status.redeem_waiting yes}
    {FOREACH redeemer.attack l}
        [if]
            [variable]
                name=redeemer.attack[$l].name
                equals=redeem
            [/variable]
            [then]
                {VARIABLE redeemer.attack[$l].attack_weight "0"}
            [/then]
        [/if]
    {NEXT l}
    [unstore_unit]
        variable=redeemer
        {COLOR_HEAL}
        find_vacant=no
    [/unstore_unit]
    {CLEAR_VARIABLE redeemer}
#enddef

#define REDEEM_SURE_LEVEL LEVEL
    [if]
        [variable]
            name=second_unit.level
            less_than_equal_to={LEVEL}
        [/variable]
        [then]
            {VARIABLE redeemed 1}
        [/then]
    [/if]
#enddef

#define REDEEM_UNSURE_LEVEL LEVEL PROBABILITY
    [if]
        [variable]
            name=second_unit.level
            equals={LEVEL}
        [/variable]
        [and]
            [variable]
                name=luck
                greater_than={PROBABILITY}
            [/variable]
        [/and]
        [then]
            {VARIABLE redeemed 1}
        [/then]
    [/if]
#enddef

#define REDEEMING
    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            name=redeem
        [/filter_attack]
        # Begin This looks like it can be replaced with unit.variables.redeem_level
        #  But be sure to search for "so we should correct it back" if you do
        {FOREACH weapon.specials.damage i}
            [if]
                [variable]
                    name=weapon.specials.damage[$i].id
                    contains=redeem
                [/variable]
                [then]
                    [set_variables]
                        name=redeem_level_raw
                        mode=replace
                        [split]
                            list=$weapon.specials.damage[$i].id
                            key=identified
                            separator=" "
                            remove_empty=yes
                        [/split]
                    [/set_variables]
                    {VARIABLE redeem_level $redeem_level_raw[1].identified}
                [/then]
            [/if]
        {NEXT i}
        # End This looks like it can be replaced with unit.variables.redeem_level
        {VARIABLE redeemed_in_total 0}
        [if]
            [variable]
                name=redeem_level
                greater_than=4
            [/variable]
            [then]
                {VARIABLE_OP redeem_level sub 4}
                [set_variable]
                    name=redeem_level
                    divide=2
                    round=ceil
                [/set_variable]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            id=$second_unit.id
                        [/filter_adjacent]
                        [not]
                            [filter_wml]
                                [variables]
                                    unredeemable=yes
                                [/variables]
                            [/filter_wml]
                        [/not]
                        side=$enemy_sides
                    [/filter]
                    variable=redeem_store
                    kill=no
                [/store_unit]
                {FOREACH redeem_store i}
                    {VARIABLE_OP luck rand (0,1,2,3)}
                    {VARIABLE redeemed 0}
                    [if]
                        [variable]
                            name=redeem_store[$i].level
                            less_than_equal_to=$redeem_level
                        [/variable]
                        [then]
                            {VARIABLE redeemed 1}
                        [/then]
                    [/if]
                    {VARIABLE redeem_level_higher "$($redeem_level+1)"}
                    [if]
                        [variable]
                            name=redeem_store[$i].level
                            equals=$redeem_level_higher
                        [/variable]
                        [and]
                            [variable]
                                name=luck
                                greater_than=1
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE redeemed 1}
                        [/then]
                    [/if]
                    {VARIABLE redeem_level_higher "$($redeem_level+2)"}
                    [if]
                        [variable]
                            name=redeem_store[$i].level
                            equals=$redeem_level_higher
                        [/variable]
                        [and]
                            [variable]
                                name=luck
                                greater_than=2
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE redeemed 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=redeemed
                            equals=1
                        [/variable]
                        [then]
                            [kill]
                                id=$redeem_store[$i].id
                                animate=no
                                fire_event=yes
                            [/kill]
                            {VARIABLE_OP redeemed_in_total add 1}
                        [/then]
                    [/if]
                {NEXT i}
                {CLEAR_VARIABLE redeem_level_higher,redeem_store}
                {VARIABLE redeem_level $redeem_level_raw[1].identified}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=2
            [/variable]
            [then]
                {VARIABLE_OP luck rand (0,1,2,3)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL $redeem_level}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 1}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 2}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                equals=5
            [/variable]
            [then]	#Redeem level 5's direct effect is identical to level 4, it has an extra AoE
                {VARIABLE redeem_level 4}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=4
            [/variable]
            [and]
                [variable]
                    name=redeem_level
                    greater_than=2
                [/variable]
            [/and]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-1)"}
                {REDEEM_UNSURE_LEVEL "$redeem_level" 4}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 9}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 14}
                # Redeem level 5 was set to 4 to simplify calculations, so we should correct it back
                {VARIABLE redeem_level $redeem_level_raw[1].identified}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=8
            [/variable]
            [and]
                [variable]
                    name=redeem_level
                    greater_than=5
                [/variable]
            [/and]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-2)"}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-1)" 4}
                {REDEEM_UNSURE_LEVEL "$redeem_level" 9}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 14}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 18}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=11
            [/variable]
            [and]
                [variable]
                    name=redeem_level
                    greater_than=8
                [/variable]
            [/and]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-4)"}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-3)" 2}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-2)" 8}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-1)" 12}
                {REDEEM_UNSURE_LEVEL "$($redeem_level)" 14}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 16}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 18}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                greater_than=11
            [/variable]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-6)"}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-5)" 2}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-4)" 4}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-3)" 6}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-2)" 8}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-1)" 10}
                {REDEEM_UNSURE_LEVEL "$redeem_level" 12}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 14}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 16}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+3)" 18}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeemed
                greater_than_equal_to=1
            [/variable]
            [not]
                [variable]
                    name=second_unit.variables.unredeemable
                    equals=yes
                [/variable]
            [/not]
            [then]
                [kill]
                    id=$second_unit.id
                    animate=yes
                    experience=no
                    fire_event=yes
                [/kill]
                [if]
                    [variable]
                        name=redeemed_in_total
                        greater_than_equal_to=1
                    [/variable]
                    [else]
                        [fire_event]
                            name=redeem
                            [primary_unit]
                                id=$unit.id
                            [/primary_unit]
                        [/fire_event]
                    [/else]
                [/if]
            [/then]
            [else]
                [floating_text]
                    text=_"Redeem failed!"
                    x,y=$x1,$y1
                [/floating_text]
            [/else]
        [/if]
        [if]
            [variable]
                name=redeemed_in_total
                greater_than_equal_to=1
            [/variable]
            [then]
                [if]
                    [variable]
                        name=redeemed
                        equals=0
                    [/variable]
                    [then]
                        {VARIABLE_OP redeemed_in_total sub 1}
                    [/then]
                [/if]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=redeemer
                    kill=no
                [/store_unit]
                [if]
                    [variable]
                        name=redeemer.variables.redeem_count
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE_OP redeemer.variables.redeem_count add $redeemed_in_total}
                    [/then]
                    [else]
                        {VARIABLE redeemer.variables.redeem_count $redeemed_in_total}
                    [/else]
                [/if]
                [unstore_unit]
                    variable=redeemer
                    find_vacant=no
                [/unstore_unit]
                [fire_event]
                    name=redeem
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE redeemed,luck,redeem_level,redeemed_in_total,redeem_level_raw}
        {REDEEM_COOLDOWN}
    [/event]

    [event]
        name=redeem
        first_time_only=no
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=redeemer
        [/store_unit]
        [if]
            [variable]
                name=redeemer.variables.max_redeem_count
                greater_than=0
            [/variable]
            [else]
                {VARIABLE redeemer.variables.max_redeem_count 5}
                {FOREACH redeemer.modifications.advancement i}
                    [if]
                        [variable]
                            name=redeemer.modifications.advancement[$i].id
                            equals="lightning"
                        [/variable]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="fireblast"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="firestorm"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="arcticblast"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="blizzard"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="entropy"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="particlestorm"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="resist_fire"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="resist_cold"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="resist_arcane"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="resist_blade"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="resist_pierce"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="resist_impact"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="health"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="regeneration"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="absorb"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="heal"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="leadership"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="spirit"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="fire_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="cold_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="arcane_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="blade_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="impact_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="pierce_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="weapons"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=redeemer.modifications.advancement[$i].id
                                equals="magic"
                            [/variable]
                        [/or]
                        [then]
                            {VARIABLE_OP redeemer.variables.max_redeem_count multiply 4}
                            [set_variable]
                                name=redeemer.variables.max_redeem_count
                                divide=3
                                round=floor
                            [/set_variable]
                        [/then]
                    [/if]
                {NEXT i}
            [/else]
        [/if]
        [if]
            [variable]
                name=redeemer.variables.redeem_count
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP redeemer.variables.redeem_count add 1}
                [if]
                    [variable]
                        name=redeemer.variables.redeem_count
                        greater_than_equal_to=$redeemer.variables.max_redeem_count
                    [/variable]
                    [then]
#ifdef MULTIPLAYER
                        [if]
                            [variable]
                                name=side_number
                                equals=$redeemer.side
                            [/variable]
                            [then]
#endif
                                [show_redeem_menu]
                                    find_in=redeemer
                                    to_variable=chose
                                    ability_tree=redeem
                                [/show_redeem_menu]

                                {VARIABLE_OP redeemer.variables.redeem_level add 1}

                                [if]
                                    [variable]
                                        name=chose
                                        equals=0
                                    [/variable]
                                    [then]
                                        {VARIABLE question_asked "$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"}
                                    [/then]
                                    [else]
                                        {VARIABLE_OP redeemer.variables.redeem_count sub $redeemer.variables.max_redeem_count}
                                        [if]
                                            [variable]
                                                name=redeemer.variables.redeem_count
                                                less_than=0
                                            [/variable]
                                            [then]
                                                {VARIABLE redeemer.variables.redeem_count 0}
                                            [/then]
                                        [/if]
                                        # We can't just calculate the new max_redeem_count from the existing one, we have to look it up.
                                        # If player took an upgrade to jump redeem levels (e.g. c08s03 United), the current max_redeem_count won't
                                        # be "correct" for the first advancement.
                                        # Or we could iterate our way up from level 1.  Not.
                                        [lua]
                                            code =  <<
                -- max_redeem_count(n+1)=max_redeem_count(n)+floor(n*4/3), where n is redeem level 
                --   and max_redeem_count(1) = 6.
                -- Instead of repeatedly calculating these values, they are presented here (with plenty of extras for future use)
                local max_redeem_count_list = {6, 8, 10, 13, 17, 22, 29, 38, 50, 66, 88, 117, 156, 208, 277, 369, 492, 656, 874, 1165, 1553, 2070, 2760, 3680, 4906, 6541, 8721, 11628, 15504, 20672, 27562, 36749, 48998, 65330, 87106, 116141, 154854, 206472, 275296, 367061}
                local redeem_level = wml.variables["redeemer.variables.redeem_level"]
                wml.variables["redeemer.variables.max_redeem_count"] = max_redeem_count_list[redeem_level]
            >>
                                        [/lua]

                                        {VARIABLE question_asked "$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"}
                                        [if]
                                            [variable]
                                                name=redeemer.variables.redeem_level
                                                greater_than=20
                                            [/variable]
                                            [then]
                                                {VARIABLE redeemer.variables.redeem_level 20}
                                            [/then]
                                        [/if]
                                        [switch]
                                            variable=redeemer.variables.redeem_level
                                            [case]
                                                value=1		#Clone of the following one for the case if something went wrong
                                                {VARIABLE redeemer.variables.redeem_level 2}
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 1
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_2}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=2
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 1
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_2}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=3
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 2
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_3}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=4
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 3,magical
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_4}
                                                                {WEAPON_SPECIAL_FOCUSED}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=5
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 4
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_5}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=6
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 5
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_6}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=7
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 6
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_7}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=8
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 7,focused
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_8}
                                                                {WEAPON_SPECIAL_GUIDED}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=9
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 8
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_9}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=10
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 9
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_10}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=11
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 10
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_11}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=12
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 11
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_12}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=13
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 12
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_13}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=14
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 13
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_14}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=15
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 14
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_15}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=16
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 15
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_16}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=17
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 16
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_17}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=18
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 17
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_18}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=19
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 18
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_19}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=20
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 19
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_20}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                        [/switch]
                                        [if]
                                            [variable]
                                                name=redeemer.variables.redeem_level
                                                greater_than=20
                                            [/variable]
                                            [then]
                                                [set_variables]
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                    [/value]
                                                [/set_variables]
                                            [/then]
                                        [/if]
                                    [/else]
                                [/if]
                                [unstore_unit]
                                    variable=redeemer
                                    {COLOR_HEAL}
                                    text="$question_asked"
                                    find_vacant=no
                                [/unstore_unit]
#ifdef MULTIPLAYER
                            [/then]
                            [else]
                                [unstore_unit]
                                    variable=redeemer
                                    {COLOR_HEAL}
                                    text="$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"
                                    find_vacant=no
                                [/unstore_unit]
                            [/else]
                        [/if]
#endif
                        {UPDATE_STATS}
                    [/then]
                    [else]
                        [unstore_unit]
                            variable=redeemer
                            {COLOR_HEAL}
                            text="$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"
                            find_vacant=no
                        [/unstore_unit]
                    [/else]
                [/if]
            [/then]
            [else]
                {VARIABLE redeemer.variables.redeem_count 1}
                [if]
                    [variable]
                        name=redeemer.variables.redeem_level
                        greater_than=0
                    [/variable]
                    [else]
                        {VARIABLE redeemer.variables.redeem_level 1}
                    [/else]
                [/if]
                [unstore_unit]
                    variable=redeemer
                    {COLOR_HEAL}
                    text="$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"
                    find_vacant=no
                [/unstore_unit]
            [/else]
        [/if]
        {CLEAR_VARIABLE redeemer,question_asked,chose}
    [/event]

    [event]
        name=side turn
        first_time_only=no

        [store_unit]
            [filter]
                status=redeem_waiting
                side=$side_number
            [/filter]
            variable=redeemer
        [/store_unit]

        {FOREACH redeemer i}
            [if]
                [variable]
                    name=redeemer[$i].variables.redeem_wait
                    equals=0
                [/variable]
                [then]
                    {CLEAR_VARIABLE redeemer[$i].status.redeem_waiting}
                    {CLEAR_VARIABLE redeemer[$i].variables.redeem_wait}
                    {FOREACH redeemer[$i].attack l}
                        [if]
                            [variable]
                                name=redeemer[$i].attack[$l].name
                                equals=redeem
                            [/variable]
                            [then]
                                {CLEAR_VARIABLE redeemer[$i].attack[$l].attack_weight}
                            [/then]
                        [/if]
                    {NEXT l}
                    [scroll_to_unit]
                        for_side=$redeemer[$i].side
                        id=$redeemer[$i].id
                    [/scroll_to_unit]
                    [unstore_unit]
                        variable=redeemer[$i]
                        {COLOR_HEAL}
                        text= _ "Redeem recharged!"
                    [/unstore_unit]
                    [delay]
                        time=500
                        accelerate=yes
                    [/delay]
                [/then]
            [/if]
            [if]
                [variable]
                    name=redeemer[$i].variables.redeem_wait
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP redeemer[$i].variables.redeem_wait sub 1}
                    [unstore_unit]
                        variable=redeemer[$i]
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT i}

        {CLEAR_VARIABLE redeemer}
    [/event]
#enddef
