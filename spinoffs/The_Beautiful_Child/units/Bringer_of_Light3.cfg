#textdomain wesnoth-tbc
#define LIGHTNING_FRAME_INIT NAME START_TIME
    {NAME}_start_time={START_TIME}
#enddef
#define LIGHTNING_FRAME NAME DIRECTION_NUMBER X Y
    [{NAME}_frame]
        duration=1
        halo="misc/blank-hex.png"
    [/{NAME}_frame]
    [if]
        direction=sw,s,se

        [{NAME}_frame]
            duration=400
            halo=halo/lightning-bolt-{DIRECTION_NUMBER}-1.png~FL(vert):100,halo/lightning-bolt-{DIRECTION_NUMBER}-2.png~FL(vert):100,halo/lightning-bolt-{DIRECTION_NUMBER}-3.png~FL(vert):100,halo/lightning-bolt-{DIRECTION_NUMBER}-4.png~FL(vert):100
            halo_x={X}
            halo_y={Y}
            offset=0
        [/{NAME}_frame]
    [/if]
    [else]
        direction=nw,n,ne

        [{NAME}_frame]
            duration=400
            halo=halo/lightning-bolt-{DIRECTION_NUMBER}-1.png:100,halo/lightning-bolt-{DIRECTION_NUMBER}-2.png:100,halo/lightning-bolt-{DIRECTION_NUMBER}-3.png:100,halo/lightning-bolt-{DIRECTION_NUMBER}-4.png:100
            halo_x={X}
            halo_y={Y}
            offset=0
        [/{NAME}_frame]
    [/else]
    [{NAME}_frame]
        duration=1
        halo="misc/blank-hex.png"
    [/{NAME}_frame]
#enddef

#define MISSILE_FRAME_LIGHTNING_STORM
{LIGHTNING_FRAME_INIT missile1 -650}
{LIGHTNING_FRAME_INIT missile2 -550}
{LIGHTNING_FRAME_INIT missile3 -450}
{LIGHTNING_FRAME_INIT missile4 -250}
{LIGHTNING_FRAME_INIT missile5 -150}
{LIGHTNING_FRAME_INIT missile6 -50}
{LIGHTNING_FRAME_INIT missile7 50}
{LIGHTNING_FRAME_INIT missile8 150}
{LIGHTNING_FRAME_INIT missile9 250}
{LIGHTNING_FRAME_INIT missile10 350}
{LIGHTNING_FRAME_INIT missile11 450}
{LIGHTNING_FRAME missile1 1 35 -180}
{LIGHTNING_FRAME missile2 2 -50 -100}
{LIGHTNING_FRAME missile3 3 60 -150}
{LIGHTNING_FRAME missile4 2 -70 -80}
{LIGHTNING_FRAME missile5 3 35 -205}
{LIGHTNING_FRAME missile6 1 40 -65}
{LIGHTNING_FRAME missile7 1 70 -55}
{LIGHTNING_FRAME missile8 3 25 -150}
{LIGHTNING_FRAME missile9 2 -85 -175}
{LIGHTNING_FRAME missile10 3 15 -70}
{LIGHTNING_FRAME missile11 1 25 -25}
#enddef
#define DAZZLE_COUNTER
[chance_to_hit]
    id=dazzle_counter
    value=30
    apply_to=opponent
    [filter_base_value]
        greater_than=30
    [/filter_base_value]
    [filter_opponent]
        [filter_wml]
            [variables]
                dazzled=yes
            [/variables]
        [/filter_wml]
    [/filter_opponent]
[/chance_to_hit]
#enddef
[unit_type]
    id=Bringer of Light3
    name= _ "Bringer of Light"
    race=human
    gender=male
    image="units/humans/celestial.png"
    profile="portraits/humans/mage-light.png"
    halo=halo/illuminates-aura.png
    hitpoints=400
    {QUANTITY hitpoints 250 400 600}
    movement_type=smallfoot
    movement=6
    experience=500
    level=9
    alignment=lawful
    advances_to=null
    cost=84
    usage=healer
    [movement_costs]
        shallow_water=1
        deep_water=1
        reef=1
        swamp_water=1
        flat=1
        sand=1
        forest=1
        hills=1
        mountains=2
        village=1
        castle=1
        frozen=1
    unwalkable=1
    [/movement_costs]
    [defense]
        deep_water=60
        shallow_water=60
    swamp_water=60
    reef=60
    unwalkable=50
    [/defense]
    description= _ "This man is the leader of the Brothers of Light. His bloodline originates from gods themselves and his knowledge of the divine is so good the gods personally speak to him and grant him a fraction of their powers... if his words are believable. His enemies claim that his power comes from necromantic rituals that are based on extracting souls of his victims by torture. Regardless of the truth behind it, he is a formidable opponent to face."
    die_sound={SOUND_LIST:HUMAN_OLD_DIE}
    {DEFENSE_ANIM "units/humans/celestial-defend-2.png" "units/humans/celestial-defend-1.png" {SOUND_LIST:HUMAN_HIT} }
    [portrait]
        size=400
        side="left"
        mirror="false"
        image="portraits/humans/transparent/mage-light.png"
    [/portrait]
    [portrait]
        size=400
        side="right"
        mirror="true"
        image="portraits/humans/transparent/mage-light.png"
    [/portrait]
    [abilities]
    [dummy]
        id=spellcasting_light_3
        name= _ "spell casting"
#ifver WESNOTH_VERSION >= 1.11.2
        description= _ "At the beginning of this unit's turn, a spell is cast. It can be an acid rain that creates areas that poison and damage all units inside, it can be a healing spell that allows him to recover a lot of hitpoints or burden of sin that causes nearby units to break through the floor and fall."
#else
        description= _ "Spell Casting: At the beginning of this unit's turn, a spell is cast. It can be an acid rain that creates areas that poison and damage all units inside, it can be a healing spell that allows him to recover a lot of hitpoints or burden of sin that causes nearby units to break through the floor and fall."
#endif
    [/dummy]
        {ABILITY_ILLUMINATES}
        {ABILITY_CURES}
        {ABILITY_REGENERATES_OTHER 32}
    [/abilities]
    [resistance]
        arcane=30
        blade=90
        pierce=90
        impact=90
    [/resistance]
    [healing_anim]
        [frame]
            begin=-525
            end=-450
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            begin=-450
            end=-375
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=-375
            end=-300
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/holy/halo6.png
        [/frame]
        [frame]
            begin=-300
            end=-225
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/holy/halo1.png
        [/frame]
        [frame]
            begin=-225
            end=-150
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo2.png
        [/frame]
        [frame]
            begin=-150
            end=-75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo3.png
        [/frame]
        [frame]
            begin=-75
            end=0
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo4.png
        [/frame]
        [frame]
            begin=0
            end=75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo5.png
        [/frame]
        [frame]
            begin=75
            end=150
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/holy/halo6.png
        [/frame]
        [frame]
            begin=150
            end=225
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=225
            end=300
            image="units/humans/celestial.png"
        [/frame]
    [/healing_anim]
    [attack]
        name=mace
        description=_"mace"
        type=impact
        range=melee
        damage=9
        number=3
        icon=attacks/mace-spiked.png
        attack_weight=0
        [specials]
            {DAZZLE_COUNTER}
        [/specials]
    [/attack]
    [attack]
        name=firebeam
        description=_"firebeam"
        icon=attacks/lightbeam.png~CS(100,0,-100)
        type=fire
        range=ranged
        [specials]
            {WEAPON_SPECIAL_MAGICAL}
            {DAZZLE_COUNTER}
        [/specials]
        damage=12
        number=4
        attack_weight=0
    [/attack]
    [attack]
            name=thunderstorm
            description=_"thunderstorm"
            type=lightning
            [specials]
                {WEAPON_SPECIAL_MAGICAL}
                {WEAPON_SPECIAL_STORM}
            [/specials]
            range=ranged
            damage=24
            number=2
            icon=attacks/lightning.png
            defense_weight=0
    [/attack]
    [attack_anim]
        [filter_attack]
            name=thunderstorm
        [/filter_attack]
        {MISSILE_FRAME_LIGHTNING_STORM}

        start_time=-250
        [if]
            hits=yes
            [frame]
                duration=50
                image="units/humans/celestial-attack-ranged-1.png"
                halo=halo/elven/faerie-fire-halo2.png
                sound=magic-dark-big.ogg
            [/frame]
        [/if]
        [else]
            hits=no
            [frame]
                duration=50
                image="units/humans/celestial-attack-ranged-1.png"
                halo=halo/elven/faerie-fire-halo2.png
            [/frame]
        [/else]
        [frame]
            duration=100
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/elven/faerie-fire-halo3.png
        [/frame]
        [frame]
            duration=100
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/elven/faerie-fire-halo4.png
        [/frame]
        [frame]
            duration=100
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/elven/faerie-fire-halo5.png
        [/frame]
        [frame]
            duration=50
            image="units/humans/celestial.png"
        [/frame]
    [/attack_anim]
    [attack_anim]
        [filter_attack]
            name=firebeam
        [/filter_attack]
        {MISSILE_FRAME_FIRE_BEAM}

        [frame]
            begin=-300
            end=-225
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            begin=-225
            end=-150
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=-150
            end=-75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo6.png
        [/frame]
        [if]
            hits=yes
            [frame]
                begin=-75
                end=0
                image="units/humans/celestial-attack-ranged-2.png"
                sound={SOUND_LIST:HOLY}
                halo=halo/holy/halo1.png
            [/frame]
        [/if]
        [else]
            hits=no
            [frame]
                begin=-75
                end=0
                image="units/humans/celestial-attack-ranged-2.png"
                sound={SOUND_LIST:HOLY_MISS}
                halo=halo/holy/halo1.png
            [/frame]
        [/else]
        [frame]
            begin=0
            end=75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo3.png
        [/frame]
        [frame]
            begin=75
            end=150
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo5.png
        [/frame]

        [frame]
            begin=150
            end=200
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo6.png
        [/frame]
        [frame]
            begin=200
            end=250
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=250
            end=300
            image="units/humans/celestial.png"
        [/frame]
    [/attack_anim]
    [attack_anim]
        [filter_attack]
            name=mace
        [/filter_attack]
        [frame]
            begin=-300
            end=-275
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            begin=-275
            end=-200
            image="units/humans/celestial-attack-melee-1.png"
        [/frame]
        [if]
            hits=yes
            [frame]
                begin=-200
                end=0
                image="units/humans/celestial-attack-melee-2.png"
                sound=mace.wav
            [/frame]
            [frame]
                begin=0
                end=200
                image="units/humans/celestial-attack-melee-3.png"
                sound=mace.wav
            [/frame]
        [/if]
        [else]
            hits=no
            [frame]
                begin=-200
                end=0
                image="units/humans/celestial-attack-melee-2.png"
                sound={SOUND_LIST:MISS}
            [/frame]
            [frame]
                begin=0
                end=200
                image="units/humans/celestial-attack-melee-3.png"
                sound={SOUND_LIST:MISS}
            [/frame]
        [/else]
        [frame]
            begin=200
            end=300
            image="units/humans/celestial-attack-melee-4.png"
        [/frame]
        [frame]
            begin=300
            end=325
            image="units/humans/celestial.png"
        [/frame]
    [/attack_anim]
    [standing_anim]
        start_time=0
        layer=60
        [frame]
            duration=200
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-1.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-2.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-3.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-4.png"
        [/frame]
    [/standing_anim]
    [movement_anim]
        start_time=0
        [frame]
            duration=200
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-1.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-2.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-3.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-4.png"
        [/frame]
    [/movement_anim]
    [event]
    name=turn refresh
    id=spellcasting_light_3
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=spellcasting_light_3
        [/filter]
        variable=casters
        kill=no
    [/store_unit]
    {FOREACH casters i}
        {VARIABLE_OP spell rand (cleansing_rain,healing,burden_of_sin)}
        [switch]
            variable=spell
            [case]
                value=cleansing_rain
                [floating_text]
                    x,y=$casters[$i].x,$casters[$i].y
                    text=_"Cleansing Rain!"
                [/floating_text]
                {VARIABLE already no}
                {FOREACH cleansing_rain j}
                    [if]
                        [variable]
                            name=cleansing_rain[$j].x
                            equals=$casters[$i].x
                        [/variable]
                        [and]
                            [variable]
                                name=cleansing_rain[$j].x
                                equals=$casters[$i].x
                            [/variable]
                        [/and]
                        [and]
                            [variable]
                                name=cleansing_rain[$j].side
                                equals=$casters[$i].side
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE already yes}
                        [/then]
                    [/if]
                {NEXT j}
                [if]
                    [variable]
                        name=already
                        equals=yes
                    [/variable]
                    [else]
                        [set_variables]
                            mode=replace
                            name=cleansing_rain[$cleansing_rain.length]
                            [value]
                                x,y=$casters[$i].x,$casters[$i].y
                                side=$casters[$i].side
                            [/value]
                        [/set_variables]
                        [item]
                            halo=bloodrain/bloodrain-1.png~CS(-100,250,100):40,bloodrain/bloodrain-2.png~CS(-100,250,100):40,bloodrain/bloodrain-3.png~CS(-100,250,100):40,bloodrain/bloodrain-4.png~CS(-100,250,100):40,bloodrain/bloodrain-5.png~CS(-100,250,100):40,bloodrain/bloodrain-6.png~CS(-100,250,100):40,bloodrain/bloodrain-7.png~CS(-100,250,100):40,bloodrain/bloodrain-8.png~CS(-100,250,100):40,bloodrain/bloodrain-9.png~CS(-100,250,100):40,bloodrain/bloodrain-10.png~CS(-100,250,100):40
                            x,y=$casters[$i].x,$casters[$i].y
                        [/item]

                        {VARIABLE target_x $casters[$i].x}
                        {VARIABLE_OP target_x sub 18}
                        [set_variables]
                            mode=replace
                            name=cleansing_rain[$cleansing_rain.length]
                            [value]
                                x,y=$target_x,$casters[$i].y
                                side=$casters[$i].side
                            [/value]
                        [/set_variables]
                        [item]
                            halo=bloodrain/bloodrain-1.png~CS(-100,250,100):40,bloodrain/bloodrain-2.png~CS(-100,250,100):40,bloodrain/bloodrain-3.png~CS(-100,250,100):40,bloodrain/bloodrain-4.png~CS(-100,250,100):40,bloodrain/bloodrain-5.png~CS(-100,250,100):40,bloodrain/bloodrain-6.png~CS(-100,250,100):40,bloodrain/bloodrain-7.png~CS(-100,250,100):40,bloodrain/bloodrain-8.png~CS(-100,250,100):40,bloodrain/bloodrain-9.png~CS(-100,250,100):40,bloodrain/bloodrain-10.png~CS(-100,250,100):40
                            x,y=$target_x,$casters[$i].y
                        [/item]
                        [event]
                            name=victory
                            id=remove_cleansing_rain_notes
                            {CLEAR_VARIABLE cleansing_rain}
                        [/event]
                    [/else]
                [/if]
                {CLEAR_VARIABLE already}
            [/case]
            [case]
                value=healing
                [floating_text]
                    x,y=$casters[$i].x,$casters[$i].y
                    text=_"Healing!"
                [/floating_text]
                {VARIABLE amount $casters[$i].max_hitpoints}
                {VARIABLE_OP amount divide 2}
                [heal_unit]
                    [filter]
                    id=$casters[$i].id
                    [/filter]
                    amount=$amount
                    animate=yes
                    restore_statuses=yes
                [/heal_unit]
                {CLEAR_VARIABLE amount}
            [/case]
            [case]
                value=burden_of_sin
                [floating_text]
                    x,y=$casters[$i].x,$casters[$i].y
                    text=_"Burden of Sin!"
                [/floating_text]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            x,y=$casters[$i].x,$casters[$i].y
                        [/filter_adjacent]
                        [filter_location]
                            terrain=Iwr
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=targets
                    kill=no
                [/store_unit]
                {FOREACH targets i}
                    {EARTHQUAKE (
                        [terrain]
                            x,y=$targets[$i].x,$targets[$i].y
                            terrain=Qxu
                        [/terrain]
                        {VARIABLE target_x $targets[$i].x}
                        {VARIABLE_OP target_x sub 18}
                        [teleport]
                            [filter]
                                id=$targets[$i].id
                            [/filter]
                            x,y=$target_x,$targets[$i].y
                        [/teleport]
                        [terrain]
                            x,y=$target_x,$targets[$i].y
                            terrain=Iwr^Dr
                        [/terrain]
                    )}
                    [harm_unit]
                        [filter]
                          x,y=$target_x,$targets[$i].y
                        [/filter]
                        amount=32
                        damage_type=impact
                        kill=yes
                        fire_event=yes
                    [/harm_unit]
                    {CLEAR_VARIABLE target_x}
                {NEXT i}
                {CLEAR_VARIABLE targets}
            [/case]
        [/switch]
        [fire_event]
            name=spellcast
            [primary_unit]
                id=$casters[$i]
            [/primary_unit]
        [/fire_event]
    {NEXT i}
    {CLEAR_VARIABLE casters,spell}
    [/event]
    [event]
        name=turn_refresh
        first_time_only=no
        [store_side]
            side=$side_number
            variable=this_side
        [/store_side]
        {FOREACH cleansing_rain i}
            [store_side]
                side=$cleansing_rain[$i].side
                variable=rain_side
            [/store_side]
            [if]
                [variable]
                    name=this_side.team_name
                    equals=$rain_side.team_name
                [/variable]
                [else]
                    [harm_unit]
                        [filter]
                        [filter_location]
                            x,y=$cleansing_rain[$i].x,$cleansing_rain[$i].y
                            radius=1
                        [/filter_location]
                        side=$side_number
                        [/filter]
                        amount=4
                        poisoned=yes
                        kill=no
                    [/harm_unit]
                [/else]
            [/if]
            {CLEAR_VARIABLE rain_side}
        {NEXT i}
        {CLEAR_VARIABLE this_side}
    [/event]
[/unit_type]
#undef DAZZLE_COUNTER
#undef MISSILE_FRAME_LIGHTNING_STORM
#undef LIGHTNING_FRAME
#undef LIGHTNING_FRAME_INIT
