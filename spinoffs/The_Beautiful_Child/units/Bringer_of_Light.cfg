#textdomain wesnoth-tbc
#define DAZZLE_COUNTER
[chance_to_hit]
    id=dazzle_counter
    value=30
    apply_to=opponent
    [filter_base_value]
        greater_than=30
    [/filter_base_value]
    [filter_opponent]
        [filter_wml]
            [variables]
                dazzled=yes
            [/variables]
        [/filter_wml]
    [/filter_opponent]
[/chance_to_hit]
#enddef
[unit_type]
    id=Bringer of Light
    name= _ "Bringer of Light"
    race=human
    gender=male
    image="units/humans/celestial.png"
    profile="portraits/humans/mage-light.png"
    halo=halo/illuminates-aura.png
    hitpoints=500
    {QUANTITY hitpoints 300 500 700}
    movement_type=smallfoot
    movement=6
    experience=500
    level=10
    alignment=lawful
    advances_to=null
    cost=84
    usage=healer
    [movement_costs]
        shallow_water=1
        deep_water=1
        reef=1
        swamp_water=1
        flat=1
        sand=1
        forest=1
        hills=1
        mountains=2
        village=1
        castle=1
        frozen=1
    [/movement_costs]
    [defense]
        deep_water=60
        shallow_water=60
    swamp_water=60
    reef=60
    [/defense]
    description= _ "This man is the leader of the Brothers of Light. His bloodline originates from gods themselves and his knowledge of the divine is so good the gods personally speak to him and grant him a fraction of their powers... if his words are believable. His enemies claim that his power comes from necromantic rituals that are based on extracting souls of his victims by torture. Regardless of the truth behind it, he is a formidable opponent to face."
    die_sound={SOUND_LIST:HUMAN_OLD_DIE}
    {DEFENSE_ANIM "units/humans/celestial-defend-2.png" "units/humans/celestial-defend-1.png" {SOUND_LIST:HUMAN_HIT} }
    [portrait]
        size=400
        side="left"
        mirror="false"
        image="portraits/humans/transparent/mage-light.png"
    [/portrait]
    [portrait]
        size=400
        side="right"
        mirror="true"
        image="portraits/humans/transparent/mage-light.png"
    [/portrait]
    [abilities]
    [dummy]
        id=spellcasting_light
        name= _ "spell casting"
#ifver WESNOTH_VERSION >= 1.11.2
        description= _ "At the beginning of this unit's turn, a spell is cast. It can be holy fire that ignites ground under him, it can be a call to arms that brings new soldiers to him or a burst of blinding light that limits the chance to hit of nearby enemies."
#else
        description= _ "Spell Casting: At the beginning of this unit's turn, a spell is cast. It can be holy fire that ignites ground under him, it can be a call to arms that brings new soldiers to him or a burst of blinding light that limits the chance to hit of nearby enemies."
#endif
    [/dummy]
        {ABILITY_ILLUMINATES}
        {ABILITY_CURES}
        {ABILITY_REGENERATES_OTHER 40}
    [/abilities]
    [resistance]
        arcane=30
        blade=90
        pierce=90
        impact=90
    [/resistance]
    [healing_anim]
        [frame]
            begin=-525
            end=-450
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            begin=-450
            end=-375
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=-375
            end=-300
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/holy/halo6.png
        [/frame]
        [frame]
            begin=-300
            end=-225
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/holy/halo1.png
        [/frame]
        [frame]
            begin=-225
            end=-150
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo2.png
        [/frame]
        [frame]
            begin=-150
            end=-75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo3.png
        [/frame]
        [frame]
            begin=-75
            end=0
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo4.png
        [/frame]
        [frame]
            begin=0
            end=75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo5.png
        [/frame]
        [frame]
            begin=75
            end=150
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/holy/halo6.png
        [/frame]
        [frame]
            begin=150
            end=225
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=225
            end=300
            image="units/humans/celestial.png"
        [/frame]
    [/healing_anim]
    [attack]
        name=mace
        description=_"mace"
        type=impact
        range=melee
        damage=10
        number=3
        icon=attacks/mace-spiked.png
        attack_weight=0
        [specials]
            {DAZZLE_COUNTER}
        [/specials]
    [/attack]
    [attack]
        name=lightbeam
        description=_"lightbeam"
        type=arcane
        range=ranged
        [specials]
            {WEAPON_SPECIAL_MAGICAL}
            {DAZZLE_COUNTER}
        [/specials]
        damage=12
        number=4
        attack_weight=0
    [/attack]
    [attack]
            name=firestorm
            description=_"firestorm"
            type=fire
            [specials]
                {WEAPON_SPECIAL_MAGICAL}
                {WEAPON_SPECIAL_STORM}
                {DAZZLE_COUNTER}
            [/specials]
            range=ranged
            damage=25
            number=2
            icon=attacks/firestorm.png
            defense_weight=0
    [/attack]
    [attack_anim]
        [filter_attack]
            name=firestorm
        [/filter_attack]
        {MISSILE_FRAME_FIRESTORM}

        start_time=-250
        [if]
            hits=yes
            [frame]
                duration=50
                image="units/humans/celestial-attack-ranged-1.png"
                halo=halo/elven/faerie-fire-halo2.png
                sound=fire.wav
            [/frame]
        [/if]
        [else]
            hits=no
            [frame]
                duration=50
                image="units/humans/celestial-attack-ranged-1.png"
                halo=halo/elven/faerie-fire-halo2.png
            [/frame]
        [/else]
        [frame]
            duration=100
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/elven/faerie-fire-halo3.png
        [/frame]
        [frame]
            duration=100
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/elven/faerie-fire-halo4.png
        [/frame]
        [frame]
            duration=100
            image="units/humans/celestial-attack-ranged-1.png"
            halo=halo/elven/faerie-fire-halo5.png
        [/frame]
        [frame]
            duration=50
            image="units/humans/celestial.png"
        [/frame]
    [/attack_anim]
    [attack_anim]
        [filter_attack]
            name=lightbeam
        [/filter_attack]
        {MISSILE_FRAME_LIGHT_BEAM}

        [frame]
            begin=-300
            end=-225
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            begin=-225
            end=-150
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=-150
            end=-75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo6.png
        [/frame]
        [if]
            hits=yes
            [frame]
                begin=-75
                end=0
                image="units/humans/celestial-attack-ranged-2.png"
                sound={SOUND_LIST:HOLY}
                halo=halo/holy/halo1.png
            [/frame]
        [/if]
        [else]
            hits=no
            [frame]
                begin=-75
                end=0
                image="units/humans/celestial-attack-ranged-2.png"
                sound={SOUND_LIST:HOLY_MISS}
                halo=halo/holy/halo1.png
            [/frame]
        [/else]
        [frame]
            begin=0
            end=75
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo3.png
        [/frame]
        [frame]
            begin=75
            end=150
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo5.png
        [/frame]

        [frame]
            begin=150
            end=200
            image="units/humans/celestial-attack-ranged-2.png"
            halo=halo/holy/halo6.png
        [/frame]
        [frame]
            begin=200
            end=250
            image="units/humans/celestial-attack-ranged-1.png"
        [/frame]
        [frame]
            begin=250
            end=300
            image="units/humans/celestial.png"
        [/frame]
    [/attack_anim]
    [attack_anim]
        [filter_attack]
            name=mace
        [/filter_attack]
        [frame]
            begin=-300
            end=-275
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            begin=-275
            end=-200
            image="units/humans/celestial-attack-melee-1.png"
        [/frame]
        [if]
            hits=yes
            [frame]
                begin=-200
                end=0
                image="units/humans/celestial-attack-melee-2.png"
                sound=mace.wav
            [/frame]
            [frame]
                begin=0
                end=200
                image="units/humans/celestial-attack-melee-3.png"
                sound=mace.wav
            [/frame]
        [/if]
        [else]
            hits=no
            [frame]
                begin=-200
                end=0
                image="units/humans/celestial-attack-melee-2.png"
                sound={SOUND_LIST:MISS}
            [/frame]
            [frame]
                begin=0
                end=200
                image="units/humans/celestial-attack-melee-3.png"
                sound={SOUND_LIST:MISS}
            [/frame]
        [/else]
        [frame]
            begin=200
            end=300
            image="units/humans/celestial-attack-melee-4.png"
        [/frame]
        [frame]
            begin=300
            end=325
            image="units/humans/celestial.png"
        [/frame]
    [/attack_anim]
    [standing_anim]
        start_time=0
        layer=60
        [frame]
            duration=200
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-1.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-2.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-3.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-4.png"
        [/frame]
    [/standing_anim]
    [movement_anim]
        start_time=0
        [frame]
            duration=200
            image="units/humans/celestial.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-1.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-2.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-3.png"
        [/frame]
        [frame]
            duration=200
            image="units/humans/celestial-standing-4.png"
        [/frame]
    [/movement_anim]
    [event]
    name=turn refresh
    id=spellcasting_light
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=spellcasting_light
        [/filter]
        variable=casters
        kill=no
    [/store_unit]
    {FOREACH casters i}
        {VARIABLE_OP spell rand (holy_fire,call_to_arms,burst_of_light)}
        [switch]
            variable=spell
            [case]
                value=holy_fire
                [floating_text]
                    x,y=$casters[$i].x,$casters[$i].y
                    text=_"Holy Fire!"
                [/floating_text]
                {VARIABLE already no}
                {FOREACH burning_ground j}
                    [if]
                        [variable]
                            name=burning_ground[$j].x
                            equals=$casters[$i].x
                        [/variable]
                        [and]
                            [variable]
                                name=burning_ground[$j].x
                                equals=$casters[$i].x
                            [/variable]
                        [/and]
                        [and]
                            [variable]
                                name=burning_ground[$j].side
                                equals=$casters[$i].side
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE already yes}
                        [/then]
                    [/if]
                {NEXT j}
                [if]
                    [variable]
                        name=already
                        equals=no
                    [/variable]
                    [then]
                        [set_variables]
                            mode=replace
                            name=burning_ground[$burning_ground.length]
                            [value]
                                x,y=$casters[$i].x,$casters[$i].y
                                side=$casters[$i].side
                            [/value]
                        [/set_variables]
                        [item]
                            halo=burning_ground/burning-ground-1.png:80,burning_ground/burning-ground-2.png:80,burning_ground/burning-ground-3.png:80,burning_ground/burning-ground-4.png:80,burning_ground/burning-ground-5.png:80,burning_ground/burning-ground-6.png:80,burning_ground/burning-ground-7.png:80,burning_ground/burning-ground-8.png:80
                            x,y=$casters[$i].x,$casters[$i].y
                            visible_in_fog=no
                        [/item]
                        [event]
                            name=victory
                            id=remove_burning_ground_notes
                            {CLEAR_VARIABLE burning_ground}
                        [/event]
                    [/then]
                [/if]
            [/case]
            [case]
                value=call_to_arms
                [floating_text]
                    x,y=$casters[$i].x,$casters[$i].y
                    text=_"Call to Arms!"
                [/floating_text]
                {VARIABLE count 0}
                [while]
                    [variable]
                        name=count
                        {QUANTITY less_than 4 5 6}
                    [/variable]
                    [do]
                        {VARIABLE_OP type rand "Pikeman,Spearman,Swordsman,Bowman,Lieutenant,Heavy Infantryman"}
                        {GENERIC_UNIT $side_number $type $casters[$i].x $casters[$i].y}
                        [+unit]
                            animate=yes
                            moves=0
                            attacks_left=0
                            [modifications]
                                [advance]
                                    id=dazzle_effect
                                    [effect]
                                        apply_to=attack
                                        [set_specials]
                                                {DAZZLE_COUNTER}
                                        [/set_specials]
                                    [/effect]
                                [/advance]
                            [/modifications]
                        [/unit]
                        {VARIABLE_OP count add 1}
                    [/do]
                [/while]
                {CLEAR_VARIABLE count,type}
            [/case]
            [case]
                value=burst_of_light
                [floating_text]
                    x,y=$casters[$i].x,$casters[$i].y
                    text=_"Light of Divinity!"
                [/floating_text]
                {COLOR_ADJUST 200 200 200}
                [delay]
                    time=300
                [/delay]
                {COLOR_ADJUST 0 0 0}
                [store_unit]
                    [filter]
                        [filter_location]
                            x,y=$casters[$i].x,$casters[$i].y
                            radius=6
                        [/filter_location]
                        [filter_side]
                            [enemy_of]
                                side=$side_number
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    variable=targets
                    kill=no
                [/store_unit]
                {FOREACH targets i}
                    {VARIABLE targets[$i].variables.dazzled yes}
                    [unstore_unit]
                        variable=targets[$i]
                        find_vacant=no
                        text=_"blinded"
                        {COLOR_HARM}
                    [/unstore_unit]
                    [event]
                        delayed_variable_substitution=no
                        name=turn refresh
                        [filter_side]
                            side=$side_number
                        [/filter_side]
                        [store_unit]
                            [filter]
                                id=$targets[$i].id
                            [/filter]
                            variable=undazzled
                        [/store_unit]
                        {CLEAR_VARIABLE undazzled.variables.dazzled}
                        [unstore_unit]
                            variable=undazzled
                            find_vacant=no
                        [/unstore_unit]
                        {CLEAR_VARIABLE undazzled}
                    [/event]
                {NEXT i}
                {CLEAR_VARIABLE targets}
            [/case]
        [/switch]
        [fire_event]
            name=spellcast
            [primary_unit]
                id=$casters[$i]
            [/primary_unit]
        [/fire_event]
    {NEXT i}
    {CLEAR_VARIABLE casters,spell}
    [/event]
    [event]
    name=turn refresh
    id=burning_ground_damaging_event
    first_time_only=no
    [store_side]
        side=$side_number
        variable=this_side
    [/store_side]
    {FOREACH burning_ground i}
        [store_side]
            side=$burning_ground[$i].side
            variable=burning_ground_side
        [/store_side]
        [if]
            [variable]
                name=this_side.team_name
                equals=$burning_ground_side.team_name
            [/variable]
            [else]
                [if]
                    [have_unit]
                        [filter_location]
                            x,y=$burning_ground[$i].x,$burning_ground[$i].y
                            radius=1
                        [/filter_location]
                        side=$side_number
                    [/have_unit]
                    [then]
                        [fire_event]
                            name=burning ground
                        [/fire_event]
                    [/then]
                [/if]
                [harm_unit]
                    [filter]
                    [filter_location]
                        x,y=$burning_ground[$i].x,$burning_ground[$i].y
                        radius=1
                    [/filter_location]
                    side=$side_number
                    [/filter]
                    amount=24
                    damage_type=fire
                [/harm_unit]
            [/else]
        [/if]
        {CLEAR_VARIABLE burning_ground_side}
    {NEXT i}
    {CLEAR_VARIABLE this_side}
    [/event]
[/unit_type]
#undef DAZZLE_COUNTER
