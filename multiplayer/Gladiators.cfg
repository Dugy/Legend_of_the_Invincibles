#textdomain wesnoth-loti
#define GENDER_CHOICE
    [message]
        speaker=narrator
        message= _ "Choose gender."
        side_for=$side_number
        image=wesnoth-icon.png
        [option]
            message= _ "Male"
            [command]
                {VARIABLE gender_picked male}
            [/command]
        [/option]
        [option]
            message= _ "Female"
            [command]
                {VARIABLE gender_picked female}
            [/command]
        [/option]
    [/message]
#enddef
#define CH08G_OBSERVER SIDE TYPE X Y
    [unit]
        side={SIDE}
        type={TYPE}
        x={X}
        y={Y}
        generate_name=yes
        random_traits=yes
        random_gender=yes
        upkeep=full
        [modifications]
            [object]
                [effect]
                    apply_to=movement_costs
                    replace="true"
                    [movement_costs]
                        flat={UNREACHABLE}
                        sand={UNREACHABLE}
                        forest={UNREACHABLE}
                        village={UNREACHABLE}
                    [/movement_costs]
                [/effect]
            [/object]
        [/modifications]
    [/unit]
#enddef
[multiplayer]
    id=LotI-Gladiators
    name= _ "LotI - Gladiators"
    description= _ "This is a multiplayer scenario designed to be a multiplayer version of the Gladiatrix scenario from the Legend of the Invincibles campaign.

Several mighty warriors were captured by the corrupted empire of Karhaba and used as gladiators to please the inhabitants. All schemed by demons in order to turn the citizens into something as evil as they are. Lead the captives to survival.

The difficulty is adjustable, for 1-5 players, so you can balance it yourself. Use map settings or you're screwed at the start, eras and factions will have no effect on this (you will have to choose your hero at the beginning of the scenario)."
    turns="-1"
    experience_modifier="60"
    map_data="{~add-ons/Legend_of_the_Invincibles/multiplayer/MP_Arena.map}"
    fog=no
    shroud=no
    {DUSK1}
    [side]
        side=1
        id=hero1
        type=Warlock
        canrecruit=yes
        team_name="heroes"
        user_team_name= _ "teamname^Heroes"
        controller="human"
        save_id="hero1"
        recruit=
        village_gold=0
        gold=50
        income=-2
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        fog=no
        share_view="yes"
        share_maps=yes
        shroud=no
    [/side]
    [side]
        side=2
        id=hero2
        type=Scythemaster
        canrecruit=yes
        team_name="heroes"
        user_team_name= _ "teamname^Heroes"
        controller="human"
        save_id="hero2"
        recruit=
        village_gold=0
        gold=50
        income=-2
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        fog=no
        share_view="yes"
        share_maps=yes
        shroud=no
    [/side]
    [side]
        side=3
        id=hero3
        type=Dwarvish Hero
        canrecruit=yes
        team_name="heroes"
        user_team_name= _ "teamname^Heroes"
        controller="human"
        save_id="hero3"
        recruit=
        village_gold=0
        gold=50
        income=-2
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        fog=no
        share_view="yes"
        share_maps=yes
        shroud=no
    [/side]
    [side]
        side=4
        id=hero4
        type=Blackguard
        canrecruit=yes
        team_name="heroes"
        user_team_name= _ "teamname^Heroes"
        controller="human"
        save_id="hero4"
        recruit=
        village_gold=0
        gold=50
        income=-2
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        fog=no
        share_view="yes"
        share_maps=yes
        shroud=no
    [/side]
    [side]
        side=5
        id=hero5
        type=Elvish Juggernaut
        canrecruit=yes
        team_name="heroes"
        user_team_name= _ "teamname^Heroes"
        controller="human"
        save_id="hero5"
        recruit=
        village_gold=0
        gold=50
        income=-2
        gold_lock="true"
        income_lock="true"
        team_lock="true"
        fog=no
        share_view="yes"
        share_maps=yes
        shroud=no
    [/side]
    [side]
        no_leader=yes
        side=6
        allow_player=no
        team_name=Opponents
        user_team_name=_"Opponents"
        [ai]
            aggression=1.0
            caution=-10
            {MODIFY_AI_ADD_ASPECT 6 attacks (
                [facet]
                    name=testing_ai_default::aspect_attacks
                    id=dont_attack_hidden
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=7
                        [/not]
                    [/filter_enemy]
                [/facet]
            )}
        [/ai]
        defeat_condition=never
    [/side]
    [side]
        id=emperor
        name=Emperor Abbath I
        type=Demon Infiltrator Prophet
        gender=male
        random_traits=yes
        side=7
        allow_player=no
        recruit=
        team_name=heroes,Opponents
        user_team_name=_"Observers"
        village_gold=0
        ai_formula=idle_ai
        gold=0
        income=-2
        [modifications]
            [object]
                [effect]
                    apply_to=movement_costs
                    replace="true"
                    [movement_costs]
                        flat={UNREACHABLE}
                        sand={UNREACHABLE}
                        forest={UNREACHABLE}
                        village={UNREACHABLE}
                    [/movement_costs]
                [/effect]
            [/object]
        [/modifications]
        [unit]
            type=Merchant
            x,y=22,2
            id=trader
            generate_name=yes
            ai_special=guardian
            random_traits=no
            [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                [advancement]
#else
                [advance]
#endif
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                [/advancement]
#else
                [/advance]
#endif
            [/modifications]
        [/unit]
        [unit]
            type=Merchant
            x,y=28,3
            id=trader2
            generate_name=yes
            ai_special=guardian
            random_traits=no
            [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                [advancement]
#else
                [advance]
#endif
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                [/advancement]
#else
                [/advance]
#endif
            [/modifications]
        [/unit]
        [unit]
            type=Merchant
            x,y=26,2
            id=trader3
            generate_name=yes
            ai_special=guardian
            random_traits=no
            [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                [advancement]
#else
                [advance]
#endif
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                [/advancement]
#else
                [/advance]
#endif
            [/modifications]
        [/unit]
        [unit]
            type=Merchant
            x,y=20,3
            id=trader4
            generate_name=yes
            ai_special=guardian
            random_traits=no
            [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                [advancement]
#else
                [advance]
#endif
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                [/advancement]
#else
                [/advance]
#endif
            [/modifications]
        [/unit]
        [unit]
            id=moderator
            type=Duelist
            x,y=14,18
            [modifications]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                            sand={UNREACHABLE}
                            forest={UNREACHABLE}
                            village={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [unit]
            id=observer1
            type=Spearman
            x,y=17,12
            [modifications]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                            sand={UNREACHABLE}
                            forest={UNREACHABLE}
                            village={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [unit]
            id=observer2
            type=Lieutenant
            x,y=31,13
            [modifications]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                            sand={UNREACHABLE}
                            forest={UNREACHABLE}
                            village={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [unit]
            id=observer3
            type=Peasant
            x,y=33,23
            [modifications]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                            sand={UNREACHABLE}
                            forest={UNREACHABLE}
                            village={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [unit]
            id=observer4
            type=Thug
            x,y=15,23
            [modifications]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                            sand={UNREACHABLE}
                            forest={UNREACHABLE}
                            village={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        {CH08G_OBSERVER 7 "Spearman" 20 26}
        {CH08G_OBSERVER 7 "Demon Infiltrator Bowman" 17 26}
        {CH08G_OBSERVER 7 "Spearman" 16 23}
        {CH08G_OBSERVER 7 "Mage" 14 23}
        {CH08G_OBSERVER 7 "Spearman" 15 22}
        {CH08G_OBSERVER 7 "Mage" 14 22}
        {CH08G_OBSERVER 7 "Red Mage" 13 22}
        {CH08G_OBSERVER 7 "Sergeant" 12 19}
        {CH08G_OBSERVER 7 "White Mage" 12 16}
        {CH08G_OBSERVER 7 "Spearman" 15 16}
        {CH08G_OBSERVER 7 "Spearman" 17 25}
        {CH08G_OBSERVER 7 "Longbowman" 14 15}
        {CH08G_OBSERVER 7 "Thief" 15 14}
        {CH08G_OBSERVER 7 "Footpad" 16 12}
        {CH08G_OBSERVER 7 "Spearman" 17 13}
        {CH08G_OBSERVER 7 "Demon Infiltrator Swordsman" 17 11}
        {CH08G_OBSERVER 7 "Swordsman" 18 26}
        {CH08G_OBSERVER 7 "Spearman" 18 11}
        {CH08G_OBSERVER 7 "Mage" 20 9}
        {CH08G_OBSERVER 7 "Mage" 19 11}
        {CH08G_OBSERVER 7 "Heavy Infantryman" 28 10}
        {CH08G_OBSERVER 7 "Duelist Wizard" 30 10}
        {CH08G_OBSERVER 7 "Peasant" 31 12}
        {CH08G_OBSERVER 7 "Peasant" 15 13}
        {CH08G_OBSERVER 7 "Ruffian" 33 13}
        {CH08G_OBSERVER 7 "Ruffian" 19 10}
        {CH08G_OBSERVER 7 "Spearman" 34 15}
        {CH08G_OBSERVER 7 "Rogue" 36 17}
        {CH08G_OBSERVER 7 "Royal Guard" 34 19}
        {CH08G_OBSERVER 7 "Red Mage" 35 21}
        {CH08G_OBSERVER 7 "Demon Infiltrator Shock Trooper" 29 10}
        {CH08G_OBSERVER 7 "Mage" 33 22}
        {CH08G_OBSERVER 7 "Spearman" 33 24}
        {CH08G_OBSERVER 7 "Demon Infiltrator Spearman" 32 23}
        {CH08G_OBSERVER 7 "Bowman" 32 24}
        {CH08G_OBSERVER 7 "Spearman" 31 25}
        {CH08G_OBSERVER 7 "Javelineer" 34 22}
        {CH08G_OBSERVER 7 "Woodsman" 30 26}
        {CH08G_OBSERVER 7 "Woodsman" 30 11}
        {CH08G_OBSERVER 7 "Fencer" 28 36}
        {CH08G_OBSERVER 7 "Silver Mage" 32 13}
        {CH08G_OBSERVER 7 "Spearman" 34 17}
        {CH08G_OBSERVER 7 "Master at Arms" 33 15}
    [/side]

    [event]
        name=prestart
        [objectives]
            [objective]
                description= _ "Survive as long as possible"
                condition=win
            [/objective]
            [note]
                description= _ "Death of all heroes in a single round"
            [/note]
        [/objectives]
        {VARIABLE difficulties_to_adjust 1}
        {VARIABLE difficulty 0}
        {VARIABLE round 1}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        [if]
            [variable]
                name=difficulties_to_adjust
                equals=1
            [/variable]
            [and]
                [variable]
                    name=side_number
                    less_than=6
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=narrator
                    message= _ "Choose your hero."
                    side_for=$side_number
                    [option]
                        message="&" + "units/undead-necromancers/ancient-lich.png" + "=" + _"Ancient Lich"
                        [command]
                            {VARIABLE type_picked "09 Ancient Lich"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/arch-necromancer.png" + "=" + _"Arch Necromancer"
                        [command]
                            {VARIABLE type_picked "Arch Necromancer"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/blackguard.png" + "=" + _"Blackguard"
                        [command]
                            {VARIABLE type_picked "Blackguard"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/celestial.png" + "=" + _"Celestial Messenger"
                        [command]
                            {VARIABLE type_picked "Celestial Messenger"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/champion.png" + "=" + _"Champion"
                        [command]
                            {VARIABLE type_picked "Champion"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/championbowman.png" + "=" + _"Champion Bowman"
                        [command]
                            {VARIABLE type_picked "Champion Bowman"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/chaosrider.png" + "=" + _"Chaos Rider"
                        [command]
                            {VARIABLE type_picked "Chaos Rider"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/destroyer.png" + "=" + _"Destroyer"
                        [command]
                            {VARIABLE type_picked "Destroyer"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/duelist-wizard.png" + "=" + _"Duelist Wizard"
                        [command]
                            {VARIABLE type_picked "Duelist Wizard"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/dwarves/battlerager.png" + "=" + _"Dwarvish Battlerager"
                        [command]
                            {VARIABLE type_picked "Dwarvish Battlerager"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/dwarves/hero.png" + "=" + _"Dwarvish Hero"
                        [command]
                            {VARIABLE type_picked "Dwarvish Hero"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/dwarves/protector.png" + "=" + _"Dwarvish Protector"
                        [command]
                            {VARIABLE type_picked "Dwarvish Protector"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/dwarves/technocrat.png" + "=" + _"Dwarvish Technocrat"
                        [command]
                            {VARIABLE type_picked "Dwarvish Technocrat"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/elves/assassin.png" + "=" + _"Elvish Assassin"
                        [command]
                            {VARIABLE type_picked "Elvish Assassin"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/elves/gryphon-rider.png" + "=" + _"Elvish Gryphon Rider"
                        [command]
                            {VARIABLE type_picked "Elvish Gryphon Rider"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/elves/juggernaut.png" + "=" + _"Elvish Juggernaut"
                        [command]
                            {VARIABLE type_picked "Elvish Juggernaut"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/elves/nightprowler.png" + "=" + _"Elvish Nightprowler"
                        [command]
                            {VARIABLE type_picked "Elvish Nightprowler"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/elves/overlord.png" + "=" + _"Elvish Overlord"
                        [command]
                            {VARIABLE type_picked "Elvish Overlord"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/exterminator.png" + "=" + _"Exterminator"
                        [command]
                            {VARIABLE type_picked "Exterminator"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/elves/incarnation.png" + "=" + _"Faerie Incarnation"
                        [command]
                            {VARIABLE type_picked "Faerie Incarnation"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/forester.png" + "=" + _"Forester"
                        [command]
                            {VARIABLE type_picked "Forester"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/orcs/strafer.png" + "=" + _"Orcish Strafer"
                        [command]
                            {VARIABLE type_picked "Orcish Strafer"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/orcs/warmonger.png" + "=" + _"Orcish Warmonger"
                        [command]
                            {VARIABLE type_picked "Orcish Warmonger"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/pilum-master.png" + "=" + _"Pilum Master"
                        [command]
                            {VARIABLE type_picked "Pilum Master"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/predator.png" + "=" + _"Predator"
                        [command]
                            {VARIABLE type_picked "Predator"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/prophet.png" + "=" + _"Prophet"
                        [command]
                            {VARIABLE type_picked "Prophet"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/scythemaster.png" + "=" + _"Scythemaster"
                        [command]
                            {VARIABLE type_picked "Scythemaster"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/assassin-sword.png" + "=" + _"Shadowalker"
                        [command]
                            {VARIABLE type_picked "Shadowalker"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/shadowprince.png" + "=" + _"Shadow Prince"
                        [command]
                            {VARIABLE type_picked "Shadow Prince"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/trolls/siege-troll-base.png" + "=" + _"Siege Troll"
                        [command]
                            {VARIABLE type_picked "Siege Troll"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/elves/snowhunter.png" + "=" + _"Snow Hunter"
                        [command]
                            {VARIABLE type_picked "Snow Hunter"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/swordmaster.png" + "=" + _"Swordmaster"
                        [command]
                            {VARIABLE type_picked "Swordmaster"}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/humans/warlock.png" + "=" + _"Warlock"
                        [command]
                            {VARIABLE type_picked "Warlock"}
                            {GENDER_CHOICE}
                        [/command]
                    [/option]
                    [option]
                        message="&" + "units/orcs/werewolf-rider.png" + "=" + _"Werewolf Rider"
                        [command]
                            {VARIABLE type_picked "Werewolf Rider"}
                        [/command]
                    [/option]
                [/message]
                [if]
                    [variable]
                        name=type_picked
                        not_equals=""
                    [/variable]
                    [else]
                        {VARIABLE type_picked "Warlock"}
                    [/else]
                [/if]
                [store_unit]
                    [filter]
                        side=$side_number
                        canrecruit=yes
                    [/filter]
                    variable=leader
                    kill=yes
                [/store_unit]
                [if]
                    [variable]
                        name=gender_picked
                        equals=male
                    [/variable]
                    [or]
                        [variable]
                            name=gender_picked
                            equals=female
                        [/variable]
                    [/or]
                    [then]
                        [unit]
                            side=$side_number
                            type=$type_picked
                            id=$leader.id
                            x,y=$leader.x,$leader.y
                            name=$leader.name
                            gender=$gender_picked
                            canrecruit=yes
                            to_variable=advanced2
                        [/unit]
                        [fire_event]
                            name=update_stats
                            [primary_unit]
                                id=$advanced2.id
                            [/primary_unit]
                        [/fire_event]
                    [/then]
                    [else]
                        [unit]
                            side=$side_number
                            type=$type_picked
                            id=$leader.id
                            x,y=$leader.x,$leader.y
                            name=$leader.name
                            canrecruit=yes
                            to_variable=advanced2
                        [/unit]
                        [fire_event]
                            name=update_stats
                            [primary_unit]
                                id=$advanced2.id
                            [/primary_unit]
                        [/fire_event]
                    [/else]
                [/if]
                {CLEAR_VARIABLE type_picked}
                [message]
                    speaker=narrator
                    message= _ "Which difficulty do you prefer?"
                    side_for=$side_number
                    image=wesnoth-icon.png
                    [option]
                        message= _ "Very hard"
                        [command]
                            {VARIABLE difficulty_picked 100}
                        [/command]
                    [/option]
                    [option]
                        message= _ "Quite hard"
                        [command]
                            {VARIABLE difficulty_picked 90}
                        [/command]
                    [/option]
                    [option]
                        message= _ "Normal"
                        [command]
                            {VARIABLE difficulty_picked 80}
                        [/command]
                    [/option]
                    [option]
                        message= _ "Rather easy"
                        [command]
                            {VARIABLE difficulty_picked 70}
                        [/command]
                    [/option]
                    [option]
                        message= _ "Very easy"
                        [command]
                            {VARIABLE difficulty_picked 60}
                        [/command]
                    [/option]
                [/message]
                {VARIABLE_OP difficulty add $difficulty_picked}
            [/then]
        [/if]
    [/event]

    [event]
        name=turn 2
        {CLEAR_VARIABLE difficulty_picked}
        {CLEAR_VARIABLE difficulties_to_adjust}
        {VARIABLE i $difficulty}
        [while]		#Randomness is too pseudorandom. This should shuffle it better, so that it completely depends on the difficulty selected.
            [variable]
                name=i
                greater_than=1
            [/variable]
            [do]
                {VARIABLE_OP i sub 5}
                {VARIABLE_OP k rand (1..5)}
            [/do]
        [/while]
        {CLEAR_VARIABLE k}
        [message]
            speaker=moderator
            message= _ "The combat will start soon!"
        [/message]
    [/event]

    [event]
        name=start
        [message]
            caption= _"Gladiators"
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "This is a multiplayer one-scenario campaign. At the beginning, you will choose your difficulty. The difficulty affects almost everything. You can gain gold for defeating enemy waves and randomly from enemies, and use it to buy items from traders.

The enemy waves are generated randomly, so it may happen that one will be harder than another. If a hero dies, he will respawn soon, but losing a lot of accumulated power.

Everyone will choose difficulty, and the selected difficulties will be averaged. Less players means lower difficulty as well."
        [/message]
        [set_variables]
            name=item_list
            mode=replace
            [value]
                {ITEM_LIST}
            [/value]
        [/set_variables]
        {RANDOM_ITEM 21 6}
        {RANDOM_ITEM 27 6}
        {VARIABLE i41 1}
        {VARIABLE i42 1}
        {VARIABLE i43 1}
        {VARIABLE i44 1}
        {VARIABLE i45 1}
        {VARIABLE i46 1}
        {VARIABLE i47 1}
        {VARIABLE i48 1}
        {VARIABLE i49 1}
        {VARIABLE i50 1}
        {VARIABLE i51 1}
        {VARIABLE i52 1}
        {VARIABLE i53 1}
    [/event]

    [event]
        name=last breath
        first_time_only=no
        [filter]
            canrecruit=yes
            side=1,2,3,4,5
            [not]
                ability=necromancy
                [not]
                    race=undead
                [/not]
            [/not]
        [/filter]
        {VARIABLE unit.hitpoints $unit.max_hitpoints}
        {VARIABLE unit.experience 0}
#ifver WESNOTH_VERSION >= 1.13.2
        {VARIABLE lost_advancement "$(unit.modifications.advancement.length-1)"}
#else
        {VARIABLE lost_advancement "$(unit.modifications.advance.length-1)"}
#endif
        [if]
            [variable]
                name=lost_advancement
                greater_than=0
            [/variable]
            [then]
#ifver WESNOTH_VERSION >= 1.13.2
                {CLEAR_VARIABLE "unit.modifications.advancement[$lost_advancement]"}
#else
                {CLEAR_VARIABLE "unit.modifications.advance[$lost_advancement]"}
#endif
            [/then]
        [/if]
        [set_variables]
            name=units_to_revive
            to_variable=unit
            mode=append
        [/set_variables]
        {CLEAR_VARIABLE lost_advancement}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1,2,3,4,5
            [filter_adjacent]
                x,y=22,2
            [/filter_adjacent]
        [/filter]
        [store_gold]
            side=$side_number
            variable=gold
        [/store_gold]
        [message]
            speaker=trader
            message= _ "Hello, I am a trader. I sell items. Look at my stock and tell me what would you like to look at more closely."
            side_for=$side_number
            {SELL_GEMS}
            {SHOP_ITEM _"Fine Bow" 45 23 items/bow-elven.png i1}
            {SHOP_ITEM _"Jawbreaker" 70 127 items/morningstar.png i2}
            {SHOP_ITEM _"Silver Axe" 40 29 items/axe.png i3}
            {SHOP_ITEM _"Dragon Claw" 35 36 items/sword.png i4}
            {SHOP_ITEM _"Cunctator's Sword" 50 100 items/crystal-blade.png i5}
            {SHOP_ITEM _"Staff of Kerathur" 80 4 items/staff-magic.png i6}
            {SHOP_ITEM _"Heathenbasher" 45 74 items/mace.png i19}
            {SHOP_ITEM _"Tormentor of Light" 50 75 items/mace.png i20}
            {SHOP_ITEM _"Dark Sword of Destruction" 65 156 items/sword.png i21}
            {SHOP_ITEM _"Godsmasher" 140 148 items/mace.png i22}
            {SHOP_ITEM _"Hellrake" 100 150 items/storm-trident.png i22}
            {SHOP_ITEM _"Stardust" 85 141 items/staff.png i23}
            {SHOP_ITEM _"Shadowalker's Dagger" 70 118 items/dagger.png i24}
            {SHOP_ITEM _"Deathwhirl" 110 107 items/sword.png i25}
            {SHOP_ITEM _"Headsmasher" 50 109 items/axe.png i26}
            {SHOP_ITEM _"Explosionlance" 40 92 items/spear-fancy.png i40}
            {SHOP_ITEM _"Balls of Steel" 40 607 items/bolas.png i54}
            {SHOP_ITEM _"Blooddrunk beast" 45 608 items/claws.png i55}
            {SHOP_ITEM _"Bean Shooter" 50 609 items/thunderstick.png i56}
            {SHOP_ITEM _"Winged Axe" 150 197 items/axe.png i41}
            {SHOP_ITEM _"Aevyn's Wrath" 200 202 items/swordbeam.png i42}
            {SHOP_ITEM _"Despicable Heroism" 180 197 items/mace.png i43}
            {SHOP_ITEM _"Corpsegrinder" 250 180 items/spear-fancy.png i51}
            [option]
                message= _ "Nothing"
                [command]
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE gold}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1,2,3,4,5
            [filter_adjacent]
                x,y=28,3
            [/filter_adjacent]
        [/filter]
        [store_gold]
            side=$side_number
            variable=gold
        [/store_gold]
        [message]
            speaker=trader2
            message= _ "Hello, I am a trader. I sell items. Look at my stock and tell me what would you like to look at more closely."
            side_for=$side_number
            {SELL_GEMS}
            {SHOP_ITEM _"Ancient Armour of the Power of the Ancients" 95 137 items/armor-aegis.png i7}
            {SHOP_ITEM _"Hell Warlord's Armour" 80 82 items/armour-fire.png i8}
            {SHOP_ITEM _"Rherraent's Armour" 25 114 items/armor.png i9}
            {SHOP_ITEM _"Greater Guardsman's Leather Armour" 120 143 items/armour-leather.png i27}
            {SHOP_ITEM _"Ice Armour" 60 15 items/armour-ice.png i28}
            {SHOP_ITEM _"Wanderlust" 40 66 items/boots.png i10}
            {SHOP_ITEM _"Boots of Evanescence" 35 71 items/boots.png i31}
            {SHOP_ITEM _"Boots of Fleeing" 40 97 items/boots.png i32}
            {SHOP_ITEM _"Nimble Boots" 40 98 items/boots.png i33}
            {SHOP_ITEM _"Irongut Helmet" 15 69 items/helmet.png i11}
            {SHOP_ITEM _"Dark Helmet of Destruction" 60 157 items/helmet.png i34}
            {SHOP_ITEM _"Shako" 70 129 items/helmet.png i35}
            {SHOP_ITEM _"Mask of Insanity" 100 81 items/helmet.png i36}
            {SHOP_ITEM _"Quick Gauntlets" 30 64 items/gauntlets.png i12}
            {SHOP_ITEM _"Draingloves" 30 132 items/gauntlets.png i37}
            {SHOP_ITEM _"Hellslash" 160 78 items/gauntlets.png i38}
            {SHOP_ITEM _"Mighty gauntlets" 30 63 items/gauntlets.png i39}
            {SHOP_ITEM _"Cunctator's Armour" 120 208 items/armor-aegis.png i44}
            {SHOP_ITEM _"Leechward" 150 165 items/armor-aegis.png i45}
            {SHOP_ITEM _"Brawler's Triumph" 100 206 items/gauntlets.png i46}
            {SHOP_ITEM _"Hand of Sorrow" 120 199 items/gauntlets.png i47}
            {SHOP_ITEM _"Cunctator's Helmet" 220 209 items/helmet.png i52}
            [option]
                message=_"Nothing"
                [command]
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE gold}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1,2,3,4,5
            [filter_adjacent]
                x,y=26,2
            [/filter_adjacent]
        [/filter]
        [store_gold]
            side=$side_number
            variable=gold
        [/store_gold]
        [message]
            speaker=trader3
            message= _ "Hello, I am a trader. I sell items. Look at my stock and tell me what would you like to look at more closely."
            side_for=$side_number
            {SELL_GEMS}
            {SHOP_ITEM _"Ring of Health" 40 73 items/ring-red.png i13}
            {SHOP_ITEM _"Demon Core" 50 83 items/ice-necklace.png i14}
            {SHOP_ITEM _"Cloak of Koschei" 85 133 items/cloak-black.png i15}
            {SHOP_ITEM _"Dazzling Ring" 35 96 items/ring-silver.png i16}
            {SHOP_ITEM _"Ring of the King" 15 154 items/ring-silver.png i30}
            {SHOP_ITEM _"Gloomy Amulet" 60 123 items/dark-necklace.png i17}
            {SHOP_ITEM _"Lucky Farmer's Amulet" 20 134 items/charm.png i29}
            {SHOP_ITEM _"Guide to Lycantropy" 70 101 items/book2.png i18}
            {SHOP_ITEM _"Potion of Vitality" 30 205 items/potion-red.png i48}
            {SHOP_ITEM _"Potion of the Northern Winds" 100 201 items/potion-blue.png i49}
            {SHOP_ITEM _"Precious Eagle Cactus Fruit" 90 186 items/ring-silver.png i50}
            {SHOP_ITEM _"Heart of Darkness" 250 181 items/book5.png i53}
            [option]
                message= _ "Nothing"
                [command]
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE gold}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1,2,3,4,5
            [filter_adjacent]
                x,y=20,3
            [/filter_adjacent]
        [/filter]
        [store_gold]
            side=$side_number
            variable=gold
        [/store_gold]
        [message]
            speaker=trader4
            message= _ "Hello, I am a trader. I sell items. Look at my stock and tell me what would you like to look at more closely. I know I am not the cheapest, but I can restock myself between duels."
            side_for=$side_number
            {SELL_GEMS}
            {SHOP_ITEM _"Obsidian" 10 521 items/obsidian.png ig1}
            {SHOP_ITEM _"Topaz" 15 522 items/topaz.png ig2}
            {SHOP_ITEM _"Opal" 20 523 items/opal.png ig3}
            {SHOP_ITEM _"Pearl" 30 524 items/pearl.png ig4}
            {SHOP_ITEM _"Diamond" 45 525 items/diamond.png ig5}
            {SHOP_ITEM _"Ruby" 65 526 items/ruby.png ig6}
            {SHOP_ITEM _"Emerald" 90 527 items/emerald.png ig7}
            {SHOP_ITEM _"Amethyst" 150 528 items/amethyst.png ig8}
            {SHOP_ITEM _"Sapphire" 220 529 items/sapphire.png ig9}
            {SHOP_ITEM _"Black Pearl" 350 530 items/black_pearl.png ig10}
            [option]
                message= _ "Nothing"
                [command]
                [/command]
            [/option]
        [/message]
        {CLEAR_VARIABLE gold}
    [/event]
    [event]
        name=turn 3
        first_time_only=no
        {MODIFY_TERRAIN Urb (23,25) (10,10)}
        [redraw]
        [/redraw]
        [message]
            speaker=emperor
            message= _ "Let the game start! Fight $round|."
        [/message]
        {VARIABLE_OP dialogue rand (1..5)}
        [if]
            [variable]
                name=dialogue
                equals=1
            [/variable]
            [then]
                [message]
                    speaker=moderator
                    message= _ "Ready to see some mayhem? Let it start!"
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=dialogue
                equals=2
            [/variable]
            [then]
                [message]
                    speaker=moderator
                    message= _ "Observers, honest people of Karhaba, now you will see another fight of survival of a group of our former enemies. Let us watch the inspiring fight!"
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=dialogue
                equals=3
            [/variable]
            [then]
                [message]
                    speaker=moderator
                    message= _ "Now, let us see if your favourite heroes shall survive this battle!"
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=dialogue
                equals=4
            [/variable]
            [then]
                [message]
                    speaker=moderator
                    message= _ "Did you ever wonder how might guts look? You might see it now! And hope the right side's guts shall be seen!"
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=dialogue
                equals=5
            [/variable]
            [then]
                [message]
                    speaker=moderator
                    message= _ "Wimps and cowards, leave the stage, the oncoming fight will be for the strong ones only!"
                [/message]
            [/then]
        [/if]
        {CLEAR_VARIABLE dialogue}
        [move_unit]
            side=1,2,3,4,5
            to_x=24
            to_y=13
            fire_event=no
        [/move_unit]
        {VARIABLE phase 1}
        {VARIABLE_OP enemy_theme rand (animals,undead,corruption,elementals,imps)}
        [if]
            [variable]
                name=enemy_theme
                equals=animals
            [/variable]
            [then]
                [if]
                    [variable]
                        name=difficulty
                        less_than=500
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Wolf,Great Wolf,Direwolf,Giant Spider,Giant Scorpion"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=900
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=500
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Wolf,Great Wolf,Direwolf,Giant Spider,Giant Scorpion,Hellhound,Shadow Hound"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1300
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=900
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Great Wolf,Direwolf,Giant Spider,Hellhound,Shadow Hound"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1700
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=1300
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Direwolf,Giant Spider,Hellhound,Hellhound,Shadow Hound"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        greater_than_equal_to=1700
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Hellhound,Shadow Hound"}
                    [/then]
                [/if]
                {VARIABLE spawn_count $difficulty}
                [set_variable]
                    name=spawn_count
                    divide=90
                    round=bottom
                [/set_variable]
            [/then]
        [/if]
        [if]
            [variable]
                name=enemy_theme
                equals=undead
            [/variable]
            [then]
                [if]
                    [variable]
                        name=difficulty
                        less_than=400
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Skeleton,Skeleton Archer,Ghost,Wraith,Revenant,Deathblade,Bone Shooter,Draug,Ghoul,Monstrosity"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=800
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=400
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Skeleton,Skeleton Archer,Ghost,Wraith,Revenant,Deathblade,Bone Shooter,Draug,Spectre,Death Knight,Grim Knight,Banebow,Ghoul,Necrophage,Monstrosity"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1200
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=800
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Wraith,Revenant,Deathblade,Bone Shooter,Draug,Spectre,Death Knight,Grim Knight,Banebow,Ghoul,Necrophage,Nightgaunt,Deathlord,Chocobone,Phantom,Monstrosity"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1600
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=1200
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Wraith,Revenant,Deathblade,Bone Shooter,Draug,Spectre,Death Knight,Grim Knight,Banebow,Ghoul,Necrophage,Nightgaunt,Deathlord,Chocobone,Phantom,Soul Shooter,Reaper,Ghast,Monstrosity,Abomination"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        greater_than_equal_to=1600
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Draug,Spectre,Death Knight,Grim Knight,Banebow,Ghoul,Necrophage,Nightgaunt,Deathlord,Chocobone,Phantom,Soul Shooter,Reaper,Ghast,Abomination,Monstrosity"}
                    [/then]
                [/if]
                {VARIABLE spawn_count $difficulty}
                [set_variable]
                    name=spawn_count
                    divide=75
                    round=bottom
                [/set_variable]
            [/then]
        [/if]
        [if]
            [variable]
                name=enemy_theme
                equals=corruption
            [/variable]
            [then]
                [if]
                    [variable]
                        name=difficulty
                        less_than=400
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Corrupted Orcish Grunt,Corrupted Orcish Assassin,Corrupted Elvish Fighter,Corrupted Elvish Scout,Corrupted Elvish Archer,Corrupted Drake Clasher,Corrupted Drake Fighter,Spell Eater"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=900
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=400
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Corrupted Orcish Grunt,Corrupted Orcish Assassin,Corrupted Orcish Slayer,Corrupted Orcish Warrior,Corrupted Elvish Fighter,Corrupted Elvish Hero,Corrupted Elvish Scout,Corrupted Elvish Rider,Corrupted Elvish Archer,Corrupted Elvish Ranger,Corrupted Drake Clasher,Corrupted Drake Fighter,Corrupted Drake Arbiter,Corrupted Drake Thrasher,Corrupted Drake Warrior,Spell Eater,Spell Eater"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1300
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=900
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Corrupted Orcish Grunt,Corrupted Orcish Assassin,Corrupted Orcish Slayer,Corrupted Orcish Warrior,Corrupted Elvish Fighter,Corrupted Elvish Hero,Corrupted Elvish Scout,Corrupted Elvish Rider,Corrupted Elvish Archer,Corrupted Elvish Ranger,Corrupted Drake Clasher,Corrupted Drake Fighter,Corrupted Drake Arbiter,Corrupted Drake Thrasher,Corrupted Drake Warrior,Corrupted Elvish Nightprowler,Corrupted Orcish Sovereign,Corrupted Naga Warrior,Corrupted Naga Myrmidon,Spell Eater,Spell Eater"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1800
                    [/variable]
                    [and]
                        [variable]
                            name=difficulty
                            greater_than_equal_to=1300
                        [/variable]
                    [/and]
                    [then]
                        {VARIABLE spawn_types "Corrupted Orcish Slayer,Corrupted Orcish Warrior,Corrupted Elvish Fighter,Corrupted Elvish Hero,Corrupted Elvish Rider,Corrupted Elvish Ranger,Corrupted Drake Arbiter,Corrupted Drake Thrasher,Corrupted Drake Warrior,Corrupted Elvish Nightprowler,Corrupted Orcish Sovereign,Corrupted Naga Warrior,Corrupted Naga Myrmidon,Spell Eater,Spell Eater"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        greater_than_equal_to=1800
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Corrupted Elvish Fighter,Corrupted Elvish Hero,Corrupted Elvish Rider,Corrupted Elvish Ranger,Corrupted Drake Arbiter,Corrupted Drake Thrasher,Corrupted Drake Warrior,Corrupted Elvish Nightprowler,Corrupted Orcish Sovereign,Corrupted Naga Warrior,Corrupted Naga Myrmidon,Spell Eater,Spell Eater"}
                    [/then]
                [/if]
                {VARIABLE spawn_count $difficulty}
                [set_variable]
                    name=spawn_count
                    divide=150
                    round=bottom
                [/set_variable]
            [/then]
        [/if]
        [if]
            [variable]
                name=enemy_theme
                equals=elementals
            [/variable]
            [then]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1000
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Fire Guardian,Fire Guardian,Ice Spirit"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        greater_than_equal_to=1000
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Fire Guardian,Ice Spirit,Ice Spirit"}
                    [/then]
                [/if]
                {VARIABLE spawn_count $difficulty}
                [set_variable]
                    name=spawn_count
                    divide=60
                    round=bottom
                [/set_variable]
            [/then]
        [/if]
        [if]
            [variable]
                name=enemy_theme
                equals=imps
            [/variable]
            [then]
                [if]
                    [variable]
                        name=difficulty
                        less_than=1100
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Imp,Imp,Doom Imp"}
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=difficulty
                        greater_than_equal_to=1100
                    [/variable]
                    [then]
                        {VARIABLE spawn_types "Imp,Doom Imp,Doom Imp"}
                    [/then]
                [/if]
                {VARIABLE spawn_count $difficulty}
                [set_variable]
                    name=spawn_count
                    divide=50
                    round=bottom
                [/set_variable]
            [/then]
        [/if]
        {VARIABLE second_spawn_count "$($spawn_count/2)"}
        {VARIABLE remaining_spawns 0}
        {VARIABLE spawns_omitted 0}
        [if]
            [variable]
                name=spawn_count
                greater_than=36
            [/variable]
            [then]
                {VARIABLE remaining_spawns "$($spawn_count-36)"}
                {VARIABLE spawn_count 36}
            [/then]
        [/if]
        [if]
            [variable]
                name=remaining_spawns
                greater_than=60
            [/variable]
            [then]
                {VARIABLE spawns_omitted "$($remaining_spawns-60)"}
                {VARIABLE remaining_spawns 60}
            [/then]
        [/if]
        [while]
            [variable]
                name=spawn_count
                greater_than=0
            [/variable]
            [do]
                {VARIABLE_OP spawn_type rand $spawn_types}
                [if]
                    [variable]
                        name=remaining_spawns
                        greater_than_equal_to=1
                    [/variable]
                    [then]
                        {GENERIC_UNIT 6 $spawn_type 24 30}
                        [+unit]
                            [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                                [advancement]
#else
                                [advance]
#endif
                                    id=monster_init
                                    [effect]
                                        apply_to=hitpoints
                                        increase_total=$spawns_omitted
                                        heal_full=yes
                                    [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                                [/advancement]
#else
                                [/advance]
#endif
                            [/modifications]
                        [/unit]
                    [/then]
                    [else]
                        {GENERIC_UNIT 6 $spawn_type 24 30}
                    [/else]
                [/if]
                {VARIABLE_OP spawn_count sub 1}
            [/do]
        [/while]
        {CLEAR_VARIABLE spawn_count,spawn_type}
    [/event]
    [event]
        name=die
        [filter]
            side=6
        [/filter]
        first_time_only=no
        [if]
            [variable]
                name=remaining_spawns
                greater_than_equal_to=1
            [/variable]
            [then]
                {VARIABLE_OP spawn_type rand $spawn_types}
                {GENERIC_UNIT 6 $spawn_type 24 30}
                [+unit]
                    [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                        [advancement]
#else
                        [advance]
#endif
                            id=monster_init
                            [effect]
                                apply_to=hitpoints
                                increase_total=$remaining_spawns
                                heal_full=yes
                            [/effect]
                            [effect]
                                apply_to=attack
                                increase_damage=$remaining_spawns|%
                            [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                        [/advancement]
#else
                        [/advance]
#endif
                    [/modifications]
                [/unit]
                {VARIABLE_OP remaining_spawns sub 1}
                {CLEAR_VARIABLE spawn_type}
            [/then]
        [/if]
        [fire_event]
            name=enemy_check
        [/fire_event]
    [/event]
    [event]
        name=new turn	#For the case of something went wrong
        first_time_only=no
        [if]
            [variable]
                name=turn_number
                greater_than=2
            [/variable]
            [then]
                [if]
                    [variable]
                        name=remaining_spawns
                        greater_than_equal_to=1
                    [/variable]
                    [then]
                        {VARIABLE_OP spawn_type rand $spawn_types}
                        {GENERIC_UNIT 6 $spawn_type 24 30}
                        [+unit]
                            [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                                [advancement]
#else
                                [advance]
#endif
                                    id=monster_init
                                    [effect]
                                        apply_to=hitpoints
                                        increase_total=$remaining_spawns
                                        heal_full=yes
                                    [/effect]
                                    [effect]
                                        apply_to=attack
                                        increase_damage=$remaining_spawns|%
                                    [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                                [/advancement]
#else
                                [/advance]
#endif
                            [/modifications]
                        [/unit]
                        {CLEAR_VARIABLE spawn_type}
                    [/then]
                [/if]
                [fire_event]
                    name=enemy_check
                [/fire_event]
            [/then]
        [/if]
    [/event]
    [event]
        name=enemy_check
        first_time_only=no
        [if]
            [have_unit]
                side=6
            [/have_unit]
            [else]
                [if]
                    [variable]
                        name=phase
                        equals=1
                    [/variable]
                    [then]
                        [message]
                            speaker=moderator
                            message= _ "Prepare your position for another enemy wave!"
                        [/message]
                        {VARIABLE phase 2}
                        [event]
                            name=turn end
                            [message]
                                speaker=moderator
                                message= _ "The enemy wave will arrive in any moment, beware!"
                            [/message]
                            [event]
                                name=turn end
                                {VARIABLE hitpoints $difficulty}
                                {VARIABLE damage $difficulty}
                                {VARIABLE_OP boss_type rand (Fire Dragon loti,Ice Dragon,Dark Dragon,Skeletal Dragon,Dracolich,Reaper,Dark Shade,Lich King,Corrupted Elvish Juggernaut,Ancient Lich,Spell Eater)}
                                [set_variables]
                                    name=boss_object
                                    mode=replace
                                    [value]
                                        [effect]
                                            apply_to=max_experience
                                            increase=1319
                                        [/effect]
                                    [/value]
                                [/set_variables]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Fire Dragon loti
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 10}
                                        {VARIABLE_OP hitpoints divide "2.5"}
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Ice Dragon
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 12}
                                        {VARIABLE_OP hitpoints divide "2.9"}
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Dark Dragon
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 14}
                                        {VARIABLE_OP hitpoints divide "4.2"}
                                        [set_variables]
                                            name=boss_object
                                            mode=replace
                                            [value]
                                                [effect]
                                                    apply_to=hitpoints
                                                    increase_total=-300
                                                    increase=-300
                                                [/effect]
                                                [effect]
                                                    apply_to=attack
                                                    increase_damage=-40%
                                                [/effect]
                                                [effect]
                                                    apply_to=max_experience
                                                    increase=1319
                                                [/effect]
                                            [/value]
                                        [/set_variables]
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Skeletal Dragon
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 12}
                                        {VARIABLE_OP hitpoints divide "2"}
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Dracolich
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 20}
                                        {VARIABLE_OP hitpoints divide "5.8"}
                                        [set_variables]
                                            name=boss_object
                                            mode=replace
                                            [value]
                                                [effect]
                                                    apply_to=hitpoints
                                                    increase_total=-300
                                                    increase=-300
                                                [/effect]
                                                [effect]
                                                    apply_to=attack
                                                    increase_damage=-40%
                                                [/effect]
                                                [effect]
                                                    apply_to=max_experience
                                                    increase=1319
                                                [/effect]
                                            [/value]
                                        [/set_variables]
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Reaper
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 8}
                                        {VARIABLE_OP hitpoints divide "3.3"}
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Lich King
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 8}
                                        {VARIABLE_OP hitpoints divide "2.1"}
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Ancient Lich
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 8}
                                        {VARIABLE_OP hitpoints divide "2.2"}
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Dark Shade
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 8}
                                        {VARIABLE_OP hitpoints divide "3.1"}
                                    [/then]
                                [/if]
                                [if]
                                    [variable]
                                        name=boss_type
                                        equals=Corrupted Elvish Juggernaut
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP damage divide 8}
                                        {VARIABLE_OP hitpoints divide "4.7"}
                                    [/then]
                                [/if]
                                [unit]
                                    side=6
                                    type=$boss_type
                                    x,y=24,30
                                    {IS_HERO}
                                    [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                                        [advancement]
#else
                                        [advance]
#endif
                                            [effect]
                                                apply_to=hitpoints
                                                increase_total=$hitpoints
                                            [/effect]
                                            [effect]
                                                apply_to=attack
                                                increase_damage=$damage%
                                            [/effect]
                                            [effect]
                                                apply_to=resistance
                                                replace=false
                                                [resistance]
                                                    arcane=-40
                                                [/resistance]
                                            [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                                        [/advancement]
#else
                                        [/advance]
#endif
                                        [insert_tag]
                                            name=advance
                                            variable=boss_object
                                        [/insert_tag]
                                    [/modifications]
                                [/unit]
                                {VARIABLE remaining_spawns 0}
                                [if]
                                    [variable]
                                        name=second_spawn_count
                                        greater_than=36
                                    [/variable]
                                    [then]
                                        {VARIABLE remaining_spawns "$($second_spawn_count-36)"}
                                        {VARIABLE second_spawn_count 36}
                                    [/then]
                                [/if]
                                [while]
                                    [variable]
                                        name=second_spawn_count
                                        greater_than=0
                                    [/variable]
                                    [do]
                                        {VARIABLE_OP spawn_type rand $spawn_types}
                                        [if]
                                            [variable]
                                                name=remaining_spawns
                                                greater_than_equal_to=1
                                            [/variable]
                                            [then]
                                                {GENERIC_UNIT 6 $spawn_type 24 30}
                                                [+unit]
                                                    [modifications]
#ifver WESNOTH_VERSION >= 1.13.2
                                                        [advancement]
#else
                                                        [advance]
#endif
                                                            id=monster_init
                                                            [effect]
                                                                apply_to=hitpoints
                                                                increase_total=$remaining_spawns
                                                                heal_full=yes
                                                            [/effect]
                                                            [effect]
                                                                apply_to=attack
                                                                increase_damage=$remaining_spawns|%
                                                            [/effect]
#ifver WESNOTH_VERSION >= 1.13.2
                                                        [/advancement]
#else
                                                        [/advance]
#endif
                                                    [/modifications]
                                                [/unit]
                                            [/then]
                                            [else]
                                                {GENERIC_UNIT 6 $spawn_type 24 30}
                                            [/else]
                                        [/if]
                                        {VARIABLE_OP second_spawn_count sub 1}
                                    [/do]
                                [/while]
                                {VARIABLE phase 3}
                            [/event]
                        [/event]
                    [/then]
                [/if]
                [if]
                    [variable]
                        name=phase
                        equals=3
                    [/variable]
                    [then]
                        [message]
                            speaker=moderator
                            message= _ "Good job, take a breath and return to your rooms. (hit end turn to continue)"
                        [/message]
                        [event]
                            name=side turn end
                            [move_unit]
                                side=1,2,3,4,5
                                to_x=24
                                to_y=4
                                fire_event=no
                            [/move_unit]
                            {FOREACH units_to_revive i}
                                {VARIABLE units_to_revive[$i].x 24}
                                {VARIABLE units_to_revive[$i].y 4}
                                [unstore_unit]
                                    variable=units_to_revive[$i]
                                    find_vacant=yes
                                [/unstore_unit]
                            {NEXT i}
                            {CLEAR_VARIABLE units_to_revive}
                            [store_unit]
                                [filter]
                                    side=1,2,3,4,5
                                    canrecruit=yes
                                [/filter]
                                variable=heal_store
                                kill=no
                            [/store_unit]
                            {FOREACH heal_store i}
                                {VARIABLE heal_store[$i].hitpoints $heal_store[$i].max_hitpoints}
                                {CLEAR_VARIABLE heal_store[$i].status.poisoned}
                                {CLEAR_VARIABLE heal_store[$i].status.slowed}
                                {VARIABLE heal_store[$i].moves $heal_store[$i].max_moves}
                                [unstore_unit]
                                    variable=heal_store[$i]
                                    find_vacant=no
                                [/unstore_unit]
                            {NEXT i}
                            {CLEAR_VARIABLE heal_store}
                            {VARIABLE phase 1}
                            {MODIFY_TERRAIN Urb^Xo (23,25) (10,10)}
                            [redraw]
                            [/redraw]
                            [modify_turns]
                                current=1
                            [/modify_turns]
                            {FADE_TO_BLACK}
                            [store_unit]
                                [filter]
                                    side=7
                                [/filter]
                                variable=home_store
                                kill=yes
                            [/store_unit]
                            {VARIABLE_OP difficulty multiply 1.2}
                            [gold]
                                side=1,2,3,4,5
                                amount=$(50+$round/10)
                            [/gold]
                            {VARIABLE_OP item_return rand (1..40)}
                            {CLEAR_VARIABLE "i$item_return"}
                            {VARIABLE_OP item_return rand (1..40)}
                            {CLEAR_VARIABLE "i$item_return"}
                            {CLEAR_VARIABLE item_return}
                            [if]
                                [variable]
                                    name=round
                                    equals=5
                                [/variable]
                                [then]
                                    {CLEAR_VARIABLE i41,i42,i43,i44,i45,i46,i46,i47,i48,i49,i50}
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=round
                                    equals=10
                                [/variable]
                                [then]
                                    {CLEAR_VARIABLE i51,i52,i53}
                                [/then]
                            [/if]
                            {VARIABLE_OP round add 1}
                            {RANDOM_ITEM 22 6}
                            {FADE_IN}
                            {FOREACH home_store i}
                                [unstore_unit]
                                    variable=home_store[$i]
                                    find_vacant=no
                                [/unstore_unit]
                            {NEXT i}
                            {CLEAR_VARIABLE home_store}
                            {CLEAR_VARIABLE ig1,ig2,ig3,ig4,ig5,ig6,ig7,ig8,ig9,ig10}
                            [message]
                                speaker=moderator
                                message= _ "The next battle will start in turn 3!"
                            [/message]
                        [/event]
                    [/then]
                [/if]
            [/else]
        [/if]
    [/event]

    {DROPS 14 30 (sword,sword,sword,bow,bow,bow,staff,staff,staff,axe,axe,axe,xbow,dagger,knife,mace,mace,spear) yes 6}
    {GLOBAL_EVENTS}
[/multiplayer]
