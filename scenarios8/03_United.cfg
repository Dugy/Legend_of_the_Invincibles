#textdomain wesnoth-loti
[scenario]
    id="03_United"
    name= _ "United"
    map_data="{~add-ons/Legend_of_the_Invincibles/maps/03_Valley_of_Peace.map}"
    next_scenario=04_Kidnapped
    victory_when_enemies_defeated=yes
    {TURNS 35 33 31}
    experience_modifier=80
    {SCENARIO_MUSIC "battle.ogg"}
    {EXTRA_SCENARIO_MUSIC battle-epic.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}
    {TWO_SUNS_DEFAULT_SCHEDULE}
    [side]
        type=Efraim_god
        id=Efraim
        name=_"Efraim"
        canrecruit=yes
        side=1
        controller=human
        recruit=Skeleton,Skeleton Archer,Ghost,Walking Corpse,Soulless,Bone Shooter,Deathblade,Revenant,Wraith,Shadow,Chocobone,Spearman,Swordsman,Javelineer,Pikeman,Bowman,Longbowman,Heavy Infantryman,Shock Trooper,Fencer,Duelist,Mage,White Mage,Red Mage,Cavalryman,Dragoon,Horseman,Lancer,Snow Hunter,Knight,Elvish Fighter,Elvish Archer,Elvish Shaman,Elvish Scout,Elvish Druid,Elvish Sorceress,Elvish Captain,Elvish Hero,Elvish Marksman,Elvish Ranger,Elvish Lord,Elvish Marshal,Elvish Champion,Elvish Sharpshooter,Elvish Avenger,Elvish Outrider,Elvish Shyde,Elvish Enchantress,Dwarvish Fighter,Dwarvish Steelclad,Dwarvish Guardsman,Dwarvish Stalwart,Dwarvish Thunderer,Dwarvish Thunderguard,Dwarvish Ulfserker,Dwarvish Berserker
        village_gold=2
        gold=300
        team_name=good
        unrenamable=yes
        user_team_name=_"Good"
    [/side]
    [side]
        type=Duke
        id=duke
        generate_name=yes
        canrecruit=yes
        side=2
        recruit=Elvish Champion,Elvish Outrider,Elvish Sharpshooter,Elvish Shyde,Elvish Enchantress,Elvish Avenger,Halberdier,Royal Guard,Master Bowman,Arch Mage,Mage of Light,Iron Mauler,Cavalier,Grand Knight,Paladin,Grim Knight,Draug,Banebow,Lich,Spectre,Nightgaunt,Dwarvish Lord,Dwarvish Dragonguard,Dwarvish Sentinel
        village_gold=4
        gold=1000
        {INCOME 80 90 100}
        team_name=good
        user_team_name=_"Good"
        [unit]
            type=Celestial Messenger
            generate_name=yes
            ai_special=guardian
            gender=male
            x,y=23,20
            id=sage
        [/unit]
        [unit]
            type=Elvish Sylph
            generate_name=yes
            ai_special=guardian
            x,y=27,19
            id=elf
        [/unit]
        [unit]
            type=Dwarvish Hero
            generate_name=yes
            ai_special=guardian
            x,y=23,17
            id=dwarf
        [/unit]
        [unit]
            type=Ancient Lich
            name= _ "Merethil"
            generate_name=yes
            ai_special=guardian
            x,y=26,17
            id=lich
        [/unit]
        {GUARDIAN_UNIT 2 "Royal Guard" 25 28}
        {GUARDIAN_UNIT 2 "Royal Guard" 26 27}
        {GUARDIAN_UNIT 2 "Royal Guard" 27 27}
        {GUARDIAN_UNIT 2 "Royal Guard" 28 26}
        {GUARDIAN_UNIT 2 "Royal Guard" 29 25}
        {GUARDIAN_UNIT 2 "Royal Guard" 29 24}
        {GUARDIAN_UNIT 2 "Royal Guard" 30 23}
        {GUARDIAN_UNIT 2 "Royal Guard" 30 22}
        {GUARDIAN_UNIT 2 "Royal Guard" 32 21}
        {GUARDIAN_UNIT 2 "Royal Guard" 32 20}
        {GUARDIAN_UNIT 2 "Royal Guard" 32 19}
        {GUARDIAN_UNIT 2 "Royal Guard" 32 17}
        {GUARDIAN_UNIT 2 "Royal Guard" 31 17}
        {GUARDIAN_UNIT 2 "Royal Guard" 30 16}
        {GUARDIAN_UNIT 2 "Royal Guard" 29 16}
        {GUARDIAN_UNIT 2 "Royal Guard" 27 15}
        {GUARDIAN_UNIT 2 "Royal Guard" 26 14}
        {GUARDIAN_UNIT 2 "Royal Guard" 25 14}
        {GUARDIAN_UNIT 2 "Royal Guard" 24 14}
        {GUARDIAN_UNIT 2 "Royal Guard" 23 14}
        {GUARDIAN_UNIT 2 "Royal Guard" 22 14}
        {GUARDIAN_UNIT 2 "Royal Guard" 22 15}
        {GUARDIAN_UNIT 2 "Royal Guard" 19 17}
        {GUARDIAN_UNIT 2 "Royal Guard" 19 18}
        {GUARDIAN_UNIT 2 "Royal Guard" 19 19}
        {GUARDIAN_UNIT 2 "Royal Guard" 19 20}
        {GUARDIAN_UNIT 2 "Royal Guard" 19 21}
        {GUARDIAN_UNIT 2 "Royal Guard" 19 22}
        {GUARDIAN_UNIT 2 "Royal Guard" 19 23}
        {GUARDIAN_UNIT 2 "Royal Guard" 20 24}
        {GUARDIAN_UNIT 2 "Royal Guard" 20 25}
        {GUARDIAN_UNIT 2 "Royal Guard" 21 26}
        {GUARDIAN_UNIT 2 "Royal Guard" 22 26}
    [/side]

    [side]
        no_leader=yes
        side=3
        recruit=Demon Infiltrator Cavalryman,Demon Infiltrator Bowman,Demon Infiltrator Spearman,Demon Infiltrator Heavy Infantryman,Demon Infiltrator Fencer
        team_name=Invaders
        user_team_name=_"Invaders"
        village_gold=5
        {GOLD 900 1100 1300}
        {INCOME 110 130 150}
        [ai]
            aggression=1.0
        [/ai]
        {AI_OVERHAUL_PLACE 3}
        {AI_OVERHAUL_PLACE_2 3}
    [/side]
    [side]
        no_leader=yes
        side=4
        recruit=Demon
        team_name=Invaders
        user_team_name=_"Invaders"
        village_gold=5
#ifdef CAMPAIGN_LEGEND_OF_THE_INVINCIBLES_VIII
        {GOLD 600 700 800}
        {INCOME 70 90 110}
#else
        {GOLD 700 900 1100}
        {INCOME 140 160 180}
#endif
        [ai]
            aggression=1.0
        [/ai]
        {AI_OVERHAUL_PLACE 4}
        {AI_OVERHAUL_PLACE_2 4}
    [/side]
    [side]
        no_leader=yes
        side=5
        recruit=Imp
        team_name=Invaders
        user_team_name=_"Invaders"
        village_gold=5
#ifdef CAMPAIGN_LEGEND_OF_THE_INVINCIBLES_VIII
        {GOLD 600 700 800}
        {INCOME 70 90 110}
#else
        {GOLD 900 1100 1300}
        {INCOME 110 130 150}
#endif
        [ai]
            aggression=1.0
        [/ai]
        {AI_OVERHAUL_PLACE 5}
        {AI_OVERHAUL_PLACE_2 5}
    [/side]
    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description=_ "Defeat all enemy leaders"
                condition=win
            [/objective]
            [objective]
                description=_ "Death of Efraim, Lethalia, Krux or Vritra"
                condition=lose
            [/objective]
            [objective]
                description=_ "Turns run out"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]
    [/event]

    [event]
        name=start
        [message]
            speaker=Efraim
            message= _ "We are here..."
        [/message]
        {CAPTURE_VILLAGES 2 24 18 30}
        {MOVE_UNIT id=Efraim 26 22}
        [message]
            speaker=Efraim
            message= _ "Hail."
        [/message]
        [recall]
            id=Lethalia
        [/recall]
        [recall]
            id=Krux
        [/recall]
        [recall]
            id=Vritra
        [/recall]
        [message]
            speaker=duke
            message= _ "Welcome. You have arrived just in time to our grand meeting. May I introduce a dwarvish royal counselor, an elvish speaker of a High Lord, a sage and fighter known for his incredible knowledge and a representative of Darkness."
        [/message]
        [message]
            speaker=lich
            message= _ "Efraim and Lethalia have arrived. We may continue now, I hate interruptions."
        [/message]
        [message]
            speaker=elf
            message= _ "We were only beginning, we wanted to wait for you, but we recently assumed that our messenger was slain."
        [/message]
        [message]
            speaker=Vritra
            message= _ "He probably died, the forest was full of carnivorous monsters and we saw no messengers."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "Hush, let the adults speak."
        [/message]
        [message]
            speaker=Efraim
            message= _ "We arrived because we were <i>fleeing</i> from these things, the messenger was probably eaten as my daughter said."
        [/message]
        [message]
            speaker=dwarf
            message= _ "Your <i>foster</i> daughter."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "Does it matter?"
        [/message]
        [message]
            speaker=dwarf
            message= _ "For us dwarves, yes."
        [/message]
        [message]
            speaker=sage
            message= _ "Back to topic, I wanted to say that these new invaders are demons. I have seen that some of them had horns under their helmets, and some of them also had demonic facial traits. I have also seen several regular demons among them."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "I thought they were demons, but I was not sure. We have faced only about a dozen of them, then we had to flee."
        [/message]
        [message]
            speaker=lich
            message= _ "What do we know about demons? The knowledge of demonology is forbidden and punished by death even in the society of necromancers."
        [/message]
        [message]
            speaker=sage
            message= _ "Long ago, there were times when it was not forbidden. All demonologists were extinct eons before, and their knowledge was forgotten. Demonology was simply another field of study, and magi studied it a lot. They discovered their world, named Inferno, when they were exploring other worlds."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "That was before the creation of the second sun, right?"
        [/message]
        [message]
            speaker=sage
            message= _ "I cannot remember. But what is more important is that they found Inferno as a world that was inaccessible because of a strong barrier. Nothing could penetrate through it, no matter what they tried. After the Fall, however, they figured it out. There was some kind of key on this side, making the barrier openable from here. They used it to interview some demons and collect knowledge about an unmapped world. They also passed their knowledge to other mages in the few communities that survived the Fall. One of these communities were also the elves of the Wesmere forest, who managed to summon a powerful demon lord in one of their experiments. The demon lord, named Zhangor, tricked them to worship him as god and they did incredible deeds of evil under his command."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "No!"
        [/message]
        [message]
            speaker=Efraim
            message= _ "Your prophecy was fulfilled. We could not prevent it, because we were like dead."
        [/message]
        [message]
            speaker=dwarf
            message= _ "You foretold it?"
        [/message]
        [message]
            speaker=Lethalia
            message= _ "Yes, and we were trying to prevent it from fulfilling for millennia, but when the foolish magi tried to create a third sun, we had to sacrifice ourselves, letting it fall on us, to avoid a fatal change of climate. We eventually recovered, losing almost all our power, but it was only about three decades ago."
        [/message]
        [message]
            speaker=lich
            message= _ "I wish I had such power..."
        [/message]
        [message]
            speaker=sage
            message= _ "Zhangor was eventually defeated by two great heroes, one was named Argan and the other one was his wife..."
        [/message]
        [message]
            speaker=Efraim
            message= _ "Argan?! But he was a villain!"
        [/message]
        [message]
            speaker=Lethalia
            message= _ "We cannot know how many times he reincarnated before we met him. He is not inherently evil, if one of his incarnations gets into a good company, it should not become a villain."
        [/message]
        [message]
            speaker=Efraim
            message= _ "But Argan was rather a good leader, not a great fighter or mage."
        [/message]
        [message]
            speaker=sage
            message= _ "That Argan I was speaking about was a great master of arcane arts, and so was his wife, nobody has ever seen such powerful discharges of magical power."
        [/message]
        [message]
            speaker=Efraim
            message= _ "It must have been a <i>different</i> Argan, names are not unique."
        [/message]
        [message]
            speaker=sage
            message= _ "Back to the story, Zhangor was defeated after some time, but that was not enough. The magi that discovered it, I think that it was on the Isle of Alduin..."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "The magi of Alduin Isle were really pathetic..."
        [/message]
        [message]
            speaker=sage
            message= _ "They did not know how evil the demons were for very long, they simply thought that they were just another race, like orcs or drakes, and the demons lied to make them believe this. The mages considered ancient stories about evil demons as unreliable rumours, basically the same thing was wrongly believed about orcs and sometimes also about drakes. They appointed a meeting with an important demonic noblewoman, Yechnagoth. They charged a great amount of magical power to open a portal for her coming, but after her triumphal arrival, she simply killed them all except those who agreed to serve her."
        [/message]
        [message]
            speaker=sage
            message= _ "Many wars were led against Yechnagoth, but it was not possible to defeat her by usual methods, when her body was destroyed, she just became an incorporeal entity that recovered after some time. I suspect that she was finally defeated by one of the few good demons that exist."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "Good demons? What are these demons, anyway?"
        [/message]
        [message]
            speaker=sage
            message= _ "A group of ten demons was originally created by Yarae the Arcane Lord, as arbiters in a lengthy war between the Light and the Darkness. After some time, Yarae decided to use his power for evil purposes, and the demons became evil with him. This was one of the rare occasions when the Darkness united with the Light, so it is suspected that this collaboration was what Yarae wanted to achieve. They defeated the demons and made the demons who survived serve their original purpose. After some time, Yarae managed to corrupt some of them again, and taught them how to create lesser demons. That was eons ago, and today, it is said that only one of the original evil demons survived. That demon's name is Uria."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "I have already heard that name..."
        [/message]
        [message]
            speaker=sage
            message= _ "That is possible, people know who is the ruler of Inferno, the worst thing that ever existed."
        [/message]
        [message]
            speaker=elf
            message= _ "Why not Yarae?"
        [/message]
        [message]
            speaker=sage
            message= _ "Almost nothing is known about him, only that it is somebody with an incredible power, a power beyond our understanding. Also, Yarae is not influencing us, because he was somehow sealed, probably better than the world of Inferno. It must have been easier to seal a single person than a whole world. Uria is active, though, and created a group of demon lords, like Zhangor, Yechnagoth or Lilith. Demon lords keep creating lesser demons endlessly."
        [/message]
        [message]
            speaker=Efraim
            message= _ "We have faced Lilith, she was pretty bad."
        [/message]
        [message]
            speaker=elf
            message= _ "I suppose that during the wars against Yechnagoth, the knowledge of demonology became very widespread."
        [/message]
        [message]
            speaker=sage
            message= _ "Yes, today, it is relatively common that demonologists summon armies for vengeance or hunger for magical power, just like necromancers."
        [/message]
        [message]
            speaker=lich
            message= _ "There is an important difference. Demons are things that will obey you only if you have similar interests like them, like destruction or mayhem, and demonologists are limited to a certain number of demons they control, or they risk a riot. Necromancers may have limitless numbers of undead servants, and undead will obey every command, including doing good deeds, but from the other side demons are much stronger than undead. Demonologists are weaklings, with no power on their own, knowing only a few tricks to summon demons. That is why we hate demonologists as much as other people do, and help you fight them."
        [/message]
        [message]
            speaker=Efraim
            message= _ "In campaigns against demons, necromancy is tolerated?"
        [/message]
        [message]
            speaker=duke
            message= _ "Yes. You know what may happen if somebody is killed by a demon? The same thing that some gods do to their believers that betrayed them as absolute punishment. They are moved into the world of Inferno, where the demons will torture them for all eternity."
        [/message]
        [message]
            speaker=sage
            message= _ "The well conceived torture consists of improving their bodies with a strong regenerating ability and supernatural strength controlled by demons. They are set on fire, burn and regenerate at the same time. The strength within them is only turning the agony worse. Unless fighting for demons by exception, they hit themselves in desperation, scratch the most painful parts of their burns and wounds... but only the luckiest die from madness. Death moves them into the world of the dead, their only rescue. Of course, a good demon might be able to free them in the first place, but those are extremely rare. They do not build endless armies and cannot access most parts of Inferno: Uria is stronger and knows how to keep intruders away from her realm."
        [/message]
        [message]
            speaker=lich
            message= _ "They feel immense pain all the time, and the knowledge that the pain will never end is even worse. Becoming a Burning Soul is worse than anything else can be. That is why during campaigns against demons, people prefer to be enchanted by necromancers that they become undead after death, like ghosts or zombies, or usually simply lost souls that nobody notices and will leave this world after some time, and that prevents the demons from taking their souls. Demons cannot take the souls of the undead, because they are kept here by magic."
        [/message]
        [message]
            speaker=Efraim
            message= _ "Excellent, we can now summon the army of undead we had by the time we were resurrected from undeath, to help in this campaign. Who is that demonologist over there? Quick, summon the undead!"
        [/message]
        {FOREACH undead_store i}
            {CLEAR_VARIABLE undead_store[$i].status.slowed}
            {VARIABLE undead_store[$i].hitpoints $undead_store[$i].max_hitpoints}
            {VARIABLE undead_store[$i].x recall}
            {VARIABLE undead_store[$i].y recall}
            [unstore_unit]
                variable=undead_store[$i]
            [/unstore_unit]
        {NEXT i}
        {FOREACH undead_store2 i}
            {CLEAR_VARIABLE undead_store2[$i].status.slowed}
            {VARIABLE undead_store2[$i].hitpoints $undead_store2[$i].max_hitpoints}
            {VARIABLE undead_store2[$i].x recall}
            {VARIABLE undead_store2[$i].y recall}
            [unstore_unit]
                variable=undead_store2[$i]
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE undead_store,undead_store2}
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "You may now recall the undead you had in chapter 6."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "Any idea about the identity of that demonologist with so many demons in his wake?"
        [/message]
        [message]
            speaker=dwarf
            message= _ "I have never seen a demonologist having more than a dozen of demons under his control. This must be something much worse, either a conspiracy of demonologists..."
        [/message]
        [message]
            speaker=sage
            message= _ "...or a sign that their countless experiments and summonings weakened the barrier around Inferno so badly that a self-sustaining portal was opened from the side of Inferno, and this is an invasion of demons. There were even rumours that people have seen the river Styx."
        [/message]
        [message]
            speaker=Krux
            message= _ "Is it that river of lava that we have seen in our forest?"
        [/message]
        [message]
            speaker=sage
            message= _ "Probably yes. It is known that through the world on Inferno, a flaming river named Styx flows between all places it can reach. So, if this world was connected to the world of Inferno, it would flow here as well. On the other hand, it will lead us to the portal."
        [/message]
        [message]
            speaker=elf
            message= _ "So you really believe that there is a hole leading right into Inferno?"
        [/message]
        [message]
            speaker=duke
            message= _ "I would tend to think so, there is no other explanation for that flaming river."
        [/message]
        [message]
            speaker=elf
            message= _ "Maybe it is simply a volcanic explosion."
        [/message]
        [message]
            speaker=sage
            message= _ "There are no volcanoes around."
        [/message]
        [message]
            speaker=elf
            message= _ "Any mountain can become a volcano unexpectedly, it is just very improbable."
        [/message]
        [message]
            speaker=sage
            message= _ "Many people feared that a portal from Inferno might be opened. Calculated scenarios were terrible, world transforming into a clone of Inferno, volcanoes running wild, new volcanoes appearing, rivers of flame flowing from them like streams of water, burning skies turning day and night into a constant twilight, acid rains poisoning the water, terrible carnivorous plants replacing forests, demons roaming the land and preying on the survivors, people surviving only in the deepest caves, losing their faith in anything. Doomsayers called it Götterdämmerung, or Twilight of the Gods."
        [/message]
        [message]
            speaker=dwarf
            message= _ "So, what shall we do?"
        [/message]
        [message]
            speaker=sage
            message= _ "There must be a way to close the portal, but somebody must get through the demons to it."
        [/message]
        [message]
            speaker=duke
            message= _ "Is there a way to defeat these demons without fighting them?"
        [/message]
        [message]
            speaker=sage
            message= _ "They are all powered by Uria probably, so defeating Uria or somehow disconnecting them from her power should make the demons lose their arcane power, their magical strength and their supernatural resilience. Killing Uria or Yarae should stop the thread the demons cause for good, but I think not even gods can do that."
        [/message]
        [message]
            speaker=Efraim
            message= _ "Do you think we can defeat that Uria, Leth?"
        [/message]
        [message]
            speaker=Lethalia
            message= _ "Maybe if we had a massive army and she had no minions... We have defeated Lilith, one of her strongest servants. Can Uria die if we somehow manage to slay her in Inferno?"
        [/message]
        [message]
            speaker=sage
            message= _ "I think yes. And it should also weaken all her servants so badly that they would be no match for those who defeated Uria. But Uria cannot be defeated, admit it."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "So do you think that if we close the portal, everything will be fine?"
        [/message]
        [message]
            speaker=sage
            message= _ "Yes, it must have been sewed from the flaws created by demonologists for millennia, so if you close it, it will take eons until the demonologists will cause a hole again. And together, I hope we will exterminate the demonologists."
        [/message]
        [message]
            speaker=Efraim
            message= _ "So, we have to find the portal, figure out how to close it while fending off the demons, close it and slay all the remaining demons?"
        [/message]
        [message]
            speaker=elf
            message= _ "Yes, but you are known to have a power to kill almost anything without a fight."
        [/message]
        [message]
            speaker=Efraim
            message= _ "Yes, but using this ability on creatures whose souls are so incredibly evil is risky, we might become evil ourselves."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "No, there is no risk if you are prepared. The souls within us have a world on their own. Because there is no death, no disease, no famine and no wars, their world is highly developed. They learned to convert villains into lawful beings in a few days, and they can use demons as sources of magical power, or even convert them. Demons are terribly evil, but not inherently evil."
        [/message]
        [message]
            speaker=Efraim
            message= _ "I agree, I did not contemplate so much about it, but we will need really a lot of practice with our ability to absorb something as strong as Uria. If that is even possible."
        [/message]
        [store_unit]
            [filter]
                id=Lethalia
            [/filter]
            variable=Lethstore
            kill=no
        [/store_unit]
        [store_unit]
            [filter]
                id=Efraim
            [/filter]
            variable=Efrstore
            kill=no
        [/store_unit]
        {VARIABLE efraim_upgrade_count 0}
#ifver WESNOTH_VERSION >= 1.13.2
        {FOREACH Efrstore.modifications.advancement i}
#else
        {FOREACH Efrstore.modifications.advance i}
#endif
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="lightning"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="thunder"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="fireblast"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="firestorm"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="blizzard"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="arcticblast"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="entropy"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="particlestorm"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="resist_fire"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="resist_cold"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="resist_arcane"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="resist_blade"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="resist_pierce"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="resist_impact"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="health"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="regeneration"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="absorb"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="heal"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="spirit"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="leadership"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="fire_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="cold_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="arcane_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="blade_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="impact_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="pierce_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="weapons"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Efrstore.modifications.advancement[$i].id
#else
                    name=Efrstore.modifications.advance[$i].id
#endif
                    equals="magic"
                [/variable]
                [then]
                    {VARIABLE_OP efraim_upgrade_count add 1}
                [/then]
            [/if]
        {NEXT i}
        {VARIABLE lethalia_upgrade_count 0}
#ifver WESNOTH_VERSION >= 1.13.2
        {FOREACH Lethstore.modifications.advancement i}
#else
        {FOREACH Lethstore.modifications.advance i}
#endif
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="lightning"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="thunder"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="fireblast"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="firestorm"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="blizzard"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="arcticblast"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="entropy"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="particlestorm"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="resist_fire"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="resist_cold"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="resist_arcane"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="resist_blade"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="resist_pierce"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="resist_impact"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="health"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="regeneration"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="absorb"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="heal"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="spirit"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="leadership"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="fire_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="cold_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="arcane_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="blade_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="impact_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="pierce_penetrate"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="weapons"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=Lethstore.modifications.advancement[$i].id
#else
                    name=Lethstore.modifications.advance[$i].id
#endif
                    equals="magic"
                [/variable]
                [then]
                    {VARIABLE_OP lethalia_upgrade_count add 1}
                [/then]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=efraim_upgrade_count
                less_than=5
            [/variable]
            [and]
                [variable]
                    name=lethalia_upgrade_count
                    less_than=5
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=Efraim
                    message= _ "But there is a problem, our ability to absorb souls is not developed enough to absorb most of the demons, so we have almost nothing to practise on, and that might cripple us badly."
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=efraim_upgrade_count
                less_than=5
            [/variable]
            [and]
                [variable]
                    name=lethalia_upgrade_count
                    greater_than=4
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=Efraim
                    message= _ "But there is a problem, my ability to absorb souls is not developed enough to absorb most of the demons, so I have almost nothing to practise on, and that might cripple me badly."
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=lethalia_upgrade_count
                less_than=5
            [/variable]
            [and]
                [variable]
                    name=efraim_upgrade_count
                    greater_than=4
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=Lethalia
                    message= _ "But there is a problem, my ability to absorb souls is not developed enough to absorb most of the demons, so I have almost nothing to practise on, and that might cripple me badly."
                [/message]
            [/then]
        [/if]
        {VARIABLE efraim_will_upgrade 0}
        {VARIABLE lethalia_will_upgrade 0}
        [if]
            [variable]
                name=efraim_upgrade_count
                less_than=5
            [/variable]
            [or]
                [variable]
                    name=lethalia_upgrade_count
                    less_than=5
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=Efraim
                    message= _ "Hm... A quick reach into the lucky bag could help and strengthen our redeeming forces ahead of time... Sure, it would be unusual, but we have never had any problem with abnormalities... And before making real improvements we have to save the required number of souls nevertheless... So, should we do it?"
                    [option]
                        message= _ "Yes, for both."
                        [show_if]
                            [variable]
                                name=efraim_upgrade_count
                                less_than=5
                            [/variable]
                            [and]
                                [variable]
                                    name=lethalia_upgrade_count
                                    less_than=5
                                [/variable]
                            [/and]
                        [/show_if]
                        [command]
                            {VARIABLE efraim_will_upgrade 1}
                            {VARIABLE lethalia_will_upgrade 1}
                        [/command]
                    [/option]
                    [option]
                        message= _ "Yes, for Efraim."
                        [show_if]
                            [variable]
                                name=efraim_upgrade_count
                                less_than=5
                            [/variable]
                        [/show_if]
                        [command]
                            {VARIABLE efraim_will_upgrade 1}
                        [/command]
                    [/option]
                    [option]
                        message= _ "Yes, for Lethalia."
                        [show_if]
                            [variable]
                                name=lethalia_upgrade_count
                                less_than=5
                            [/variable]
                        [/show_if]
                        [command]
                            {VARIABLE lethalia_will_upgrade 1}
                        [/command]
                    [/option]
                    [option]
                        message= _ "No."
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=efraim_will_upgrade
                equals=1
            [/variable]
            [then]
                [while]
                    [variable]
                        name=efraim_upgrade_count
                        less_than=5
                    [/variable]
                    [do]
#ifver WESNOTH_VERSION >= 1.13.2
                        {VARIABLE Efrstore.modifications.advancement[$Efrstore.modifications.advancement.length].id leadership}
#else
                        {VARIABLE Efrstore.modifications.advance[$Efrstore.modifications.advance.length].id leadership}
#endif
                        {VARIABLE_OP efraim_upgrade_count add 1}
                        [unstore_unit]
                            variable=Efrstore
                            find_vacant=no
                        [/unstore_unit]
                        [object]
                            silent=yes
                            [filter]
                                id=Efraim
                            [/filter]
                            [effect]
                                apply_to=attack
                                name="redeem"
                                [set_specials]
                                    mode=replace
                                    {WEAPON_SPECIAL_REDEEM_5}
                                    {WEAPON_SPECIAL_FOCUSED}
                                [/set_specials]
                            [/effect]
                        [/object]
                    [/do]
                [/while]
            [/then]
        [/if]
        [if]
            [variable]
                name=lethalia_will_upgrade
                equals=1
            [/variable]
            [then]
                [while]
                    [variable]
                        name=lethalia_upgrade_count
                        less_than=5
                    [/variable]
                    [do]
#ifver WESNOTH_VERSION >= 1.13.2
                        {VARIABLE Lethstore.modifications.advancement[$Lethstore.modifications.advancement.length].id heal}
#else
                        {VARIABLE Lethstore.modifications.advance[$Lethstore.modifications.advance.length].id heal}
#endif
                        {VARIABLE_OP lethalia_upgrade_count add 1}
                        [unstore_unit]
                            variable=Lethstore
                            find_vacant=no
                        [/unstore_unit]
                        [object]
                            silent=yes
                            [filter]
                                id=Lethalia
                            [/filter]
                            [effect]
                                apply_to=attack
                                name="redeem"
                                [set_specials]
                                    mode=replace
                                    {WEAPON_SPECIAL_REDEEM_5}
                                    {WEAPON_SPECIAL_FOCUSED}
                                [/set_specials]
                            [/effect]
                        [/object]
                    [/do]
                [/while]
            [/then]
        [/if]
        [if]
            [variable]
                name=efraim_upgrade_count
                less_than=5
            [/variable]
            [or]
                [variable]
                    name=lethalia_upgrade_count
                    less_than=5
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=Lethalia
                    message= _ "Done."
                [/message]
            [/then]
        [/if]
        {CLEAR_VARIABLE efraim_upgrade_count,Efrstore,efraim_will_upgrade,lethalia_upgrade_count,Lethstore,lethalia_will_upgrade}
        [message]
            speaker=duke
            message= _ "So, what do we do now?"
        [/message]
        [message]
            speaker=Efraim
            message= _ "There were lots of demons in the valley where the river of Styx flowed. We must go through the mountains, and then proceed south, trying to avoid them."
        [/message]
        [message]
            speaker=dwarf
            message= _ "There might be some bandits. They usually act impulsively and might not understand you are fighting demons, that are a danger also for them. They might even obey the demons for gold."
        [/message]
        [message]
            speaker=Efraim
            message= _ "We have fought demons and other abominations, bandits should not be a problem."
        [/message]
        [message]
            speaker=dwarf
            message= _ "True."
        [/message]
        [unit]
            type=Demon Infiltrator General
            id=enemy1
            gender=male
            name= _ "Azazel"
            random_traits=yes
            side=3
            canrecruit=yes
            x,y=54,19
            [modifications]
                [trait]
                    id=brutal
                    male_name= _ "brutal"
                    female_name= _ "female^brutal"
                    description= _ "uses a lesser berserk"
                    [effect]
                        apply_to=attack
                        range=melee
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_LESSER_BERSERK 3}
                        [/set_specials]
                    [/effect]
                [/trait]
                [trait]
                    id=cruel
                    male_name= _ "cruel"
                    female_name= _ "female^cruel"
                    description= _ "can charge"
                    [effect]
                        apply_to=attack
                        range=melee
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_CHARGE}
                        [/set_specials]
                    [/effect]
                [/trait]
                [trait]
                    id=spectral
                    male_name= _ "spectral"
                    female_name= _ "female^spectral"
                    description= _ "melee attacks drain"
                    [effect]
                        apply_to=attack
                        range=melee
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_DRAIN}
                        [/set_specials]
                    [/effect]
                [/trait]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [unit]
            type=Demon Overlord
            id=enemy2
            gender=male
            name= _ "Azrael"
            random_traits=yes
            side=4
            canrecruit=yes
            x,y=2,19
            [modifications]
                [trait]
                    id=horrid
                    male_name= _ "horrid"
                    female_name= _ "female^horrid"
                    description= _ "aura of despair"
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_DESPAIR 25}
                        [/abilities]
                    [/effect]
                [/trait]
                [trait]
                    id=regrowing
                    male_name= _ "regrowing"
                    female_name= _ "female^regrowing"
                    description= _ "regenerates"
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES_OTHER 16}
                        [/abilities]
                    [/effect]
                [/trait]
                [trait]
                    id=foul
                    male_name= _ "foul"
                    female_name= _ "female^foul"
                    description= _ "resistant to physical damage, especially impact"
                    [effect]
                        apply_to=resistance
                        replace=false
                        [resistance]
                            blade=-20
                            impact=-40
                            pierce=-20
                        [/resistance]
                    [/effect]
                [/trait]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [unit]
            type=Demonologist
            id=enemy3
            gender=male
            name= _ "Blutyn"
            random_traits=yes
            side=5
            canrecruit=yes
            x,y=28,41
            [modifications]
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace="true"
                        [movement_costs]
                            flat={UNREACHABLE}
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]
        [message]
            speaker=enemy1
            message= _ "Surrender now, you are surrounded, there is no escape."
        [/message]
        [message]
            speaker=dwarf
            message= _ "What will you do to us if we surrender?"
        [/message]
        [message]
            speaker=enemy2
            message= _ "We will kill you with one blow, almost painlessly."
        [/message]
        [message]
            speaker=elf
            message= _ "And our souls will be dragged into Inferno and suffer there forever, right? We will never surrender to you, we will prefer to die in combat because it is our only hope to save ourselves from the endless torment."
        [/message]
        [message]
            speaker=Efraim
            message= _ "I think the situation is not so bad, we can defeat them. The necromancy that has to be involved will cost you a bit of yourselves, but it is still better than the endless torment."
        [/message]
        [message]
            speaker=sage
            message= _ "I think that the Duke is the best tactician here, we should let him lead our soldiers into battle."
        [/message]
        [message]
            speaker=elf
            message= _ "I agree."
        [/message]
        [message]
            speaker=dwarf
            message= _ "I agree."
        [/message]
        [message]
            speaker=lich
            message= _ "I agree."
        [/message]
        [message]
            speaker=Efraim
            message= _ "My soldiers are loyal only to me, so I will lead my troops. I will take some villages, if it is not a problem. Charge!"
        [/message]
        {CAPTURE_VILLAGES 1 24 18 12}
        [message]
            speaker=duke
            message= _ "CHAAAARGE!"
        [/message]
        [message]
            speaker=lich
            message= _ "Thar'thazz grozofrt'rheni k'armagos umurnuk... Haradrakarabazo'o'okram buirbehee phantitiok... Now, the souls of our soldiers belong to me. They will stay on the battlefield, until eradicated. The demons will never take them."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "That is too cruel. Karakroama manalitaria floata klapaeretia kohranol... now the souls of our soldiers will be taken and send into the world of the dead if they get killed."
        [/message]
    [/event]

    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=2
            [not]
                race=undead
            [/not]
        [/filter]
        {VARIABLE reviveX $x1}
        {VARIABLE reviveY $y1}
        [unit]
            animate=yes
            type=Ghost
            x=$reviveX
            y=$reviveY
            side=2
        [/unit]
        {CLEAR_VARIABLE reviveX}
        {CLEAR_VARIABLE reviveY}
    [/event]

    [event]
        name=enemies defeated
        [message]
            speaker=Efraim
            message= _ "We have won, but its cost was terrible. We must prevent this Twilight of the Gods from happening as quickly as possible."
        [/message]
        [message]
            speaker=Vritra
            message= _ "Mom, can we go with you?"
        [/message]
        [message]
            speaker=Lethalia
            message= _ "No, you will stay here, in safety."
        [/message]
        [message]
            speaker=Efraim
            message= _ "This place is not very safe. Another and another army of demons will come, and they will have to retreat, either through the mountains north, or into another location, and the demons will go there too... They will be safer with us."
        [/message]
        [message]
            speaker=Lethalia
            message= _ "All right then, I have to choose between bad and worse, so I choose bad."
        [/message]
        [message]
            speaker=Krux
            message= _ "Adventures await us, sister!"
        [/message]
        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    [event]
        name=time over
        [message]
            speaker=Efraim
            message= _ "You can also see those huge enemy reinforcements approaching us, right?"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Vritra
        [/filter]
        [message]
            speaker=Lethalia
            message= _ "No, we should not have let her fight..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Krux
        [/filter]
        [message]
            speaker=Lethalia
            message= _ "No, we should not have let him fight..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    {BEELZEBUB_SPAWN_POINT 6 8 43 38 38-48,33-43}
    {GENERIC_DEATHS}
    {DROPS 5 7 (axe,axe,staff,sword,sword,knife,bow,xbow,spear,spear,bow,dagger,mace) yes 3,4,5}
    {GLOBAL_EVENTS}
[/scenario]
